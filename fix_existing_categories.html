<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Existing Categories</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .fix-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
        .warning { border-left: 4px solid #FF9800; }
        .info { border-left: 4px solid #2196F3; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        .danger {
            background: #f44336;
        }
        .danger:hover { background: #d32f2f; }
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .data-display {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #ddd;
        }
        .menu-item {
            background: #e3f2fd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border: 1px solid #2196f3;
        }
        .category-tag {
            background: #4caf50;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
            display: inline-block;
        }
        .before-after {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .before, .after {
            padding: 15px;
            border-radius: 5px;
        }
        .before {
            background: #ffebee;
            border: 1px solid #f44336;
        }
        .after {
            background: #e8f5e8;
            border: 1px solid #4caf50;
        }
    </style>
</head>
<body>
    <h1>üîß Fix Existing Categories</h1>
    
    <div class="fix-card warning">
        <h3>‚ö†Ô∏è Important Notice</h3>
        <p>This tool will fix existing OMS customizations that have "Uncategorized" categories. It will extract actual categories from menu items and update the database.</p>
        <p><strong>Make sure you have admin access to the database before proceeding.</strong></p>
    </div>
    
    <div class="fix-card info">
        <h3>üß™ Fix Categories Tool</h3>
        <p>This will scan all OMS customizations and fix categories that are showing as "Uncategorized".</p>
        <button onclick="scanProblematicRecords()">Scan Problematic Records</button>
        <button onclick="fixAllCategories()" class="danger">Fix All Categories</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div id="log" class="fix-card">
        <h3>üìã Fix Log:</h3>
        <div id="log-content" class="log">Click "Scan Problematic Records" to start...</div>
    </div>
    
    <div id="results" class="fix-card">
        <h3>üìä Results:</h3>
        <div id="data-display"></div>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://lmrrdcaavwwletcjcpqv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxtcnJkY2Fhdnd3bGV0Y2pjcHF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MDQ0ODgsImV4cCI6MjA3MTA4MDQ4OH0.AU59Qfr6K9i880Gcn5y-3pjCf8PXsDIq4OI0-lPQVuQ';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        function log(message) {
            const logContent = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();
            logContent.textContent += `[${timestamp}] ${message}\n`;
            logContent.scrollTop = logContent.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log-content').textContent = 'Log cleared...\n';
        }

        async function scanProblematicRecords() {
            log('üîç Scanning for records with "Uncategorized" categories...');
            
            try {
                const { data: omsCustomizations, error: omsError } = await supabase
                    .from('oms_customizations')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (omsError) {
                    log(`‚ùå Error loading OMS data: ${omsError.message}`);
                    return;
                }

                if (!omsCustomizations || omsCustomizations.length === 0) {
                    log('‚ö†Ô∏è No OMS data found');
                    return;
                }

                log(`‚úÖ Found ${omsCustomizations.length} total OMS customizations`);

                const problematicRecords = [];
                const fixedRecords = [];

                omsCustomizations.forEach((oms, index) => {
                    try {
                        const menuItems = typeof oms.menu_items === 'string' ? JSON.parse(oms.menu_items) : (oms.menu_items || []);
                        const menuCategories = typeof oms.menu_categories === 'string' ? JSON.parse(oms.menu_categories) : (oms.menu_categories || []);
                        
                        // Check if categories contain "Uncategorized"
                        const hasUncategorized = menuCategories.some(cat => 
                            cat.name === 'Uncategorized' || cat.name === 'Uncategorized'
                        );
                        
                        if (hasUncategorized && menuItems.length > 0) {
                            // Extract actual categories from menu items
                            const actualCategories = Array.from(new Set(
                                menuItems.map(item => item.item_category || item.category || 'General')
                                    .filter(cat => cat && cat.trim() !== '' && cat !== 'Uncategorized')
                            ));
                            
                            if (actualCategories.length > 0) {
                                problematicRecords.push({
                                    ...oms,
                                    actualCategories,
                                    currentCategories: menuCategories
                                });
                            }
                        } else if (menuCategories.length > 0) {
                            fixedRecords.push(oms);
                        }
                    } catch (error) {
                        log(`‚ùå Error processing record ${oms.id}: ${error.message}`);
                    }
                });

                log(`\nüìä Scan Results:`);
                log(`   Total records: ${omsCustomizations.length}`);
                log(`   Problematic records: ${problematicRecords.length}`);
                log(`   Already fixed records: ${fixedRecords.length}`);

                if (problematicRecords.length > 0) {
                    log(`\nüîç Problematic Records Details:`);
                    problematicRecords.forEach((record, index) => {
                        log(`\n   Record ${index + 1}: ${record.restaurant_name}`);
                        log(`   Current categories: ${record.currentCategories.map(c => c.name).join(', ')}`);
                        log(`   Actual categories: ${record.actualCategories.join(', ')}`);
                        log(`   Menu items: ${record.menu_items.length} items`);
                    });
                }

                displayScanResults(problematicRecords, fixedRecords);

            } catch (error) {
                log(`‚ùå Exception: ${error.message}`);
            }
        }

        async function fixAllCategories() {
            log('üîß Starting to fix all categories...');
            
            try {
                const { data: omsCustomizations, error: omsError } = await supabase
                    .from('oms_customizations')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (omsError) {
                    log(`‚ùå Error loading OMS data: ${omsError.message}`);
                    return;
                }

                let fixedCount = 0;
                let errorCount = 0;

                for (const oms of omsCustomizations) {
                    try {
                        const menuItems = typeof oms.menu_items === 'string' ? JSON.parse(oms.menu_items) : (oms.menu_items || []);
                        const menuCategories = typeof oms.menu_categories === 'string' ? JSON.parse(oms.menu_categories) : (oms.menu_categories || []);
                        
                        // Check if this record needs fixing
                        const hasUncategorized = menuCategories.some(cat => 
                            cat.name === 'Uncategorized' || cat.name === 'Uncategorized'
                        );
                        
                        if (hasUncategorized && menuItems.length > 0) {
                            // Extract actual categories from menu items
                            const actualCategories = Array.from(new Set(
                                menuItems.map(item => item.item_category || item.category || 'General')
                                    .filter(cat => cat && cat.trim() !== '' && cat !== 'Uncategorized')
                            ));
                            
                            if (actualCategories.length > 0) {
                                // Create new categories array
                                const newCategories = actualCategories.map((category, index) => ({
                                    id: `cat_${index + 1}`,
                                    name: category
                                }));
                                
                                // Update the record
                                const { error: updateError } = await supabase
                                    .from('oms_customizations')
                                    .update({ menu_categories: newCategories })
                                    .eq('id', oms.id);
                                
                                if (updateError) {
                                    log(`‚ùå Error updating ${oms.restaurant_name}: ${updateError.message}`);
                                    errorCount++;
                                } else {
                                    log(`‚úÖ Fixed ${oms.restaurant_name}: ${actualCategories.join(', ')}`);
                                    fixedCount++;
                                }
                            } else {
                                // No valid categories found, set to empty array
                                const { error: updateError } = await supabase
                                    .from('oms_customizations')
                                    .update({ menu_categories: [] })
                                    .eq('id', oms.id);
                                
                                if (updateError) {
                                    log(`‚ùå Error updating ${oms.restaurant_name}: ${updateError.message}`);
                                    errorCount++;
                                } else {
                                    log(`‚úÖ Fixed ${oms.restaurant_name}: Set to empty categories`);
                                    fixedCount++;
                                }
                            }
                        }
                    } catch (error) {
                        log(`‚ùå Error processing ${oms.restaurant_name}: ${error.message}`);
                        errorCount++;
                    }
                }

                log(`\nüéâ Fix Complete!`);
                log(`   Records fixed: ${fixedCount}`);
                log(`   Errors: ${errorCount}`);

            } catch (error) {
                log(`‚ùå Exception: ${error.message}`);
            }
        }

        function displayScanResults(problematicRecords, fixedRecords) {
            const resultsDiv = document.getElementById('data-display');
            
            let html = `
                <h4>Scan Results</h4>
                <div class="before-after">
                    <div class="before">
                        <h5>‚ùå Problematic Records (${problematicRecords.length})</h5>
                        <p>These records have "Uncategorized" categories but have actual categories in their menu items.</p>
                        ${problematicRecords.length > 0 ? problematicRecords.map(record => `
                            <div class="data-display">
                                <strong>${record.restaurant_name}</strong>
                                <p>Current: ${record.currentCategories.map(c => c.name).join(', ')}</p>
                                <p>Should be: ${record.actualCategories.join(', ')}</p>
                            </div>
                        `).join('') : '<p>No problematic records found</p>'}
                    </div>
                    <div class="after">
                        <h5>‚úÖ Fixed Records (${fixedRecords.length})</h5>
                        <p>These records already have proper categories.</p>
                        ${fixedRecords.length > 0 ? fixedRecords.slice(0, 3).map(record => `
                            <div class="data-display">
                                <strong>${record.restaurant_name}</strong>
                                <p>Categories: ${(typeof record.menu_categories === 'string' ? JSON.parse(record.menu_categories) : record.menu_categories).map(c => c.name).join(', ')}</p>
                            </div>
                        `).join('') : '<p>No fixed records found</p>'}
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
        }

        // Auto-scan on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('üîß Fix Existing Categories Tool Loaded');
            log('Click "Scan Problematic Records" to see what needs fixing');
        });
    </script>
</body>
</html>
