import{supabase as p}from"./supabase.DeXTyW8I.js";import"./index.9NDAT-bh.js";import"./preload-helper.BlTxHScW.js";const _=document.getElementById("login-form"),y=document.getElementById("error-message"),c=document.getElementById("error-text"),f=document.getElementById("success-message"),w=document.getElementById("success-text"),R=document.getElementById("google-signin-btn");let I=!1;function d(a,s="info"){w&&(w.textContent=a),f?.classList.remove("hidden"),f?.classList.add(s),s==="success"&&setTimeout(()=>{f?.classList.add("hidden")},3e3)}async function C(){I=!0,sessionStorage.setItem("oauth-google","1");try{d("Connecting to Google...","loading");const{data:a,error:s}=await p.auth.signInWithOAuth({provider:"google",options:{redirectTo:`${window.location.origin}/auth/callback`,queryParams:{access_type:"offline",prompt:"consent"}}});if(s){console.error("Google auth error:",s);let i=s.message;s.message.includes("Provider not found")||s.message.includes("not configured")?i="Google provider not configured. Please contact administrator.":s.message.includes("redirect_uri_mismatch")||s.message.includes("mismatch")?(i=`Redirect URI mismatch. Please add this exact URI to Google Cloud Console: ${window.location.origin}/auth/callback`,console.error("URI Mismatch Details:",{currentOrigin:window.location.origin,expectedRedirect:`${window.location.origin}/auth/callback`,error:s.message,fixInstructions:"Add the exact URI above to Google Cloud Console â†’ APIs & Services â†’ Credentials â†’ OAuth 2.0 Client ID â†’ Authorized redirect URIs"})):s.message.includes("access_denied")&&(i="Access denied. Please try again."),d(`Authentication failed: ${i}`,"error");return}d("Redirecting to Google...","loading")}catch(a){console.error("Google auth error:",a),d(`Authentication failed: ${a.message}`,"error")}}async function D(a){try{const{data:s,error:i}=await p.rpc("sync_google_user",{p_google_id:a.user_metadata.provider_id,p_email:a.email,p_name:a.user_metadata.full_name,p_picture:a.user_metadata.avatar_url,p_provider_id:a.user_metadata.provider_id});if(i){console.error("Sync error:",i);return}return console.log("Google user synced:",s),s}catch(s){console.error("Sync error:",s)}}R?.addEventListener("click",C);p.auth.onAuthStateChange(async(a,s)=>{if(a==="SIGNED_IN"&&s?.user){const i=s.user;if(i.app_metadata.provider==="google"){if(!(I||sessionStorage.getItem("oauth-google")==="1"))return;sessionStorage.removeItem("oauth-google"),d("Syncing Google account...","loading"),await D(i),d("Successfully signed in with Google!","success"),setTimeout(()=>{window.location.href="/dashboard"},1500)}}});_?.addEventListener("submit",async a=>{a.preventDefault();const s=new FormData(_),i=s.get("email"),S=s.get("password");if(!i||!S){c&&(c.textContent="Please fill in all fields."),y?.classList.remove("hidden");return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i)){c&&(c.textContent="Please enter a valid email address."),y?.classList.remove("hidden");return}y?.classList.add("hidden"),f?.classList.remove("hidden");const u=_.querySelector('button[type="submit"]'),E=u.textContent;u.disabled=!0,u.innerHTML=`
      <svg class="animate-spin h-5 w-5 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    `;try{console.log("Attempting to sign in with Supabase:",i);const{data:n,error:l}=await p.auth.signInWithPassword({email:i,password:S});if(l)throw console.error("Supabase sign in error:",l),l;if(n.user){console.log("User signed in successfully:",n.user.email),sessionStorage.setItem("simple-auth-session",JSON.stringify({user:n.user,access_token:n.session?.access_token,timestamp:Date.now()})),window.dispatchEvent(new CustomEvent("user-logged-in",{detail:n.user})),w&&(w.textContent="Welcome back! Signing you in..."),f?.classList.remove("hidden");const t={id:n.user.id,email:n.user.email,full_name:n.user.email?.split("@")[0]||"User",phone:"Not set",company_name:"Not set",role:"customer"},b={user:t,access_token:n.session?.access_token||"simple-token-"+Date.now(),timestamp:Date.now()};sessionStorage.setItem("simple-auth-session",JSON.stringify(b)),localStorage.setItem("simple-auth-user",JSON.stringify(t)),localStorage.setItem("simple-auth-session",JSON.stringify(b)),console.log("âœ… Session stored in both sessionStorage and localStorage for deployment reliability"),window.dispatchEvent(new CustomEvent("user-logged-in",{detail:t})),console.log("âœ… User data sent to global auth manager:",t);let r=new URLSearchParams(window.location.search).get("redirect");r&&r.includes("/products/order-menu-system")&&(console.log("ğŸ”„ OMS product page redirect detected - changing to dashboard"),r="/dashboard");const g=r||"/dashboard";console.log("ğŸ” Redirect parameter found:",r),console.log("ğŸ” Default redirect URL:",g);const v=setTimeout(()=>{let e=g;e&&e.includes("/products/order-menu-system")&&(e="/dashboard"),console.log("âš ï¸ Fallback redirect triggered - going to:",e),window.location.href=e},3e3);try{const{data:e,error:h}=await p.from("profiles").select("role, status, full_name, phone, company_name").eq("id",n.user.id).single();let o=g;if(!h&&e){console.log("âœ… User profile found:",e),console.log("ğŸ” Role value from database:",JSON.stringify(e.role)),e.role==="admin"||e.role==="developer"||e.role==="support"?r&&r.includes("/products/order-menu-system")?(o="/dashboard",console.log(`ğŸ‰ ADMIN USER - OMS detected, redirecting to dashboard: ${o}`)):!r||r==="/dashboard"?(o="/admin",console.log(`ğŸ‰ ADMIN USER DETECTED: ${e.full_name} (${e.role})`),console.log(`ğŸš€ Redirecting to admin panel: ${o}`)):(o=r,console.log(`ğŸ‰ ADMIN USER - preserving redirect: ${o}`)):e.role&&e.role.toLowerCase().trim()==="menu_operator"?r&&r.includes("/products/order-menu-system")?(o="/dashboard",console.log(`ğŸ½ï¸ MENU OPERATOR - OMS detected, redirecting to dashboard: ${o}`)):!r||r==="/dashboard"?(o="/menu-operator",console.log(`ğŸ½ï¸ MENU OPERATOR DETECTED: ${e.full_name} (${e.role})`),console.log(`ğŸš€ Redirecting to menu operator dashboard: ${o}`)):(o=r,console.log(`ğŸ½ï¸ MENU OPERATOR - preserving redirect: ${o}`)):r&&r.includes("product=")&&!r.includes("order-menu-system")?(o=r,console.log(`âœ… Customer user - preserving product selection: ${o}`)):r&&r.includes("/products/order-menu-system")?(o="/dashboard",console.log(`âœ… Customer user - OMS detected, redirecting to dashboard: ${o}`)):e.status&&e.status==="pending_verification"?(o="/dashboard?message=Please check your email to verify your account.&type=warning",console.log(`âš ï¸ Customer user with pending verification: ${e.full_name}`)):e.status&&e.status==="suspended"?(o="/dashboard?message=Your account has been suspended. Please contact support.&type=error",console.log(`âŒ Customer user suspended: ${e.full_name}`)):(o=g,console.log(`âœ… Customer user: ${e.full_name} (${e.role})`)),console.log(`ğŸ¯ Final redirect URL: ${o}`),t.full_name=e.full_name||t.full_name,t.phone=e.phone||t.phone,t.company_name=e.company_name||t.company_name,t.role=e.role||t.role,console.log("ğŸ” Profile data from Supabase:",{role:e.role,full_name:e.full_name,status:e.status}),console.log("ğŸ” User data before update:",{role:t.role,email:t.email});const m={user:t,access_token:n.session?.access_token||"simple-token-"+Date.now(),timestamp:Date.now()};sessionStorage.setItem("simple-auth-session",JSON.stringify(m)),localStorage.setItem("simple-auth-user",JSON.stringify(t)),localStorage.setItem("simple-auth-session",JSON.stringify(m)),console.log("âœ… Updated session storage with role in both storages:",t.role),console.log("ğŸ” Full user data being stored:",JSON.stringify(t,null,2)),window.dispatchEvent(new CustomEvent("user-logged-in",{detail:t}))}if(clearTimeout(v),typeof sessionStorage<"u"){const m={user:t,access_token:n.session?.access_token||"simple-token-"+Date.now(),timestamp:Date.now()};sessionStorage.setItem("simple-auth-session",JSON.stringify(m)),localStorage.setItem("simple-auth-user",JSON.stringify(t)),localStorage.setItem("simple-auth-session",JSON.stringify(m))}sessionStorage.setItem("login-redirect-in-progress","true"),setTimeout(()=>{console.log("ğŸš€ Redirecting to:",o),window.location.href=o},1500)}catch(e){console.warn("Could not fetch user profile, using redirect parameter:",e);const h={user:t,access_token:n.session?.access_token||"simple-token-"+Date.now(),timestamp:Date.now()};sessionStorage.setItem("simple-auth-session",JSON.stringify(h)),localStorage.setItem("simple-auth-user",JSON.stringify(t)),localStorage.setItem("simple-auth-session",JSON.stringify(h));let o=g;o&&o.includes("/products/order-menu-system")&&(o="/dashboard"),clearTimeout(v),sessionStorage.setItem("login-redirect-in-progress","true"),setTimeout(()=>{console.log("ğŸš€ Redirecting to (fallback):",o),window.location.href=o},1500)}}else throw new Error("Sign in failed - no user data returned")}catch(n){console.error("Login error:",n);let l="An error occurred during sign in.";n.message&&(n.message.includes("Invalid login credentials")?l="Invalid email or password.":n.message.includes("Email not confirmed")?l="Please check your email and confirm your account before signing in.":n.message.includes("Too many requests")?l="Too many login attempts. Please try again later.":l=n.message),c&&(c.textContent=l),y?.classList.remove("hidden"),u.disabled=!1,u.textContent=E}});
