import{s as l}from"./supabase.ASU9rNY7.js";import"./Footer.astro_astro_type_script_index_0_lang.CYGdQqJr.js";import"https://unpkg.com/@supabase/supabase-js@2";import"./index.BFAZBQoJ.js";const y=document.getElementById("signup-form"),c=document.getElementById("error-message"),a=document.getElementById("error-text"),L=document.getElementById("google-signup-btn");function d(o,e="info"){a&&(a.textContent=o),c?.classList.remove("hidden"),c?.classList.add(e),e==="success"&&setTimeout(()=>{c?.classList.add("hidden")},3e3)}async function P(){try{d("Connecting to Google...","loading");const{data:o,error:e}=await l.auth.signInWithOAuth({provider:"google",options:{redirectTo:`${window.location.origin}/auth/callback`,queryParams:{access_type:"offline",prompt:"consent"}}});if(e){console.error("Google auth error:",e);let t=e.message;e.message.includes("Provider not found")||e.message.includes("not configured")?t="Google provider not configured. Please contact administrator.":e.message.includes("redirect_uri_mismatch")||e.message.includes("mismatch")?(t=`Redirect URI mismatch. Please add this exact URI to Google Cloud Console: ${window.location.origin}/auth/callback`,console.error("URI Mismatch Details:",{currentOrigin:window.location.origin,expectedRedirect:`${window.location.origin}/auth/callback`,error:e.message,fixInstructions:"Add the exact URI above to Google Cloud Console → APIs & Services → Credentials → OAuth 2.0 Client ID → Authorized redirect URIs"})):e.message.includes("access_denied")&&(t="Access denied. Please try again."),d(`Authentication failed: ${t}`,"error");return}d("Redirecting to Google...","loading")}catch(o){console.error("Google auth error:",o),d(`Authentication failed: ${o.message}`,"error")}}async function x(o){try{const{data:e,error:t}=await l.rpc("sync_google_user",{p_google_id:o.user_metadata.provider_id,p_email:o.email,p_name:o.user_metadata.full_name,p_picture:o.user_metadata.avatar_url,p_provider_id:o.user_metadata.provider_id});if(t){console.error("Sync error:",t);return}return console.log("Google user synced:",e),e}catch(e){console.error("Sync error:",e)}}L?.addEventListener("click",P);l.auth.onAuthStateChange(async(o,e)=>{if(o==="SIGNED_IN"&&e?.user){const t=e.user;t.app_metadata.provider==="google"&&(d("Syncing Google account...","loading"),await x(t),d("Successfully signed up with Google!","success"),setTimeout(()=>{window.location.href="/dashboard"},1500))}});document.addEventListener("DOMContentLoaded",function(){const o=document.getElementById("email"),e=document.getElementById("full_name"),t=document.getElementById("password"),i=document.getElementById("confirm_password"),g=document.getElementById("phone"),n=document.getElementById("company_name");o&&(o.value=""),e&&(e.value=""),t&&(t.value=""),i&&(i.value=""),g&&(g.value=""),n&&(n.value=""),o&&(o.setAttribute("autocomplete","off"),o.setAttribute("data-lpignore","true")),t&&t.setAttribute("autocomplete","new-password"),i&&i.setAttribute("autocomplete","new-password")});const C=new URLSearchParams(window.location.search),_=C.get("message"),S=C.get("type")||"success";_&&(S==="error"?(a&&(a.textContent=_),c?.classList.remove("hidden")):typeof window.showToast=="function"&&window.showToast(_,"success"),window.history.replaceState({},document.title,window.location.pathname));y?.addEventListener("submit",async o=>{o.preventDefault();const e=new FormData(y),t=e.get("email"),i=e.get("password"),g=e.get("confirm_password"),n=e.get("full_name"),p=e.get("phone"),f=e.get("company_name");if(c?.classList.add("hidden"),i!==g){a&&(a.textContent="Passwords do not match."),c?.classList.remove("hidden");return}if(i.length<6){a&&(a.textContent="Password must be at least 6 characters long."),c?.classList.remove("hidden");return}const u=y.querySelector('button[type="submit"]'),A=u.textContent;u.disabled=!0,u.innerHTML=`
      <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Creating account...
    `;try{console.log("Attempting to sign up with Supabase:",t);let s="customer";n.toLowerCase().includes("admin")||t.toLowerCase().includes("admin")?s="admin":n.toLowerCase().includes("developer")||t.toLowerCase().includes("developer")?s="developer":(n.toLowerCase().includes("support")||t.toLowerCase().includes("support"))&&(s="support");const{data:r,error:w}=await l.auth.signUp({email:t,password:i,options:{data:{full_name:n,phone:p,company_name:f,role:s,username:n.toLowerCase().replace(/\s+/g,"_")}}});if(w)throw console.error("Supabase signup error:",w),w;if(r.user){console.log("User created successfully in Auth:",r.user.email);const{error:v}=await l.from("profiles").insert({id:r.user.id,email:t,full_name:n,phone:p||null,company_name:f||null,role:s,status:"pending_verification",username:n.toLowerCase().replace(/\s+/g,"_"),created_at:new Date().toISOString(),updated_at:new Date().toISOString()});if(v){console.error("Error creating user profile:",v);try{await l.auth.admin.deleteUser(r.user.id)}catch(h){console.error("Error deleting auth user after profile creation failure:",h)}throw new Error("Failed to create user profile. Please try again.")}try{await l.from("user_activity_log").insert({user_id:r.user.id,action:"user_signup",details:{email:t,full_name:n,role:s,company_name:f,phone:p},ip_address:"127.0.0.1",user_agent:navigator.userAgent})}catch(h){console.warn("Could not log user activity:",h)}console.log("Complete user profile created successfully with role:",s),typeof window.showToast=="function"&&window.showToast(`Account created successfully! Welcome to DevExpress! Role: ${s}`,"success",3e3);let I="/login?message=Account created successfully! Please check your email to confirm your account before signing in.&type=success";s==="admin"&&(I="/login?message=Admin account created! Please check your email to confirm your account before signing in.&type=success"),setTimeout(()=>{window.location.href=I},2e3)}else throw new Error("Signup failed - no user data returned")}catch(s){console.error("Signup error:",s);let r="An error occurred during account creation.";s.message&&(s.message.includes("User already registered")?r="An account with this email already exists. Please try signing in instead.":s.message.includes("Password should be at least")?r="Password must be at least 6 characters long.":s.message.includes("Invalid email")?r="Please enter a valid email address.":s.message.includes("Failed to create user profile")?r="Account creation failed. Please try again or contact support.":r=s.message),a&&(a.textContent=r),c?.classList.remove("hidden"),u.disabled=!1,u.textContent=A}});const E=document.getElementById("password"),m=document.getElementById("confirm_password"),b=()=>{m.value&&E.value!==m.value?m.setCustomValidity("Passwords do not match"):m.setCustomValidity("")};E?.addEventListener("input",b);m?.addEventListener("input",b);
