import{supabase as d}from"./supabase.C3b_eKiV.js";import"./Toast.astro_astro_type_script_index_0_lang.D91WvFkz.js";import"https://unpkg.com/@supabase/supabase-js@2";import"./index.BymsOcZI.js";import"./preload-helper.CLcXU_4U.js";const p=document.getElementById("reset-password-form"),a=document.getElementById("reset-password-btn");document.addEventListener("DOMContentLoaded",async()=>{try{const e=new URLSearchParams(window.location.hash.substring(1)),s=e.get("access_token"),t=e.get("refresh_token"),r=e.get("type"),u=new URLSearchParams(window.location.search),k=u.get("access_token"),m=u.get("refresh_token"),o=u.get("type"),g=s||k,w=t||m,R=r||o;if(console.log("Reset page loaded. Checking for tokens..."),console.log("Hash params:",{accessToken:s,refreshToken:t,type:r}),console.log("Search params:",{searchAccessToken:k,searchRefreshToken:m,searchType:o}),console.log("Current URL:",window.location.href),g&&w&&R==="recovery"){console.log("Setting session with tokens from URL"),i("Setting up session...");const{data:l,error:c}=await d.auth.setSession({access_token:g,refresh_token:w});if(c){console.error("Error setting session:",c),n("Invalid or expired reset link. Please enter your email to request a new reset link."),i("Request New Reset Link"),y();return}console.log("Session set successfully:",l),l.user?(L(l.user.email),i("Update Password"),h(`Ready to reset password for ${l.user.email}`)):i("Update Password"),E()}else{const{data:{session:l}}=await d.auth.getSession();l&&l.user?(console.log("User already has a valid session"),L(l.user.email),i("Update Password"),h(`Ready to reset password for ${l.user.email}`),E()):(console.log("No session found, checking for auth state change..."),i("Waiting for session..."),d.auth.onAuthStateChange((c,f)=>{console.log("Auth state changed:",c,f?.user?.email),c==="SIGNED_IN"&&f&&f.user?(console.log("User signed in via auth state change"),L(f.user.email),i("Update Password"),h(`Ready to reset password for ${f.user.email}`),E()):c==="SIGNED_OUT"&&(n("Session expired. Please enter your email to request a new reset link."),i("Request New Reset Link"),y())}),setTimeout(async()=>{const{data:{session:c}}=await d.auth.getSession();c||(n("No valid session found. Please enter your email to request a new reset link."),i("Request New Reset Link"),y())},5e3))}}catch(e){console.error("Error in session setup:",e),n("Error setting up password reset session. Please enter your email to request a new reset link."),i("Request New Reset Link"),y()}});p?.addEventListener("submit",async e=>{e.preventDefault();const s=new FormData(p),t=s.get("email"),r=s.get("password"),u=s.get("confirmPassword");if(a.textContent?.includes("Request New Reset Link")){if(!t){n("Please enter your email address");return}const m=a.innerHTML;a.disabled=!0,a.innerHTML=`
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Sending Reset Link...
      `;try{const{error:o}=await d.auth.resetPasswordForEmail(t,{redirectTo:`${window.location.origin}/reset-password`});if(o){console.error("Reset link error:",o),n(o.message||"Failed to send reset link");return}h("Password reset link has been sent to your email address! Please check your inbox and click the reset link."),p.reset()}catch(o){console.error("Reset link error:",o),n(o.message||"Failed to send reset link")}finally{a.disabled=!1,a.innerHTML=m}}else{if(!r||!u){n("Please fill in all fields");return}if(r.length<6){n("Password must be at least 6 characters long");return}if(r!==u){n("Passwords do not match");return}const m=a.innerHTML;a.disabled=!0,a.innerHTML=`
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Updating Password...
      `;try{const{data:{session:o},error:g}=await d.auth.getSession();if(g||!o){console.error("No valid session:",g),n("No valid session found. Please request a new password reset.");return}const{error:w}=await d.auth.updateUser({password:r});if(w){console.error("Password update error:",w),n(w.message||"Failed to update password");return}h("Password updated successfully! You can now log in with your new password."),p.reset(),setTimeout(()=>{window.location.href="/login"},3e3)}catch(o){console.error("Password update error:",o),n(o.message||"Failed to update password")}finally{a.disabled=!1,a.innerHTML=m}}});function h(e){const s=document.getElementById("success-message"),t=document.getElementById("success-text"),r=document.getElementById("error-message");s&&t&&(t.textContent=e,s.classList.remove("hidden"),r&&r.classList.add("hidden"))}function n(e){const s=document.getElementById("error-message"),t=document.getElementById("error-text"),r=document.getElementById("success-message");s&&t&&(t.textContent=e,s.classList.remove("hidden"),r&&r.classList.add("hidden"))}function E(){const e=document.getElementById("reset-password-btn");e&&(e.disabled=!1)}function P(){const e=document.getElementById("reset-password-btn");e&&(e.disabled=!0)}function i(e){const s=document.getElementById("reset-password-btn");s&&(s.textContent=e)}function y(){const e=document.getElementById("email-field");e&&e.classList.remove("hidden")}function L(e){const s=document.getElementById("email-display"),t=document.getElementById("user-email");s&&t&&(t.textContent=e,s.classList.remove("hidden"))}P();i("Setting up session...");
