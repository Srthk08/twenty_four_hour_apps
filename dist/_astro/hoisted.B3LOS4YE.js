import{s as F}from"./shared-data-store.BLbwHvcf.js";import{s as N}from"./supabase.ASU9rNY7.js";import"./Footer.astro_astro_type_script_index_0_lang.Z9Ovqgr-.js";import"https://unpkg.com/@supabase/supabase-js@2";import"./index.BFAZBQoJ.js";console.log("üöÄ Cart page script loaded");document.addEventListener("DOMContentLoaded",()=>{console.log("üöÄ DOM Content Loaded - Cart page initialization starting..."),["empty-cart","cart-items","cart-actions","project-requirements","cart-content"].forEach(e=>{const o=document.getElementById(e);console.log(`üîç Element ${e}:`,!!o)});try{console.log("üîç Creating Cart instance...");const e=window.globalAuthManager||window.simpleAuthManager;if(console.log("üîç Auth manager available:",!!e),e){const a=e.getCurrentUser();console.log("üîç Current user:",a?`${a.email} (${a.full_name||"No name"})`:"Not logged in")}const o=new U;console.log("‚úÖ Cart created, items count:",o.items.length),console.log("‚úÖ Cart initialized with",o.items.length,"items");const t=document.getElementById("cart-content");t&&(t.style.display="block",t.style.visibility="visible",console.log("‚úÖ Forced cart content to be visible")),document.getElementById("submit-requirements")?.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),o.submitRequirements()}),document.getElementById("requirements-form")?.addEventListener("submit",a=>(a.preventDefault(),a.stopPropagation(),!1))}catch(e){console.error("‚ùå Error initializing cart:",e),alert("Error initializing cart: "+e.message)}});class U{constructor(){this.items=[],this.requirements={},this.currentSharedOrderId=null,this.isSubmitting=!1,this.debouncedSaveToSupabase=this.debounce(this.saveCartToSupabase.bind(this),1e3),this.init().catch(e=>{console.error("‚ùå Error initializing cart:",e)})}async init(){console.log("üöÄ Cart initialization started"),this.items=[],this.requirements={};const o=(window.globalAuthManager||window.simpleAuthManager)?.getCurrentUser();o?console.log("üë§ User authenticated:",o.email,"- loading user cart"):(console.log("üë§ No authenticated user - checking localStorage"),this.checkAndClearNewUserCart()),await this.loadCart(),console.log("üì¶ Cart loaded, items count:",this.items.length),this.items.length>0&&o&&(window.validateCartOwnership()||(console.log("üîÑ Cart ownership validation failed, clearing cart..."),this.items=[],this.requirements={},localStorage.removeItem("cart-items"),localStorage.removeItem("cart-requirements"),localStorage.removeItem("user-cart-data"),console.log("üì¶ Cart cleared after validation, items count:",this.items.length))),this.checkUrlParams(),this.populateFormFields(),console.log("üìù Form fields populated"),this.renderCart(),console.log("üé® Cart rendered"),this.bindEvents(),console.log("üîó Events bound, initialization complete")}checkAndClearNewUserCart(){if(console.log("üîç Checking if this is a new user session..."),sessionStorage.getItem("has-visited-cart"))console.log("üë§ Returning user session - keeping existing cart data");else{console.log("üÜï New user session detected - checking if cart should be cleared");const o=localStorage.getItem("cart-items");if(o)try{const t=JSON.parse(o);if(Array.isArray(t)&&t.length>0){console.log("üë§ Returning user with existing cart data - keeping cart"),sessionStorage.setItem("has-visited-cart","true");return}}catch{console.log("üîÑ Invalid cart data found - clearing it")}console.log("üÜï Truly new user - clearing any existing cart data"),localStorage.removeItem("cart-items"),localStorage.removeItem("cart-requirements"),localStorage.removeItem("user-cart-data"),localStorage.removeItem("cart-customizations"),sessionStorage.setItem("has-visited-cart","true"),console.log("‚úÖ Cart cleared for new user session")}}checkUrlParams(){console.log("üîç Checking URL parameters...");const e=new URLSearchParams(window.location.search),o=e.get("product"),t=e.get("price");console.log("üì¶ URL parameters found:",{product:o,price:t}),o&&t?(console.log("‚úÖ Product and price found, adding to cart..."),this.addProductFromUrl(o,parseInt(t)),window.history.replaceState({},document.title,window.location.pathname),console.log("‚úÖ URL parameters cleared")):console.log("‚ùå No product or price found in URL parameters")}addProductFromUrl(e,o){console.log("üõí Adding product from URL:",{productId:e,price:o}),this.items=[];const t={1:"Restaurant Menu System",2:"Android TV App",3:"Streaming Mobile App",4:"Restaurant Website","restaurant-menu":"Restaurant Menu System","android-tv":"Android TV App","mobile-streaming":"Mobile Streaming App","restaurant-menu-system":"Restaurant Menu System","android-tv-app":"Android TV App","streaming-mobile-app":"Streaming Mobile App","restaurant-website":"Restaurant Website"},r={1:"Digital menu system with QR code ordering, real-time updates, and analytics dashboard.",2:"Custom Android TV application with streaming capabilities and smart remote support.",3:"Cross-platform mobile app for video streaming with offline download support.",4:"Professional restaurant website with online ordering and reservation system.","restaurant-menu":"Digital menu system with QR code ordering, real-time updates, and analytics dashboard.","android-tv":"Custom Android TV application with streaming capabilities and smart remote support.","mobile-streaming":"Cross-platform mobile app for video streaming with offline download support.","restaurant-menu-system":"Digital menu system with QR code ordering, real-time updates, and analytics dashboard.","android-tv-app":"Custom Android TV application with streaming capabilities and smart remote support.","streaming-mobile-app":"Cross-platform mobile app for video streaming with offline download support.","restaurant-website":"Professional restaurant website with online ordering and reservation system."},n={id:e,name:t[e]||"Custom Product",description:r[e]||"Professional digital solution",price:o,quantity:1,customName:"",logo:null,color:"#3B82F6",features:[]};console.log("üì¶ Created cart item:",n),this.items.push(n),this.saveCart(),console.log("‚úÖ Product added to cart, items count:",this.items.length)}async loadCart(){this.items=[],this.requirements={};const o=(window.globalAuthManager||window.simpleAuthManager)?.getCurrentUser();if(console.log("üë§ Loading cart for user:",o?o.email:"anonymous"),o&&N)try{console.log("üîÑ Loading cart from Supabase for user:",o.email);const{data:r,error:n}=await N.from("cart_customizations").select("*").eq("user_email",o.email).eq("cart_status","active").order("created_at",{ascending:!1});if(n){console.error("‚ùå Error loading cart from Supabase:",n),this.items=[],this.clearUserCartFromLocalStorage(o.email);return}else if(r&&r.length>0){if(console.log("‚úÖ Loaded cart from Supabase:",r),console.log("üìä Cart data details:",{count:r.length,firstItem:r[0],basePrice:r[0]?.base_price,productName:r[0]?.product_name}),this.items=r.map(a=>({id:a.product_id,name:a.product_name,description:a.product_description,price:a.base_price,quantity:1,customName:a.custom_name||"",restaurantName:a.restaurant_name_customization||"",color:a.selected_color||"#3B82F6",features:a.selected_features||[],projectName:a.project_name||"",contactPerson:a.contact_person||"",cuisineType:a.cuisine_type||"",appName:a.app_name||"",productDescription:a.product_description_custom||"",email:a.contact_email||o.email,phone:a.contact_phone||"",primaryColor:a.primary_color||"#3B82F6",secondaryColor:a.secondary_color||"#A5CF6",accentColor:a.accent_color||"#F59E0B",textColor:a.text_color||"#1F2937",additionalRequirements:a.additional_requirements||""})),console.log("üîÑ Mapped cart items:",this.items),console.log("üí∞ First item price:",this.items[0]?.price),this.items.length>0){const a=this.items[0];this.requirements={projectName:a.projectName,contactPerson:a.contactPerson,restaurantName:a.restaurantName,cuisineType:a.cuisineType,appName:a.appName,productDescription:a.productDescription,email:a.email,phone:a.phone,primaryColor:a.primaryColor,secondaryColor:a.secondaryColor,accentColor:a.accentColor,textColor:a.textColor,additionalRequirements:a.additionalRequirements}}console.log("‚úÖ Cart loaded from Supabase with",this.items.length,"items");return}else{console.log("üîÑ No cart data found in Supabase for user:",o.email,"- starting with empty cart"),this.items=[],this.clearUserCartFromLocalStorage(o.email);return}}catch(r){console.error("‚ùå Error loading cart from Supabase:",r),this.items=[],this.clearUserCartFromLocalStorage(o.email);return}console.log("üîÑ Loading cart from localStorage for anonymous user");const t=localStorage.getItem("cart-items");if(t)try{const r=JSON.parse(t);Array.isArray(r)&&r.length>0?(this.items=r,console.log("‚úÖ Cart loaded from localStorage with",this.items.length,"items")):(this.items=[],console.log("üîÑ Invalid cart data in localStorage, starting with empty cart"))}catch(r){console.error("‚ùå Error parsing localStorage cart data:",r),this.items=[],localStorage.removeItem("cart-items")}else this.items=[],console.log("üîÑ No cart data in localStorage, starting with empty cart")}saveCart(){localStorage.setItem("cart-items",JSON.stringify(this.items)),console.log("üíæ Cart saved to localStorage, items count:",this.items.length),(window.globalAuthManager||window.simpleAuthManager)?.getCurrentUser()&&(console.log("üíæ Cart data will also be saved to Supabase for authenticated user"),this.debouncedSaveToSupabase())}clearUserCartFromLocalStorage(e){console.log("üßπ Clearing localStorage cart data for user:",e);const o=localStorage.getItem("cart-items");if(o)try{const t=JSON.parse(o);if(e){console.log("üßπ Clearing localStorage cart data for authenticated user"),localStorage.removeItem("cart-items"),this.items=[];return}t.length>0&&t[0].email&&t[0].email!==e&&(console.log("üßπ Clearing localStorage cart data from different user"),localStorage.removeItem("cart-items"),this.items=[])}catch(t){console.error("‚ùå Error checking localStorage cart data:",t),localStorage.removeItem("cart-items"),this.items=[]}localStorage.removeItem("cart-requirements"),localStorage.removeItem("user-cart-data"),this.items=[],this.requirements={}}populateFormFields(){if(this.items.length===0)return;const e=this.items[0];console.log("üîÑ Populating form fields with loaded data:",e);const o=document.getElementById("projectName");o&&e.projectName&&(o.value=e.projectName);const t=document.getElementById("contactPerson");t&&e.contactPerson&&(t.value=e.contactPerson);const r=document.getElementById("restaurantName");r&&e.restaurantName&&(r.value=e.restaurantName);const n=document.getElementById("cuisineType");n&&e.cuisineType&&(n.value=e.cuisineType);const a=document.getElementById("appName");a&&e.appName&&(a.value=e.appName);const l=document.getElementById("productDescription");l&&e.productDescription&&(l.value=e.productDescription);const i=document.getElementById("email");i&&e.email&&(i.value=e.email);const s=document.getElementById("phone");s&&e.phone&&(s.value=e.phone);const d=document.querySelector('input[name="primaryColor"]');d&&e.primaryColor&&(d.value=e.primaryColor);const c=document.querySelector('input[name="secondaryColor"]');c&&e.secondaryColor&&(c.value=e.secondaryColor);const u=document.querySelector('input[name="accentColor"]');u&&e.accentColor&&(u.value=e.accentColor);const m=document.querySelector('input[name="textColor"]');m&&e.textColor&&(m.value=e.textColor);const g=document.getElementById("additionalRequirements");g&&e.additionalRequirements&&(g.value=e.additionalRequirements),e.features&&Array.isArray(e.features)&&e.features.forEach(h=>{const p=document.querySelector(`input[data-feature="${h}"]`);p&&(p.checked=!0)}),this.requirements={projectName:e.projectName||"",contactPerson:e.contactPerson||"",restaurantName:e.restaurantName||"",cuisineType:e.cuisineType||"",appName:e.appName||"",productDescription:e.productDescription||"",email:e.email||"",phone:e.phone||"",primaryColor:e.primaryColor||"#3B82F6",secondaryColor:e.secondaryColor||"#A5CF6",accentColor:e.accentColor||"#F59E0B",textColor:e.textColor||"#1F2937",additionalRequirements:e.additionalRequirements||""},console.log("‚úÖ Form fields populated successfully")}addItem(e){this.items.length>0&&(this.items=[]),this.items.push({...e,quantity:1,customName:"",logo:null,color:"#3B82F6",features:[]}),this.saveCart(),this.renderCart()}removeItem(e){this.items=this.items.filter(o=>o.id!==e),this.saveCart(),this.renderCart()}updateItem(e,o){const t=this.items.find(r=>r.id===e);t&&(Object.assign(t,o),this.saveCart(),this.renderCart())}renderCart(){console.log("üé® renderCart called with items:",this.items.length);const e=document.getElementById("empty-cart"),o=document.getElementById("cart-items"),t=document.getElementById("cart-actions"),r=document.getElementById("project-requirements"),n=document.getElementById("cart-content");console.log("üîç DOM elements found:",{emptyCart:!!e,cartItems:!!o,cartActions:!!t,projectRequirements:!!r,cartContent:!!n}),this.items.length===0?(console.log("üì≠ Showing empty cart"),e?.classList.remove("hidden"),o?.classList.add("hidden"),t?.classList.add("hidden"),r?.classList.add("hidden")):(console.log("üì¶ Showing cart with items"),e?.classList.add("hidden"),o?.classList.remove("hidden"),t?.classList.remove("hidden"),r?.classList.add("hidden")),this.renderCartItems(),this.updateSummary()}renderCartItems(){const e=document.getElementById("cart-items");e&&(e.innerHTML="",this.items.forEach(o=>{const t=this.createCartItemElement(o);e.appendChild(t)}))}createCartItemElement(e){const o=document.getElementById("cart-item-template");if(!o)return document.createElement("div");const t=o.cloneNode(!0);t.classList.remove("hidden"),t.id=`cart-item-${e.id}`,t.querySelector(".product-name").textContent=e.name,t.querySelector(".product-description").textContent=e.description,t.querySelector(".product-price").textContent=`‚Çπ${e.price}`;const r=t.querySelector(".product-type-text"),n=t.querySelector(".product-type-badge");e.id==="restaurant-menu"||e.id==="restaurant-menu-system"||e.id==="restaurant-website"||e.id==="1"||e.id==="4"?(r.textContent="Restaurant Solution",n.className="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium product-type-badge bg-green-100 text-green-800"):e.id==="order-menu-system"||e.id==="5"?(r.textContent="Order Menu System",n.className="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium product-type-badge bg-blue-100 text-blue-800"):e.id==="android-tv"||e.id==="android-tv-app"||e.id==="2"?(r.textContent="Android TV App",n.className="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium product-type-badge bg-purple-100 text-purple-800"):e.id==="mobile-streaming"||e.id==="streaming-mobile-app"||e.id==="3"?(r.textContent="Mobile Streaming App",n.className="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium product-type-badge bg-orange-100 text-orange-800"):(r.textContent="Custom Product",n.className="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium product-type-badge bg-gray-100 text-gray-800");const a=t.querySelector("#restaurant-name-customization");e.id==="restaurant-menu"||e.id==="restaurant-menu-system"||e.id==="restaurant-website"||e.id==="1"||e.id==="4"?a?.classList.remove("hidden"):a?.classList.add("hidden");const l=t.querySelector(".product-name-input");l&&e.customName&&(l.value=e.customName);const i=t.querySelector(".restaurant-name-input");return i&&e.restaurantName&&(i.value=e.restaurantName),t.querySelectorAll(".color-option").forEach(c=>{c.dataset.color===e.color&&c.classList.add("border-2","border-gray-900")}),t.querySelectorAll(".feature-checkbox").forEach(c=>{e.features.includes(c.dataset.feature)&&(c.checked=!0)}),this.bindItemEvents(t,e),t}bindItemEvents(e,o){e.querySelector(".product-name-input")?.addEventListener("input",d=>{this.updateItem(o.id,{customName:d.target.value})}),e.querySelector(".restaurant-name-input")?.addEventListener("input",d=>{this.updateItem(o.id,{restaurantName:d.target.value})});const n=e.querySelector(".logo-upload"),a=e.querySelector(".logo-upload-btn"),l=e.querySelector(".logo-preview");a.addEventListener("click",()=>n.click()),n.addEventListener("change",d=>{const c=d.target.files[0];if(c){const u=new FileReader;u.onload=m=>{l.innerHTML=`<img src="${m.target.result}" class="w-full h-full object-cover rounded-lg">`,this.updateItem(o.id,{logo:m.target.result})},u.readAsDataURL(c)}});const i=e.querySelectorAll(".color-option");i.forEach(d=>{d.addEventListener("click",()=>{i.forEach(c=>c.classList.remove("border-2","border-gray-900")),d.classList.add("border-2","border-gray-900"),this.updateItem(o.id,{color:d.dataset.color})})});const s=e.querySelectorAll(".feature-checkbox");s.forEach(d=>{d.addEventListener("change",()=>{const c=Array.from(s).filter(u=>u.checked).map(u=>u.dataset.feature);this.updateItem(o.id,{features:c})})})}updateSummary(){console.log("üí∞ updateSummary called with items:",this.items);const e=this.items.reduce((d,c)=>d+c.price*c.quantity,0),o=this.items.reduce((d,c)=>d+c.features.length*500,0),t=Math.round((e+o)*.18),r=e+o+t;console.log("üí∞ Amount calculation:",{subtotal:e,featuresTotal:o,tax:t,total:r,itemsCount:this.items.length});const n=document.getElementById("subtotal"),a=document.getElementById("features-total"),l=document.getElementById("tax"),i=document.getElementById("total"),s=document.getElementById("final-amount");console.log("üí∞ Summary elements found:",{subtotalElement:!!n,featuresTotalElement:!!a,taxElement:!!l,totalElement:!!i,finalAmountElement:!!s}),n&&(n.textContent=`‚Çπ${e.toLocaleString()}`,console.log("‚úÖ Updated subtotal:",n.textContent)),a&&(a.textContent=`‚Çπ${o.toLocaleString()}`,console.log("‚úÖ Updated features total:",a.textContent)),l&&(l.textContent=`‚Çπ${t.toLocaleString()}`,console.log("‚úÖ Updated tax:",l.textContent)),i&&(i.textContent=`‚Çπ${r.toLocaleString()}`,console.log("‚úÖ Updated total:",i.textContent)),s&&(s.textContent=r.toLocaleString(),console.log("‚úÖ Updated final amount:",s.textContent))}bindEvents(){document.getElementById("delete-selected")?.addEventListener("click",()=>{this.deleteSelectedProject()}),document.getElementById("proceed-to-requirements")?.addEventListener("click",()=>{this.showProjectRequirements()}),document.getElementById("back-to-cart")?.addEventListener("click",()=>{this.backToCart()}),document.getElementById("back-to-requirements")?.addEventListener("click",()=>{this.backToRequirements()}),document.getElementById("final-payment")?.addEventListener("click",()=>{this.processFinalPayment()}),document.querySelectorAll('input[name="paymentMethod"]').forEach(e=>{e.addEventListener("change",o=>{this.switchPaymentMethod(o.target.value)})})}continueShopping(){this.items=[],this.saveCart(),window.location.href="/products"}deleteSelectedProject(){confirm("Are you sure you want to delete this project? You will be redirected to products page.")&&(this.items=[],this.saveCart(),window.location.href="/products")}async showProjectRequirements(){const e=document.getElementById("cart-actions"),o=document.getElementById("project-requirements");e&&e.classList.add("hidden"),o&&o.classList.remove("hidden"),this.prefillRequirementsForm(),this.showProjectTypeFields(),o?.scrollIntoView({behavior:"smooth"})}async submitRequirements(){console.log("üöÄ submitRequirements function called!");const e=document.getElementById("submit-requirements"),o=e.innerHTML;if(this.isSubmitting||e.disabled){console.log("‚ùå Form already being submitted, ignoring duplicate call");return}this.isSubmitting=!0;try{console.log("üöÄ Starting submitRequirements...");const t=document.getElementById("requirements-form"),r=this.items[0]&&(this.items[0].id==="order-menu-system"||this.items[0].id==="5");if(r){const s=["projectName","contactPerson","orderMenuRestaurantName","orderMenuOwnerName","orderMenuAddress","email","phone"];let d=!0;for(const c of s){const u=t.querySelector(`[name="${c}"]`);if(u&&!u.value.trim()){u.focus(),u.reportValidity(),d=!1;break}}if(!d){console.log("‚ùå Order Menu System form validation failed");return}}else{const s=t.querySelectorAll("#order-menu-fields [required], #restaurant-fields [required], #restaurant-cuisine-fields [required]"),d=[];if(s.forEach((c,u)=>{d[u]=c.required,c.required=!1}),!t.checkValidity()){console.log("‚ùå Form validation failed"),t.reportValidity(),s.forEach((c,u)=>{c.required=d[u]});return}s.forEach((c,u)=>{c.required=d[u]})}console.log("‚úÖ Form validation passed"),e.innerHTML=`
          <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Saving & Processing...
        `,e.disabled=!0;const n=this.items[0];if(r){const s=this.collectMenuItems();console.log("üçΩÔ∏è Collected menu items for Order Menu System:",s),this.requirements={restaurantName:t.querySelector('[name="orderMenuRestaurantName"]')?.value||"",ownerName:t.querySelector('[name="orderMenuOwnerName"]')?.value||"",restaurantAddress:t.querySelector('[name="orderMenuAddress"]')?.value||"",email:t.querySelector('[name="email"]')?.value||"",phone:t.querySelector('[name="phone"]')?.value||"",additionalRequirements:t.querySelector('[name="additionalRequirements"]')?.value||"",menuItems:s,primaryColor:t.querySelector('[name="primaryColor"]')?.value||"#3B82F6",secondaryColor:t.querySelector('[name="secondaryColor"]')?.value||"#000000",accentColor:t.querySelector('[name="accentColor"]')?.value||"#F59E0B",textColor:t.querySelector('[name="textColor"]')?.value||"#1F2937",restaurantLogo:this.orderMenuLogoFile||null}}else this.requirements={projectName:t.querySelector('[name="projectName"]')?.value||"",contactPerson:t.querySelector('[name="contactPerson"]')?.value||"",restaurantName:t.querySelector('[name="restaurantName"]')?.value||"",cuisineType:t.querySelector('[name="cuisineType"]')?.value||"",appName:t.querySelector('[name="appName"]')?.value||"",productDescription:t.querySelector('[name="productDescription"]')?.value||"",email:t.querySelector('[name="email"]')?.value||"",phone:t.querySelector('[name="phone"]')?.value||"",additionalRequirements:t.querySelector('[name="additionalRequirements"]')?.value||""};console.log("üìù Collected form data:",this.requirements);let a=null;try{console.log("üîç Attempting to save to Supabase..."),a=await Promise.race([this.saveCartToSupabase(),new Promise((s,d)=>setTimeout(()=>d(new Error("Database timeout")),1e4))])}catch(s){console.warn("‚ö†Ô∏è Database save failed, but continuing:",s)}a?(console.log("‚úÖ Cart data saved successfully:",a),this.items.length>0&&(this.items[0].savedData=a,this.saveCart())):console.log("‚ö†Ô∏è No database save, but continuing with local data"),e.innerHTML=`
          <svg class="w-4 h-4 text-white inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Success! Redirecting...
        `,this.updateOrderReview();const l=document.getElementById("project-requirements"),i=document.getElementById("payment-section");if(console.log("üîÑ Showing payment page directly..."),console.log("üîç Project requirements element:",!!l),console.log("üîç Payment section element:",!!i),i&&(console.log("üîç Payment section parent:",i.parentElement),console.log("üîç Payment section offsetHeight:",i.offsetHeight),console.log("üîç Payment section offsetWidth:",i.offsetWidth),console.log("üîç Payment section computed style display:",window.getComputedStyle(i).display)),l&&(l.classList.add("hidden"),l.style.display="none",console.log("‚úÖ Hidden project requirements")),i){i.classList.remove("hidden"),i.style.setProperty("display","block","important"),i.style.setProperty("visibility","visible","important"),i.style.setProperty("opacity","1","important"),i.style.setProperty("position","relative","important"),i.style.setProperty("z-index","999","important"),i.style.setProperty("height","auto","important"),i.style.setProperty("width","100%","important"),i.style.setProperty("background-color","#ffffff","important"),console.log("‚úÖ Showed payment section with forced visibility");const s=document.getElementById("payment-loading"),d=document.getElementById("payment-content");s&&(s.classList.remove("hidden"),s.style.display="block"),d&&(d.style.display="none"),this.updatePaymentSummary(),setTimeout(()=>{s&&(s.classList.add("hidden"),s.style.display="none"),d&&(d.style.display="block"),i.scrollIntoView({behavior:"smooth"}),console.log("‚úÖ Scrolled to payment page")},500)}else console.error("‚ùå Payment section element not found!"),alert("Error: Payment page not found. Please refresh the page and try again.");setTimeout(()=>{e.innerHTML=o,e.disabled=!1,this.isSubmitting=!1},2e3)}catch(t){console.error("‚ùå Error in submitRequirements:",t),e.innerHTML=`
          <svg class="w-4 h-4 text-white inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          Error
        `,alert("Warning: Could not save to database, but you can still proceed with your order. Please contact support if this persists."),this.updateOrderReview();const r=document.getElementById("project-requirements"),n=document.getElementById("payment-section");if(r&&(r.classList.add("hidden"),r.style.display="none"),n){n.classList.remove("hidden"),n.style.setProperty("display","block","important"),n.style.setProperty("visibility","visible","important"),n.style.setProperty("opacity","1","important"),n.style.setProperty("position","relative","important"),n.style.setProperty("z-index","999","important"),n.style.setProperty("height","auto","important"),n.style.setProperty("width","100%","important"),n.style.setProperty("background-color","#ffffff","important");const a=document.getElementById("payment-loading"),l=document.getElementById("payment-content");a&&(a.classList.remove("hidden"),a.style.display="block"),l&&(l.style.display="none"),this.updatePaymentSummary(),setTimeout(()=>{a&&(a.classList.add("hidden"),a.style.display="none"),l&&(l.style.display="block"),n.scrollIntoView({behavior:"smooth"})},500)}setTimeout(()=>{e.innerHTML=o,e.disabled=!1,this.isSubmitting=!1},3e3)}}showProjectTypeFields(){if(this.items.length===0)return;const e=this.items[0];console.log("üîç Debug - Product ID:",e.id);const o=document.getElementById("app-name-fields"),t=document.getElementById("product-description-fields"),r=document.getElementById("restaurant-fields"),n=document.getElementById("restaurant-cuisine-fields");console.log("üîç Debug - Field elements found:",{appNameFields:!!o,productDescriptionFields:!!t,restaurantFields:!!r,restaurantCuisineFields:!!n});const a=document.getElementById("upload-label"),l=document.getElementById("upload-text"),i=document.getElementById("photos-label"),s=document.getElementById("photos-text");if(o?.classList.add("hidden"),t?.classList.add("hidden"),r?.classList.add("hidden"),n?.classList.add("hidden"),e.id==="restaurant-menu"||e.id==="restaurant-menu-system"||e.id==="restaurant-website"||e.id==="1"||e.id==="4"){console.log("üçï Showing restaurant fields for restaurant product:",e.id),r&&(r.classList.remove("hidden"),r.style.display="block"),n&&(n.classList.remove("hidden"),n.style.display="block"),console.log("üîç Debug - Restaurant fields visibility:",{restaurantFieldsHidden:r?.classList.contains("hidden"),restaurantCuisineFieldsHidden:n?.classList.contains("hidden"),restaurantFieldsDisplay:r?.style.display,restaurantCuisineFieldsDisplay:n?.style.display});const c=document.querySelector('input[name="restaurantName"]'),u=document.querySelector('select[name="cuisineType"]');c&&(c.required=!0),u&&(u.required=!0);const m=document.getElementById("logo-upload-section"),g=document.getElementById("photos-upload-section");m&&(m.classList.remove("hidden"),m.style.display="block"),g&&(g.classList.remove("hidden"),g.style.display="block");const h=document.querySelector('input[name="projectName"]'),p=document.querySelector('input[name="contactPerson"]'),v=document.querySelector('input[name="appName"]'),y=document.querySelector('textarea[name="productDescription"]');h&&(h.closest("div").classList.remove("hidden"),h.required=!0),p&&(p.closest("div").classList.remove("hidden"),p.required=!0),v&&(v.closest("div").classList.remove("hidden"),v.required=!0),y&&(y.closest("div").classList.remove("hidden"),y.required=!0),a&&(a.textContent="Restaurant Logo"),l&&(l.textContent="Upload logo or drag and drop"),i&&(i.textContent="Menu Photos (Optional)"),s&&(s.textContent="Upload menu photos or drag and drop")}else if(e.id==="order-menu-system"||e.id==="5"){console.log("üçΩÔ∏è Showing Order Menu System fields for product:",e.id);const c=document.getElementById("order-menu-fields");c&&(c.classList.remove("hidden"),c.style.display="block"),f&&(f.classList.add("hidden"),f.style.display="none"),C&&(C.classList.add("hidden"),C.style.display="none");const u=document.querySelector('input[name="orderMenuRestaurantName"]'),m=document.querySelector('input[name="orderMenuOwnerName"]'),g=document.querySelector('textarea[name="orderMenuAddress"]');u&&(u.required=!0),m&&(m.required=!0),g&&(g.required=!0);const h=document.querySelector('input[name="projectName"]'),p=document.querySelector('input[name="contactPerson"]'),v=document.querySelector('input[name="appName"]'),y=document.querySelector('textarea[name="productDescription"]');h&&(h.required=!0),p&&(p.required=!0),v&&(v.closest("div").classList.add("hidden"),v.required=!1),y&&(y.closest("div").classList.add("hidden"),y.required=!1),document.querySelectorAll(".non-order-menu-fields").forEach(b=>{b.classList.add("hidden"),b.style.display="none"});const f=document.getElementById("restaurant-fields"),C=document.getElementById("restaurant-cuisine-fields");f&&f.classList.add("hidden"),C&&C.classList.add("hidden"),document.querySelectorAll(".non-order-menu-fields").forEach(b=>{b.classList.remove("hidden"),b.style.display="block"}),this.setupOrderMenuLogoUpload()}else{console.log("üì± Showing non-restaurant fields for product:",e.id);const c=document.getElementById("order-menu-fields");c&&(c.classList.add("hidden"),c.style.display="none",console.log("üö´ Order Menu System fields hidden for non-Order Menu System product")),document.querySelectorAll("#order-menu-fields [required]").forEach(y=>{y.required=!1}),n&&(n.classList.add("hidden"),n.style.display="none",console.log("üö´ Cuisine type field hidden for non-restaurant product")),document.querySelectorAll(".non-order-menu-fields").forEach(y=>{y.classList.remove("hidden"),y.style.display="block"});const g=document.querySelector('input[name="projectName"]'),h=document.querySelector('input[name="contactPerson"]'),p=document.querySelector('input[name="appName"]'),v=document.querySelector('textarea[name="productDescription"]');g&&(g.closest("div").classList.remove("hidden"),g.required=!0),h&&(h.closest("div").classList.remove("hidden"),h.required=!0),p&&(p.closest("div").classList.remove("hidden"),p.required=!0),v&&(v.closest("div").classList.remove("hidden"),v.required=!0),e.id==="android-tv"||e.id==="android-tv-app"?(console.log("üì∫ Showing TV app fields"),a&&(a.textContent="App Icon"),l&&(l.textContent="Upload app icon or drag and drop"),i&&(i.textContent="App Screenshots (Optional)"),s&&(s.textContent="Upload app screenshots or drag and drop")):e.id==="mobile-streaming"||e.id==="streaming-mobile-app"?(console.log("üì± Showing mobile app fields"),a&&(a.textContent="App Icon"),l&&(l.textContent="Upload app icon or drag and drop"),i&&(i.textContent="App Screenshots (Optional)"),s&&(s.textContent="Upload app screenshots or drag and drop")):(a&&(a.textContent="App Icon"),l&&(l.textContent="Upload app icon or drag and drop"),i&&(i.textContent="App Screenshots (Optional)"),s&&(s.textContent="Upload app screenshots or drag and drop"))}const d=document.querySelector('input[name="appName"]');d&&(d.required=!0)}prefillRequirementsForm(){const o=(window.globalAuthManager||window.simpleAuthManager)?.getCurrentUser();if(!o)return;const t=document.querySelector('input[name="email"]'),r=document.querySelector('input[name="phone"]');t&&(t.value=o.email||""),r&&(r.value=o.phone||""),this.setupFileUploads()}setupFileUploads(){const e=document.getElementById("logo-upload");e&&e.addEventListener("change",t=>{const r=t.target.files[0];r&&(this.showUploadSuccess("logo-upload",r.name),this.items.length>0&&(this.items[0].logo=r,console.log("Logo stored:",r.name)))});const o=document.getElementById("menu-upload");o&&o.addEventListener("change",t=>{const r=Array.from(t.target.files);r.length>0&&(this.showUploadSuccess("photos-upload",`${r.length} files selected`),this.items.length>0&&(this.items[0].photos=r,console.log("Photos stored:",r.map(n=>n.name))))}),this.setupDragAndDrop()}setupFormChangeListeners(){console.log("üö´ Auto-save disabled to prevent duplicate entries")}setupDragAndDrop(){const e=document.querySelector("#logo-upload-section .border-dashed"),o=document.querySelector("#photos-upload-section .border-dashed");e&&(e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("border-primary-400","bg-primary-50")}),e.addEventListener("dragleave",t=>{t.preventDefault(),e.classList.remove("border-primary-400","bg-primary-50")}),e.addEventListener("drop",t=>{t.preventDefault(),e.classList.remove("border-primary-400","bg-primary-50");const r=Array.from(t.dataTransfer.files);if(r.length>0){const n=r[0];document.getElementById("logo-upload").files=t.dataTransfer.files,this.showUploadSuccess("logo-upload",n.name),this.items.length>0&&(this.items[0].logo=n)}})),o&&(o.addEventListener("dragover",t=>{t.preventDefault(),o.classList.add("border-primary-400","bg-primary-50")}),o.addEventListener("dragleave",t=>{t.preventDefault(),o.classList.remove("border-primary-400","bg-primary-50")}),o.addEventListener("drop",t=>{t.preventDefault(),o.classList.remove("border-primary-400","bg-primary-50");const r=Array.from(t.dataTransfer.files);r.length>0&&(document.getElementById("menu-upload").files=t.dataTransfer.files,this.showUploadSuccess("photos-upload",`${r.length} files selected`),this.items.length>0&&(this.items[0].photos=r))}))}showUploadSuccess(e,o){const t=document.getElementById(e==="logo-upload"?"upload-status":"photos-status");t&&(t.textContent=`‚úì ${o}`,t.className="mt-3 text-sm font-medium text-green-600",t.classList.remove("hidden"),setTimeout(()=>{t.classList.add("hidden")},3e3))}setupOrderMenuLogoUpload(){const e=document.getElementById("order-menu-logo-upload"),o=document.getElementById("order-menu-logo-status");e&&e.addEventListener("change",t=>{const r=t.target.files[0];if(r){if(!r.type.startsWith("image/")){o.textContent="Please select an image file",o.className="mt-3 text-sm font-medium text-red-500",o.classList.remove("hidden");return}if(r.size>10*1024*1024){o.textContent="File size must be less than 10MB",o.className="mt-3 text-sm font-medium text-red-500",o.classList.remove("hidden");return}o.textContent=`Selected: ${r.name}`,o.className="mt-3 text-sm font-medium text-green-500",o.classList.remove("hidden"),this.orderMenuLogoFile=r}})}collectMenuItems(){const e=[],o=document.querySelectorAll(".menu-item");return console.log("üçΩÔ∏è Collecting menu items from",o.length,"elements"),o.forEach((t,r)=>{const n=t.querySelector('input[name="menuItemName[]"]')?.value?.trim(),a=t.querySelector('input[name="menuItemPrice[]"]')?.value?.trim(),l=t.querySelector('input[name="menuItemQuantity[]"]')?.value?.trim();console.log(`üçΩÔ∏è Item ${r+1}:`,{itemName:n,price:a,quantity:l}),n&&a&&l?e.push({item_name:n,price:parseFloat(a)||0,quantity_available:parseInt(l)||0,item_description:"",item_category:"General",is_available:!0}):console.log(`‚ö†Ô∏è Skipping item ${r+1} - missing required fields`)}),console.log("üçΩÔ∏è Collected menu items:",e),e}updateMenuItemsReview(){const e=document.getElementById("review-menu-items");e&&(this.requirements.menuItems&&this.requirements.menuItems.length>0?e.innerHTML=this.requirements.menuItems.map((o,t)=>`
          <div class="flex justify-between items-center py-3 border-b border-gray-200 ${t===this.requirements.menuItems.length-1?"border-b-0":""}">
            <div class="flex-1">
              <div class="font-medium text-gray-900">${o.item_name}</div>
              <div class="text-sm text-gray-500">Quantity Available: ${o.quantity_available}</div>
            </div>
            <div class="text-right">
              <div class="font-semibold text-lg text-gray-900">‚Çπ${o.price.toFixed(2)}</div>
            </div>
          </div>
        `).join(""):e.innerHTML='<p class="text-gray-500 text-center py-4">No menu items added</p>')}backToCart(){const e=document.getElementById("project-requirements"),o=document.getElementById("cart-actions");e&&e.classList.add("hidden"),o&&o.classList.remove("hidden"),o?.scrollIntoView({behavior:"smooth"})}async saveCartToSupabase(){try{console.log("üîç Starting saveCartToSupabase...");const e=window.globalAuthManager||window.simpleAuthManager;console.log("üîç Auth manager found:",!!e);const o=e?.getCurrentUser();if(console.log("üîç Current user:",o),!o||this.items.length===0)return console.log("‚ùå No user or items found for Supabase save"),console.log("‚ùå User:",o),console.log("‚ùå Items length:",this.items.length),null;const t=this.items[0];if(console.log("üîç Debug - Item being saved:",t),console.log("üîç Debug - Current user:",o),!N)return console.error("‚ùå Supabase client not available"),null;const r=document.getElementById("requirements-form");let n={};const a=t&&(t.id==="order-menu-system"||t.id==="5");r&&(a?(n={projectName:r.querySelector('[name="projectName"]')?.value||"",contactPerson:r.querySelector('[name="contactPerson"]')?.value||"",restaurantName:r.querySelector('[name="orderMenuRestaurantName"]')?.value||"",ownerName:r.querySelector('[name="orderMenuOwnerName"]')?.value||"",restaurantAddress:r.querySelector('[name="orderMenuAddress"]')?.value||"",email:r.querySelector('[name="email"]')?.value||"",phone:r.querySelector('[name="phone"]')?.value||"",menuItems:this.collectMenuItems(),additionalRequirements:r.querySelector('[name="additionalRequirements"]')?.value||""},console.log("üçΩÔ∏è Form data collected for Order Menu System:",n)):n={projectName:r.querySelector('[name="projectName"]')?.value||"",contactPerson:r.querySelector('[name="contactPerson"]')?.value||"",restaurantName:r.querySelector('[name="restaurantName"]')?.value||"",cuisineType:r.querySelector('[name="cuisineType"]')?.value||r.querySelector('[name="emergencyCuisineType"]')?.value||"",appName:r.querySelector('[name="appName"]')?.value||"",email:r.querySelector('[name="email"]')?.value||"",phone:r.querySelector('[name="phone"]')?.value||"",additionalRequirements:r.querySelector('[name="additionalRequirements"]')?.value||""});const l=document.querySelector('input[name="primaryColor"]')?.value||"#3B82F6",i=document.querySelector('input[name="secondaryColor"]')?.value||"#A5CF6",s=document.querySelector('input[name="accentColor"]')?.value||"#F59E0B",d=document.querySelector('input[name="textColor"]')?.value||"#1F2937",c=t.price,u=t.features.reduce((S,L)=>S+({responsive:500,seo:300,analytics:200}[L]||0),0),m=c+u,g=Math.round(m*.18),h=m+g,p=document.querySelector('input[name="restaurantLogo"]')?.files?.[0],v=document.querySelector('input[name="menuPhotos"]')?.files;let y="",x="",f=0,C="",E="",b=[],q=[],I=[],M=[],P=[];p&&(console.log("üì∏ Processing restaurant logo upload:",p.name),x=p.name,f=p.size,C=p.type,y=`pending_upload_${Date.now()}_${p.name}`,E=`hash_${p.name}_${p.size}_${Date.now()}`),v&&v.length>0&&(console.log("üì∏ Processing menu photos upload:",v.length,"files"),Array.from(v).forEach(S=>{q.push(S.name),I.push(S.size),M.push(S.type),b.push(`pending_upload_${Date.now()}_${S.name}`),P.push(`hash_${S.name}_${S.size}_${Date.now()}`)}));let B;if(a?B={user_email:o.email,user_id:o.id||null,product_id:"order-menu-system",product_name:"Order Menu System",base_price:t.price,total_amount:h,project_name:n.projectName||"",contact_person:n.contactPerson||"",restaurant_name:n.restaurantName||"",owner_name:n.ownerName||"",app_icon_url:null,app_icon_filename:null,app_icon_size:null,app_icon_type:null,restaurant_address:n.restaurantAddress||"",restaurant_logo_url:y,restaurant_logo_filename:x,restaurant_logo_size:f,restaurant_logo_type:C,contact_email:n.email||o.email,contact_phone:n.phone||o.phone||"",app_screenshots:[],primary_color:l,secondary_color:i,accent_color:s,text_color:d,additional_requirements:n.additionalRequirements||"",menu_items:n.menuItems?n.menuItems.map(S=>({item_name:S.item_name,price:parseFloat(S.price)||0,quantity_available:parseInt(S.quantity_available)||0,item_description:S.item_description||"",item_category:S.item_category||"General",is_available:!0,created_at:new Date().toISOString()})):[],menu_items_count:n.menuItems?n.menuItems.length:0,cart_status:"pending"}:B={user_email:o.email,user_id:o.id||null,product_id:t.id,product_name:t.name,product_description:t.description,base_price:t.price,total_amount:h,custom_name:t.customName||"",restaurant_name_customization:t.restaurantName||"",selected_color:t.color||"#3B82F6",selected_features:t.features||[],project_name:n.projectName||"",contact_person:n.contactPerson||"",restaurant_name:n.restaurantName||"",cuisine_type:n.cuisineType||"",app_name:n.appName||"",product_description_custom:n.productDescription||"",contact_email:n.email||o.email,contact_phone:n.phone||o.phone||"",primary_color:l,secondary_color:i,accent_color:s,text_color:d,restaurant_logo_url:y,restaurant_logo_filename:x,restaurant_logo_size:f,restaurant_logo_type:C,restaurant_logo_hash:E,menu_photos_urls:b,menu_photos_filenames:q,menu_photos_sizes:I,menu_photos_types:M,menu_photos_hashes:P,additional_requirements:n.additionalRequirements||"",cart_status:"pending",is_checkout_initiated:!1},console.log("üîç Debug - Cart data being sent to Supabase:",B),a){console.log("üçΩÔ∏è Saving Order Menu System data to dedicated tables...");const{data:S,error:L}=await N.from("order_menu_system_customizations").insert(B).select().single();return L?(console.error("‚ùå Error saving Order Menu System customization:",L),null):(console.log("‚úÖ Order Menu System customization saved:",S),console.log("‚úÖ Menu items included in customization:",n.menuItems?n.menuItems.length:0,"items"),S)}else{console.log("üîç Testing Supabase connection for standard cart...");const{data:S,error:L}=await N.from("cart_customizations").select("*").limit(1);if(L)return console.error("‚ùå Supabase connection test failed:",L),null;console.log("‚úÖ Supabase connection test successful"),console.log("üöÄ Attempting to save to Supabase using simple upsert function...");const{data:k,error:T}=await N.rpc("upsert_cart_customization",{p_user_email:o.email,p_user_id:o.id||null,p_product_id:t.id,p_product_name:t.name,p_product_description:t.description,p_base_price:t.price,p_total_amount:h,p_project_name:n.projectName||"",p_app_name:n.appName||"",p_contact_person:n.contactPerson||"",p_product_description_custom:n.productDescription||"",p_restaurant_name:n.restaurantName||"",p_cuisine_type:n.cuisineType||"",p_contact_email:n.email||o.email,p_contact_phone:n.phone||o.phone||"",p_restaurant_logo_url:y,p_restaurant_logo_filename:x,p_restaurant_logo_size:f,p_restaurant_logo_type:C,p_restaurant_logo_hash:E,p_menu_photos_urls:b,p_menu_photos_filenames:q,p_menu_photos_sizes:I,p_menu_photos_types:M,p_menu_photos_hashes:P,p_primary_color:l,p_secondary_color:i,p_accent_color:s,p_text_color:d,p_additional_requirements:n.additionalRequirements||""});if(T){console.error("‚ùå Upsert function failed, trying direct upsert:",T);let{data:A,error:_}=await N.from("cart_customizations").upsert([B],{onConflict:"user_email,product_id"}).select();if(_){console.warn("‚ö†Ô∏è Direct upsert failed, trying insert as fallback:",_);const O=await N.from("cart_customizations").insert([B]).select();O.error?(console.error("‚ùå Insert also failed:",O.error),_=O.error):(console.log("‚úÖ Insert successful as fallback"),A=O.data,_=null)}return _?(console.error("‚ùå All save methods failed:",_),null):(console.log("‚úÖ Cart saved successfully via fallback method"),A[0])}else{console.log("‚úÖ Cart saved successfully via upsert function"),console.log("üîç Upsert result:",k);const{data:A,error:_}=await N.from("cart_customizations").select("*").eq("id",k).single();return _?(console.error("‚ùå Failed to fetch saved cart:",_),null):A}}}catch(e){return console.error("‚ùå Error in saveCartToSupabase:",e),console.error("‚ùå Error stack:",e.stack),null}}async markOrderAsCompleted(e){try{console.log("üí≥ Marking order as completed:",e);const t=(window.globalAuthManager||window.simpleAuthManager)?.getCurrentUser();if(!t)return console.error("‚ùå No user found for order completion"),!1;const r=window.supabase?.createClient("https://lmrrdcaavwwletcjcpqv.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxtcnJkY2Fhdnd3bGV0Y2pjcHF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MDQ0ODgsImV4cCI6MjA3MTA4MDQ4OH0.AU59Qfr6K9i880Gcn5y-3pjCf8PXsDIq4OI0-lPQVuQ"),{data:n,error:a}=await r.from("cart_customizations").update({cart_status:"completed",updated_at:new Date().toISOString()}).eq("id",e).eq("user_email",t.email);return a?(console.error("‚ùå Error marking order as completed:",a),!1):(console.log("‚úÖ Order marked as completed successfully"),!0)}catch(o){return console.error("‚ùå Error in markOrderAsCompleted:",o),!1}}async cancelOrder(e){try{console.log("‚ùå Cancelling order:",e);const t=(window.globalAuthManager||window.simpleAuthManager)?.getCurrentUser();if(!t)return console.error("‚ùå No user found for order cancellation"),!1;const r=window.supabase?.createClient("https://lmrrdcaavwwletcjcpqv.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxtcnJkY2Fhdnd3bGV0Y2pjcHF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MDQ0ODgsImV4cCI6MjA3MTA4MDQ4OH0.AU59Qfr6K9i880Gcn5y-3pjCf8PXsDIq4OI0-lPQVuQ"),{data:n,error:a}=await r.from("cart_customizations").update({cart_status:"cancelled",updated_at:new Date().toISOString()}).eq("id",e).eq("user_email",t.email);return a?(console.error("‚ùå Error cancelling order:",a),!1):(console.log("‚úÖ Order cancelled successfully"),!0)}catch(o){return console.error("‚ùå Error in cancelOrder:",o),!1}}calculateTotal(){const e=this.items.reduce((r,n)=>r+n.price*n.quantity,0),o=this.items.reduce((r,n)=>{const a={responsive:500,seo:300,analytics:200};return r+n.features.reduce((l,i)=>l+(a[i]||0),0)},0),t=(e+o)*.18;return Math.round(e+o+t)}declineOrder(){confirm("Are you sure you want to decline this order? You will be redirected to products page.")&&(this.items=[],this.saveCart(),window.location.href="/products")}deleteItem(){confirm("Are you sure you want to delete this item? You will be redirected to products page.")&&(this.items=[],this.saveCart(),window.location.href="/products")}switchPaymentMethod(e){const o=document.getElementById("card-details"),t=document.getElementById("upi-details"),r=document.getElementById("netbanking-details");switch(o?.classList.add("hidden"),t?.classList.add("hidden"),r?.classList.add("hidden"),e){case"card":o?.classList.remove("hidden");break;case"upi":t?.classList.remove("hidden");break;case"netbanking":r?.classList.remove("hidden");break}}updateOrderReview(){console.log("üîÑ Updating order review with data:",this.requirements);try{const e=this.items[0];if(e&&(e.id==="order-menu-system"||e.id==="5")){const f=document.getElementById("review-order-menu-info");f&&f.classList.remove("hidden");const C=document.getElementById("review-restaurant-name"),E=document.getElementById("review-owner-name"),b=document.getElementById("review-restaurant-address"),q=document.getElementById("review-contact-email"),I=document.getElementById("review-contact-phone");C&&(C.textContent=this.requirements.restaurantName||"-"),E&&(E.textContent=this.requirements.ownerName||"-"),b&&(b.textContent=this.requirements.restaurantAddress||"-"),q&&(q.textContent=this.requirements.email||"-"),I&&(I.textContent=this.requirements.phone||"-"),this.updateMenuItemsReview()}else{const f=document.getElementById("review-order-menu-info");f&&f.classList.add("hidden");const C=document.getElementById("review-project-name"),E=document.getElementById("review-contact-person"),b=document.getElementById("review-app-name");C&&(C.textContent=this.requirements.projectName||"-"),E&&(E.textContent=this.requirements.contactPerson||"-"),b&&(b.textContent=this.requirements.appName||"-");const q=document.getElementById("review-restaurant-info"),I=document.getElementById("review-cuisine-info"),M=document.getElementById("review-restaurant-name"),P=document.getElementById("review-cuisine-type");e&&(e.id==="restaurant-menu"||e.id==="restaurant-menu-system"||e.id==="restaurant-website"||e.id==="1"||e.id==="4")?(q&&q.classList.remove("hidden"),I&&I.classList.remove("hidden"),M&&(M.textContent=this.requirements.restaurantName||"-"),P&&(P.textContent=this.requirements.cuisineType||"-")):(q&&q.classList.add("hidden"),I&&I.classList.add("hidden"))}const t=document.querySelector('input[name="primaryColor"]')?.value||"#3B82F6",r=document.querySelector('input[name="secondaryColor"]')?.value||"#A5CF6",n=document.querySelector('input[name="accentColor"]')?.value||"#F59E0B",a=document.querySelector('input[name="textColor"]')?.value||"#1F2937",l=document.getElementById("review-primary-color"),i=document.getElementById("review-secondary-color"),s=document.getElementById("review-accent-color"),d=document.getElementById("review-text-color");l&&(l.style.backgroundColor=t),i&&(i.style.backgroundColor=r),s&&(s.style.backgroundColor=n),d&&(d.style.backgroundColor=a);const c=document.getElementById("logo-upload")?.files[0],u=document.getElementById("menu-upload")?.files,m=document.getElementById("review-logo-status"),g=document.getElementById("review-photos-status");m&&(m.textContent=c?`‚úì ${c.name}`:"Not uploaded"),g&&(g.textContent=u&&u.length>0?`‚úì ${u.length} photos selected`:"Not uploaded");const h=document.getElementById("review-total");if(h){const f=this.calculateTotal();h.textContent=`‚Çπ${f.toLocaleString()}`}const p=document.getElementById("final-amount");if(p){const f=this.calculateTotal();p.textContent=f.toLocaleString()}const v=document.getElementById("review-email"),y=document.getElementById("review-phone");v&&(v.textContent=this.requirements.email||"-"),y&&(y.textContent=this.requirements.phone||"-");const x=document.getElementById("review-additional-requirements");x&&(x.textContent=this.requirements.additionalRequirements||"No additional requirements specified"),console.log("‚úÖ Order review updated successfully")}catch(e){console.error("‚ùå Error updating order review:",e)}}backToRequirements(){const e=document.getElementById("order-review"),o=document.getElementById("project-requirements");e&&e.classList.add("hidden"),o&&o.classList.remove("hidden"),o?.scrollIntoView({behavior:"smooth"})}async proceedToPayment(){await this.createOrder(),this.showPaymentSection()}showPaymentSection(){const e=document.getElementById("project-requirements"),o=document.getElementById("payment-section");e&&e.classList.add("hidden"),o&&o.classList.remove("hidden"),this.updatePaymentSummary(),o?.scrollIntoView({behavior:"smooth"})}updatePaymentSummary(){try{console.log("üîÑ Updating payment summary..."),console.log("üìù Requirements data:",this.requirements);const e=document.getElementById("payment-project-name"),o=document.getElementById("payment-contact-person"),t=document.getElementById("payment-app-name"),r=document.getElementById("payment-email"),n=document.getElementById("payment-phone"),a=document.getElementById("payment-total-amount");if(console.log("üîç Payment elements found:",{projectNameEl:!!e,contactPersonEl:!!o,appNameEl:!!t,emailEl:!!r,phoneEl:!!n,totalAmountEl:!!a}),e&&(e.textContent=this.requirements.projectName||"-",console.log("‚úÖ Updated project name:",this.requirements.projectName)),o&&(o.textContent=this.requirements.contactPerson||"-",console.log("‚úÖ Updated contact person:",this.requirements.contactPerson)),t&&(t.textContent=this.requirements.appName||"-",console.log("‚úÖ Updated app name:",this.requirements.appName)),r&&(r.textContent=this.requirements.email||"-",console.log("‚úÖ Updated email:",this.requirements.email)),n&&(n.textContent=this.requirements.phone||"-",console.log("‚úÖ Updated phone:",this.requirements.phone)),a){const i=this.calculateTotal();a.textContent=i.toLocaleString(),console.log("‚úÖ Updated total amount:",i)}const l=document.getElementById("final-amount");if(l){const i=this.calculateTotal();l.textContent=i.toLocaleString(),console.log("‚úÖ Updated final payment amount:",i)}console.log("‚úÖ Payment summary updated successfully")}catch(e){console.error("‚ùå Error updating payment summary:",e)}}processFinalPayment(){const e=document.querySelector('input[name="paymentMethod"]:checked')?.value;if(!e){alert("Please select a payment method");return}let o=!0,t="";switch(e){case"card":const r=document.querySelector('input[name="cardNumber"]').value,n=document.querySelector('input[name="cardholderName"]').value,a=document.querySelector('input[name="expiryDate"]').value,l=document.querySelector('input[name="cvv"]').value;(!r||!n||!a||!l)&&(o=!1,t="Please fill in all card details");break;case"upi":document.querySelector('input[name="upiId"]').value||(o=!1,t="Please enter your UPI ID");break;case"netbanking":document.querySelector('select[name="bank"]').value||(o=!1,t="Please select your bank");break}if(!o){alert(t);return}this.simulatePayment()}simulatePayment(){const e=document.getElementById("final-payment");e.innerHTML,e.innerHTML=`
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Processing Payment...
      `,e.disabled=!0,setTimeout(()=>{this.saveOrderToHistory(),this.updateOrderStatusToConfirmed(),this.items=[],this.saveCart(),e.innerHTML=`
          <svg class="w-5 h-5 text-white inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Payment Successful!
        `,setTimeout(()=>{window.location.href="/orders?order=success"},2e3)},3e3)}saveOrderToHistory(){if(this.items.length===0)return;const o=(window.globalAuthManager||window.simpleAuthManager)?.getCurrentUser();if(!o)return;const t=this.items[0],r=this.calculateTotal(),n=document.querySelector('input[name="primaryColor"]')?.value||"#3B82F6",a=document.querySelector('input[name="secondaryColor"]')?.value||"#A5CF6",l=document.querySelector('input[name="accentColor"]')?.value||"#F59E0B",i=document.querySelector('input[name="textColor"]')?.value||"#1F2937",s={userId:o.email,customerName:o.fullName||"User",customerEmail:o.email,serviceName:t.name,serviceType:"web_development",status:"cart",paymentStatus:"pending",amount:r,currency:"INR",requirements:{primaryColor:n,secondaryColor:a,accentColor:l,textColor:i,customName:t.customName||"",logo:t.logo||null,features:t.features||[],description:t.description}};try{const m=F.createOrder(s);console.log("Order saved to shared store:",m),this.currentSharedOrderId=m.id;const g=F.getOrders();console.log("All orders in shared store after creation:",g),console.log("Current shared order ID:",this.currentSharedOrderId)}catch(m){console.error("Error saving to shared store:",m)}const d={orderId:`ORD-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,userId:o.email,projectName:t.name,description:t.description,total:r,orderDate:new Date().toISOString(),requirements:{...this.requirements,primaryColor:n,secondaryColor:a,accentColor:l,textColor:i},features:t.features||[],logo:t.logo||null,color:t.color||"#3B82F6",customName:t.customName||""};let c=[];const u=localStorage.getItem("user-orders");u&&(c=JSON.parse(u)),c.push(d),localStorage.setItem("user-orders",JSON.stringify(c)),console.log("Order saved to user orders:",d)}async createOrder(){if(this.items.length===0)return;const o=(window.globalAuthManager||window.simpleAuthManager)?.getCurrentUser();if(!o)return;const t=this.items[0],r=this.calculateTotal(),n=document.querySelector('input[name="primaryColor"]')?.value||"#3B82F6",a=document.querySelector('input[name="secondaryColor"]')?.value||"#A5CF6",l=document.querySelector('input[name="accentColor"]')?.value||"#F59E0B",i=document.querySelector('input[name="textColor"]')?.value||"#1F2937",s=document.getElementById("requirements-form");let d={};const c=t&&(t.id==="order-menu-system"||t.id==="5");s&&(c?d={projectName:s.querySelector('[name="projectName"]')?.value||"",contactPerson:s.querySelector('[name="contactPerson"]')?.value||"",restaurantName:s.querySelector('[name="orderMenuRestaurantName"]')?.value||"",ownerName:s.querySelector('[name="orderMenuOwnerName"]')?.value||"",restaurantAddress:s.querySelector('[name="orderMenuAddress"]')?.value||"",email:s.querySelector('[name="email"]')?.value||"",phone:s.querySelector('[name="phone"]')?.value||"",menuItems:this.collectMenuItems(),additionalRequirements:s.querySelector('[name="additionalRequirements"]')?.value||""}:d={projectName:s.querySelector('[name="projectName"]')?.value||"",contactPerson:s.querySelector('[name="contactPerson"]')?.value||"",restaurantName:s.querySelector('[name="restaurantName"]')?.value||"",cuisineType:s.querySelector('[name="cuisineType"]')?.value||"",appName:s.querySelector('[name="appName"]')?.value||"",productDescription:s.querySelector('[name="productDescription"]')?.value||"",email:s.querySelector('[name="email"]')?.value||"",phone:s.querySelector('[name="phone"]')?.value||"",additionalRequirements:s.querySelector('[name="additionalRequirements"]')?.value||""});try{const u=await this.saveCartToSupabase();u?(console.log("‚úÖ Cart customization saved to Supabase:",u),this.currentSharedOrderId=u.id):console.error("‚ùå Failed to save cart data to Supabase");const m={userId:o.email,customerName:o.fullName||"User",customerEmail:o.email,serviceName:t.name,serviceType:c?"order_menu_system":"web_development",status:"pending",paymentStatus:"pending",amount:r,currency:"INR",requirements:{...d,primaryColor:n,secondaryColor:a,accentColor:l,textColor:i,customName:t.customName||"",logo:t.logo||null,features:t.features||[],description:t.description}},g=F.createOrder(m);console.log("Order created in shared store:",g);const h=F.getOrders();console.log("All orders in shared store after creation:",h),console.log("Current shared order ID:",this.currentSharedOrderId)}catch(u){console.error("Error creating order:",u)}}updateOrderStatusToPending(){if(this.currentSharedOrderId)try{F.updateOrderStatus(this.currentSharedOrderId,"pending","Payment initiated"),console.log("Order status updated to pending")}catch(e){console.error("Error updating order status:",e)}}updateOrderStatusToConfirmed(){if(this.currentSharedOrderId)try{F.updateOrderStatus(this.currentSharedOrderId,"confirmed","Payment successful - Order confirmed"),console.log("Order status updated to confirmed")}catch(e){console.error("Error updating order status:",e)}}debounce(e,o){let t;return function(...n){const a=()=>{clearTimeout(t),e(...n)};clearTimeout(t),t=setTimeout(a,o)}}}function D(){document.getElementById("menu-items-container").insertAdjacentHTML("beforeend",`
      <div class="menu-item border border-gray-300 rounded-lg p-4 mb-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-white mb-2">Item Name</label>
            <input type="text" name="menuItemName[]" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500" placeholder="e.g., Margherita Pizza">
          </div>
          <div>
            <label class="block text-sm font-medium text-white mb-2">Price (‚Çπ)</label>
            <input type="number" name="menuItemPrice[]" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500" placeholder="299">
          </div>
          <div>
            <label class="block text-sm font-medium text-white mb-2">Quantity Available</label>
            <input type="number" name="menuItemQuantity[]" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500" placeholder="50">
          </div>
        </div>
        <button type="button" onclick="removeMenuItem(this)" class="mt-2 text-red-500 hover:text-red-700 text-sm font-medium">Remove Item</button>
      </div>
    `)}function R(w){w.closest(".menu-item").remove()}window.addMenuItem=D;window.removeMenuItem=R;window.markOrderAsCompleted=async function(w){return window.cart?await window.cart.markOrderAsCompleted(w):(console.error("‚ùå Cart not initialized"),!1)};window.cancelOrder=async function(w){return window.cart?await window.cart.cancelOrder(w):(console.error("‚ùå Cart not initialized"),!1)};window.handlePaymentSuccess=async function(w){console.log("üí≥ Payment successful for order:",w);const e=await window.markOrderAsCompleted(w);alert(e?"‚úÖ Payment successful! Your order has been completed.":"‚ùå Error updating order status. Please contact support.")};window.handlePaymentFailure=async function(w){console.log("‚ùå Payment failed for order:",w),alert("‚ùå Payment failed. Please try again or contact support.")};window.handleOrderCancellation=async function(w){console.log("‚ùå Order cancelled:",w);const e=await window.cancelOrder(w);alert(e?"‚ùå Order has been cancelled.":"‚ùå Error cancelling order. Please contact support.")};window.clearCartForNewUser=function(){console.log("üßπ Clearing cart for new user"),window.cart&&(window.cart.items=[],window.cart.requirements={},localStorage.removeItem("cart-items"),localStorage.removeItem("cart-requirements"),localStorage.removeItem("user-cart-data"),console.log("‚úÖ Cart cleared for new user"))};window.clearCartOnUserChange=function(){console.log("üßπ Clearing cart due to user change"),window.cart&&(window.cart.items=[],window.cart.requirements={},localStorage.removeItem("cart-items"),localStorage.removeItem("cart-requirements"),localStorage.removeItem("user-cart-data"),console.log("‚úÖ Cart cleared due to user change"))};window.debugCartState=function(){console.log("üîç Cart Debug State:"),console.log("- Cart instance:",!!window.cart),console.log("- Cart items count:",window.cart?window.cart.items.length:0),console.log("- Cart items:",window.cart?window.cart.items:[]),console.log("- localStorage cart-items:",localStorage.getItem("cart-items")),console.log("- localStorage cart-requirements:",localStorage.getItem("cart-requirements")),console.log("- localStorage user-cart-data:",localStorage.getItem("user-cart-data"));const e=(window.globalAuthManager||window.simpleAuthManager)?.getCurrentUser();if(console.log("- Current user:",e?e.email:"Not logged in"),window.cart&&window.cart.items.length>0){const o=window.cart.items[0];console.log("- First item email:",o.email),console.log("- First item name:",o.name)}};window.validateCartOwnership=function(){const e=(window.globalAuthManager||window.simpleAuthManager)?.getCurrentUser();if(!e)return!0;if(window.cart&&window.cart.items.length>0){const o=window.cart.items[0];if(o.email&&o.email!==e.email)return console.log("‚ö†Ô∏è Cart belongs to different user, clearing..."),window.clearCartForNewUser(),!1}return!0};
