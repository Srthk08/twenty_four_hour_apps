import{supabase as y}from"./supabase.DFVW9e3y.js";import"./ProductDialog.astro_astro_type_script_index_0_lang.CpUg5vNK.js";import"https://unpkg.com/@supabase/supabase-js@2";import"./index.BymsOcZI.js";import"./preload-helper.CLcXU_4U.js";const B=document.getElementById("signup-form"),d=document.getElementById("error-message"),l=document.getElementById("error-text"),h=document.getElementById("success-message"),x=document.getElementById("success-text"),T=document.getElementById("google-signup-btn");let k=!1;function I(t,e="info"){if(e==="error"){l&&(l.textContent=t),d?.classList.remove("hidden"),d&&(d.className="p-4 bg-red-50 border border-red-200 rounded-lg");return}x&&(x.textContent=t),h?.classList.remove("hidden"),h&&(h.className="p-4 bg-green-50 border border-green-200 rounded-lg"),d?.classList.add("hidden")}async function N(){k=!0,sessionStorage.setItem("oauth-google","1");try{I("Connecting to Google...","loading");const{data:t,error:e}=await y.auth.signInWithOAuth({provider:"google",options:{redirectTo:`${window.location.origin}/auth/callback`,queryParams:{access_type:"offline",prompt:"consent"}}});if(e){console.error("Google auth error:",e);let n=e.message;e.message.includes("Provider not found")||e.message.includes("not configured")?n="Google provider not configured. Please contact administrator.":e.message.includes("redirect_uri_mismatch")||e.message.includes("mismatch")?(n=`Redirect URI mismatch. Please add this exact URI to Google Cloud Console: ${window.location.origin}/auth/callback`,console.error("URI Mismatch Details:",{currentOrigin:window.location.origin,expectedRedirect:`${window.location.origin}/auth/callback`,error:e.message,fixInstructions:"Add the exact URI above to Google Cloud Console ‚Üí APIs & Services ‚Üí Credentials ‚Üí OAuth 2.0 Client ID ‚Üí Authorized redirect URIs"})):e.message.includes("access_denied")&&(n="Access denied. Please try again."),I(`Authentication failed: ${n}`,"error");return}I("Redirecting to Google...","loading")}catch(t){console.error("Google auth error:",t),I(`Authentication failed: ${t.message}`,"error")}}async function U(t){try{const{data:e,error:n}=await y.rpc("sync_google_user",{p_google_id:t.user_metadata.provider_id,p_email:t.email,p_name:t.user_metadata.full_name,p_picture:t.user_metadata.avatar_url,p_provider_id:t.user_metadata.provider_id});if(n){console.error("Sync error:",n);return}return console.log("Google user synced:",e),e}catch(e){console.error("Sync error:",e)}}T?.addEventListener("click",N);y.auth.onAuthStateChange(async(t,e)=>{if(t==="SIGNED_IN"&&e?.user){const n=e.user;if(n.app_metadata.provider==="google"){if(!(k||sessionStorage.getItem("oauth-google")==="1"))return;sessionStorage.removeItem("oauth-google"),I("Syncing Google account...","loading"),await U(n),I("Successfully signed up with Google!","success");const s={...n,role:"customer"};sessionStorage.setItem("simple-auth-session",JSON.stringify({user:s,access_token:e?.access_token,timestamp:Date.now()})),window.dispatchEvent(new CustomEvent("user-logged-in",{detail:s})),setTimeout(()=>{window.location.href="/dashboard"},1500)}}});async function O(){try{console.log("üîç Checking for missing profiles...");const{data:{user:t}}=await y.auth.getUser();if(!t){console.log("‚ÑπÔ∏è No user logged in");return}const{data:e,error:n}=await y.from("profiles").select("*").eq("id",t.id).single();if(n||!e){console.log("‚ö†Ô∏è Profile missing for user, creating...");const{data:f,error:s}=await y.rpc("create_profile_for_existing_user",{user_id:t.id,user_email:t.email,user_full_name:t.user_metadata?.full_name||"",user_phone:t.user_metadata?.phone||"",user_company_name:t.user_metadata?.company_name||"",user_role:"customer"});s?console.error("‚ùå Error creating missing profile:",s):console.log("‚úÖ Missing profile created:",f)}else console.log("‚úÖ Profile exists:",e)}catch(t){console.error("‚ùå Error checking/fixing profiles:",t)}}document.addEventListener("DOMContentLoaded",function(){O();const t=document.getElementById("email"),e=document.getElementById("full_name"),n=document.getElementById("password"),f=document.getElementById("confirm_password"),s=document.getElementById("phone"),v=document.getElementById("company_name"),a=document.getElementById("admin-code-section"),c=document.getElementById("phone-error");t&&(t.value=""),e&&(e.value=""),n&&(n.value=""),f&&(f.value=""),s&&(s.value=""),v&&(v.value="");const _=document.getElementById("country_code"),r=document.getElementById("country_code_custom");if(s&&_){let m=function(){return _.value==="other"&&r?r.value.trim()||"+91":_.value},S=function(){_.value==="other"?r&&(r.classList.remove("hidden"),r.required=!0,r.value="+"):r&&(r.classList.add("hidden"),r.required=!1,r.value="")},w=function(){const g=m(),o=s.value.replace(/\D/g,""),u=i[g];u?(s.maxLength=u,s.pattern=`[0-9]{${u}}`,o.length>0&&o.length!==u?(c?.classList.remove("hidden"),c.textContent=`Please enter a valid ${u}-digit phone number for this country`,s.classList.add("border-red-500")):(o.length===u||o.length===0)&&(c?.classList.add("hidden"),s.classList.remove("border-red-500"))):(s.maxLength=15,s.pattern="[0-9]{5,15}",o.length>0&&o.length<5?(c?.classList.remove("hidden"),c.textContent="Please enter a valid phone number (at least 5 digits)",s.classList.add("border-red-500")):o.length>15?(c?.classList.remove("hidden"),c.textContent="Please enter a valid phone number (max 15 digits)",s.classList.add("border-red-500")):(c?.classList.add("hidden"),s.classList.remove("border-red-500")))};r&&r.addEventListener("input",function(g){let o=g.target.value;o.startsWith("+")||(o="+"+o.replace(/\+/g,"")),o=o.replace(/[^+0-9]/g,""),g.target.value=o});const i={"+91":10,"+1":10,"+44":10,"+61":9,"+86":11,"+81":10,"+49":11,"+33":9,"+971":9,"+966":9};s.addEventListener("input",function(g){const o=g.target.value.replace(/[^0-9]/g,""),u=m(),C=i[u]||15;g.target.value=o.slice(0,C),w()}),_.addEventListener("change",function(){S(),s.value="";const g=m();s.placeholder=g==="+91"?"9876543210":"Enter phone number",w()}),S(),s.addEventListener("blur",w),r&&r.addEventListener("blur",w)}const p=new URLSearchParams(window.location.search).get("admin_code");if(p&&a){a.classList.remove("hidden");const m=document.getElementById("admin_code");m&&(m.value=p)}t&&(t.setAttribute("autocomplete","off"),t.setAttribute("data-lpignore","true")),n&&n.setAttribute("autocomplete","new-password"),f&&f.setAttribute("autocomplete","new-password")});const R=new URLSearchParams(window.location.search),$=R.get("message"),q=R.get("type")||"success";$&&(q==="error"?(l&&(l.textContent=$),d?.classList.remove("hidden")):typeof window.showToast=="function"&&window.showToast($,"success"),window.history.replaceState({},document.title,window.location.pathname));B?.addEventListener("submit",async t=>{t.preventDefault();const e=new FormData(B),n=e.get("email"),f=e.get("password"),s=e.get("confirm_password"),v=e.get("full_name"),a=e.get("phone"),c=e.get("company_name"),_=e.get("admin_code");if(d?.classList.add("hidden"),f!==s){l&&(l.textContent="Passwords do not match."),d?.classList.remove("hidden");return}if(f.length<6){l&&(l.textContent="Password must be at least 6 characters long."),d?.classList.remove("hidden");return}const r=document.getElementById("country_code"),D=document.getElementById("country_code_custom");let p=r?.value||"+91";p==="other"&&D&&(p=D.value.trim()||"+91");const m=a?a.replace(/\D/g,""):"",w={"+91":10,"+1":10,"+44":10,"+61":9,"+86":11,"+81":10,"+49":11,"+33":9,"+971":9,"+966":9}[p];if(w){if(!a||m.length!==w||!/^[0-9]+$/.test(m)){l&&(l.textContent=`Please enter a valid ${w}-digit phone number for this country.`),d?.classList.remove("hidden");return}}else if(!a||m.length<5||m.length>15||!/^[0-9]+$/.test(m)){l&&(l.textContent="Please enter a valid phone number (5-15 digits)."),d?.classList.remove("hidden");return}const i=B.querySelector('button[type="submit"]'),g=i.textContent;i.disabled=!0,i.innerHTML=`
      <svg class="animate-spin h-5 w-5 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    `;try{console.log("Attempting to sign up with Supabase:",n);const{data:o,error:u}=await y.auth.signUp({email:n,password:f,options:{data:{full_name:v,phone:a?`${p}${a.replace(/\D/g,"")}`:"",company_name:c}}});if(u)throw console.error("Supabase signup error:",u),u;if(o.user){console.log("User created successfully:",o.user.email),console.log("Session available:",!!o.session);let C="customer";_==="ADMIN2024"&&(C="admin"),console.log("üîÑ Creating user profile...");const A={id:o.user.id,email:n,full_name:v||"",phone:a?`${p}${a.replace(/\D/g,"")}`:"",company_name:c||"",role:C,status:"pending_verification",username:v?.toLowerCase().replace(/\s+/g,"_")||n.split("@")[0],created_at:new Date().toISOString(),updated_at:new Date().toISOString()};d?.classList.add("hidden");let P=!1;try{const{error:L}=await y.from("profiles").insert(A);if(L){console.error("‚ùå Profile creation error:",L);try{const{error:E}=await y.rpc("create_profile_for_existing_user",{user_id:o.user.id,user_email:n,user_full_name:v||"",user_phone:a?`${p}${a.replace(/\D/g,"")}`:"",user_company_name:c||"",user_role:C});E?console.error("Fallback profile creation also failed:",E):(P=!0,console.log("‚úÖ Profile created successfully via RPC"))}catch(E){console.error("RPC call failed:",E)}}else P=!0,console.log("‚úÖ Profile created successfully")}catch(L){console.error("Profile creation failed:",L)}if(i.disabled=!1,o.session&&o.session.access_token){const L={...o.user,id:o.user.id,email:n,full_name:v||"",phone:a?`${p}${a.replace(/\D/g,"")}`:"",company_name:c||"",role:C,status:P?"active":"pending_verification",created_at:new Date().toISOString(),updated_at:new Date().toISOString()};sessionStorage.setItem("simple-auth-session",JSON.stringify({user:L,access_token:o.session.access_token,timestamp:Date.now()})),window.dispatchEvent(new CustomEvent("user-logged-in",{detail:L})),x&&(x.textContent="Account created and signed in successfully! Redirecting to dashboard..."),h&&(h.classList.remove("hidden"),h.style.display="block"),i.innerHTML=`
            <svg class="w-5 h-5 text-white mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
            Success! Redirecting...
          `,setTimeout(()=>{window.location.href="/dashboard"},1200)}else console.log("No session - email confirmation required"),x&&(x.textContent="Account created successfully! Please check your email to verify your account."),h&&(h.classList.remove("hidden"),h.style.display="block"),i.innerHTML=`
            <svg class="w-5 h-5 text-white mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
            Account Created
          `,setTimeout(()=>{window.location.href="/login?message=Please check your email to verify your account"},2e3)}else throw new Error("Account creation failed")}catch(o){console.error("Signup error:",o),l&&(l.textContent=o.message||"An error occurred during account creation."),d&&(d.classList.remove("hidden"),d.style.display="block"),h?.classList.add("hidden"),i.disabled=!1,i.textContent=g}finally{i.disabled&&(i.disabled=!1,(i.textContent===""||i.innerHTML.includes("animate-spin"))&&(i.textContent=g))}});const M=document.getElementById("password"),b=document.getElementById("confirm_password"),G=()=>{b.value&&M.value!==b.value?b.setCustomValidity("Passwords do not match"):b.setCustomValidity("")};M?.addEventListener("input",G);b?.addEventListener("input",G);
