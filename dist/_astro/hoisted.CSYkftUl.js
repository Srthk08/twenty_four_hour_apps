import"./ProductDialog.astro_astro_type_script_index_0_lang.BMBe0S5g.js";import"https://unpkg.com/@supabase/supabase-js@2";import"./MenuOperatorGuard.astro_astro_type_script_index_0_lang.BiNjOZly.js";import"./index.BFAZBQoJ.js";document.addEventListener("DOMContentLoaded",async()=>{const o=window.globalAuthManager||window.simpleAuthManager;if(!o||!o.isUserLoggedIn()){console.log("‚ùå User not logged in - redirecting to login"),window.location.href="/login";return}b(),await w()});function b(){console.log("üîç Debugging storage...");try{const o=sessionStorage.getItem("simple-auth-session");if(console.log("üì¶ SessionStorage data:",o),o){const e=JSON.parse(o);console.log("üë§ Session user:",e.user)}}catch(o){console.log("‚ùå Error reading sessionStorage:",o)}try{const o=localStorage.getItem("simple-auth-user");if(console.log("üíæ LocalStorage data:",o),o){const e=JSON.parse(o);console.log("üë§ Local user:",e)}}catch(o){console.log("‚ùå Error reading localStorage:",o)}console.log("üîó Supabase available:",typeof window.supabase<"u"),typeof window.supabase<"u"&&console.log("‚úÖ Supabase client:",window.supabase)}async function w(){try{if(console.log("üöÄ Starting profile load..."),typeof window.supabase>"u"){console.error("‚ùå Supabase client not available, using fallback data"),s();return}const o=window.supabase;console.log("‚úÖ Supabase client found");const{data:{user:e},error:l}=await o.auth.getUser();if(l||!e){console.error("‚ùå Error getting user:",l),console.log("üîÑ Redirecting to login..."),window.location.href="/login";return}console.log("‚úÖ User found:",e.email);let t=null,a=null;try{const{data:n,error:r}=await o.from("profiles").select("*").eq("id",e.id).eq("role","menu_operator").single();t=n,a=r}catch(n){console.log("‚ö†Ô∏è Role-filtered query failed, trying fallback..."),a=n}if(a){console.log("‚ö†Ô∏è Role-filtered query failed:",a);try{const{data:n,error:r}=await o.from("profiles").select("*").eq("id",e.id).single();if(r){console.error("‚ùå Fallback profile query failed:",r),console.log("üîÑ Using fallback profile data..."),s(e);return}if(t=n,console.log("‚úÖ Fallback profile loaded:",t),t.role&&t.role.toLowerCase().trim()!=="menu_operator"){console.log("‚ùå User does not have menu_operator role. Role:",t.role),window.location.href="/dashboard";return}}catch(n){console.error("‚ùå Fallback query failed:",n),s(e);return}}if(t){if(t.role&&t.role.toLowerCase().trim()!=="menu_operator"){console.log("‚ùå User does not have menu_operator role. Role:",t.role),window.location.href="/dashboard";return}console.log("‚úÖ Profile loaded successfully:",t),u(e,t)}else console.log("‚ö†Ô∏è No profile found, using fallback data"),s(e)}catch(o){console.error("‚ùå Error loading user profile:",o),s()}}function s(o=null){console.log("üîÑ Showing fallback profile...");let e=o,l=null;if(!e){try{const t=sessionStorage.getItem("simple-auth-session");if(t){const a=JSON.parse(t);a.user&&a.access_token&&(e=a.user,console.log("‚úÖ Found user in sessionStorage:",e.email))}}catch(t){console.log("‚ö†Ô∏è Error reading sessionStorage:",t)}if(!e)try{const t=localStorage.getItem("simple-auth-user");t&&(e=JSON.parse(t),console.log("‚úÖ Found user in localStorage:",e.email))}catch(t){console.log("‚ö†Ô∏è Error reading localStorage:",t)}}if(!e){console.log("‚ùå No authenticated user found - redirecting to login"),window.location.href="/login";return}l={full_name:e.full_name||e.name||"Menu Operator",email:e.email,created_at:e.created_at||new Date().toISOString(),last_login:new Date().toISOString(),role:"menu_operator"},console.log("‚úÖ Using fallback profile:",l),u(e,l)}function u(o,e){try{const l=e.full_name||o.email,t=e.full_name?e.full_name.split(" ").map(p=>p.charAt(0)).join("").toUpperCase():o.email.charAt(0).toUpperCase(),a=document.getElementById("profile-avatar");a&&(a.textContent=t);const n=document.getElementById("profile-name");n&&(n.textContent=l);const r=document.getElementById("profile-email");r&&(r.textContent=o.email);const i=document.getElementById("profile-full-name");i&&(i.textContent=e.full_name||"Not set");const c=document.getElementById("profile-email-detail");c&&(c.textContent=o.email);const f=e.created_at?new Date(e.created_at).toLocaleDateString():new Date(o.created_at).toLocaleDateString(),m=e.last_login?new Date(e.last_login).toLocaleDateString():new Date().toLocaleDateString(),d=document.getElementById("profile-member-since");d&&(d.textContent=f);const g=document.getElementById("profile-last-login");g&&(g.textContent=m),console.log("‚úÖ Profile display updated successfully")}catch(l){console.error("Error updating profile display:",l),S("Failed to update profile display.")}}function S(o){const e=document.createElement("div");e.className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4",e.textContent=o;const l=document.querySelector(".space-y-6");l&&l.insertBefore(e,l.firstChild)}
