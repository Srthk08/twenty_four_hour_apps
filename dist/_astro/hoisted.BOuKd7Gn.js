import{supabase as f}from"./supabase.DO6XXPT9.js";import"./ProductDialog.astro_astro_type_script_index_0_lang.r4zW4cVw.js";import"https://unpkg.com/@supabase/supabase-js@2";import"./index.BFAZBQoJ.js";const _=document.getElementById("signup-form"),i=document.getElementById("error-message"),a=document.getElementById("error-text"),h=document.getElementById("success-message"),w=document.getElementById("success-text"),A=document.getElementById("google-signup-btn");let b=!1;function g(t,e="info"){if(e==="error"){a&&(a.textContent=t),i?.classList.remove("hidden"),i&&(i.className="p-4 bg-red-50 border border-red-200 rounded-lg");return}w&&(w.textContent=t),h?.classList.remove("hidden"),h&&(h.className="p-4 bg-green-50 border border-green-200 rounded-lg"),i?.classList.add("hidden")}async function B(){b=!0,sessionStorage.setItem("oauth-google","1");try{g("Connecting to Google...","loading");const{data:t,error:e}=await f.auth.signInWithOAuth({provider:"google",options:{redirectTo:`${window.location.origin}/auth/callback`,queryParams:{access_type:"offline",prompt:"consent"}}});if(e){console.error("Google auth error:",e);let o=e.message;e.message.includes("Provider not found")||e.message.includes("not configured")?o="Google provider not configured. Please contact administrator.":e.message.includes("redirect_uri_mismatch")||e.message.includes("mismatch")?(o=`Redirect URI mismatch. Please add this exact URI to Google Cloud Console: ${window.location.origin}/auth/callback`,console.error("URI Mismatch Details:",{currentOrigin:window.location.origin,expectedRedirect:`${window.location.origin}/auth/callback`,error:e.message,fixInstructions:"Add the exact URI above to Google Cloud Console → APIs & Services → Credentials → OAuth 2.0 Client ID → Authorized redirect URIs"})):e.message.includes("access_denied")&&(o="Access denied. Please try again."),g(`Authentication failed: ${o}`,"error");return}g("Redirecting to Google...","loading")}catch(t){console.error("Google auth error:",t),g(`Authentication failed: ${t.message}`,"error")}}async function D(t){try{const{data:e,error:o}=await f.rpc("sync_google_user",{p_google_id:t.user_metadata.provider_id,p_email:t.email,p_name:t.user_metadata.full_name,p_picture:t.user_metadata.avatar_url,p_provider_id:t.user_metadata.provider_id});if(o){console.error("Sync error:",o);return}return console.log("Google user synced:",e),e}catch(e){console.error("Sync error:",e)}}A?.addEventListener("click",B);f.auth.onAuthStateChange(async(t,e)=>{if(t==="SIGNED_IN"&&e?.user){const o=e.user;if(o.app_metadata.provider==="google"){if(!(b||sessionStorage.getItem("oauth-google")==="1"))return;sessionStorage.removeItem("oauth-google"),g("Syncing Google account...","loading"),await D(o),g("Successfully signed up with Google!","success");const d={...o,role:"customer"};sessionStorage.setItem("simple-auth-session",JSON.stringify({user:d,access_token:e?.access_token,timestamp:Date.now()})),window.dispatchEvent(new CustomEvent("user-logged-in",{detail:d})),setTimeout(()=>{window.location.href="/dashboard"},1500)}}});document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("email"),e=document.getElementById("full_name"),o=document.getElementById("password"),c=document.getElementById("confirm_password"),d=document.getElementById("phone"),u=document.getElementById("company_name"),n=document.getElementById("admin-code-section"),m=document.getElementById("phone-error");t&&(t.value=""),e&&(e.value=""),o&&(o.value=""),c&&(c.value=""),d&&(d.value=""),u&&(u.value=""),d&&d.addEventListener("input",function(s){s.target.value=s.target.value.replace(/[^0-9]/g,""),s.target.value.length>10&&(s.target.value=s.target.value.slice(0,10)),m&&(s.target.value.length>0&&s.target.value.length!==10?m.classList.remove("hidden"):m.classList.add("hidden"))});const l=new URLSearchParams(window.location.search).get("admin_code");if(l&&n){n.classList.remove("hidden");const s=document.getElementById("admin_code");s&&(s.value=l)}t&&(t.setAttribute("autocomplete","off"),t.setAttribute("data-lpignore","true")),o&&o.setAttribute("autocomplete","new-password"),c&&c.setAttribute("autocomplete","new-password")});const x=new URLSearchParams(window.location.search),I=x.get("message"),G=x.get("type")||"success";I&&(G==="error"?(a&&(a.textContent=I),i?.classList.remove("hidden")):typeof window.showToast=="function"&&window.showToast(I,"success"),window.history.replaceState({},document.title,window.location.pathname));_?.addEventListener("submit",async t=>{t.preventDefault();const e=new FormData(_),o=e.get("email"),c=e.get("password"),d=e.get("confirm_password"),u=e.get("full_name"),n=e.get("phone"),m=e.get("company_name"),S=e.get("admin_code");if(i?.classList.add("hidden"),c!==d){a&&(a.textContent="Passwords do not match."),i?.classList.remove("hidden");return}if(c.length<6){a&&(a.textContent="Password must be at least 6 characters long."),i?.classList.remove("hidden");return}if(!n||n.length!==10||!/^[0-9]{10}$/.test(n)){a&&(a.textContent="Please enter a valid 10-digit phone number."),i?.classList.remove("hidden");return}const l=_.querySelector('button[type="submit"]'),s=l.textContent;l.disabled=!0,l.innerHTML=`
      <svg class="animate-spin h-5 w-5 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    `;try{console.log("Attempting to sign up with Supabase:",o);const{data:r,error:y}=await f.auth.signUp({email:o,password:c,options:{data:{full_name:u,phone:n?`+91${n}`:"",company_name:m}}});if(y)throw console.error("Supabase signup error:",y),y;if(r.user){console.log("User created successfully:",r.user.email);let v="customer";S==="ADMIN2024"&&(v="admin");const{error:C}=await f.from("profiles").insert({id:r.user.id,email:o,full_name:u||"",phone:n?`+91${n}`:"",company_name:m||"",role:v,status:"pending_verification",username:u?.toLowerCase().replace(/\s+/g,"_")||o.split("@")[0],created_at:new Date().toISOString(),updated_at:new Date().toISOString()});if(C&&console.error("Profile creation error:",C),r.session){const E={...r.user,id:r.user.id,email:o,full_name:u||"",phone:n?`+91${n}`:"",company_name:m||"",role:v,status:"active",created_at:new Date().toISOString(),updated_at:new Date().toISOString()};sessionStorage.setItem("simple-auth-session",JSON.stringify({user:E,access_token:r.session.access_token,timestamp:Date.now()})),window.dispatchEvent(new CustomEvent("user-logged-in",{detail:E}))}w&&(w.textContent=r.session?"Account created and signed in successfully!":"Account created. Please check your email to verify your account."),h?.classList.remove("hidden"),r.session?setTimeout(()=>{window.location.href="/dashboard"},2e3):setTimeout(()=>{window.location.href="/login"},3e3)}else throw new Error("Account creation failed")}catch(r){console.error("Signup error:",r),a&&(a.textContent=r.message||"An error occurred during account creation."),i?.classList.remove("hidden")}finally{l.disabled=!1,l.textContent=s}});const L=document.getElementById("password"),p=document.getElementById("confirm_password"),P=()=>{p.value&&L.value!==p.value?p.setCustomValidity("Passwords do not match"):p.setCustomValidity("")};L?.addEventListener("input",P);p?.addEventListener("input",P);
