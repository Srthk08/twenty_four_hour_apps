import{supabase as m}from"./supabase.DFVW9e3y.js";import"./ProductDialog.astro_astro_type_script_index_0_lang.CpUg5vNK.js";import"https://unpkg.com/@supabase/supabase-js@2";import"./index.BymsOcZI.js";import"./preload-helper.CLcXU_4U.js";(function(){const e=window.location.pathname,s=window.location.hash,t=window.location.search,r=s.includes("access_token")||s.includes("type=recovery")||t.includes("access_token")||t.includes("type=recovery");if(e!=="/reset-password"&&e!=="/reset-password/"&&r&&!e.startsWith("/login")&&e!=="/"){console.log("⚠️ Reset tokens detected but not on reset-password page, redirecting"),window.location.href="/reset-password"+t+s;return}console.log("✅ Reset password page loaded successfully");let l=!1,w=!1;const d=setInterval(()=>{const o=window.location.pathname;o==="/"||o==="/index.html"?!w&&!l&&(console.log("⚠️ Redirect to home page detected, blocking and staying on reset-password page"),w=!0,window.history.pushState({},"","/reset-password"+t+s)):(o==="/reset-password"||o==="/reset-password/")&&(w=!1)},100);setTimeout(()=>{clearInterval(d)},1e4),window.allowPasswordResetRedirect=function(){l=!0}})();const k=document.getElementById("reset-password-form"),i=document.getElementById("reset-password-btn");document.addEventListener("DOMContentLoaded",async()=>{try{const e=new URLSearchParams(window.location.search);if(e.get("error")){n("Invalid or expired reset link. Please enter your email to request a new reset link."),a("Request New Reset Link"),p();return}const t=new URLSearchParams(window.location.hash.substring(1)),r=t.get("access_token"),l=t.get("refresh_token"),w=t.get("type"),d=e.get("access_token"),o=e.get("refresh_token"),g=e.get("type"),h=r||d,v=l||o,L=w||g;if(console.log("Reset page loaded. Checking for tokens..."),console.log("Hash params:",{accessToken:r,refreshToken:l,type:w}),console.log("Search params:",{searchAccessToken:d,searchRefreshToken:o,searchType:g}),console.log("Current URL:",window.location.href),h&&v&&L==="recovery"){console.log("Setting session with tokens from URL"),a("Setting up session...");const{data:c,error:u}=await m.auth.setSession({access_token:h,refresh_token:v});if(u){console.error("Error setting session:",u),n("Invalid or expired reset link. Please enter your email to request a new reset link."),a("Request New Reset Link"),p();return}console.log("Session set successfully:",c),c.user?(P(c.user.email),a("Update Password"),y(`Ready to reset password for ${c.user.email}`)):a("Update Password"),R()}else{const{data:{session:c}}=await m.auth.getSession();c&&c.user?(console.log("User already has a valid session"),P(c.user.email),a("Update Password"),y(`Ready to reset password for ${c.user.email}`),R()):(console.log("No session found, checking for auth state change..."),a("Waiting for session..."),m.auth.onAuthStateChange((u,f)=>{console.log("Auth state changed:",u,f?.user?.email),u==="SIGNED_IN"&&f&&f.user?(console.log("User signed in via auth state change"),P(f.user.email),a("Update Password"),y(`Ready to reset password for ${f.user.email}`),R()):u==="SIGNED_OUT"&&(n("Session expired. Please enter your email to request a new reset link."),a("Request New Reset Link"),p())}),setTimeout(async()=>{const{data:{session:u}}=await m.auth.getSession();u||(n("No valid session found. Please enter your email to request a new reset link."),a("Request New Reset Link"),p())},5e3))}}catch(e){console.error("Error in session setup:",e),n("Error setting up password reset session. Please enter your email to request a new reset link."),a("Request New Reset Link"),p()}});k?.addEventListener("submit",async e=>{e.preventDefault();const s=new FormData(k),t=s.get("email"),r=s.get("password"),l=s.get("confirmPassword");if(i.textContent?.includes("Request New Reset Link")){if(!t){n("Please enter your email address");return}const d=i.innerHTML;i.disabled=!0,i.innerHTML=`
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Sending Reset Link...
      `;try{const{error:o}=await m.auth.resetPasswordForEmail(t,{redirectTo:`${window.location.origin}/reset-password`});if(o){console.error("Reset link error:",o),n(o.message||"Failed to send reset link");return}y("Password reset link has been sent to your email address! Please check your inbox and click the reset link."),k.reset()}catch(o){console.error("Reset link error:",o),n(o.message||"Failed to send reset link")}finally{i.disabled=!1,i.innerHTML=d}}else{if(!r||!l){n("Please fill in all fields");return}if(r.length<6){n("Password must be at least 6 characters long");return}if(r!==l){n("Passwords do not match");return}const d=i.innerHTML;i.disabled=!0,i.innerHTML=`
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Updating Password...
      `;try{const{data:{session:o},error:g}=await m.auth.getSession();if(g||!o){console.error("No valid session:",g),n("No valid session found. Please request a new password reset.");return}const{error:h}=await m.auth.updateUser({password:r});if(h){console.error("Password update error:",h),n(h.message||"Failed to update password");return}y("Password updated successfully! You can now log in with your new password."),k.reset(),window.allowPasswordResetRedirect&&window.allowPasswordResetRedirect(),setTimeout(()=>{window.location.href="/login"},3e3)}catch(o){console.error("Password update error:",o),n(o.message||"Failed to update password")}finally{i.disabled=!1,i.innerHTML=d}}});function y(e){const s=document.getElementById("success-message"),t=document.getElementById("success-text"),r=document.getElementById("error-message");s&&t&&(t.textContent=e,s.classList.remove("hidden"),r&&r.classList.add("hidden"))}function n(e){const s=document.getElementById("error-message"),t=document.getElementById("error-text"),r=document.getElementById("success-message");s&&t&&(t.textContent=e,s.classList.remove("hidden"),r&&r.classList.add("hidden"))}function R(){const e=document.getElementById("reset-password-btn");e&&(e.disabled=!1)}function E(){const e=document.getElementById("reset-password-btn");e&&(e.disabled=!0)}function a(e){const s=document.getElementById("reset-password-btn");s&&(s.textContent=e)}function p(){const e=document.getElementById("email-field");e&&e.classList.remove("hidden")}function P(e){const s=document.getElementById("email-display"),t=document.getElementById("user-email");s&&t&&(t.textContent=e,s.classList.remove("hidden"))}E();a("Setting up session...");
