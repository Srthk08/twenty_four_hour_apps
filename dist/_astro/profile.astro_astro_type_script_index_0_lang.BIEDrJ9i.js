document.addEventListener("DOMContentLoaded",async()=>{console.log("üöÄ Menu Operator Profile Page Loading...");const t=sessionStorage.getItem("simple-auth-session");if(!t){console.log("‚ùå No session data found - redirecting to login"),window.location.href="/login";return}let e;try{e=JSON.parse(t)}catch{console.log("‚ùå Invalid session data - redirecting to login"),window.location.href="/login";return}if(!e.user||!e.user.email){console.log("‚ùå No user data in session - redirecting to login"),window.location.href="/login";return}console.log("‚úÖ Session found for user:",e.user.email),S(),await b()});function S(){console.log("üîç Debugging storage...");try{const t=sessionStorage.getItem("simple-auth-session");if(console.log("üì¶ SessionStorage data:",t),t){const e=JSON.parse(t);console.log("üë§ Session user:",e.user)}}catch(t){console.log("‚ùå Error reading sessionStorage:",t)}try{const t=localStorage.getItem("simple-auth-user");if(console.log("üíæ LocalStorage data:",t),t){const e=JSON.parse(t);console.log("üë§ Local user:",e)}}catch(t){console.log("‚ùå Error reading localStorage:",t)}console.log("üîó Supabase available:",typeof window.supabase<"u"),typeof window.supabase<"u"&&console.log("‚úÖ Supabase client:",window.supabase)}async function b(){try{console.log("üöÄ Starting profile load...");const t=sessionStorage.getItem("simple-auth-session");if(!t){console.log("‚ùå No session data - redirecting to login"),window.location.href="/login";return}const o=JSON.parse(t).user;if(!o||!o.email){console.log("‚ùå No user data in session - redirecting to login"),window.location.href="/login";return}if(console.log("‚úÖ User found in session:",o.email),c(o,{full_name:o.full_name||o.name||"Menu Operator",email:o.email,created_at:o.created_at||new Date().toISOString(),last_login:new Date().toISOString(),role:"menu_operator"}),typeof window.supabase>"u"){console.error("‚ùå Supabase client not available, using fallback data"),i(o);return}const n=window.supabase;console.log("‚úÖ Supabase client found");let l=null,r=null;try{const{data:a,error:s}=await n.from("profiles").select("*").eq("id",o.id).eq("role","menu_operator").single();l=a,r=s}catch(a){console.log("‚ö†Ô∏è Role-filtered query failed, trying fallback..."),r=a}if(r){console.log("‚ö†Ô∏è Role-filtered query failed:",r);try{const{data:a,error:s}=await n.from("profiles").select("*").eq("id",o.id).single();if(s){console.log("‚ö†Ô∏è Profile fetch failed (this is normal if profiles table doesn't exist):",s.message),console.log("üîÑ Using fallback profile data..."),i(o);return}if(l=a,console.log("‚úÖ Fallback profile loaded:",l),l.role&&l.role.toLowerCase().trim()!=="menu_operator")if(console.log("‚ö†Ô∏è User does not have menu_operator role in database. Role:",l.role),o.role==="menu_operator"||o.role==="menu operator")console.log("‚úÖ Using session role instead of database role"),l.role="menu_operator";else{console.log("‚ùå No valid role found - redirecting to dashboard"),window.location.href="/dashboard";return}}catch(a){console.error("‚ùå Fallback query failed:",a),i(o);return}}if(l){if(l.role&&l.role.toLowerCase().trim()!=="menu_operator")if(console.log("‚ö†Ô∏è User does not have menu_operator role in database. Role:",l.role),o.role==="menu_operator"||o.role==="menu operator")console.log("‚úÖ Using session role instead of database role"),l.role="menu_operator";else{console.log("‚ùå No valid role found - redirecting to dashboard"),window.location.href="/dashboard";return}console.log("‚úÖ Profile loaded successfully:",l),c(o,l)}else console.log("‚ö†Ô∏è No profile found, using fallback data"),i(o)}catch(t){console.error("‚ùå Error loading user profile:",t),i()}}function i(t=null){console.log("üîÑ Showing fallback profile...");let e=t,o=null;if(!e){try{const n=sessionStorage.getItem("simple-auth-session");if(n){const l=JSON.parse(n);l.user&&l.access_token&&(e=l.user,console.log("‚úÖ Found user in sessionStorage:",e.email))}}catch(n){console.log("‚ö†Ô∏è Error reading sessionStorage:",n)}if(!e)try{const n=localStorage.getItem("simple-auth-user");n&&(e=JSON.parse(n),console.log("‚úÖ Found user in localStorage:",e.email))}catch(n){console.log("‚ö†Ô∏è Error reading localStorage:",n)}}if(!e){console.log("‚ùå No authenticated user found - redirecting to login"),window.location.href="/login";return}o={full_name:e.full_name||e.name||"Menu Operator",email:e.email,created_at:e.created_at||new Date().toISOString(),last_login:new Date().toISOString(),role:"menu_operator"},console.log("‚úÖ Using fallback profile:",o),c(e,o)}function c(t,e){try{const o=e.full_name||t.email,n=e.full_name?e.full_name.split(" ").map(p=>p.charAt(0)).join("").toUpperCase():t.email.charAt(0).toUpperCase(),l=document.getElementById("profile-avatar");l&&(l.textContent=n);const r=document.getElementById("profile-name");r&&(r.textContent=o);const a=document.getElementById("profile-email");a&&(a.textContent=t.email);const s=document.getElementById("profile-full-name");s&&(s.textContent=e.full_name||"Not set");const d=document.getElementById("profile-email-detail");d&&(d.textContent=t.email);const f=e.created_at?new Date(e.created_at).toLocaleDateString():new Date(t.created_at).toLocaleDateString(),m=e.last_login?new Date(e.last_login).toLocaleDateString():new Date().toLocaleDateString(),g=document.getElementById("profile-member-since");g&&(g.textContent=f);const u=document.getElementById("profile-last-login");u&&(u.textContent=m),console.log("‚úÖ Profile display updated successfully")}catch(o){console.error("Error updating profile display:",o),w("Failed to update profile display.")}}function w(t){const e=document.createElement("div");e.className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4",e.textContent=t;const o=document.querySelector(".space-y-6");o&&o.insertBefore(e,o.firstChild)}
