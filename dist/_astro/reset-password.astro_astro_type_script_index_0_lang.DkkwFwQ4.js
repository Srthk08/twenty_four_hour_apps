import{supabase as k}from"./supabase.DeXTyW8I.js";import"./index.9NDAT-bh.js";import"./preload-helper.BlTxHScW.js";(function(){const e=window.location.pathname,t=window.location.hash,s=window.location.search,o=t.includes("access_token")||t.includes("type=recovery")||s.includes("access_token")||s.includes("type=recovery");if(e!=="/reset-password"&&e!=="/reset-password/"&&o&&!e.startsWith("/login")&&e!=="/"){console.log("⚠️ Reset tokens detected but not on reset-password page, redirecting"),window.location.href="/reset-password"+s+t;return}console.log("✅ Reset password page loaded successfully");let r=!1,d=!1;const m=setInterval(()=>{const n=window.location.pathname;n==="/"||n==="/index.html"?!d&&!r&&(console.log("⚠️ Redirect to home page detected, blocking and staying on reset-password page"),d=!0,window.history.pushState({},"","/reset-password"+s+t)):(n==="/reset-password"||n==="/reset-password/")&&(d=!1)},100);setTimeout(()=>{clearInterval(m)},1e4),window.allowPasswordResetRedirect=function(){r=!0}})();const P=document.getElementById("reset-password-form"),i=document.getElementById("reset-password-btn");let L=null;if(i){const e=i.querySelector("span.absolute");e&&(L=e.outerHTML,console.log("Stored original button icon HTML:",L))}let f=!1;async function b(){try{const e=new URLSearchParams(window.location.search);if(e.get("error")){a("Invalid or expired reset link. Please enter your email to request a new reset link."),c("Request New Reset Link"),h(),p();return}const s=new URLSearchParams(window.location.hash.substring(1)),o=s.get("access_token"),r=s.get("refresh_token"),d=s.get("type"),m=e.get("access_token"),n=e.get("refresh_token"),B=e.get("type"),x=o||m,E=r||n,v=d||B;if(console.log("Reset page loaded. Checking for tokens..."),console.log("Hash params:",{accessToken:o,refreshToken:r,type:d}),console.log("Search params:",{searchAccessToken:m,searchRefreshToken:n,searchType:B}),console.log("Current URL:",window.location.href),x&&E&&v==="recovery"){console.log("Setting session with tokens from URL"),c("Setting up session...");try{const{data:l,error:R}=await k.auth.setSession({access_token:x,refresh_token:E});if(R){console.error("Error setting session:",R),a("Invalid or expired reset link. Please enter your email to request a new reset link."),c("Request New Reset Link"),h(),p();return}console.log("Session set successfully:",l),console.log('Updating button to "Update Password"'),f=!0,c("Update Password");const u=document.getElementById("reset-password-btn-text");u&&(u.textContent="Update Password",console.log("Direct span update - textContent:",u.textContent)),p(),setTimeout(()=>{const w=document.getElementById("reset-password-btn"),C=document.getElementById("reset-password-btn-text");console.log("Button verification - textContent:",w?.textContent),console.log("Text span verification - textContent:",C?.textContent),C&&(C.textContent!=="Update Password"&&(C.textContent="Update Password",console.log("Forced final update")),f=!0)},100);let g=0;const I=setInterval(()=>{g++;const w=document.getElementById("reset-password-btn-text");w&&w.textContent!=="Update Password"&&f&&(console.warn('Button text was changed, fixing it back to "Update Password"'),w.textContent="Update Password"),g>=20&&clearInterval(I)},100);if(l?.user)T(l.user.email),y(`Ready to reset password for ${l.user.email}`);else{const{data:{user:w}}=await k.auth.getUser();w?(T(w.email||"your account"),y(`Ready to reset password for ${w.email||"your account"}`)):y("Ready to reset your password")}}catch(l){console.error("Exception setting session:",l),a("Error setting up session. Please try requesting a new reset link."),c("Request New Reset Link"),h(),p()}}else{const{data:{session:l}}=await k.auth.getSession();l&&l.user?(console.log("User already has a valid session"),T(l.user.email),c("Update Password"),y(`Ready to reset password for ${l.user.email}`),p()):(console.log("No tokens or session found, showing email field immediately"),c("Request New Reset Link"),h(),p(),k.auth.onAuthStateChange((R,u)=>{if(console.log("Auth state changed:",R,u?.user?.email),R==="SIGNED_IN"&&u&&u.user){console.log("User signed in via auth state change"),U(),T(u.user.email),c("Update Password");const g=document.getElementById("reset-password-btn-text");g&&(g.textContent="Update Password"),y(`Ready to reset password for ${u.user.email}`),p()}else if(R==="SIGNED_OUT"){a("Session expired. Please enter your email to request a new reset link."),c("Request New Reset Link");const g=document.getElementById("reset-password-btn-text");g&&(g.textContent="Request New Reset Link"),h()}}))}}catch(e){console.error("Error in session setup:",e),a("Error setting up password reset session. Please enter your email to request a new reset link."),c("Request New Reset Link"),h(),p()}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",b):b();P?.addEventListener("submit",async e=>{e.preventDefault();const t=new FormData(P),s=t.get("email"),o=t.get("password"),r=t.get("confirmPassword");if(i.textContent?.includes("Request New Reset Link")){if(!s){a("Please enter your email address");return}const m=i.innerHTML;i.disabled=!0,i.innerHTML=`
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Sending Reset Link...
      `;try{const{error:n}=await k.auth.resetPasswordForEmail(s,{redirectTo:`${window.location.origin}/reset-password`});if(n){console.error("Reset link error:",n),a(n.message||"Failed to send reset link");return}y("Password reset link has been sent to your email address! Please check your inbox and click the reset link."),P.reset()}catch(n){console.error("Reset link error:",n),a(n.message||"Failed to send reset link")}finally{i.disabled=!1,i.innerHTML=m}}else{if(!o||!r){a("Please fill in all fields");return}if(o.length<6){a("Password must be at least 6 characters long");return}if(o!==r){a("Passwords do not match");return}const m=i.innerHTML;i.disabled=!0,i.innerHTML=`
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Updating Password...
      `;try{const{data:{session:n},error:B}=await k.auth.getSession();if(B||!n){console.error("No valid session:",B),a("No valid session found. Please request a new password reset.");return}const{error:x}=await k.auth.updateUser({password:o});if(x){console.error("Password update error:",x),a(x.message||"Failed to update password");return}y("Password updated successfully! You can now log in with your new password."),P.reset(),window.allowPasswordResetRedirect&&window.allowPasswordResetRedirect(),setTimeout(()=>{window.location.href="/login"},3e3)}catch(n){console.error("Password update error:",n),a(n.message||"Failed to update password")}finally{i.disabled=!1,i.innerHTML=m}}});function y(e){const t=document.getElementById("success-message"),s=document.getElementById("success-text"),o=document.getElementById("error-message");t&&s&&(s.textContent=e,t.classList.remove("hidden"),o&&o.classList.add("hidden"))}function a(e){const t=document.getElementById("error-message"),s=document.getElementById("error-text"),o=document.getElementById("success-message");t&&s&&(s.textContent=e,t.classList.remove("hidden"),o&&o.classList.add("hidden"))}function p(){const e=document.getElementById("reset-password-btn");e&&(e.disabled=!1)}function S(){const e=document.getElementById("reset-password-btn");e&&(e.disabled=!0)}function c(e){const t=document.getElementById("reset-password-btn"),s=document.getElementById("reset-password-btn-text");if(t){if(f&&e!=="Update Password"&&!e.includes("Request New Reset Link")){console.log('Button text is locked to "Update Password", ignoring update to:',e);return}if(console.log("updateButtonText called with:",e),e==="Update Password"&&(f=!0,console.log('Button text locked to "Update Password"')),s){s.textContent=e,console.log("Button text updated via span:",s.textContent);return}let o=L;if(!o){const r=t.querySelector("span.absolute");r&&(o=r.outerHTML,L=o)}o?(t.innerHTML=o+'<span id="reset-password-btn-text">'+e+"</span>",console.log("Button updated with icon and new span, new innerHTML:",t.innerHTML)):(t.textContent=e,console.log("Button updated without icon, new textContent:",t.textContent)),t.offsetHeight,setTimeout(()=>{const r=t.textContent||t.innerText||"";if(console.log("Button state check - textContent:",r),!r.includes(e)&&e!=="Setting up session..."&&e!=="Checking session..."){console.warn("Button text update may have failed, forcing update...");const d=document.getElementById("reset-password-btn-text");d?d.textContent=e:t.textContent=e}},50)}else console.error("Reset button not found!")}function h(){const e=document.getElementById("email-field");e&&e.classList.remove("hidden")}function U(){const e=document.getElementById("email-field");e&&e.classList.add("hidden")}function T(e){const t=document.getElementById("email-display"),s=document.getElementById("user-email");t&&s&&(s.textContent=e,t.classList.remove("hidden"))}S();f||c("Checking session...");setTimeout(()=>{const e=document.getElementById("reset-password-btn");if(e&&!f){const t=e.textContent||e.innerText||"";(t.includes("Setting up session")||t.includes("Checking session"))&&(console.warn("Button still showing setup message after 10s, enabling fallback"),f=!1,c("Request New Reset Link"),h(),p())}},1e4);
