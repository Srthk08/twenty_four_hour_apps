import{supabase as m}from"./supabase.C3b_eKiV.js";import"./Toast.astro_astro_type_script_index_0_lang.DSPk3YYf.js";import"https://unpkg.com/@supabase/supabase-js@2";import"./index.BymsOcZI.js";import"./preload-helper.CLcXU_4U.js";const y=document.getElementById("reset-password-form"),a=document.getElementById("reset-password-btn");document.addEventListener("DOMContentLoaded",async()=>{try{console.log("üîÑ Reset password page loaded"),console.log("üìç Current URL:",window.location.href),console.log("üîó URL hash:",window.location.hash),console.log("üîç URL search:",window.location.search),console.log("üìã Initial page state:"),console.log("- Email field visible:",!document.getElementById("email-field")?.classList.contains("hidden")),console.log("- Auth buttons visible:",!document.getElementById("auth-buttons")?.classList.contains("hidden")),console.log("- User menu visible:",!document.getElementById("user-menu")?.classList.contains("hidden"));const e=new URLSearchParams(window.location.hash.substring(1)),s=e.get("access_token"),t=e.get("refresh_token"),n=e.get("type"),g=new URLSearchParams(window.location.search),L=g.get("access_token"),w=g.get("refresh_token"),o=g.get("type"),c=s||L,u=t||w,d=n||o;if(console.log("Token detection:",{hashTokens:{accessToken:s,refreshToken:t,type:n},searchTokens:{searchAccessToken:L,searchRefreshToken:w,searchType:o},finalTokens:{finalAccessToken:c,finalRefreshToken:u,finalType:d}}),c&&u&&d==="recovery"){console.log("‚úÖ Valid reset tokens detected!"),console.log("üîë Token details:",{hasAccessToken:!!c,hasRefreshToken:!!u,type:d,accessTokenLength:c.length}),l("Setting up session...");const{data:i,error:h}=await m.auth.setSession({access_token:c,refresh_token:u});if(h){console.error("‚ùå Error setting session:",h),r("Invalid or expired reset link. Please enter your email to request a new reset link."),l("Request New Reset Link"),k();return}console.log("‚úÖ Session set successfully:",i),i.user?(console.log("üë§ User data:",i.user.email),E(i.user.email),l("Update Password"),p(`Ready to reset password for ${i.user.email}`),console.log("üéØ Password update form should now be ready")):(console.log("‚ö†Ô∏è No user data in session"),l("Update Password")),R()}else{console.log("‚ùå No valid reset tokens found in URL"),console.log("üîç Token analysis:",{hasAccessToken:!!c,hasRefreshToken:!!u,type:d,expectedType:"recovery"});const{data:{session:i}}=await m.auth.getSession();i&&i.user?(console.log("‚úÖ User already has a valid session"),E(i.user.email),l("Update Password"),p(`Ready to reset password for ${i.user.email}`),R()):(console.log("‚ö†Ô∏è No session found, showing email field for new reset request"),r("No valid reset link found. Please enter your email to request a new password reset link."),l("Request New Reset Link"),k(),m.auth.onAuthStateChange((h,f)=>{console.log("üîÑ Auth state changed:",h,f?.user?.email),h==="SIGNED_IN"&&f&&f.user?(console.log("‚úÖ User signed in via auth state change"),E(f.user.email),l("Update Password"),p(`Ready to reset password for ${f.user.email}`),R(),b()):h==="SIGNED_OUT"&&(r("Session expired. Please enter your email to request a new reset link."),l("Request New Reset Link"),k())}))}}catch(e){console.error("Error in session setup:",e),r("Error setting up password reset session. Please enter your email to request a new reset link."),l("Request New Reset Link"),k()}});y?.addEventListener("submit",async e=>{e.preventDefault();const s=new FormData(y),t=s.get("email"),n=s.get("password"),g=s.get("confirmPassword");if(a.textContent?.includes("Request New Reset Link")){if(!t){r("Please enter your email address");return}const w=a.innerHTML;a.disabled=!0,a.innerHTML=`
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Sending Reset Link...
      `;try{const{error:o}=await m.auth.resetPasswordForEmail(t,{redirectTo:`${window.location.origin}/reset-password`});if(o){console.error("Reset link error:",o),r(o.message||"Failed to send reset link");return}p("Password reset link has been sent to your email address! Please check your inbox and click the reset link."),y.reset()}catch(o){console.error("Reset link error:",o),r(o.message||"Failed to send reset link")}finally{a.disabled=!1,a.innerHTML=w}}else{if(!n||!g){r("Please fill in all fields");return}if(n.length<6){r("Password must be at least 6 characters long");return}if(n!==g){r("Passwords do not match");return}const w=a.innerHTML;a.disabled=!0,a.innerHTML=`
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Updating Password...
      `;try{const{data:{session:o},error:c}=await m.auth.getSession();if(c||!o){console.error("‚ùå No valid session:",c),r("No valid session found. Please request a new password reset.");return}console.log("üîê Updating password for user:",o.user.email),console.log("üîë Password length:",n.length);const{data:u,error:d}=await m.auth.updateUser({password:n});if(d){console.error("‚ùå Password update error:",d),r(d.message||"Failed to update password");return}console.log("‚úÖ Password updated successfully:",u),p("Password updated successfully! Your new password is now active. You can log in with your new password."),y.reset(),console.log("üö™ Signing out user to force login with new password..."),await m.auth.signOut(),setTimeout(()=>{console.log("üîÑ Redirecting to login page..."),window.location.href="/login?message=password-updated"},3e3)}catch(o){console.error("Password update error:",o),r(o.message||"Failed to update password")}finally{a.disabled=!1,a.innerHTML=w}}});function p(e){const s=document.getElementById("success-message"),t=document.getElementById("success-text"),n=document.getElementById("error-message");s&&t&&(t.textContent=e,s.classList.remove("hidden"),n&&n.classList.add("hidden"))}function r(e){const s=document.getElementById("error-message"),t=document.getElementById("error-text"),n=document.getElementById("success-message");s&&t&&(t.textContent=e,s.classList.remove("hidden"),n&&n.classList.add("hidden"))}function R(){const e=document.getElementById("reset-password-btn");e&&(e.disabled=!1)}function T(){const e=document.getElementById("reset-password-btn");e&&(e.disabled=!0)}function l(e){const s=document.getElementById("reset-password-btn");s&&(s.textContent=e)}function k(){const e=document.getElementById("email-field");e&&e.classList.remove("hidden")}function b(){const e=document.getElementById("email-field");e&&e.classList.add("hidden")}function E(e){const s=document.getElementById("email-display"),t=document.getElementById("user-email");s&&t&&(t.textContent=e,s.classList.remove("hidden"))}window.testResetFlow=function(){console.log("üß™ Testing reset flow..."),console.log("Current URL:",window.location.href),console.log("Hash:",window.location.hash),console.log("Search:",window.location.search);const e={hasAccessToken:!!new URLSearchParams(window.location.hash.substring(1)).get("access_token"),hasRefreshToken:!!new URLSearchParams(window.location.hash.substring(1)).get("refresh_token"),type:new URLSearchParams(window.location.hash.substring(1)).get("type"),emailFieldVisible:!document.getElementById("email-field")?.classList.contains("hidden"),authButtonsVisible:!document.getElementById("auth-buttons")?.classList.contains("hidden"),userMenuVisible:!document.getElementById("user-menu")?.classList.contains("hidden")};console.log("üîç Debug Info:",e),alert("Check console for debug info")};if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"){const e=document.getElementById("debug-section");e&&e.classList.remove("hidden")}T();l("Setting up session...");
