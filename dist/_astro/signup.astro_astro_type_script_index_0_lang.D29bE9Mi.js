import{supabase as w}from"./supabase.DeXTyW8I.js";import"./index.9NDAT-bh.js";import"./preload-helper.BlTxHScW.js";const C=document.getElementById("signup-form"),u=document.getElementById("error-message"),i=document.getElementById("error-text"),E=document.getElementById("success-message"),b=document.getElementById("success-text"),J=document.getElementById("google-signup-btn");let $=!1;function x(e,t="info"){if(t==="error"){i&&(i.textContent=e),u?.classList.remove("hidden"),u&&(u.className="p-4 bg-red-50 border border-red-200 rounded-lg");return}b&&(b.textContent=e),E?.classList.remove("hidden"),E&&(E.className="p-4 bg-green-50 border border-green-200 rounded-lg"),u?.classList.add("hidden")}async function W(){$=!0,sessionStorage.setItem("oauth-google","1");try{x("Connecting to Google...","loading");const{data:e,error:t}=await w.auth.signInWithOAuth({provider:"google",options:{redirectTo:`${window.location.origin}/auth/callback`,queryParams:{access_type:"offline",prompt:"consent"}}});if(t){console.error("Google auth error:",t);let o=t.message;t.message.includes("Provider not found")||t.message.includes("not configured")?o="Google provider not configured. Please contact administrator.":t.message.includes("redirect_uri_mismatch")||t.message.includes("mismatch")?(o=`Redirect URI mismatch. Please add this exact URI to Google Cloud Console: ${window.location.origin}/auth/callback`,console.error("URI Mismatch Details:",{currentOrigin:window.location.origin,expectedRedirect:`${window.location.origin}/auth/callback`,error:t.message,fixInstructions:"Add the exact URI above to Google Cloud Console ‚Üí APIs & Services ‚Üí Credentials ‚Üí OAuth 2.0 Client ID ‚Üí Authorized redirect URIs"})):t.message.includes("access_denied")&&(o="Access denied. Please try again."),x(`Authentication failed: ${o}`,"error");return}x("Redirecting to Google...","loading")}catch(e){console.error("Google auth error:",e),x(`Authentication failed: ${e.message}`,"error")}}async function Z(e){try{const{data:t,error:o}=await w.rpc("sync_google_user",{p_google_id:e.user_metadata.provider_id,p_email:e.email,p_name:e.user_metadata.full_name,p_picture:e.user_metadata.avatar_url,p_provider_id:e.user_metadata.provider_id});if(o){console.error("Sync error:",o);return}return console.log("Google user synced:",t),t}catch(t){console.error("Sync error:",t)}}J?.addEventListener("click",W);w.auth.onAuthStateChange(async(e,t)=>{if(e==="SIGNED_IN"&&t?.user){const o=t.user;if(o.app_metadata.provider==="google"){if(!($||sessionStorage.getItem("oauth-google")==="1"))return;sessionStorage.removeItem("oauth-google"),x("Syncing Google account...","loading"),await Z(o),x("Successfully signed up with Google!","success");const n={...o,role:"customer"},f={user:n,access_token:t?.access_token,timestamp:Date.now()};sessionStorage.setItem("simple-auth-session",JSON.stringify(f)),localStorage.setItem("simple-auth-user",JSON.stringify(n)),window.dispatchEvent(new CustomEvent("user-logged-in",{detail:n})),sessionStorage.setItem("signup-redirect-in-progress","true"),console.log("‚úÖ Google signup successful, redirecting immediately..."),setTimeout(()=>{console.log("üîÑ Redirecting to dashboard now..."),window.location.replace("/dashboard")},300)}}});async function K(){try{console.log("üîç Checking for missing profiles...");const{data:{user:e}}=await w.auth.getUser();if(!e){console.log("‚ÑπÔ∏è No user logged in");return}const{data:t,error:o}=await w.from("profiles").select("*").eq("id",e.id).single();if(o||!t){console.log("‚ö†Ô∏è Profile missing for user, creating...");const{data:g,error:n}=await w.rpc("create_profile_for_existing_user",{user_id:e.id,user_email:e.email,user_full_name:e.user_metadata?.full_name||"",user_phone:e.user_metadata?.phone||"",user_company_name:e.user_metadata?.company_name||"",user_role:"customer"});n?console.error("‚ùå Error creating missing profile:",n):console.log("‚úÖ Missing profile created:",g)}else console.log("‚úÖ Profile exists:",t)}catch(e){console.error("‚ùå Error checking/fixing profiles:",e)}}document.addEventListener("DOMContentLoaded",function(){K();const e=document.getElementById("email"),t=document.getElementById("full_name"),o=document.getElementById("password"),g=document.getElementById("confirm_password"),n=document.getElementById("phone"),f=document.getElementById("company_name"),a=document.getElementById("admin-code-section"),h=document.getElementById("phone-error");e&&(e.value=""),t&&(t.value=""),o&&(o.value=""),g&&(g.value=""),n&&(n.value=""),f&&(f.value="");const A=document.getElementById("country_code");if(n&&A){let d=function(){return A.value},_=function(){const l=d(),L=n.value.replace(/\D/g,""),m=D[l];m&&(n.maxLength=m,n.pattern=`[0-9]{${m}}`,L.length>0&&L.length!==m?(h?.classList.remove("hidden"),h.textContent=`Please enter a valid ${m}-digit phone number for this country`,n.classList.add("border-red-500")):(L.length===m||L.length===0)&&(h?.classList.add("hidden"),n.classList.remove("border-red-500")))};const D={"+91":10,"+1":10,"+44":10,"+61":9,"+86":11,"+81":10,"+49":11,"+33":9,"+971":9,"+966":9};n.addEventListener("input",function(l){const L=l.target.value.replace(/[^0-9]/g,""),m=d(),R=D[m]||10;l.target.value=L.slice(0,R),_()}),A.addEventListener("change",function(){n.value="";const l=d();n.placeholder=l==="+91"?"9876543210":"Enter phone number",_()}),n.addEventListener("blur",_)}const I=new URLSearchParams(window.location.search).get("admin_code");if(I&&a){a.classList.remove("hidden");const d=document.getElementById("admin_code");d&&(d.value=I)}e&&(e.setAttribute("autocomplete","off"),e.setAttribute("data-lpignore","true"),e.addEventListener("blur",function(){const d=this.value.trim().toLowerCase();d?d.endsWith("@gmail.com")?/^[a-zA-Z0-9._-]+@gmail\.com$/.test(d)?(this.classList.remove("border-red-500"),this.classList.add("border-gray-300")):(this.classList.add("border-red-500"),this.classList.remove("border-gray-300")):(this.classList.add("border-red-500"),this.classList.remove("border-gray-300")):(this.classList.remove("border-red-500"),this.classList.add("border-gray-300"))}),e.addEventListener("input",function(){const d=this.value.trim().toLowerCase();d&&d.endsWith("@gmail.com")&&/^[a-zA-Z0-9._-]+@gmail\.com$/.test(d)&&(this.classList.remove("border-red-500"),this.classList.add("border-gray-300"))})),o&&o.setAttribute("autocomplete","new-password"),g&&g.setAttribute("autocomplete","new-password")});const U=new URLSearchParams(window.location.search),G=U.get("message"),j=U.get("type")||"success";G&&(j==="error"?(i&&(i.textContent=G),u?.classList.remove("hidden")):typeof window.showToast=="function"&&window.showToast(G,"success"),window.history.replaceState({},document.title,window.location.pathname));C?.addEventListener("submit",async e=>{e.preventDefault(),e.stopPropagation(),console.log("=== FORM SUBMISSION STARTED ===");const t=new FormData(C),o=t.get("email"),g=t.get("password"),n=t.get("confirm_password"),f=t.get("full_name"),a=t.get("phone"),h=t.get("company_name"),A=t.get("admin_code");if(u?.classList.add("hidden"),console.log("=== GMAIL VALIDATION START ==="),console.log("Raw email value:",o),console.log("Email type:",typeof o),!o||!o.trim()){console.log("VALIDATION FAILED: Email is empty"),i&&(i.textContent="Email address is required."),u?.classList.remove("hidden");const c=document.getElementById("email");c&&(c.classList.add("border-red-500"),c.focus());const r=C.querySelector('button[type="submit"]');r&&(r.disabled=!1),console.log("=== FORM SUBMISSION BLOCKED: Empty email ===");return}const N=o.trim(),I=N.toLowerCase();if(console.log("Email after trim and lowercase:",I),!I.endsWith("@gmail.com")){console.log("VALIDATION FAILED: Email does not end with @gmail.com"),console.log("Email value:",I),i&&(i.textContent="Please use a Gmail address (username@gmail.com format)."),u?.classList.remove("hidden");const c=document.getElementById("email");c&&(c.classList.add("border-red-500"),c.focus());const r=C.querySelector('button[type="submit"]');r&&(r.disabled=!1),console.log("=== FORM SUBMISSION BLOCKED: Not Gmail ===");return}const d=/^[a-zA-Z0-9][a-zA-Z0-9._-]*@gmail\.com$/,_=d.test(I);if(console.log("Testing email regex:",_),console.log("Email being tested:",I),!_){console.log("VALIDATION FAILED: Invalid Gmail format"),console.log("Regex pattern:",d),i&&(i.textContent="Invalid Gmail format. Please use username@gmail.com format (username must start with a letter or number and can contain letters, numbers, dots, underscores, and hyphens)."),u?.classList.remove("hidden");const c=document.getElementById("email");c&&(c.classList.add("border-red-500"),c.focus());const r=C.querySelector('button[type="submit"]');r&&(r.disabled=!1),console.log("=== FORM SUBMISSION BLOCKED: Invalid format ===");return}const D=document.getElementById("email");D&&D.classList.remove("border-red-500");const l=N;if(console.log("=== GMAIL VALIDATION PASSED ==="),console.log("Validated email:",l),console.log("=== PROCEEDING WITH FORM SUBMISSION ==="),g!==n){i&&(i.textContent="Passwords do not match."),u?.classList.remove("hidden");return}if(g.length<6){i&&(i.textContent="Password must be at least 6 characters long."),u?.classList.remove("hidden");return}const m=document.getElementById("country_code")?.value||"+91",R=a?a.replace(/\D/g,""):"",M={"+91":10,"+1":10,"+44":10,"+61":9,"+86":11,"+81":10,"+49":11,"+33":9,"+971":9,"+966":9}[m];if(M&&(!a||R.length!==M||!/^[0-9]+$/.test(R))){i&&(i.textContent=`Please enter a valid ${M}-digit phone number for this country.`),u?.classList.remove("hidden");return}const s=C.querySelector('button[type="submit"]'),P=s&&s.textContent||"Create Account";s&&(s.disabled=!0,s.innerHTML=`
        <svg class="animate-spin h-5 w-5 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      `);try{console.log("Attempting to sign up with Supabase:",l);const c=l.toLowerCase().trim();if(console.log("Final email check before Supabase:",c),!c.endsWith("@gmail.com")){console.error("CRITICAL: Email validation bypassed! Email:",c),i&&(i.textContent="Invalid email format. Only Gmail addresses are allowed."),u?.classList.remove("hidden");const y=C.querySelector('button[type="submit"]');throw y&&(y.disabled=!1,y.textContent="Create Account"),new Error("Invalid email format. Only Gmail addresses are allowed.")}console.log("Final validation passed, proceeding to Supabase signup");const{data:r,error:T}=await w.auth.signUp({email:l,password:g,options:{data:{full_name:f,phone:a?`${m}${a.replace(/\D/g,"")}`:"",company_name:h}}});if(T)throw console.error("Supabase signup error:",T),T;if(r&&r.user){console.log("‚úÖ User created successfully:",r.user.email),console.log("Session available:",!!r.session),s&&(s.disabled=!1),u?.classList.add("hidden"),b&&(b.textContent="Account created successfully! Redirecting..."),E&&(E.classList.remove("hidden"),E.style.display="block"),s&&(s.innerHTML=`
            <svg class="w-5 h-5 text-white mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
            Account Created!
          `);let y="customer";A==="ADMIN2024"&&(y="admin"),console.log("üîÑ Creating user profile in background (non-blocking)...");const V={id:r.user.id,email:l,full_name:f||"",phone:a?`${m}${a.replace(/\D/g,"")}`:"",company_name:h||"",role:y,status:"pending_verification",username:f?.toLowerCase().replace(/\s+/g,"_")||l.split("@")[0],created_at:new Date().toISOString(),updated_at:new Date().toISOString()};(async()=>{try{const{error:p}=await w.from("profiles").insert(V);if(p){console.error("‚ùå Profile creation error:",p);try{const{error:v}=await w.rpc("create_profile_for_existing_user",{user_id:r.user.id,user_email:l,user_full_name:f||"",user_phone:a?`${m}${a.replace(/\D/g,"")}`:"",user_company_name:h||"",user_role:y});v?console.error("Fallback profile creation also failed:",v):console.log("‚úÖ Profile created successfully via RPC")}catch(v){console.error("RPC call failed:",v)}}else console.log("‚úÖ Profile created successfully")}catch(p){console.error("Profile creation failed:",p)}})();const q=!0;if(r.session&&r.session.access_token){const p={...r.user,id:r.user.id,email:l,full_name:f||"",phone:a?`${m}${a.replace(/\D/g,"")}`:"",company_name:h||"",role:y,status:q?"active":"pending_verification",created_at:new Date().toISOString(),updated_at:new Date().toISOString()},v={user:p,access_token:r.session.access_token,timestamp:Date.now()};sessionStorage.setItem("simple-auth-session",JSON.stringify(v)),localStorage.setItem("simple-auth-user",JSON.stringify(p)),sessionStorage.getItem("simple-auth-session")||(console.error("‚ùå Session storage failed, retrying..."),sessionStorage.setItem("simple-auth-session",JSON.stringify(v))),window.dispatchEvent(new CustomEvent("user-logged-in",{detail:p})),b&&(b.textContent="Account created and signed in successfully! Redirecting to dashboard..."),s&&(s.innerHTML=`
              <svg class="w-5 h-5 text-white mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
              </svg>
              Success! Redirecting...
            `),console.log("‚úÖ Account created successfully, redirecting immediately..."),sessionStorage.setItem("signup-redirect-in-progress","true"),setTimeout(()=>{console.log("üîÑ Redirecting to dashboard now...");try{window.location.replace("/dashboard")}catch(k){console.error("Replace failed, trying href:",k);try{window.location.href="/dashboard"}catch(B){console.error("Href failed, trying assign:",B),window.location.assign("/dashboard")}}},300)}else{console.log("Account created successfully. No session - creating session immediately...");const p={id:r.user.id,email:l,full_name:f||"",phone:a?`${m}${a.replace(/\D/g,"")}`:"",company_name:h||"",role:y,status:"pending_verification",created_at:new Date().toISOString(),updated_at:new Date().toISOString()},v={user:p,access_token:"pending-verification-"+Date.now(),timestamp:Date.now()};sessionStorage.setItem("simple-auth-session",JSON.stringify(v)),localStorage.setItem("simple-auth-user",JSON.stringify(p)),window.dispatchEvent(new CustomEvent("user-logged-in",{detail:p})),b&&(b.textContent="Account created successfully! Redirecting..."),s&&(s.innerHTML=`
              <svg class="w-5 h-5 text-white mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
              </svg>
              Account Created! Redirecting...
            `),sessionStorage.setItem("signup-redirect-in-progress","true"),console.log("‚úÖ Account created, redirecting immediately..."),setTimeout(()=>{window.location.replace("/dashboard")},300),(async()=>{try{const{data:S,error:k}=await w.auth.signInWithPassword({email:l,password:g});if(!k&&S&&S.session){console.log("‚úÖ Background auto-login successful, updating session...");const B={...S.user,id:S.user.id,email:l,full_name:f||"",phone:a?`${m}${a.replace(/\D/g,"")}`:"",company_name:h||"",role:y,status:"active",created_at:new Date().toISOString(),updated_at:new Date().toISOString()},H={user:B,access_token:S.session.access_token,timestamp:Date.now()};sessionStorage.setItem("simple-auth-session",JSON.stringify(H)),localStorage.setItem("simple-auth-user",JSON.stringify(B)),window.dispatchEvent(new CustomEvent("user-logged-in",{detail:B}))}else console.log("Background auto-login failed, but user already has session")}catch(S){console.error("Background auto-login error:",S)}})()}}else throw new Error("Account creation failed")}catch(c){console.error("Signup error:",c),i&&(i.textContent=c.message||"An error occurred during account creation."),u&&(u.classList.remove("hidden"),u.style.display="block"),E?.classList.add("hidden"),s&&(s.disabled=!1,s.textContent=P,s.innerHTML=P)}finally{s&&(s.innerHTML.includes("animate-spin")||s.disabled)&&(s.disabled=!1,s.textContent=P,s.innerHTML=P)}});const z=document.getElementById("password"),O=document.getElementById("confirm_password"),F=()=>{O.value&&z.value!==O.value?O.setCustomValidity("Passwords do not match"):O.setCustomValidity("")};z?.addEventListener("input",F);O?.addEventListener("input",F);
