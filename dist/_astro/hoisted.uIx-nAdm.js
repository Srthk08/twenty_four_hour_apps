import{supabase as l}from"./supabase.BGdfjNZd.js";import"./ProductDialog.astro_astro_type_script_index_0_lang.C1LHbjNP.js";import"https://unpkg.com/@supabase/supabase-js@2";import"./index.BFAZBQoJ.js";const E=document.getElementById("signup-form"),m=document.getElementById("error-message"),i=document.getElementById("error-text"),y=document.getElementById("success-message"),v=document.getElementById("success-text"),R=document.getElementById("google-signup-btn");let L=!1;function w(t,e="info"){if(e==="error"){i&&(i.textContent=t),m?.classList.remove("hidden"),m&&(m.className="p-4 bg-red-50 border border-red-200 rounded-lg");return}v&&(v.textContent=t),y?.classList.remove("hidden"),y&&(y.className="p-4 bg-green-50 border border-green-200 rounded-lg"),m?.classList.add("hidden")}async function T(){L=!0,sessionStorage.setItem("oauth-google","1");try{w("Connecting to Google...","loading");const{data:t,error:e}=await l.auth.signInWithOAuth({provider:"google",options:{redirectTo:`${window.location.origin}/auth/callback`,queryParams:{access_type:"offline",prompt:"consent"}}});if(e){console.error("Google auth error:",e);let o=e.message;e.message.includes("Provider not found")||e.message.includes("not configured")?o="Google provider not configured. Please contact administrator.":e.message.includes("redirect_uri_mismatch")||e.message.includes("mismatch")?(o=`Redirect URI mismatch. Please add this exact URI to Google Cloud Console: ${window.location.origin}/auth/callback`,console.error("URI Mismatch Details:",{currentOrigin:window.location.origin,expectedRedirect:`${window.location.origin}/auth/callback`,error:e.message,fixInstructions:"Add the exact URI above to Google Cloud Console → APIs & Services → Credentials → OAuth 2.0 Client ID → Authorized redirect URIs"})):e.message.includes("access_denied")&&(o="Access denied. Please try again."),w(`Authentication failed: ${o}`,"error");return}w("Redirecting to Google...","loading")}catch(t){console.error("Google auth error:",t),w(`Authentication failed: ${t.message}`,"error")}}async function N(t){try{const{data:e,error:o}=await l.rpc("sync_google_user",{p_google_id:t.user_metadata.provider_id,p_email:t.email,p_name:t.user_metadata.full_name,p_picture:t.user_metadata.avatar_url,p_provider_id:t.user_metadata.provider_id});if(o){console.error("Sync error:",o);return}return console.log("Google user synced:",e),e}catch(e){console.error("Sync error:",e)}}R?.addEventListener("click",T);l.auth.onAuthStateChange(async(t,e)=>{if(t==="SIGNED_IN"&&e?.user){const o=e.user;if(o.app_metadata.provider==="google"){if(!(L||sessionStorage.getItem("oauth-google")==="1"))return;sessionStorage.removeItem("oauth-google"),w("Syncing Google account...","loading"),await N(o),w("Successfully signed up with Google!","success");const n={...o,role:"customer"};sessionStorage.setItem("simple-auth-session",JSON.stringify({user:n,access_token:e?.access_token,timestamp:Date.now()})),window.dispatchEvent(new CustomEvent("user-logged-in",{detail:n})),setTimeout(()=>{window.location.href="/dashboard"},1500)}}});async function U(){try{console.log("🔍 Checking for missing profiles...");const{data:{user:t}}=await l.auth.getUser();if(!t){console.log("ℹ️ No user logged in");return}const{data:e,error:o}=await l.from("profiles").select("*").eq("id",t.id).single();if(o||!e){console.log("⚠️ Profile missing for user, creating...");const{data:c,error:n}=await l.rpc("create_profile_for_existing_user",{user_id:t.id,user_email:t.email,user_full_name:t.user_metadata?.full_name||"",user_phone:t.user_metadata?.phone||"",user_company_name:t.user_metadata?.company_name||"",user_role:"customer"});n?console.error("❌ Error creating missing profile:",n):console.log("✅ Missing profile created:",c)}else console.log("✅ Profile exists:",e)}catch(t){console.error("❌ Error checking/fixing profiles:",t)}}document.addEventListener("DOMContentLoaded",function(){U();const t=document.getElementById("email"),e=document.getElementById("full_name"),o=document.getElementById("password"),c=document.getElementById("confirm_password"),n=document.getElementById("phone"),d=document.getElementById("company_name"),r=document.getElementById("admin-code-section"),g=document.getElementById("phone-error");t&&(t.value=""),e&&(e.value=""),o&&(o.value=""),c&&(c.value=""),n&&(n.value=""),d&&(d.value=""),n&&n.addEventListener("input",function(a){a.target.value=a.target.value.replace(/[^0-9]/g,""),a.target.value.length>10&&(a.target.value=a.target.value.slice(0,10)),g&&(a.target.value.length>0&&a.target.value.length!==10?g.classList.remove("hidden"):g.classList.add("hidden"))});const f=new URLSearchParams(window.location.search).get("admin_code");if(f&&r){r.classList.remove("hidden");const a=document.getElementById("admin_code");a&&(a.value=f)}t&&(t.setAttribute("autocomplete","off"),t.setAttribute("data-lpignore","true")),o&&o.setAttribute("autocomplete","new-password"),c&&c.setAttribute("autocomplete","new-password")});const A=new URLSearchParams(window.location.search),C=A.get("message"),O=A.get("type")||"success";C&&(O==="error"?(i&&(i.textContent=C),m?.classList.remove("hidden")):typeof window.showToast=="function"&&window.showToast(C,"success"),window.history.replaceState({},document.title,window.location.pathname));E?.addEventListener("submit",async t=>{t.preventDefault();const e=new FormData(E),o=e.get("email"),c=e.get("password"),n=e.get("confirm_password"),d=e.get("full_name"),r=e.get("phone"),g=e.get("company_name"),P=e.get("admin_code");if(m?.classList.add("hidden"),c!==n){i&&(i.textContent="Passwords do not match."),m?.classList.remove("hidden");return}if(c.length<6){i&&(i.textContent="Password must be at least 6 characters long."),m?.classList.remove("hidden");return}if(!r||r.length!==10||!/^[0-9]{10}$/.test(r)){i&&(i.textContent="Please enter a valid 10-digit phone number."),m?.classList.remove("hidden");return}const f=E.querySelector('button[type="submit"]'),a=f.textContent;f.disabled=!0,f.innerHTML=`
      <svg class="animate-spin h-5 w-5 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    `;try{console.log("Attempting to sign up with Supabase:",o);const{data:s,error:I}=await l.auth.signUp({email:o,password:c,options:{data:{full_name:d,phone:r?`+91${r}`:"",company_name:g}}});if(I)throw console.error("Supabase signup error:",I),I;if(s.user){console.log("User created successfully:",s.user.email);let h="customer";P==="ADMIN2024"&&(h="admin"),console.log("🔄 Creating user profile..."),await new Promise(u=>setTimeout(u,500));const{data:p,error:D}=await l.from("profiles").select("*").eq("id",s.user.id).single();if(D||!p){console.log("⚠️ Profile not found, creating manually...");const{error:u}=await l.from("profiles").insert({id:s.user.id,email:o,full_name:d||"",phone:r?`+91${r}`:"",company_name:g||"",role:h,status:"pending_verification",username:d?.toLowerCase().replace(/\s+/g,"_")||o.split("@")[0],created_at:new Date().toISOString(),updated_at:new Date().toISOString()});if(u){console.error("❌ Profile creation error:",u),console.log("🔄 Trying fallback profile creation...");const{data:G,error:b}=await l.rpc("create_profile_for_existing_user",{user_id:s.user.id,user_email:o,user_full_name:d||"",user_phone:r?`+91${r}`:"",user_company_name:g||"",user_role:h});b?console.error("❌ Function profile creation error:",b):console.log("✅ Profile created using function:",G)}else console.log("✅ Profile created successfully")}else if(console.log("✅ Profile already exists:",p),p.role!==h||p.full_name!==d){const{error:u}=await l.from("profiles").update({full_name:d||p.full_name,phone:r?`+91${r}`:p.phone,company_name:g||p.company_name,role:h,updated_at:new Date().toISOString()}).eq("id",s.user.id);u?console.error("❌ Profile update error:",u):console.log("✅ Profile updated successfully")}const{data:S,error:x}=await l.from("profiles").select("*").eq("id",s.user.id).single();if(x||!S?console.error("❌ Final profile check failed:",x):console.log("✅ Profile creation verified:",S),s.session){const u={...s.user,id:s.user.id,email:o,full_name:d||"",phone:r?`+91${r}`:"",company_name:g||"",role:h,status:"active",created_at:new Date().toISOString(),updated_at:new Date().toISOString()};sessionStorage.setItem("simple-auth-session",JSON.stringify({user:u,access_token:s.session.access_token,timestamp:Date.now()})),window.dispatchEvent(new CustomEvent("user-logged-in",{detail:u}))}v&&(v.textContent=s.session?"Account created and signed in successfully!":"Account created. Please check your email to verify your account."),y?.classList.remove("hidden"),s.session?setTimeout(()=>{window.location.href="/dashboard"},2e3):setTimeout(()=>{window.location.href="/login"},3e3)}else throw new Error("Account creation failed")}catch(s){console.error("Signup error:",s),i&&(i.textContent=s.message||"An error occurred during account creation."),m?.classList.remove("hidden")}finally{f.disabled=!1,f.textContent=a}});const B=document.getElementById("password"),_=document.getElementById("confirm_password"),k=()=>{_.value&&B.value!==_.value?_.setCustomValidity("Passwords do not match"):_.setCustomValidity("")};B?.addEventListener("input",k);_?.addEventListener("input",k);
