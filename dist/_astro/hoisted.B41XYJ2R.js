import"./MenuOperatorGuard.astro_astro_type_script_index_0_lang.DaEze9j9.js";import"./ProductDialog.astro_astro_type_script_index_0_lang.CG_DSVmw.js";import"https://unpkg.com/@supabase/supabase-js@2";import"./index.BFAZBQoJ.js";document.addEventListener("DOMContentLoaded",async()=>{console.log("üöÄ Menu Operator Profile Page Loading...");const o=sessionStorage.getItem("simple-auth-session");if(!o){console.log("‚ùå No session data found - redirecting to login"),window.location.href="/login";return}let e;try{e=JSON.parse(o)}catch{console.log("‚ùå Invalid session data - redirecting to login"),window.location.href="/login";return}if(!e.user||!e.user.email){console.log("‚ùå No user data in session - redirecting to login"),window.location.href="/login";return}console.log("‚úÖ Session found for user:",e.user.email),b(),await S()});function b(){console.log("üîç Debugging storage...");try{const o=sessionStorage.getItem("simple-auth-session");if(console.log("üì¶ SessionStorage data:",o),o){const e=JSON.parse(o);console.log("üë§ Session user:",e.user)}}catch(o){console.log("‚ùå Error reading sessionStorage:",o)}try{const o=localStorage.getItem("simple-auth-user");if(console.log("üíæ LocalStorage data:",o),o){const e=JSON.parse(o);console.log("üë§ Local user:",e)}}catch(o){console.log("‚ùå Error reading localStorage:",o)}console.log("üîó Supabase available:",typeof window.supabase<"u"),typeof window.supabase<"u"&&console.log("‚úÖ Supabase client:",window.supabase)}async function S(){try{console.log("üöÄ Starting profile load...");const o=sessionStorage.getItem("simple-auth-session");if(!o){console.log("‚ùå No session data - redirecting to login"),window.location.href="/login";return}const t=JSON.parse(o).user;if(!t||!t.email){console.log("‚ùå No user data in session - redirecting to login"),window.location.href="/login";return}if(console.log("‚úÖ User found in session:",t.email),typeof window.supabase>"u"){console.error("‚ùå Supabase client not available, using fallback data"),i(t);return}const n=window.supabase;console.log("‚úÖ Supabase client found");let l=null,r=null;try{const{data:a,error:s}=await n.from("profiles").select("*").eq("id",t.id).eq("role","menu_operator").single();l=a,r=s}catch(a){console.log("‚ö†Ô∏è Role-filtered query failed, trying fallback..."),r=a}if(r){console.log("‚ö†Ô∏è Role-filtered query failed:",r);try{const{data:a,error:s}=await n.from("profiles").select("*").eq("id",t.id).single();if(s){console.error("‚ùå Fallback profile query failed:",s),console.log("üîÑ Using fallback profile data..."),i(t);return}if(l=a,console.log("‚úÖ Fallback profile loaded:",l),l.role&&l.role.toLowerCase().trim()!=="menu_operator")if(console.log("‚ö†Ô∏è User does not have menu_operator role in database. Role:",l.role),t.role==="menu_operator"||t.role==="menu operator")console.log("‚úÖ Using session role instead of database role"),l.role="menu_operator";else{console.log("‚ùå No valid role found - redirecting to dashboard"),window.location.href="/dashboard";return}}catch(a){console.error("‚ùå Fallback query failed:",a),i(t);return}}if(l){if(l.role&&l.role.toLowerCase().trim()!=="menu_operator")if(console.log("‚ö†Ô∏è User does not have menu_operator role in database. Role:",l.role),t.role==="menu_operator"||t.role==="menu operator")console.log("‚úÖ Using session role instead of database role"),l.role="menu_operator";else{console.log("‚ùå No valid role found - redirecting to dashboard"),window.location.href="/dashboard";return}console.log("‚úÖ Profile loaded successfully:",l),u(t,l)}else console.log("‚ö†Ô∏è No profile found, using fallback data"),i(t)}catch(o){console.error("‚ùå Error loading user profile:",o),i()}}function i(o=null){console.log("üîÑ Showing fallback profile...");let e=o,t=null;if(!e){try{const n=sessionStorage.getItem("simple-auth-session");if(n){const l=JSON.parse(n);l.user&&l.access_token&&(e=l.user,console.log("‚úÖ Found user in sessionStorage:",e.email))}}catch(n){console.log("‚ö†Ô∏è Error reading sessionStorage:",n)}if(!e)try{const n=localStorage.getItem("simple-auth-user");n&&(e=JSON.parse(n),console.log("‚úÖ Found user in localStorage:",e.email))}catch(n){console.log("‚ö†Ô∏è Error reading localStorage:",n)}}if(!e){console.log("‚ùå No authenticated user found - redirecting to login"),window.location.href="/login";return}t={full_name:e.full_name||e.name||"Menu Operator",email:e.email,created_at:e.created_at||new Date().toISOString(),last_login:new Date().toISOString(),role:"menu_operator"},console.log("‚úÖ Using fallback profile:",t),u(e,t)}function u(o,e){try{const t=e.full_name||o.email,n=e.full_name?e.full_name.split(" ").map(p=>p.charAt(0)).join("").toUpperCase():o.email.charAt(0).toUpperCase(),l=document.getElementById("profile-avatar");l&&(l.textContent=n);const r=document.getElementById("profile-name");r&&(r.textContent=t);const a=document.getElementById("profile-email");a&&(a.textContent=o.email);const s=document.getElementById("profile-full-name");s&&(s.textContent=e.full_name||"Not set");const c=document.getElementById("profile-email-detail");c&&(c.textContent=o.email);const f=e.created_at?new Date(e.created_at).toLocaleDateString():new Date(o.created_at).toLocaleDateString(),m=e.last_login?new Date(e.last_login).toLocaleDateString():new Date().toLocaleDateString(),d=document.getElementById("profile-member-since");d&&(d.textContent=f);const g=document.getElementById("profile-last-login");g&&(g.textContent=m),console.log("‚úÖ Profile display updated successfully")}catch(t){console.error("Error updating profile display:",t),w("Failed to update profile display.")}}function w(o){const e=document.createElement("div");e.className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4",e.textContent=o;const t=document.querySelector(".space-y-6");t&&t.insertBefore(e,t.firstChild)}
