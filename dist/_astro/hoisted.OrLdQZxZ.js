import{supabase as f}from"./supabase.DFVW9e3y.js";import"./ProductDialog.astro_astro_type_script_index_0_lang.CpUg5vNK.js";import"https://unpkg.com/@supabase/supabase-js@2";import"./index.BymsOcZI.js";import"./preload-helper.CLcXU_4U.js";const y=document.getElementById("login-form"),p=document.getElementById("error-message"),d=document.getElementById("error-text"),m=document.getElementById("success-message"),h=document.getElementById("success-text"),S=document.getElementById("google-signin-btn");let v=!1;function u(r,o="info"){h&&(h.textContent=r),m?.classList.remove("hidden"),m?.classList.add(o),o==="success"&&setTimeout(()=>{m?.classList.add("hidden")},3e3)}async function I(){v=!0,sessionStorage.setItem("oauth-google","1");try{u("Connecting to Google...","loading");const{data:r,error:o}=await f.auth.signInWithOAuth({provider:"google",options:{redirectTo:`${window.location.origin}/auth/callback`,queryParams:{access_type:"offline",prompt:"consent"}}});if(o){console.error("Google auth error:",o);let n=o.message;o.message.includes("Provider not found")||o.message.includes("not configured")?n="Google provider not configured. Please contact administrator.":o.message.includes("redirect_uri_mismatch")||o.message.includes("mismatch")?(n=`Redirect URI mismatch. Please add this exact URI to Google Cloud Console: ${window.location.origin}/auth/callback`,console.error("URI Mismatch Details:",{currentOrigin:window.location.origin,expectedRedirect:`${window.location.origin}/auth/callback`,error:o.message,fixInstructions:"Add the exact URI above to Google Cloud Console â†’ APIs & Services â†’ Credentials â†’ OAuth 2.0 Client ID â†’ Authorized redirect URIs"})):o.message.includes("access_denied")&&(n="Access denied. Please try again."),u(`Authentication failed: ${n}`,"error");return}u("Redirecting to Google...","loading")}catch(r){console.error("Google auth error:",r),u(`Authentication failed: ${r.message}`,"error")}}async function R(r){try{const{data:o,error:n}=await f.rpc("sync_google_user",{p_google_id:r.user_metadata.provider_id,p_email:r.email,p_name:r.user_metadata.full_name,p_picture:r.user_metadata.avatar_url,p_provider_id:r.user_metadata.provider_id});if(n){console.error("Sync error:",n);return}return console.log("Google user synced:",o),o}catch(o){console.error("Sync error:",o)}}S?.addEventListener("click",I);f.auth.onAuthStateChange(async(r,o)=>{if(r==="SIGNED_IN"&&o?.user){const n=o.user;if(n.app_metadata.provider==="google"){if(!(v||sessionStorage.getItem("oauth-google")==="1"))return;sessionStorage.removeItem("oauth-google"),u("Syncing Google account...","loading"),await R(n),u("Successfully signed in with Google!","success"),setTimeout(()=>{window.location.href="/dashboard"},1500)}}});y?.addEventListener("submit",async r=>{r.preventDefault();const o=new FormData(y),n=o.get("email"),w=o.get("password");if(!n||!w){d&&(d.textContent="Please fill in all fields."),p?.classList.remove("hidden");return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n)){d&&(d.textContent="Please enter a valid email address."),p?.classList.remove("hidden");return}p?.classList.add("hidden"),m?.classList.remove("hidden");const g=y.querySelector('button[type="submit"]'),b=g.textContent;g.disabled=!0,g.innerHTML=`
      <svg class="animate-spin h-5 w-5 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    `;try{console.log("Attempting to sign in with Supabase:",n);const{data:t,error:l}=await f.auth.signInWithPassword({email:n,password:w});if(l)throw console.error("Supabase sign in error:",l),l;if(t.user){console.log("User signed in successfully:",t.user.email),sessionStorage.setItem("simple-auth-session",JSON.stringify({user:t.user,access_token:t.session?.access_token,timestamp:Date.now()})),window.dispatchEvent(new CustomEvent("user-logged-in",{detail:t.user})),h&&(h.textContent="Welcome back! Signing you in..."),m?.classList.remove("hidden");const s={id:t.user.id,email:t.user.email,full_name:t.user.email?.split("@")[0]||"User",phone:"Not set",company_name:"Not set",role:"customer"};window.dispatchEvent(new CustomEvent("user-logged-in",{detail:s})),console.log("âœ… User data sent to global auth manager:",s);const i=new URLSearchParams(window.location.search).get("redirect"),c=i||"/dashboard";console.log("ðŸ” Redirect parameter found:",i),console.log("ðŸ” Default redirect URL:",c);const _=setTimeout(()=>{console.log("âš ï¸ Fallback redirect triggered - going to:",c),window.location.href=c},3e3);try{const{data:e,error:E}=await f.from("profiles").select("role, status, full_name, phone, company_name").eq("id",t.user.id).single();let a=c;if(!E&&e){console.log("âœ… User profile found:",e),console.log("ðŸ” Role value from database:",JSON.stringify(e.role)),e.role==="admin"||e.role==="developer"||e.role==="support"?!i||i==="/dashboard"?(a="/admin",console.log(`ðŸŽ‰ ADMIN USER DETECTED: ${e.full_name} (${e.role})`),console.log(`ðŸš€ Redirecting to admin panel: ${a}`)):(a=i,console.log(`ðŸŽ‰ ADMIN USER - preserving redirect: ${a}`)):e.role&&e.role.toLowerCase().trim()==="menu_operator"?!i||i==="/dashboard"?(a="/menu-operator",console.log(`ðŸ½ï¸ MENU OPERATOR DETECTED: ${e.full_name} (${e.role})`),console.log(`ðŸš€ Redirecting to menu operator dashboard: ${a}`)):(a=i,console.log(`ðŸ½ï¸ MENU OPERATOR - preserving redirect: ${a}`)):i&&i.includes("product=")?(a=i,console.log(`âœ… Customer user - preserving product selection: ${a}`)):e.status&&e.status==="pending_verification"?(a="/dashboard?message=Please check your email to verify your account.&type=warning",console.log(`âš ï¸ Customer user with pending verification: ${e.full_name}`)):e.status&&e.status==="suspended"?(a="/dashboard?message=Your account has been suspended. Please contact support.&type=error",console.log(`âŒ Customer user suspended: ${e.full_name}`)):(a=c,console.log(`âœ… Customer user: ${e.full_name} (${e.role})`)),console.log(`ðŸŽ¯ Final redirect URL: ${a}`),s.full_name=e.full_name||s.full_name,s.phone=e.phone||s.phone,s.company_name=e.company_name||s.company_name,s.role=e.role||s.role,console.log("ðŸ” Profile data from Supabase:",{role:e.role,full_name:e.full_name,status:e.status}),console.log("ðŸ” User data before update:",{role:s.role,email:s.email});const C={user:s,access_token:t.session?.access_token,timestamp:Date.now()};sessionStorage.setItem("simple-auth-session",JSON.stringify(C)),console.log("âœ… Updated session storage with role:",s.role),console.log("ðŸ” Full user data being stored:",JSON.stringify(s,null,2)),window.dispatchEvent(new CustomEvent("user-logged-in",{detail:s}))}clearTimeout(_),setTimeout(()=>{window.location.href=a},1e3)}catch(e){console.warn("Could not fetch user profile, using redirect parameter:",e),clearTimeout(_),setTimeout(()=>{window.location.href=c},1e3)}}else throw new Error("Sign in failed - no user data returned")}catch(t){console.error("Login error:",t);let l="An error occurred during sign in.";t.message&&(t.message.includes("Invalid login credentials")?l="Invalid email or password.":t.message.includes("Email not confirmed")?l="Please check your email and confirm your account before signing in.":t.message.includes("Too many requests")?l="Too many login attempts. Please try again later.":l=t.message),d&&(d.textContent=l),p?.classList.remove("hidden"),g.disabled=!1,g.textContent=b}});
