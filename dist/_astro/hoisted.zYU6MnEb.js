import{supabase as u}from"./supabase.C3b_eKiV.js";import"./Toast.astro_astro_type_script_index_0_lang.DSPk3YYf.js";import"https://unpkg.com/@supabase/supabase-js@2";import"./index.BymsOcZI.js";import"./preload-helper.CLcXU_4U.js";const p=document.getElementById("signup-form"),r=document.getElementById("error-message"),s=document.getElementById("error-text"),x=document.getElementById("success-message"),v=document.getElementById("success-text"),A=document.getElementById("google-signup-btn");function c(t,e="info"){s&&(s.textContent=t),r?.classList.remove("hidden"),r?.classList.add(e),e==="success"&&setTimeout(()=>{r?.classList.add("hidden")},3e3)}async function S(){try{c("Connecting to Google...","loading");const{data:t,error:e}=await u.auth.signInWithOAuth({provider:"google",options:{redirectTo:`${window.location.origin}/auth/callback`,queryParams:{access_type:"offline",prompt:"consent"}}});if(e){console.error("Google auth error:",e);let o=e.message;e.message.includes("Provider not found")||e.message.includes("not configured")?o="Google provider not configured. Please contact administrator.":e.message.includes("redirect_uri_mismatch")||e.message.includes("mismatch")?(o=`Redirect URI mismatch. Please add this exact URI to Google Cloud Console: ${window.location.origin}/auth/callback`,console.error("URI Mismatch Details:",{currentOrigin:window.location.origin,expectedRedirect:`${window.location.origin}/auth/callback`,error:e.message,fixInstructions:"Add the exact URI above to Google Cloud Console → APIs & Services → Credentials → OAuth 2.0 Client ID → Authorized redirect URIs"})):e.message.includes("access_denied")&&(o="Access denied. Please try again."),c(`Authentication failed: ${o}`,"error");return}c("Redirecting to Google...","loading")}catch(t){console.error("Google auth error:",t),c(`Authentication failed: ${t.message}`,"error")}}async function b(t){try{const{data:e,error:o}=await u.rpc("sync_google_user",{p_google_id:t.user_metadata.provider_id,p_email:t.email,p_name:t.user_metadata.full_name,p_picture:t.user_metadata.avatar_url,p_provider_id:t.user_metadata.provider_id});if(o){console.error("Sync error:",o);return}return console.log("Google user synced:",e),e}catch(e){console.error("Sync error:",e)}}A?.addEventListener("click",S);u.auth.onAuthStateChange(async(t,e)=>{if(t==="SIGNED_IN"&&e?.user){const o=e.user;o.app_metadata.provider==="google"&&(c("Syncing Google account...","loading"),await b(o),c("Account created successfully! Please log in to continue.","success"),sessionStorage.removeItem("simple-auth-session"),setTimeout(()=>{window.location.href="/login"},1500))}});document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("email"),e=document.getElementById("full_name"),o=document.getElementById("password"),n=document.getElementById("confirm_password"),m=document.getElementById("phone"),a=document.getElementById("company_name");t&&(t.value=""),e&&(e.value=""),o&&(o.value=""),n&&(n.value=""),m&&(m.value=""),a&&(a.value=""),t&&(t.setAttribute("autocomplete","off"),t.setAttribute("data-lpignore","true")),o&&o.setAttribute("autocomplete","new-password"),n&&n.setAttribute("autocomplete","new-password")});const _=new URLSearchParams(window.location.search),f=_.get("message"),L=_.get("type")||"success";f&&(L==="error"?(s&&(s.textContent=f),r?.classList.remove("hidden")):typeof window.showToast=="function"&&window.showToast(f,"success"),window.history.replaceState({},document.title,window.location.pathname));p?.addEventListener("submit",async t=>{t.preventDefault();const e=new FormData(p),o=e.get("email"),n=e.get("password"),m=e.get("confirm_password"),a=e.get("full_name"),w=e.get("phone"),h=e.get("company_name");if(r?.classList.add("hidden"),n!==m){s&&(s.textContent="Passwords do not match."),r?.classList.remove("hidden");return}if(n.length<6){s&&(s.textContent="Password must be at least 6 characters long."),r?.classList.remove("hidden");return}const l=p.querySelector('button[type="submit"]'),E=l.textContent;l.disabled=!0,l.innerHTML=`
      <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Creating account...
    `;try{console.log("Attempting to sign up with Supabase:",o);const{data:i,error:g}=await u.auth.signUp({email:o,password:n,options:{data:{full_name:a,phone:w,company_name:h}}});if(g)throw console.error("Supabase signup error:",g),g;if(i.user){console.log("User created successfully:",i.user.email);const{error:y}=await u.from("profiles").insert({id:i.user.id,email:o,full_name:a||"",phone:w||"",company_name:h||"",role:"customer",status:"pending_verification",username:a?.toLowerCase().replace(/\s+/g,"_")||o.split("@")[0],created_at:new Date().toISOString(),updated_at:new Date().toISOString()});y&&console.error("Profile creation error:",y),sessionStorage.removeItem("simple-auth-session"),v&&(v.textContent="Account created successfully! Please log in to continue."),x?.classList.remove("hidden"),setTimeout(()=>{window.location.href="/login"},2e3)}else throw new Error("Account creation failed")}catch(i){console.error("Signup error:",i),s&&(s.textContent=i.message||"An error occurred during account creation."),r?.classList.remove("hidden")}finally{l.disabled=!1,l.textContent=E}});const I=document.getElementById("password"),d=document.getElementById("confirm_password"),C=()=>{d.value&&I.value!==d.value?d.setCustomValidity("Passwords do not match"):d.setCustomValidity("")};I?.addEventListener("input",C);d?.addEventListener("input",C);
