import{supabase as b}from"./supabase.DFVW9e3y.js";import"./ProductDialog.astro_astro_type_script_index_0_lang.CpUg5vNK.js";import"https://unpkg.com/@supabase/supabase-js@2";import"./AuthGuard.astro_astro_type_script_index_0_lang.DULNhCHQ.js";import"./index.BymsOcZI.js";import"./preload-helper.CLcXU_4U.js";function f(){console.log("populateUserData called");let n=null;try{const e=window.globalAuthManager||window.simpleAuthManager;e&&e.isUserLoggedIn()&&(n=e.getCurrentUser(),console.log("Found user data in global auth manager:",n))}catch(e){console.error("Error reading global auth manager:",e)}if(!n)try{const e=sessionStorage.getItem("simple-auth-session");if(e){const t=JSON.parse(e);t.user&&t.user.email&&(n=t.user,console.log("Found user data in sessionStorage:",n))}}catch(e){console.error("Error reading sessionStorage:",e)}if(!n)try{const e=localStorage.getItem("simple-auth-user");if(e){const t=JSON.parse(e);t.email&&(n=t,console.log("Found user data in localStorage:",n))}}catch(e){console.error("Error reading localStorage:",e)}if(n){console.log("Populating form with user data:",n);const e=document.getElementById("full_name"),t=document.getElementById("email"),o=document.getElementById("phone"),l=document.getElementById("company_name");if(e&&(e.value=n.full_name||n.fullName||""),o&&n.phone){const a=n.phone.toString();if(a.startsWith("+91")){const i=document.getElementById("country_code");i&&(i.value="+91"),o.value=a.substring(3).replace(/\D/g,"")}else if(a.startsWith("+")){const i=a.match(/^(\+\d{1,4})(\d+)$/);if(i){const u=document.getElementById("country_code");u&&(u.value=i[1]),o.value=i[2]}else o.value=a.replace(/\D/g,"")}else o.value=a.replace(/\D/g,"")}l&&(l.value=n.company_name||n.companyName||""),t&&(t.value=n.email||"No email available",t.readOnly=!0,t.disabled=!1,t.classList.add("bg-gray-50","cursor-not-allowed"),console.log("Email field populated with:",n.email))}else{console.log("No user data found, setting fallback values");const e=document.getElementById("email");e&&(e.value="Please log in to view email",e.readOnly=!0,e.disabled=!0,e.classList.add("bg-gray-100","cursor-not-allowed","text-gray-500"))}}function B(n){const e=document.getElementById("success-message");e&&(e.classList.remove("hidden"),setTimeout(()=>{e.classList.add("hidden")},5e3));const t=document.getElementById("update-btn");t&&(t.disabled=!1,t.innerHTML="Update Profile")}function P(n){const e=document.getElementById("password-success-message");e&&(e.classList.remove("hidden"),setTimeout(()=>{e.classList.add("hidden")},5e3))}function h(n){const e=document.getElementById("error-message"),t=document.getElementById("error-text");e&&t&&(t.textContent=n,e.classList.remove("hidden"),setTimeout(()=>{e.classList.add("hidden")},5e3))}function g(n){const e=document.getElementById("password-error-message"),t=document.getElementById("password-error-text");e&&t&&(t.textContent=n,e.classList.remove("hidden"),setTimeout(()=>{e.classList.add("hidden")},5e3))}function M(){const n=document.getElementById("country_code"),e=document.getElementById("country_code_custom"),t=document.getElementById("phone"),o=document.getElementById("phone-error");if(!n||!t)return;function l(){return n.value==="other"&&e?e.value.trim()||"+91":n.value}function a(){n.value==="other"?e&&(e.classList.remove("hidden"),e.required=!0,e.value="+"):e&&(e.classList.add("hidden"),e.required=!1,e.value="")}e&&e.addEventListener("input",function(r){let s=r.target.value;s.startsWith("+")||(s="+"+s.replace(/\+/g,"")),s=s.replace(/[^+0-9]/g,""),r.target.value=s});const i={"+91":10,"+1":10,"+44":10,"+61":9,"+86":11,"+81":10,"+49":11,"+33":9,"+971":9,"+966":9};function u(){const r=l(),s=t.value.replace(/\D/g,""),d=i[r]||15;return t.maxLength=d,t.pattern=`[0-9]{1,${d}}`,r==="+91"?s.length>0&&s.length!==10?(o?.classList.remove("hidden"),o.textContent="Please enter a valid 10-digit phone number",t.classList.add("border-red-500"),!1):(o?.classList.add("hidden"),t.classList.remove("border-red-500"),!0):s.length>0&&s.length<5?(o?.classList.remove("hidden"),o.textContent="Please enter a valid phone number (at least 5 digits)",t.classList.add("border-red-500"),!1):s.length>0&&s.length>d?(o?.classList.remove("hidden"),o.textContent=`Please enter a valid phone number (max ${d} digits)`,t.classList.add("border-red-500"),!1):(o?.classList.add("hidden"),t.classList.remove("border-red-500"),!0)}t.addEventListener("input",function(r){const s=r.target.value.replace(/\D/g,""),d=l(),p=i[d]||15;r.target.value=s.slice(0,p),u()}),n.addEventListener("change",function(){a(),t.value="";const r=l();t.placeholder=r==="+91"?"9876543210":"Enter phone number",u()}),a(),t.addEventListener("blur",u),e&&e.addEventListener("blur",u)}const L=document.getElementById("profile-form");L?.addEventListener("submit",async n=>{n.preventDefault();const e=new FormData(L),t=e.get("full_name");let o=e.get("country_code");o==="other"&&(o=e.get("country_code_custom")?.trim()||"+91");const l=e.get("phone"),a=e.get("company_name");if(!t.trim()){h("Full name is required");return}const i=document.getElementById("phone"),u=document.getElementById("country_code");if(l&&l.trim()){const d=l.replace(/\D/g,"");if((u?.value||"+91")==="+91"&&d.length!==10){h("Please enter a valid 10-digit phone number for India"),i?.focus();return}}const r=document.getElementById("update-btn"),s=r.innerHTML;r.disabled=!0,r.innerHTML=`
      <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12a8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span>Updating...</span>
    `;try{const d=window.globalAuthManager||window.simpleAuthManager,p=d?.getCurrentUser();if(!p){h("User not authenticated"),r.disabled=!1,r.innerHTML=s;return}const w=l&&l.trim()?`${o}${l.replace(/\D/g,"")}`:null,C={full_name:t.trim(),phone:w,company_name:a.trim()||null,updated_at:new Date().toISOString()};try{const c=sessionStorage.getItem("simple-auth-session");if(c){const m=JSON.parse(c);m.user&&(m.user.full_name=t.trim(),m.user.phone=w||void 0,m.user.company_name=a.trim()||void 0,sessionStorage.setItem("simple-auth-session",JSON.stringify(m)),console.log("✅ Profile updated in sessionStorage (instant)"))}}catch(c){console.warn("⚠️ SessionStorage update warning (non-critical):",c)}if(d&&typeof d.updateProfile=="function")try{const c=d.updateProfile({full_name:t.trim(),phone:w||void 0,company_name:a.trim()||void 0});c&&typeof c.then=="function"&&c.catch(m=>console.warn("Background profile update warning:",m)),console.log("✅ Profile updated in auth manager (instant)")}catch(c){console.warn("⚠️ Auth manager update warning (non-critical):",c)}const I=b.from("profiles").update(C).eq("id",p.id);B("Profile updated successfully!");const v=document.getElementById("error-message");v&&v.classList.add("hidden"),r.disabled=!1,r.innerHTML=s,window.dispatchEvent(new CustomEvent("auth-state-changed")),I.then(({error:c})=>{if(c){console.error("Supabase update error (background):",c);const m=document.getElementById("error-message"),E=document.getElementById("error-text");m&&E&&(E.textContent="Profile saved locally. Database sync failed - changes will sync on next login.",m.classList.remove("hidden"),setTimeout(()=>m.classList.add("hidden"),5e3))}else console.log("✅ Profile synced to database successfully")}).catch(c=>{console.error("Background sync error:",c)})}catch(d){console.error("Profile update error:",d),h(d.message||"Failed to update profile. Please try again."),r.disabled=!1,r.innerHTML=s}});const y=document.getElementById("password-form");y?.addEventListener("submit",async n=>{n.preventDefault();const e=new FormData(y),t=e.get("current_password"),o=e.get("new_password"),l=e.get("confirm_password");if(!t||!o||!l){g("All password fields are required");return}if(o!==l){g("New password and confirm password do not match");return}if(o.length<6){g("New password must be at least 6 characters long");return}const a=document.getElementById("change-password-btn");if(!a){console.error("Change password button not found");return}a.disabled=!0,a.innerHTML=`
      <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12a8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Changing Password...
    `;try{const u=(window.globalAuthManager||window.simpleAuthManager)?.getCurrentUser();if(!u||!u.id){g("User not authenticated. Please login again."),a.disabled=!1,a.innerHTML="Change Password";return}console.log("Changing password for user:",u.id);const{data:r,error:s}=await b.auth.updateUser({password:o});if(s){console.error("Password update error:",s),g("Failed to update password: "+s.message);return}console.log("✅ Password updated in Supabase:",r),P("Password changed successfully and permanently!"),y.reset();const d=document.getElementById("password-error-message");d&&d.classList.add("hidden"),window.dispatchEvent(new CustomEvent("auth-state-changed"))}catch(i){console.error("Password change error:",i),g(i.message||"Failed to change password")}finally{a&&(a.disabled=!1,a.innerHTML="Change Password")}});console.log("Script loaded, populating user data immediately");f();document.addEventListener("DOMContentLoaded",()=>{console.log("DOMContentLoaded event fired"),f(),M()});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{console.log("DOMContentLoaded event listener added"),f()}):(console.log("Document already loaded, populating immediately"),f());
