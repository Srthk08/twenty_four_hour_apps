(function(){try{const e=sessionStorage.getItem("simple-auth-session");let t=!1,o=null;if(e)try{const i=JSON.parse(e);i.user&&i.access_token&&i.user.email?(t=!0,o=i.user,console.log("âœ… Valid authenticated session found")):console.log("âŒ Invalid session data - missing user or token")}catch{console.log("âŒ Invalid session data format")}const n=document.createElement("style");t&&o?(n.textContent=`
          #auth-buttons, #mobile-auth-buttons { display: none !important; }
          #user-menu, #mobile-user-menu { display: flex !important; }
          #auth-loading, #mobile-auth-loading { display: none !important; }
          #user-email, #user-name, #user-avatar, #mobile-user-email { opacity: 1 !important; }
        `,setTimeout(()=>{const i=document.getElementById("user-email"),l=document.getElementById("user-name"),s=document.getElementById("user-avatar"),r=document.getElementById("mobile-user-email");i&&(i.textContent=o.email||""),l&&(l.textContent=o.full_name||o.email?.split("@")[0]||"User"),s&&(s.textContent=(o.full_name||o.email||"U").charAt(0).toUpperCase()),r&&(r.textContent=o.email||"")},0),console.log("âœ… User authenticated - showing user menu with valid data")):(n.textContent=`
          #auth-buttons, #mobile-auth-buttons { display: flex !important; }
          #user-menu, #mobile-user-menu { display: none !important; }
          #auth-loading, #mobile-auth-loading { display: none !important; }
        `,console.log("âœ… User not authenticated - showing auth buttons")),document.head.appendChild(n)}catch(e){console.error("Error setting initial navbar state:",e);const t=document.createElement("style");t.textContent=`
        #auth-buttons, #mobile-auth-buttons { display: flex !important; }
        #user-menu, #mobile-user-menu { display: none !important; }
        #auth-loading, #mobile-auth-loading { display: none !important; }
      `,document.head.appendChild(t)}})();let h=!1,g=!1;async function E(){try{console.log("Header update using global auth manager");const e=window.globalAuthManager||window.simpleAuthManager;if(!e){console.log("Global auth manager not available yet, using fallback logic"),w();return}e.updateHeader(),console.log("âœ… Header updated using global auth manager")}catch(e){console.error("Error in updateHeader:",e),w()}}function w(){console.log("Using fallback authentication logic");try{const e=sessionStorage.getItem("simple-auth-session"),t=e&&JSON.parse(e).user;let o=null;t&&(o=JSON.parse(e).user);const n=document.getElementById("auth-buttons"),i=document.getElementById("user-menu"),l=document.getElementById("mobile-auth-buttons"),s=document.getElementById("mobile-user-menu");t&&o?(n&&(n.style.display="none",n.classList.add("hidden")),i&&(i.style.display="flex",i.classList.remove("hidden")),l&&(l.style.display="none",l.classList.add("hidden")),s&&(s.style.display="block",s.classList.remove("hidden")),I(o),console.log("âœ… User logged in - showing user menu")):(n&&(n.style.display="flex",n.classList.remove("hidden")),i&&(i.style.display="none",i.classList.add("hidden")),l&&(l.style.display="block",l.classList.remove("hidden")),s&&(s.style.display="none",s.classList.add("hidden")),console.log("âœ… User not logged in - showing auth buttons")),console.log("âœ… Header updated using fallback logic")}catch(e){console.error("Error in fallback update:",e);const t=document.getElementById("auth-buttons"),o=document.getElementById("user-menu"),n=document.getElementById("mobile-auth-buttons"),i=document.getElementById("mobile-user-menu");t&&(t.style.display="flex",t.classList.remove("hidden")),o&&(o.style.display="none",o.classList.add("hidden")),n&&(n.style.display="block",n.classList.remove("hidden")),i&&(i.style.display="none",i.classList.add("hidden"))}}function I(e){if(!e||!e.email){console.log("âŒ No valid user data - clearing UI"),y();return}const t=document.getElementById("user-email"),o=document.getElementById("user-name"),n=document.getElementById("user-avatar"),i=document.getElementById("mobile-user-email");t&&(t.textContent=e.email||""),o&&(o.textContent=e.full_name||e.email?.split("@")[0]||"User"),n&&(n.textContent=(e.full_name||e.email||"U").charAt(0).toUpperCase()),i&&(i.textContent=e.email||""),m(e)}function y(){const e=document.getElementById("user-email"),t=document.getElementById("user-name"),o=document.getElementById("user-avatar"),n=document.getElementById("mobile-user-email");e&&(e.textContent=""),t&&(t.textContent="Guest"),o&&(o.textContent="G"),n&&(n.textContent="")}function m(e){if(!e||!e.email){console.log("âŒ No valid user data - hiding role-based links"),B();return}if(!e.role||e.role==="user"){console.log("âš ï¸ Role not available in session, attempting to fetch from Supabase..."),v(e);return}window.currentUserRole=e.role,console.log("ðŸ”’ Stored user role globally:",window.currentUserRole);const t=document.getElementById("menu-operator-link"),o=document.getElementById("mobile-menu-operator-link"),n=document.getElementById("admin-panel-link"),i=document.getElementById("mobile-admin-panel-link"),l=document.getElementById("profile-link"),s=document.getElementById("mobile-profile-link"),r=document.getElementById("dashboard-link"),a=document.getElementById("mobile-dashboard-link"),d=document.querySelector('#user-dropdown a[href="/orders"]'),u=document.querySelector('#mobile-user-menu a[href="/orders"]');console.log("ðŸ” Checking user role:",e.role,"for user:",e.email),e.role==="menu_operator"||e.role==="menu operator"?(t&&(t.classList.remove("hidden"),t.style.display="block"),o&&(o.classList.remove("hidden"),o.style.display="block"),r&&(r.classList.add("hidden"),r.style.display="none"),a&&(a.classList.add("hidden"),a.style.display="none"),d&&(d.classList.add("hidden"),d.style.display="none"),u&&(u.classList.add("hidden"),u.style.display="none"),l&&(l.href="/menu-operator/profile",l.setAttribute("href","/menu-operator/profile")),s&&(s.href="/menu-operator/profile",s.setAttribute("href","/menu-operator/profile"))):(t&&(t.classList.add("hidden"),t.style.display="none"),o&&(o.classList.add("hidden"),o.style.display="none"),r&&(r.classList.remove("hidden"),r.style.display="flex"),a&&(a.classList.remove("hidden"),a.style.display="flex"),d&&(d.classList.remove("hidden"),d.style.display="flex"),u&&(u.classList.remove("hidden"),u.style.display="flex"),l&&(l.href="/profile"),s&&(s.href="/profile")),e.role==="admin"||e.role==="administrator"?(n&&(n.classList.remove("hidden"),n.style.display="block"),i&&(i.classList.remove("hidden"),i.style.display="block")):(n&&(n.classList.add("hidden"),n.style.display="none"),i&&(i.classList.add("hidden"),i.style.display="none"))}async function v(e){try{if(typeof window.supabase>"u"){console.log("âŒ Supabase not available, using fallback role"),p(e);return}const t=window.supabase,{data:o,error:n}=await t.from("profiles").select("role").eq("id",e.id).single();if(n){console.log("âŒ Error fetching role from Supabase:",n),p(e);return}if(o&&o.role){console.log("âœ… Role fetched from Supabase:",o.role),e.role=o.role;const i=sessionStorage.getItem("simple-auth-session");if(i){const l=JSON.parse(i);l.user.role=o.role,sessionStorage.setItem("simple-auth-session",JSON.stringify(l))}m(e)}else console.log("âš ï¸ No role found in profile, using fallback"),p(e)}catch(t){console.error("âŒ Error fetching role from Supabase:",t),p(e)}}function p(e){console.log("ðŸ”„ Using fallback role-based link update"),e.role=e.role||"customer",m(e)}function c(){const e=document.getElementById("profile-link"),t=document.getElementById("mobile-profile-link");!e||!t||(window.currentUserRole?(console.log("ðŸ”’ Maintaining profile links with stored role:",window.currentUserRole),window.currentUserRole==="menu_operator"||window.currentUserRole==="menu operator"?(e.href!=="/menu-operator/profile"&&(e.href="/menu-operator/profile",e.setAttribute("href","/menu-operator/profile"),console.log("ðŸ”§ Fixed desktop profile link to menu operator profile")),t.href!=="/menu-operator/profile"&&(t.href="/menu-operator/profile",t.setAttribute("href","/menu-operator/profile"),console.log("ðŸ”§ Fixed mobile profile link to menu operator profile"))):(e.href!=="/profile"&&(e.href="/profile",e.setAttribute("href","/profile"),console.log("ðŸ”§ Fixed desktop profile link to regular profile")),t.href!=="/profile"&&(t.href="/profile",t.setAttribute("href","/profile"),console.log("ðŸ”§ Fixed mobile profile link to regular profile")))):window.location.pathname.includes("/menu-operator")&&(e.href!=="/menu-operator/profile"&&(e.href="/menu-operator/profile",e.setAttribute("href","/menu-operator/profile"),console.log("ðŸ”§ Fixed profile link based on current page context")),t.href!=="/menu-operator/profile"&&(t.href="/menu-operator/profile",t.setAttribute("href","/menu-operator/profile"),console.log("ðŸ”§ Fixed mobile profile link based on current page context"))))}function B(){const e=document.getElementById("menu-operator-link"),t=document.getElementById("mobile-menu-operator-link"),o=document.getElementById("admin-panel-link"),n=document.getElementById("mobile-admin-panel-link");e&&(e.classList.add("hidden"),e.style.display="none"),t&&(t.classList.add("hidden"),t.style.display="none"),o&&(o.classList.add("hidden"),o.style.display="none"),n&&(n.classList.add("hidden"),n.style.display="none")}function f(){console.log("Setting initial UI state - checking auth state"),M()?(U(),console.log("âœ… User authenticated - showing user menu")):(A(),console.log("âœ… User not authenticated - showing auth buttons"))}function M(){try{const e=sessionStorage.getItem("simple-auth-session");return e&&JSON.parse(e).user}catch(e){return console.error("Error checking auth state:",e),!1}}function U(){const e=document.getElementById("auth-buttons"),t=document.getElementById("user-menu"),o=document.getElementById("mobile-auth-buttons"),n=document.getElementById("mobile-user-menu"),i=document.createElement("style");i.textContent=`
            #auth-buttons, #mobile-auth-buttons { display: none !important; }
            #user-menu { display: flex !important; }
            #mobile-user-menu { display: block !important; }
          `,document.head.appendChild(i),e&&(e.style.display="none !important",e.classList.add("hidden")),t&&(t.style.display="flex !important",t.classList.remove("hidden")),o&&(o.style.display="none !important",o.classList.add("hidden")),n&&(n.style.display="block !important",n.classList.remove("hidden")),x(),console.log("âœ… User menu shown, auth buttons hidden")}function A(){const e=document.getElementById("auth-buttons"),t=document.getElementById("user-menu"),o=document.getElementById("mobile-auth-buttons"),n=document.getElementById("mobile-user-menu"),i=document.createElement("style");i.textContent=`
            #auth-buttons { display: flex !important; opacity: 1 !important; transition: none !important; visibility: visible !important; }
            #mobile-auth-buttons { display: block !important; opacity: 1 !important; transition: none !important; visibility: visible !important; }
            #auth-buttons a, #mobile-auth-buttons a { opacity: 1 !important; transition: none !important; visibility: visible !important; }
            #user-menu, #mobile-user-menu { display: none !important; }
          `,document.head.appendChild(i),e&&(e.style.display="flex !important",e.style.opacity="1 !important",e.style.transition="none !important",e.style.visibility="visible !important",e.classList.remove("hidden"),e.querySelectorAll("a").forEach(s=>{s.style.opacity="1 !important",s.style.transition="none !important",s.style.visibility="visible !important"})),t&&(t.style.display="none !important",t.classList.add("hidden")),o&&(o.style.display="block !important",o.style.opacity="1 !important",o.style.transition="none !important",o.style.visibility="visible !important",o.classList.remove("hidden"),o.querySelectorAll("a").forEach(s=>{s.style.opacity="1 !important",s.style.transition="none !important",s.style.visibility="visible !important"})),n&&(n.style.display="none !important",n.classList.add("hidden")),console.log("âœ… Auth buttons shown, user menu hidden")}function x(){try{const e=sessionStorage.getItem("simple-auth-session");if(e){const t=JSON.parse(e),o=t.user;if(o&&t.access_token&&o.email){const n=document.getElementById("user-email"),i=document.getElementById("user-name"),l=document.getElementById("user-avatar"),s=document.getElementById("mobile-user-email");n&&(n.textContent=o.email||"",n.style.opacity="1"),i&&(i.textContent=o.full_name||o.email?.split("@")[0]||"User",i.style.opacity="1"),l&&(l.textContent=(o.full_name||o.email||"U").charAt(0).toUpperCase(),l.style.opacity="1"),s&&(s.textContent=o.email||"",s.style.opacity="1"),console.log("ðŸ” User data in updateUserInfoFromSession:",{email:o.email,role:o.role,full_name:o.full_name,id:o.id}),console.log("ðŸ” Full session data:",JSON.stringify(t,null,2)),m(o)}else console.log("âŒ Invalid session - clearing user info"),y()}else console.log("âŒ No session data - clearing user info"),y()}catch(e){console.error("Error updating user info:",e),y()}}function S(){const e=document.getElementById("user-menu-button"),t=document.getElementById("user-dropdown"),o=document.getElementById("user-menu-arrow");e&&t&&o&&(e.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),C()}),document.addEventListener("click",n=>{!e.contains(n.target)&&!t.contains(n.target)&&L()}))}function C(){const e=document.getElementById("user-dropdown"),t=document.getElementById("user-menu-arrow");e&&t&&(h=!h,h?(e.classList.remove("hidden"),t.style.transform="rotate(180deg)"):(e.classList.add("hidden"),t.style.transform="rotate(0deg)"))}function L(){const e=document.getElementById("user-dropdown"),t=document.getElementById("user-menu-arrow");e&&t&&(e.classList.add("hidden"),t.style.transform="rotate(0deg)",h=!1)}window.signOut=async function(){try{console.log("Sign out clicked - using global auth manager");const e=window.globalAuthManager||window.simpleAuthManager;e?e.logout():window.location.href="/"}catch(e){console.error("Sign out error:",e),window.location.href="/"}};function O(){const e=document.getElementById("mobile-menu-button"),t=document.getElementById("mobile-menu"),o=document.getElementById("mobile-menu-icon");e&&t&&o&&(e.addEventListener("click",()=>{D()}),document.addEventListener("click",i=>{!e.contains(i.target)&&!t.contains(i.target)&&b()}),document.addEventListener("keydown",i=>{i.key==="Escape"&&!t.classList.contains("hidden")&&b()}),t.querySelectorAll("a, button").forEach(i=>{i.addEventListener("click",()=>{setTimeout(()=>{b()},100)})}))}function D(){const e=document.getElementById("mobile-menu"),t=document.getElementById("mobile-menu-icon");e&&t&&(g=!g,g?(e.classList.remove("hidden"),t.style.transform="rotate(90deg)",t.innerHTML=`
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        `):(e.classList.add("hidden"),t.style.transform="rotate(0deg)",t.innerHTML=`
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        `))}function b(){const e=document.getElementById("mobile-menu"),t=document.getElementById("mobile-menu-icon");e&&t&&(e.classList.add("hidden"),t.style.transform="rotate(0deg)",t.innerHTML=`
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
      `,g=!1)}function k(){const e=document.getElementById("dashboard-link"),t=document.getElementById("mobile-dashboard-link");function o(n){if(n){const i=new URLSearchParams(window.location.search),l=i.get("product"),s=i.get("price");l&&s?(n.href=`/dashboard?product=${l}&price=${s}`,console.log("ðŸ”— Dashboard link updated with parameters:",n.href)):n.href="/dashboard"}}o(e),o(t),e&&e.addEventListener("click",n=>{if(n.preventDefault(),window.location.pathname==="/dashboard"){window.scrollTo({top:0,behavior:"smooth"});return}const i=new URLSearchParams(window.location.search),l=i.get("product"),s=i.get("price");setTimeout(()=>{l&&s?window.location.href=`/dashboard?product=${l}&price=${s}`:window.location.href="/dashboard"},150)}),t&&t.addEventListener("click",n=>{if(n.preventDefault(),window.location.pathname==="/dashboard"){window.scrollTo({top:0,behavior:"smooth"});return}const i=new URLSearchParams(window.location.search),l=i.get("product"),s=i.get("price");setTimeout(()=>{l&&s?window.location.href=`/dashboard?product=${l}&price=${s}`:window.location.href="/dashboard"},150)})}function P(){const e=document.getElementById("profile-link"),t=document.getElementById("mobile-profile-link");e&&e.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),L();const n=e.getAttribute("href")||"/profile";window.location.href=n}),t&&t.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),b();const n=t.getAttribute("href")||"/profile";window.location.href=n})}document.addEventListener("DOMContentLoaded",()=>{console.log("Header initializing with fallback support"),f(),S(),O(),k(),P(),setTimeout(()=>{console.log("ðŸ”„ Force refreshing role-based links...");const t=sessionStorage.getItem("simple-auth-session");if(t)try{const o=JSON.parse(t);o.user&&o.user.email&&(console.log("ðŸ”„ Refreshing links for user:",o.user.email,"with role:",o.user.role),m(o.user))}catch(o){console.log("âš ï¸ Error refreshing role-based links:",o)}},1e3),setTimeout(()=>{console.log("ðŸš¨ IMMEDIATE PROFILE LINK FIX...");const t=sessionStorage.getItem("simple-auth-session");if(t)try{const o=JSON.parse(t);if(o.user&&o.user.email){console.log("ðŸš¨ Immediate fix for user:",o.user.email,"role:",o.user.role);const n=document.getElementById("profile-link"),i=document.getElementById("mobile-profile-link"),l=window.location.pathname.includes("/menu-operator"),s=o.user.role==="menu_operator"||o.user.role==="menu operator";console.log("ðŸ” Context check:",{isOnMenuOperatorPage:l,hasMenuOperatorRole:s,currentPath:window.location.pathname,userRole:o.user.role}),s||l?(n&&(n.href="/menu-operator/profile",n.setAttribute("href","/menu-operator/profile"),console.log("âœ… Updated desktop profile link to menu operator profile")),i&&(i.href="/menu-operator/profile",i.setAttribute("href","/menu-operator/profile"),console.log("âœ… Updated mobile profile link to menu operator profile"))):(n&&(n.href="/profile",n.setAttribute("href","/profile"),console.log("âœ… Updated desktop profile link to regular profile")),i&&(i.href="/profile",i.setAttribute("href","/profile"),console.log("âœ… Updated mobile profile link to regular profile"))),c()}}catch(o){console.log("âš ï¸ Error in immediate profile link fix:",o)}},100);const e=()=>{const t=window.globalAuthManager||window.simpleAuthManager;t?(console.log("Global auth manager found, updating header"),t.updateHeader()):setTimeout(e,200)};setTimeout(e,100),window.addEventListener("popstate",()=>{console.log("Navigation detected - updating header state"),f(),k(),c()}),document.addEventListener("visibilitychange",()=>{document.hidden||(console.log("Page visible - updating header state"),f(),k(),c())}),window.addEventListener("focus",()=>{console.log("Window focused - updating header state"),f(),c()}),setInterval(()=>{c()},2e3),console.log("âœ… Header initialized with fallback support")});window.addEventListener("load",()=>{console.log("Window loaded, ensuring header is properly initialized"),w()});window.addEventListener("user-logged-in",()=>{console.log("User logged in event received in header"),E()});window.addEventListener("user-logged-out",()=>{console.log("User logged out event received in header"),E()});
