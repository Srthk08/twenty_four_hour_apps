import{supabase as C}from"./supabase.DeXTyW8I.js";import"./index.9NDAT-bh.js";import"./preload-helper.BlTxHScW.js";function y(){console.log("populateUserData called");let n=null;try{const e=window.globalAuthManager||window.simpleAuthManager;e&&e.isUserLoggedIn()&&(n=e.getCurrentUser(),console.log("Found user data in global auth manager:",n))}catch(e){console.error("Error reading global auth manager:",e)}if(!n)try{const e=sessionStorage.getItem("simple-auth-session");if(e){const t=JSON.parse(e);t.user&&t.user.email&&(n=t.user,console.log("Found user data in sessionStorage:",n))}}catch(e){console.error("Error reading sessionStorage:",e)}if(!n)try{const e=localStorage.getItem("simple-auth-user");if(e){const t=JSON.parse(e);t.email&&(n=t,console.log("Found user data in localStorage:",n))}}catch(e){console.error("Error reading localStorage:",e)}if(n){console.log("Populating form with user data:",n);const e=document.getElementById("full_name"),t=document.getElementById("email"),u=document.getElementById("phone"),m=document.getElementById("company_name");if(e&&(e.value=n.full_name||n.fullName||""),u&&n.phone){const o=n.phone.toString().trim(),d=document.getElementById("country_code"),g=["+971","+966","+91","+86","+81","+61","+49","+44","+33","+1"];if(o.startsWith("+")){let r=!1,a="",s="";if(d){const l=Array.from(d.options).map(c=>c.value).sort((c,v)=>v.length-c.length);for(const c of l)if(o.startsWith(c)){a=c,s=o.substring(c.length),r=!0;break}}if(!r){for(const l of g)if(o.startsWith(l)){a=l,s=o.substring(l.length),r=!0;break}}if(!r){const l=o.match(/^(\+\d{1,4})(\d+)$/);l&&(a=l[1],s=l[2],r=!0)}r&&a&&s?(d&&(Array.from(d.options).some(c=>c.value===a)?d.value=a:d.value="+91"),u.value=s.replace(/\D/g,"")):(console.warn("Could not parse phone number:",o),u.value=o.replace(/\D/g,""))}else u.value=o.replace(/\D/g,"")}m&&(m.value=n.company_name||n.companyName||""),t&&(t.value=n.email||"No email available",t.readOnly=!0,t.disabled=!1,t.classList.add("bg-gray-50","cursor-not-allowed"),console.log("Email field populated with:",n.email))}else{console.log("No user data found, setting fallback values");const e=document.getElementById("email");e&&(e.value="Please log in to view email",e.readOnly=!0,e.disabled=!0,e.classList.add("bg-gray-100","cursor-not-allowed","text-gray-500"))}}function B(n){const e=document.getElementById("success-message");e&&(e.classList.remove("hidden"),setTimeout(()=>{e.classList.add("hidden")},5e3));const t=document.getElementById("update-btn");t&&(t.disabled=!1,t.innerHTML="Update Profile")}function M(n){const e=document.getElementById("password-success-message");e&&(e.classList.remove("hidden"),setTimeout(()=>{e.classList.add("hidden")},5e3))}function w(n){const e=document.getElementById("error-message"),t=document.getElementById("error-text");e&&t&&(t.textContent=n,e.classList.remove("hidden"),setTimeout(()=>{e.classList.add("hidden")},5e3))}function h(n){const e=document.getElementById("password-error-message"),t=document.getElementById("password-error-text");e&&t&&(t.textContent=n,e.classList.remove("hidden"),setTimeout(()=>{e.classList.add("hidden")},5e3))}function P(){const n=document.getElementById("country_code"),e=document.getElementById("phone"),t=document.getElementById("phone-error");if(!n||!e)return;function u(){return n.value}const m={"+91":10,"+1":10,"+44":10,"+61":9,"+86":11,"+81":10,"+49":11,"+33":9,"+971":9,"+966":9};function o(){const g=u(),r=e.value.replace(/\D/g,""),a=m[g]||10;return e.maxLength=a,e.pattern=`[0-9]{1,${a}}`,g==="+91"?r.length>0&&r.length!==10?(t?.classList.remove("hidden"),t.textContent="Please enter a valid 10-digit phone number",e.classList.add("border-red-500"),!1):(t?.classList.add("hidden"),e.classList.remove("border-red-500"),!0):r.length>0&&r.length!==a?(t?.classList.remove("hidden"),t.textContent=`Please enter a valid ${a}-digit phone number`,e.classList.add("border-red-500"),!1):(t?.classList.add("hidden"),e.classList.remove("border-red-500"),!0)}let d=!1;e.addEventListener("focus",function(){d=!0}),e.addEventListener("blur",function(){d=!1}),e.addEventListener("input",function(g){if(d){const r=g.target.value.replace(/\D/g,""),a=u(),s=m[a]||10;g.target.value=r.slice(0,s),o()}}),n.addEventListener("change",function(){(d||e===document.activeElement)&&(e.value="");const g=u();e.placeholder=g==="+91"?"9876543210":"Enter phone number",o()}),e.addEventListener("blur",o)}const L=document.getElementById("profile-form");L?.addEventListener("submit",async n=>{n.preventDefault();const e=new FormData(L),t=e.get("full_name"),u=e.get("country_code")||"+91",m=e.get("phone"),o=e.get("company_name");if(!t.trim()){w("Full name is required");return}const d=document.getElementById("phone"),g=document.getElementById("country_code");if(m&&m.trim()){const s=m.replace(/\D/g,"");if((g?.value||"+91")==="+91"&&s.length!==10){w("Please enter a valid 10-digit phone number for India"),d?.focus();return}}const r=document.getElementById("update-btn"),a=r.innerHTML;r.disabled=!0,r.innerHTML=`
      <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12a8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span>Updating...</span>
    `;try{const s=window.globalAuthManager||window.simpleAuthManager,l=s?.getCurrentUser();if(!l){w("User not authenticated"),r.disabled=!1,r.innerHTML=a;return}const c=m&&m.trim()?`${u}${m.replace(/\D/g,"")}`:null,v={full_name:t.trim(),phone:c,company_name:o.trim()||null,updated_at:new Date().toISOString()};try{const i=sessionStorage.getItem("simple-auth-session");if(i){const p=JSON.parse(i);p.user&&(p.user.full_name=t.trim(),p.user.phone=c||void 0,p.user.company_name=o.trim()||void 0,sessionStorage.setItem("simple-auth-session",JSON.stringify(p)),console.log("✅ Profile updated in sessionStorage (instant)"))}const f={...l,full_name:t.trim(),phone:c||void 0,company_name:o.trim()||void 0};localStorage.setItem("simple-auth-user",JSON.stringify(f)),console.log("✅ Profile updated in localStorage (instant)")}catch(i){console.warn("⚠️ SessionStorage update warning (non-critical):",i)}if(s){if(s.currentUser&&(s.currentUser.full_name=t.trim(),s.currentUser.phone=c||void 0,s.currentUser.company_name=o.trim()||void 0,console.log("✅ Auth manager currentUser updated")),typeof s.handleLogin=="function"){const i={...l,full_name:t.trim(),phone:c||void 0,company_name:o.trim()||void 0};s.handleLogin(i),console.log("✅ Auth manager state refreshed via handleLogin")}else if(typeof s.updateProfile=="function")try{const i=s.updateProfile({full_name:t.trim(),phone:c||void 0,company_name:o.trim()||void 0});i&&typeof i.then=="function"&&i.catch(f=>console.warn("Background profile update warning:",f)),console.log("✅ Profile updated in auth manager (instant)")}catch(i){console.warn("⚠️ Auth manager update warning (non-critical):",i)}}const I=C.from("profiles").update(v).eq("id",l.id);B("Profile updated successfully!");const b=document.getElementById("error-message");b&&b.classList.add("hidden"),r.disabled=!1,r.innerHTML=a,window.dispatchEvent(new CustomEvent("auth-state-changed")),I.then(({error:i})=>{if(i){console.error("Supabase update error (background):",i);const f=document.getElementById("error-message"),p=document.getElementById("error-text");f&&p&&(p.textContent="Profile saved locally. Database sync failed - changes will sync on next login.",f.classList.remove("hidden"),setTimeout(()=>f.classList.add("hidden"),5e3))}else console.log("✅ Profile synced to database successfully")}).catch(i=>{console.error("Background sync error:",i)})}catch(s){console.error("Profile update error:",s),w(s.message||"Failed to update profile. Please try again."),r.disabled=!1,r.innerHTML=a}});const E=document.getElementById("password-form");E?.addEventListener("submit",async n=>{n.preventDefault();const e=new FormData(E),t=e.get("current_password"),u=e.get("new_password"),m=e.get("confirm_password");if(!t||!u||!m){h("All password fields are required");return}if(u!==m){h("New password and confirm password do not match");return}if(u.length<6){h("New password must be at least 6 characters long");return}const o=document.getElementById("change-password-btn");if(!o){console.error("Change password button not found");return}o.disabled=!0,o.innerHTML=`
      <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12a8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Changing Password...
    `;try{const g=(window.globalAuthManager||window.simpleAuthManager)?.getCurrentUser();if(!g||!g.id){h("User not authenticated. Please login again."),o.disabled=!1,o.innerHTML="Change Password";return}console.log("Changing password for user:",g.id);const{data:r,error:a}=await C.auth.updateUser({password:u});if(a){console.error("Password update error:",a),h("Failed to update password: "+a.message);return}console.log("✅ Password updated in Supabase:",r),M("Password changed successfully and permanently!"),E.reset();const s=document.getElementById("password-error-message");s&&s.classList.add("hidden"),window.dispatchEvent(new CustomEvent("auth-state-changed"))}catch(d){console.error("Password change error:",d),h(d.message||"Failed to change password")}finally{o&&(o.disabled=!1,o.innerHTML="Change Password")}});console.log("Script loaded, populating user data immediately");y();document.addEventListener("DOMContentLoaded",()=>{console.log("DOMContentLoaded event fired"),y(),P()});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{console.log("DOMContentLoaded event listener added"),y()}):(console.log("Document already loaded, populating immediately"),y());
