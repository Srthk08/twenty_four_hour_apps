import{c as w}from"./index.BymsOcZI.js";import"./preload-helper.CLcXU_4U.js";const l={ASSETS_PREFIX:void 0,BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SITE:void 0,SSR:!1};var d={};const g={url:"https://lmrrdcaavwwletcjcpqv.supabase.co",anonKey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxtcnJkY2Fhdnd3bGV0Y2pjcHF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MDQ0ODgsImV4cCI6MjA3MTA4MDQ4OH0.AU59Qfr6K9i880Gcn5y-3pjCf8PXsDIq4OI0-lPQVuQ"},h=n=>typeof import.meta<"u"&&l&&l[n]?l[n]:typeof process<"u"&&d&&d[n]?d[n]:typeof window<"u"&&window.__ENV__&&window.__ENV__[n]?window.__ENV__[n]:"",p=h("VITE_SUPABASE_URL")||g.url,_=h("VITE_SUPABASE_ANON_KEY")||g.anonKey;console.log("Environment Detection:",{hasImportMeta:typeof import.meta<"u",hasProcess:typeof process<"u",hasWindow:typeof window<"u",importMetaEnv:typeof import.meta<"u"?Object.keys(l||{}):"N/A",processEnv:typeof process<"u"?Object.keys(d||{}).filter(n=>n.includes("SUPABASE")):"N/A"});console.log("Supabase Configuration:",{url:"✅ Set",key:"✅ Set",source:h("VITE_SUPABASE_URL")?"Environment Variables":"Hardcoded Config"});const o=w(p,_);class u{constructor(){this.currentUser=null,this.currentSession=null,this.initializeAuth()}static getInstance(){return u.instance||(u.instance=new u),u.instance}async initializeAuth(){try{const{data:{session:r}}=await o.auth.getSession();r&&(this.currentSession=r,await this.loadUserProfile(r.user.id)),o.auth.onAuthStateChange(async(e,t)=>{console.log("Auth state changed:",e,t?.user?.email),e==="SIGNED_IN"&&t?(this.currentSession=t,await this.loadUserProfile(t.user.id),this.dispatchAuthEvent("auth-state-changed")):e==="SIGNED_OUT"?(this.currentUser=null,this.currentSession=null,this.dispatchAuthEvent("auth-state-changed")):e==="TOKEN_REFRESHED"&&t&&(this.currentSession=t,await this.loadUserProfile(t.user.id))})}catch(r){console.error("Error initializing auth:",r)}}async loadUserProfile(r){try{const{data:e,error:t}=await o.from("profiles").select("*").eq("id",r).single();if(t){console.error("Error loading user profile:",t);return}this.currentUser=e,console.log("User profile loaded:",e.email)}catch(e){console.error("Error in loadUserProfile:",e)}}dispatchAuthEvent(r){typeof window<"u"&&window.dispatchEvent(new CustomEvent(r))}async signUp(r,e,t){try{console.log("Signing up user:",r);const{data:s,error:a}=await o.auth.signUp({email:r,password:e,options:{data:{full_name:t.full_name,phone:t.phone,company_name:t.company_name}}});if(a)throw console.error("Auth signup error:",a),a;if(s.user){console.log("User created in auth:",s.user.id);const{error:c}=await o.from("profiles").insert({id:s.user.id,email:r,full_name:t.full_name||"",phone:t.phone||"",company_name:t.company_name||"",role:t.role||"customer",status:"pending_verification",username:t.username||t.full_name?.toLowerCase().replace(/\s+/g,"_"),created_at:new Date().toISOString(),updated_at:new Date().toISOString()});if(c)throw console.error("Profile creation error:",c),await o.auth.admin.deleteUser(s.user.id),c;return await this.logUserActivity(s.user.id,"user_signup",{email:r,full_name:t.full_name}),console.log("User profile created successfully"),s}throw new Error("Failed to create user")}catch(s){throw console.error("Signup error:",s),s}}async signIn(r,e){try{console.log("Signing in user:",r);const{data:t,error:s}=await o.auth.signInWithPassword({email:r,password:e});if(s)throw console.error("Sign in error:",s),s;if(t.user)return console.log("User signed in:",t.user.email),await this.loadUserProfile(t.user.id),await this.updateLoginInfo(t.user.id),await this.logUserActivity(t.user.id,"user_login",{email:r,ip_address:await this.getClientIP()}),this.dispatchAuthEvent("auth-state-changed"),t;throw new Error("Sign in failed")}catch(t){throw console.error("Sign in error:",t),t}}async signOut(){try{this.currentUser&&await this.logUserActivity(this.currentUser.id,"user_logout",{email:this.currentUser.email});const{error:r}=await o.auth.signOut();if(r)throw console.error("Sign out error:",r),r;this.currentUser=null,this.currentSession=null,this.dispatchAuthEvent("auth-state-changed"),console.log("User signed out successfully")}catch(r){throw console.error("Sign out error:",r),r}}async getCurrentUser(){try{if(this.currentUser)return this.currentUser;const{data:{user:r}}=await o.auth.getUser();return r?(await this.loadUserProfile(r.id),this.currentUser):null}catch(r){return console.error("Error getting current user:",r),null}}async isAuthenticated(){try{const{data:{session:r}}=await o.auth.getSession();return!!r}catch(r){return console.error("Error checking authentication:",r),!1}}async updateProfile(r){try{const{data:{user:e}}=await o.auth.getUser();if(!e)throw new Error("No authenticated user");console.log("Updating profile for user:",e.email);const{data:t,error:s}=await o.from("profiles").update({...r,updated_at:new Date().toISOString()}).eq("id",e.id).select().single();if(s)throw console.error("Profile update error:",s),s;return this.currentUser=t,await this.logUserActivity(e.id,"profile_updated",{updated_fields:Object.keys(r)}),console.log("Profile updated successfully"),t}catch(e){throw console.error("Profile update error:",e),e}}async changePassword(r,e){try{const{data:{user:t}}=await o.auth.getUser();if(!t)throw new Error("No authenticated user");console.log("Changing password for user:",t.email);const{error:s}=await o.auth.updateUser({password:e});if(s)throw console.error("Password change error:",s),s;await this.logUserActivity(t.id,"password_changed",{email:t.email}),console.log("Password changed successfully")}catch(t){throw console.error("Password change error:",t),t}}async resetPassword(r){try{console.log("Sending password reset for:",r);const{error:e}=await o.auth.resetPasswordForEmail(r,{redirectTo:`${window.location.origin}/reset-password`});if(e)throw console.error("Password reset error:",e),e;console.log("Password reset email sent")}catch(e){throw console.error("Password reset error:",e),e}}async getUserProfile(r){try{const{data:e,error:t}=await o.from("profiles").select("*").eq("id",r).single();return t?(console.error("Error fetching user profile:",t),null):e}catch(e){return console.error("Error in getUserProfile:",e),null}}async getAllUsers(){try{const{data:r,error:e}=await o.from("profiles").select("*").order("created_at",{ascending:!1});if(e)throw console.error("Error fetching all users:",e),e;return r||[]}catch(r){throw console.error("Error in getAllUsers:",r),r}}async logUserActivity(r,e,t={}){try{const{error:s}=await o.from("user_activity_log").insert({user_id:r,action:e,details:t,ip_address:await this.getClientIP(),user_agent:navigator.userAgent});s&&console.error("Error logging user activity:",s)}catch(s){console.error("Error in logUserActivity:",s)}}async updateLoginInfo(r){try{const{data:e}=await o.from("profiles").select("login_count").eq("id",r).single(),s=(e?.login_count||0)+1,{error:a}=await o.from("profiles").update({last_login_at:new Date().toISOString(),login_count:s,updated_at:new Date().toISOString()}).eq("id",r);a&&console.error("Error updating login info:",a)}catch(e){console.error("Error in updateLoginInfo:",e)}}async getClientIP(){try{return"127.0.0.1"}catch{return null}}async getUserDashboardData(){try{const{data:{user:r}}=await o.auth.getUser();if(!r)throw new Error("No authenticated user");const{data:e,error:t}=await o.from("user_dashboard_data").select("*").eq("id",r.id).single();if(t)throw console.error("Error fetching dashboard data:",t),t;return e}catch(r){throw console.error("Error in getUserDashboardData:",r),r}}async getUserSessions(){try{const{data:{user:r}}=await o.auth.getUser();if(!r)throw new Error("No authenticated user");const{data:e,error:t}=await o.from("user_sessions").select("*").eq("user_id",r.id).order("created_at",{ascending:!1});if(t)throw console.error("Error fetching user sessions:",t),t;return e||[]}catch(r){throw console.error("Error in getUserSessions:",r),r}}async getUserActivityLog(r=50){try{const{data:{user:e}}=await o.auth.getUser();if(!e)throw new Error("No authenticated user");const{data:t,error:s}=await o.from("user_activity_log").select("*").eq("user_id",e.id).order("created_at",{ascending:!1}).limit(r);if(s)throw console.error("Error fetching user activity log:",s),s;return t||[]}catch(e){throw console.error("Error in getUserActivityLog:",e),e}}}const f=u.getInstance(),E=async(n,r,e)=>await f.signUp(n,r,e),U=async(n,r)=>await f.signIn(n,r),S=async()=>await f.signOut(),P=async()=>{try{const{data:n,error:r}=await o.from("products").select("*").eq("is_active",!0).order("sort_order");return r?(console.error("Error fetching products:",r),[]):n}catch(n){return console.error("Error in getProducts:",n),[]}},I=async n=>{try{const{data:r,error:e}=await o.from("products").select(`
        *,
        product_plans (*)
      `).eq("slug",n).eq("is_active",!0).single();return e?(console.error("Error fetching product by slug:",e),null):r}catch(r){return console.error("Error in getProductBySlug:",r),null}},A=async n=>{const{data:r,error:e}=await o.from("cart_items").select(`
      *,
      product:products (*),
      plan:product_plans (*)
    `).eq("user_id",n);if(e)throw e;return r},v=async(n,r,e,t={})=>{const{data:s,error:a}=await o.from("cart_items").upsert({user_id:n,product_id:r,plan_id:e,custom_requirements:t,quantity:1}).select();if(a)throw a;return s},O=async n=>{const{error:r}=await o.from("cart_items").delete().eq("id",n);if(r)throw r},q=async n=>{const{error:r}=await o.from("cart_items").delete().eq("user_id",n);if(r)throw r},C=async(n,r,e)=>{const{data:t,error:s}=await o.from("orders").insert({user_id:n,total_amount:e,status:"pending",payment_status:"pending"}).select().single();if(s)throw s;const a=r.map(i=>({order_id:t.id,product_id:i.product_id,plan_id:i.plan_id,quantity:i.quantity,unit_price:i.plan?.price||0,total_price:(i.plan?.price||0)*i.quantity,custom_requirements:i.custom_requirements})),{error:c}=await o.from("order_items").insert(a);if(c)throw c;return t},N=async n=>{const{data:r,error:e}=await o.from("orders").select(`
      *,
      order_items (
        *,
        product:products (*),
        plan:product_plans (*)
      )
    `).eq("user_id",n).order("created_at",{ascending:!1});if(e)throw e;return r},b=async n=>{try{const{data:r,error:e}=await o.from("profiles").select("*").eq("id",n).single();return e?(console.error("Error fetching user profile:",e),null):r}catch(r){return console.error("Error in getUserProfile:",r),null}},D=async n=>{try{const{data:{user:r}}=await o.auth.getUser();if(!r)throw new Error("No authenticated user");const{data:e,error:t}=await o.from("profiles").update({...n,updated_at:new Date().toISOString()}).eq("id",r.id).select().single();if(t)throw console.error("Profile update error:",t),t;return e}catch(r){throw console.error("Error updating profile:",r),r}};export{u as SupabaseAuth,v as addToCart,q as clearCart,C as createOrder,A as getCartItems,I as getProductBySlug,P as getProducts,N as getUserOrders,b as getUserProfile,O as removeFromCart,U as signIn,S as signOut,E as signUp,o as supabase,_ as supabaseAnonKey,f as supabaseAuth,p as supabaseUrl,D as updateUserProfile};
