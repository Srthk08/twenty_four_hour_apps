function u(){try{const s=sessionStorage.getItem("simple-auth-session");if(s&&s!=="null"&&s!=="{}")try{const e=JSON.parse(s);if(e&&e.user&&(e.access_token||e.user.email)){console.log("âœ… Valid session found in sessionStorage:",e.user.email);const o=window.globalAuthManager||window.simpleAuthManager;return o&&!o.isUserLoggedIn()&&(console.log("ðŸ”„ Auth manager exists but session not loaded, triggering load..."),o.checkExistingSession?o.checkExistingSession():o.handleLogin&&o.handleLogin(e.user)),!0}}catch(e){console.log("SessionStorage parse error, checking localStorage:",e)}const i=localStorage.getItem("simple-auth-session");if(i&&i!=="null"&&i!=="{}")try{const e=JSON.parse(i);if(e&&e.user&&(e.access_token||e.user.email)){console.log("âœ… Valid session found in localStorage:",e.user.email),sessionStorage.setItem("simple-auth-session",i);const o=window.globalAuthManager||window.simpleAuthManager;return o&&!o.isUserLoggedIn()&&(console.log("ðŸ”„ Auth manager exists but session not loaded, triggering load..."),o.checkExistingSession?o.checkExistingSession():o.handleLogin&&o.handleLogin(e.user)),!0}}catch(e){console.log("LocalStorage session parse error, checking user data:",e)}const n=localStorage.getItem("simple-auth-user");if(n&&n!=="null"&&n!=="{}")try{const e=JSON.parse(n);if(e&&e.email){console.log("âœ… Valid user found in localStorage:",e.email);const o={user:e,access_token:"simple-token-"+Date.now(),timestamp:Date.now()};sessionStorage.setItem("simple-auth-session",JSON.stringify(o));const a=window.globalAuthManager||window.simpleAuthManager;return a&&!a.isUserLoggedIn()&&(console.log("ðŸ”„ Auth manager exists but user not loaded, triggering load..."),a.handleLogin&&a.handleLogin(e)),!0}}catch(e){console.log("LocalStorage user parse error:",e)}return!1}catch(s){return console.error("Error checking sessionStorage:",s),!1}}async function r(s=0){const i=document.getElementById("auth-guard");if(!i)return;const n=i.dataset.redirectTo||"/login",e=30,o=sessionStorage.getItem("signup-redirect-in-progress")==="true",a=sessionStorage.getItem("login-redirect-in-progress")==="true",d=o||a;d&&(console.log("ðŸ”„ Redirect detected, giving extra time for session to load..."),setTimeout(()=>{sessionStorage.removeItem("signup-redirect-in-progress"),sessionStorage.removeItem("login-redirect-in-progress")},3e3));try{const g=u();let t=window.globalAuthManager||window.simpleAuthManager;if(!t){const l=d?e*2:e;if(g&&s<l){console.log(`â³ Auth manager not ready but session exists, waiting... (${s+1}/${l})`),setTimeout(()=>r(s+1),100);return}else if(g){console.log("âœ… Valid session found, allowing access even without auth manager");return}else if(s<l){setTimeout(()=>r(s+1),100);return}else{console.log("âŒ No auth manager and no session after max attempts"),window.location.pathname!=="/login"&&(sessionStorage.setItem("login-redirect-url",window.location.pathname+window.location.search),window.location.href=n);return}}if(t.isUserLoggedIn()){console.log("âœ… User is authenticated via auth manager, allowing access");return}if(g){if(console.log("âš ï¸ Auth manager says not logged in but session exists, forcing reload..."),t.checkExistingSession)t.checkExistingSession();else if(t.handleLogin){const l=sessionStorage.getItem("simple-auth-session")||localStorage.getItem("simple-auth-session");if(l)try{const c=JSON.parse(l);c&&c.user&&t.handleLogin(c.user)}catch(c){console.log("Error parsing session for auth manager:",c)}}setTimeout(()=>{if(t.isUserLoggedIn()){console.log("âœ… Auth manager updated, user is now authenticated");return}else if(u()){console.log("âœ… Session still valid in storage, allowing access");return}else console.log("âŒ Session invalid, redirecting to login"),window.location.pathname!=="/login"&&(sessionStorage.setItem("login-redirect-url",window.location.pathname+window.location.search),window.location.href=n)},500);return}if(console.log("âŒ User not authenticated, redirecting to:",n),window.location.pathname==="/login"){console.log("Already on login page, not redirecting");return}window.location.pathname!=="/login"&&sessionStorage.setItem("login-redirect-url",window.location.pathname+window.location.search),window.location.href=n;return}catch(g){if(console.error("Error checking authentication:",g),u()){console.log("âœ… Error occurred but valid session found, allowing access");return}window.location.pathname!=="/login"&&(window.location.href=n)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{r(),setTimeout(r,100)}):(r(),setTimeout(r,100));window.addEventListener("user-logged-in",()=>{console.log("User logged in event received in AuthGuard")});window.addEventListener("user-logged-out",()=>{console.log("User logged out event received in AuthGuard"),r()});console.log("âœ… AuthGuard initialized with global auth manager");
