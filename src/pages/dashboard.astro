---
import Layout from '../layouts/Layout.astro';
import AuthGuard from '../components/AuthGuard.astro';
---

<Layout title="Dashboard - DevExpress">
  <AuthGuard>
    <section class="py-12 bg-gray-50 min-h-screen">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Welcome Header -->
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-gray-900 mb-2">
            Welcome back, <span id="user-welcome">User</span>!
          </h1>
          <p class="text-gray-600">Manage your projects and orders from your dashboard.</p>
        </div>

        <!-- Recent Activity (Browse + guidance) -->
        <div id="recent-activity" class="bg-white rounded-lg shadow-sm p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Recent Activity</h3>
          </div>
          <div id="activity-content">
            <div class="text-center py-6">
              <p class="text-gray-800 text-base font-medium">Get started with your first order</p>
              <p class="text-gray-500 text-sm mt-1">Choose a product, submit your requirements, and track it in My Orders.</p>
              <div class="mt-4 flex items-center justify-center gap-3">
                <a href="/products" class="inline-flex items-center px-5 py-2.5 rounded-md bg-primary-600 text-white hover:bg-primary-700 transition-colors">Browse Products</a>
              </div>
            </div>
          </div>
        </div>


        <!-- Product Customization Form (shown when product is selected) -->
        <div id="product-customization-form" class="bg-white rounded-lg shadow-sm p-8 hidden">
          <div class="flex items-center justify-between mb-8">
            <h2 class="text-3xl font-bold text-gray-900">Project Requirements</h2>
            <button id="close-customization-form" class="text-gray-400 hover:text-gray-600">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
              </div>
          
          <!-- Product Details Display -->
          <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6 mb-8 border border-blue-200">
            <div class="flex items-center justify-between">
              <div>
                <h3 id="selected-product-name" class="text-xl font-bold text-gray-900 mb-2">Selected Product</h3>
                <p class="text-sm text-blue-600 font-medium">Customize your project requirements below</p>
              </div>
              <div class="text-right">
                <p id="selected-product-price" class="text-3xl font-bold text-primary-600">â‚¹0</p>
                <p class="text-sm text-gray-500">Base Price</p>
              </div>
            </div>
          </div>

          <!-- Complete Customization Form -->
          <form id="customization-form" class="space-y-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <!-- Left Column -->
              <div class="space-y-6">
                <!-- Project Name -->
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Project Name <span class="text-red-500">*</span>
                  </label>
                  <input type="text" name="projectName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-lg" placeholder="Enter your project name" required>
                </div>

                <!-- App Name -->
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    App Name <span class="text-red-500">*</span>
                  </label>
                  <input type="text" name="appName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-lg" placeholder="Enter your app name" required>
                </div>

                <!-- Restaurant Name (only for restaurant products) -->
                <div id="restaurant-name-field" class="hidden">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Restaurant Name <span class="text-red-500">*</span>
                  </label>
                  <input type="text" name="restaurantName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-lg" placeholder="Enter restaurant name">
                </div>

                <!-- Logo Upload (Required for all products) -->
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Upload Logo <span class="text-red-500">*</span>
                  </label>
                  <div id="restaurant-logo-upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-primary-400 transition-colors cursor-pointer" onclick="const el = document.getElementById('restaurant-logo-upload'); if(el) el.click(); else console.error('restaurant-logo-upload element not found in HTML onclick');">
                    <div class="flex flex-col items-center">
                      <svg class="w-12 h-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                      </svg>
                      <p class="text-gray-600 mb-2">Click to upload logo</p>
                      <p class="text-sm text-gray-500">PNG, JPG, SVG up to 10MB</p>
                    </div>
                    <input type="file" name="restaurantLogo" accept="image/*" class="hidden" id="restaurant-logo-upload">
                    <div id="restaurant-logo-preview" class="hidden mt-4">
                      <img id="restaurant-logo-preview-img" class="w-20 h-20 object-cover rounded-lg mx-auto" alt="Logo preview">
                      <p id="restaurant-logo-filename" class="text-sm text-gray-600 mt-2"></p>
                      <button type="button" id="restaurant-logo-remove" class="mt-2 text-sm text-red-600 hover:text-red-800">Remove Logo</button>
                    </div>
                  </div>
                </div>

          </div>

              <!-- Right Column -->
              <div class="space-y-6">
                <!-- Contact Person -->
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Contact Person <span class="text-red-500">*</span>
                  </label>
                  <input type="text" name="contactPerson" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-lg" placeholder="Your full name" required>
                </div>

                <!-- Product Description -->
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Product Description <span class="text-red-500">*</span>
                  </label>
                  <textarea name="productDescription" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-lg resize-none" placeholder="Describe your product requirements and features" required></textarea>
                </div>

                <!-- Cuisine Type (only for restaurant products) -->
                <div id="cuisine-type-field" class="hidden">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Cuisine Type <span class="text-red-500">*</span>
                  </label>
                  <select name="cuisineType" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-lg">
                    <option value="">Select cuisine type</option>
                    <option value="indian">Indian</option>
                    <option value="chinese">Chinese</option>
                    <option value="italian">Italian</option>
                    <option value="mexican">Mexican</option>
                    <option value="thai">Thai</option>
                    <option value="japanese">Japanese</option>
                    <option value="korean">Korean</option>
                    <option value="mediterranean">Mediterranean</option>
                    <option value="american">American</option>
                    <option value="other">Other</option>
                  </select>
                </div>

                <!-- Contact Information Section -->
                <div class="border-t pt-6">
                  <h3 class="text-lg font-semibold text-gray-900 mb-4">Contact Information</h3>
                  
                  <!-- Email -->
                  <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                      Email <span class="text-red-500">*</span>
                    </label>
                    <input type="email" name="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-lg" placeholder="your.email@example.com" required>
                  </div>

                  <!-- Phone Number -->
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                      Phone Number <span class="text-red-500">*</span>
                    </label>
                    <input type="tel" name="phone" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-lg" placeholder="+91 9876543210" required>
                  </div>
                </div>
              </div>
            </div>

            <!-- Color Customization -->
            <div class="border-t pt-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Color Customization</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Primary Color -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Primary Color <span class="text-red-500">*</span>
                  </label>
                  <div class="flex items-center space-x-3">
                    <input type="color" name="primaryColor" value="#3B82F6" class="w-12 h-12 border border-gray-300 rounded-lg cursor-pointer">
                    <input type="text" name="primaryColorText" value="#3B82F6" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="#3B82F6">
                  </div>
                </div>

                <!-- Secondary Color -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Secondary Color
                  </label>
                  <div class="flex items-center space-x-3">
                    <input type="color" name="secondaryColor" value="#10B981" class="w-12 h-12 border border-gray-300 rounded-lg cursor-pointer">
                    <input type="text" name="secondaryColorText" value="#10B981" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="#10B981">
                  </div>
                </div>

                <!-- Accent Color -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Accent Color
                  </label>
                  <div class="flex items-center space-x-3">
                    <input type="color" name="accentColor" value="#F59E0B" class="w-12 h-12 border border-gray-300 rounded-lg cursor-pointer">
                    <input type="text" name="accentColorText" value="#F59E0B" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="#F59E0B">
                  </div>
                </div>

                <!-- Text Color -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Text Color
                  </label>
                  <div class="flex items-center space-x-3">
                    <input type="color" name="textColor" value="#1F2937" class="w-12 h-12 border border-gray-300 rounded-lg cursor-pointer">
                    <input type="text" name="textColorText" value="#1F2937" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="#1F2937">
                  </div>
                </div>
              </div>
            </div>

            <!-- Additional Requirements -->
            <div class="border-t pt-6">
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                Additional Requirements
              </label>
              <textarea name="additionalRequirements" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-lg" placeholder="Describe any specific requirements or features you need..."></textarea>
            </div>

            <!-- Form Actions -->
            <div class="flex justify-end space-x-4 pt-6 border-t">
              <button type="button" id="cancel-customization" class="px-8 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500 font-medium">
                Cancel
              </button>
              <button type="button" id="test-save" class="px-8 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 font-medium">
                Test Save to Database
              </button>
              <button type="button" id="simple-test" class="px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium">
                Simple Test
              </button>
              <button type="button" id="direct-save" class="px-8 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 font-medium">
                Direct Save
              </button>
              <button type="submit" id="save-and-pay" class="px-8 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 font-medium">
                Save and Make Payment
              </button>
            </div>
          </form>
        </div>

        <!-- Order Menu System Price Page (shown first when OMS is selected) -->
        <div id="order-menu-price-page" class="bg-white rounded-lg shadow-sm p-8 hidden">
          <div class="max-w-2xl mx-auto text-center">
            <h2 class="text-3xl font-bold text-amber-800 mb-8">Order Menu System Pricing</h2>
            <div class="bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-xl shadow-lg p-8 mb-8">
              <div class="text-center">
                <h3 class="text-2xl font-bold text-amber-800 mb-4">Order Menu System</h3>
                <p class="text-amber-700 mb-6">Complete order management solution with all essential features</p>
                <div class="text-5xl font-bold text-amber-600 mb-2">â‚¹999</div>
                <div class="text-sm text-amber-600 mb-8">One-time payment â€¢ Delivery in 1 day</div>
                
                <ul class="space-y-3 mb-8 text-left max-w-md mx-auto">
                  <li class="flex items-center">
                    <svg class="w-5 h-5 text-green-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span class="text-gray-700">All essential OMS features</span>
                  </li>
                  <li class="flex items-center">
                    <svg class="w-5 h-5 text-green-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span class="text-gray-700">Digital menu integration</span>
                  </li>
                  <li class="flex items-center">
                    <svg class="w-5 h-5 text-green-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span class="text-gray-700">Real-time order tracking</span>
                  </li>
                  <li class="flex items-center">
                    <svg class="w-5 h-5 text-green-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span class="text-gray-700">Payment processing</span>
                  </li>
                  <li class="flex items-center">
                    <svg class="w-5 h-5 text-green-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span class="text-gray-700">Analytics dashboard</span>
                  </li>
                </ul>
                
                <div class="bg-white rounded-lg p-4 mb-6">
                  <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-600">Base Price:</span>
                    <span class="font-medium">â‚¹999</span>
                  </div>
                  <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-600">GST (18%):</span>
                    <span class="font-medium">â‚¹180</span>
                  </div>
                  <div class="flex justify-between items-center font-bold text-lg border-t pt-2 mt-2">
                    <span>Total Price:</span>
                    <span class="text-amber-600">â‚¹1,179</span>
                  </div>
                </div>
                
                <button 
                  id="proceed-to-oms-form"
                  class="w-full bg-amber-600 hover:bg-amber-700 text-white py-3 px-6 rounded-lg font-medium transition-colors text-lg"
                >
                  Proceed to Customization Form
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Order Menu System Custom Form (shown when Order Menu System is selected) -->
        <div id="order-menu-customization-form" class="bg-white rounded-lg shadow-sm p-8 hidden">
          <div class="flex items-center justify-between mb-8">
            <h2 class="text-3xl font-bold text-gray-900">Order Menu System Requirements</h2>
            <button id="close-order-menu-form" class="text-gray-400 hover:text-gray-600" onclick="console.log('Close button clicked via inline!'); document.getElementById('order-menu-customization-form').classList.add('hidden'); window.history.replaceState({}, document.title, window.location.pathname); userClosedForm = true; showBrowseProductsSection(); showNoActivityMessage();">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
              </div>
          
          <!-- Product Details Display -->
          <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-lg p-6 mb-8 border border-amber-200">
            <div class="text-center">
              <h3 id="order-menu-product-name" class="text-2xl font-bold text-gray-900 mb-2">Order Menu System</h3>
              <p class="text-amber-600 font-medium">Complete order management system with digital menu integration, real-time order tracking, and payment processing</p>
          </div>
        </div>

          <!-- Order Menu System Form -->
          <form id="order-menu-form" class="space-y-8">
            <!-- Validation Errors Display -->
            <div id="validation-errors" class="hidden"></div>
            
            <!-- Pricing Section - Top on Mobile, Right on Desktop -->
            <div class="lg:hidden mb-6">
              <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-lg p-6 border border-amber-200">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Pricing Details</h3>
                <div class="space-y-2">
                  <div class="flex justify-between items-center">
                    <span class="text-gray-600">Base Price:</span>
                    <span class="font-medium">â‚¹999</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-gray-600">GST (18%):</span>
                    <span class="font-medium">â‚¹180</span>
                  </div>
                  <div class="flex justify-between items-center font-bold text-lg border-t pt-2 mt-2">
                    <span>Total Price:</span>
                    <span class="text-amber-600">â‚¹1,179</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <!-- Left Column - Form Fields -->
              <div class="space-y-6">
                <!-- Project Name -->
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Project Name <span class="text-red-500">*</span>
                  </label>
                  <input type="text" name="projectName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-lg" placeholder="Enter your project name" required>
                </div>

                <!-- Restaurant Name -->
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Restaurant Name <span class="text-red-500">*</span>
                  </label>
                  <input type="text" name="restaurantName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-lg" placeholder="Enter restaurant name" required>
                </div>

                <!-- Owner Name -->
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Owner Name <span class="text-red-500">*</span>
                  </label>
                  <input type="text" name="ownerName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-lg" placeholder="Enter owner name" required>
                </div>

                <!-- Contact Information Section -->
                <div class="border-t pt-6">
                  <h3 class="text-lg font-semibold text-gray-900 mb-4">Contact Information</h3>
                  
                  <!-- Contact Person -->
                  <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                      Contact Person <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="contactPerson" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-lg" placeholder="Your full name" required>
                  </div>
                  
                  <!-- Email -->
                  <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                      Email <span class="text-red-500">*</span>
                    </label>
                    <input type="email" name="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-lg" placeholder="your.email@example.com" required>
                  </div>

                  <!-- Phone Number -->
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                      Phone Number <span class="text-red-500">*</span>
                    </label>
                    <div class="flex min-w-0 w-full">
                      <select
                        id="phone_country_code"
                        name="phone_country_code"
                        required
                        class="px-3 sm:px-4 py-3 border border-r-0 border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-gray-50 text-sm sm:text-lg flex-shrink-0"
                        style="min-width: 0; max-width: 140px;"
                      >
                        <option value="+91" selected>ðŸ‡®ðŸ‡³ +91</option>
                        <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
                        <option value="+44">ðŸ‡¬ðŸ‡§ +44</option>
                        <option value="+61">ðŸ‡¦ðŸ‡º +61</option>
                        <option value="+86">ðŸ‡¨ðŸ‡³ +86</option>
                        <option value="+81">ðŸ‡¯ðŸ‡µ +81</option>
                        <option value="+49">ðŸ‡©ðŸ‡ª +49</option>
                        <option value="+33">ðŸ‡«ðŸ‡· +33</option>
                        <option value="+971">ðŸ‡¦ðŸ‡ª +971</option>
                        <option value="+966">ðŸ‡¸ðŸ‡¦ +966</option>
                      </select>
                      <input type="tel" name="phone" id="phone-input" class="flex-1 min-w-0 px-3 sm:px-4 py-3 border border-gray-300 rounded-r-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm sm:text-lg" placeholder="9876543210" required maxlength="10" pattern="[0-9]{10}" title="Please enter 10 digits">
                    </div>
                    <div id="phone-error" class="hidden text-red-500 text-sm mt-1">Please enter a valid 10-digit phone number</div>
                  </div>
                </div>

                <!-- Professional Address -->
                <div class="space-y-4 border-t pt-6">
                  <h4 class="text-lg font-semibold text-gray-700">Restaurant Address <span class="text-red-500">*</span></h4>
                  
                  <!-- House/Flat Number -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      House/Flat Number <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="houseNumber" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-lg" placeholder="e.g., 123, Flat 4B" required>
                  </div>

                  <!-- Address Line 1 -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      Address Line 1 <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="addressLine1" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-lg" placeholder="e.g., Main Street, Sector 15" required>
                  </div>

                  <!-- City and State Row -->
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              City <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              <input type="text" name="city" id="city-input" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-lg" placeholder="Type to search city..." required autocomplete="off">
              <div id="city-suggestions" class="hidden absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto mt-1"></div>
            </div>
            <div id="city-error" class="hidden text-red-500 text-sm mt-1">City is required</div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              State <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              <input type="text" name="state" id="state-input" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-lg" placeholder="Type to search state..." required autocomplete="off">
              <div id="state-suggestions" class="hidden absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto mt-1"></div>
            </div>
            <div id="state-error" class="hidden text-red-500 text-sm mt-1">Please select a valid state</div>
          </div>
                  </div>

        <!-- Pincode and Country Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Pincode <span class="text-red-500">*</span>
            </label>
            <input type="text" name="pincode" id="pincode-input" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-lg" placeholder="e.g., 400001" required maxlength="6" pattern="[0-9]{6}" title="Please enter exactly 6 digits">
            <div id="pincode-error" class="hidden text-red-500 text-sm mt-1">Pincode must be exactly 6 digits</div>
          </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">
                        Country <span class="text-red-500">*</span>
                      </label>
                      <select name="country" id="country-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-lg" required>
                        <option value="India" selected>India</option>
                        <option value="United States">United States</option>
                        <option value="United Kingdom">United Kingdom</option>
                        <option value="Canada">Canada</option>
                        <option value="Australia">Australia</option>
                        <option value="Germany">Germany</option>
                        <option value="France">France</option>
                        <option value="Japan">Japan</option>
                        <option value="Singapore">Singapore</option>
                        <option value="UAE">UAE</option>
                        <option value="Other">Other</option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Logo Upload (Optional for OMS) -->
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Upload Logo <span class="text-gray-500">(Optional)</span>
                  </label>
                  <div id="order-menu-logo-upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-primary-400 transition-colors cursor-pointer" onclick="document.getElementById('order-menu-logo-upload').click()">
                    <div class="flex flex-col items-center">
                      <svg class="w-12 h-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                      </svg>
                      <p class="text-gray-600 mb-2">Click to upload restaurant logo</p>
                      <p class="text-sm text-gray-500">PNG, JPG, SVG up to 10MB</p>
                    </div>
                  </div>
                  <input type="file" name="restaurantLogo" accept="image/*" class="hidden" id="order-menu-logo-upload">
                  <div id="order-menu-logo-preview" class="hidden mt-4">
                    <img id="order-menu-logo-preview-img" class="w-20 h-20 object-cover rounded-lg mx-auto" alt="Logo preview">
                    <p id="order-menu-logo-filename" class="text-sm text-gray-600 mt-2"></p>
                    <button type="button" id="order-menu-logo-remove" class="mt-2 text-sm text-red-600 hover:text-red-800">Remove Logo</button>
                  </div>
                </div>

                <!-- Menu Photos Upload (Required for OMS) -->
                <div>
                  <label class="block text-lg font-semibold text-gray-700 mb-2">
                    Upload Menu Photos <span class="text-red-500">*</span>
                  </label>
                  <p class="text-sm text-gray-600 mb-4">Upload multiple menu photos. Max 5MB per photo. At least 1 photo required.</p>
                  
                  <div id="menu-photos-upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-primary-400 transition-colors cursor-pointer bg-gray-50">
                    <div class="flex flex-col items-center">
                      <svg class="w-16 h-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                      </svg>
                      <p class="text-gray-700 mb-2 font-medium">Click to upload menu photos</p>
                      <p class="text-sm text-gray-500">PNG, JPG, JPEG up to 5MB each</p>
                      <div class="mt-3 flex items-center text-xs text-gray-400">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Multiple photos allowed
                      </div>
                    </div>
                    <input type="file" name="menuPhotos" accept="image/*" multiple class="hidden" id="menu-photos-upload" required>
                  </div>
                  
                  <div id="menu-photos-preview" class="hidden mt-6">
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="menu-photos-grid">
                      <!-- Photos will be added here dynamically -->
                    </div>
                  </div>
                </div>

                <!-- Error and Success Messages -->
                <div id="validation-errors" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
                  <!-- Validation errors will appear here -->
                </div>
                <div id="menu-photos-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
                  <!-- Menu photos errors will appear here -->
                </div>
                <div id="phone-validation-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
                  <!-- Phone validation errors will appear here -->
                </div>
                <div id="address-validation-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
                  <!-- Address validation errors will appear here -->
                </div>
                <div id="email-validation-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
                  <!-- Email validation errors will appear here -->
                </div>
                <div id="file-size-error" class="hidden bg-yellow-50 border border-yellow-200 text-yellow-700 px-4 py-3 rounded mb-4">
                  <!-- File size errors will appear here -->
                </div>
                <div id="success-message" class="hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded mb-4">
                  <!-- Success messages will appear here -->
                </div>
                <div id="warning-message" class="hidden bg-yellow-50 border border-yellow-200 text-yellow-700 px-4 py-3 rounded mb-4">
                  <!-- Warning messages will appear here -->
                </div>
                <div id="popup-message" class="hidden bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded mb-4">
                  <!-- Popup messages will appear here -->
                </div>
                <div id="error-message" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
                  <!-- Error messages will appear here -->
                </div>

              </div>

              <!-- Right Column - Pricing & Contact -->
              <div class="space-y-6">
                <!-- Pricing Information - Hidden on Mobile, Visible on Desktop -->
                <div class="hidden lg:block bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                  <!-- Header -->
                  <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4">
                    <div class="flex items-center justify-between">
                      <div>
                        <h3 class="text-xl font-bold text-white">Order Summary</h3>
                        <p class="text-blue-100 text-sm">Order Menu System</p>
                      </div>
                      <div class="bg-white bg-opacity-20 rounded-lg p-2">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Pricing Details -->
                  <div class="p-6">
                    <div class="space-y-4">
                      <!-- Base Price -->
                      <div class="flex items-center justify-between py-3 border-b border-gray-100">
                        <div class="flex items-center space-x-3">
                          <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                          <span class="text-gray-700 font-medium">Base Package</span>
                        </div>
                        <span class="text-lg font-semibold text-gray-900">â‚¹999</span>
                      </div>
                      
                      <!-- GST -->
                      <div class="flex items-center justify-between py-3 border-b border-gray-100">
                        <div class="flex items-center space-x-3">
                          <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                          <span class="text-gray-700 font-medium">GST (18%)</span>
                        </div>
                        <span class="text-lg font-semibold text-gray-900">â‚¹180</span>
                      </div>
                      
                      <!-- Features -->
                      <div class="py-3 border-b border-gray-100">
                        <div class="flex items-center space-x-3 mb-3">
                          <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                          <span class="text-gray-700 font-medium">Included Features</span>
                        </div>
                        <div class="ml-5 space-y-2">
                          <div class="flex items-center text-sm text-gray-600">
                            <svg class="w-4 h-4 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Custom Menu Design
                          </div>
                          <div class="flex items-center text-sm text-gray-600">
                            <svg class="w-4 h-4 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Online Ordering System
                          </div>
                          <div class="flex items-center text-sm text-gray-600">
                            <svg class="w-4 h-4 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Admin Dashboard
                          </div>
                          <div class="flex items-center text-sm text-gray-600">
                            <svg class="w-4 h-4 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Mobile Responsive
                          </div>
                        </div>
                      </div>
                      
                      <!-- Total -->
                      <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                          <div>
                            <span class="text-lg font-bold text-gray-900">Total Amount</span>
                            <p class="text-sm text-gray-600">Including all taxes</p>
                          </div>
                          <div class="text-right">
                            <span class="text-3xl font-bold text-indigo-600">â‚¹1,179</span>
                            <p class="text-sm text-gray-500">One-time payment</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>



            <!-- Additional Requirements -->
            <div class="border-t pt-6">
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                Additional Requirements
              </label>
              <textarea name="additionalRequirements" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-lg" placeholder="Describe any specific requirements or features you need..."></textarea>
            </div>

            <!-- Form Actions -->
            <div class="flex justify-end space-x-4 pt-6 border-t">
              <button type="button" id="cancel-order-menu" class="px-8 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500 font-medium" onclick="console.log('Cancel button clicked via inline!'); document.getElementById('order-menu-customization-form').classList.add('hidden'); window.history.replaceState({}, document.title, window.location.pathname); userClosedForm = true; showBrowseProductsSection(); showNoActivityMessage();">
                Cancel
              </button>
              <button type="submit" id="save-and-pay" class="px-8 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 font-medium">
                Save and Make Payment
              </button>
            </div>
          </form>
        </div>

        
      </div>
    </section>
  </AuthGuard>
</Layout>

<script>
  // Global error handler to catch unhandled promise rejections and ensure button resets
  window.addEventListener('unhandledrejection', (event) => {
    console.error(' UNHANDLED PROMISE REJECTION ');
    console.error(' Error:', event.reason);
    console.error(' Promise:', event.promise);
    
    // If this is related to form submission, reset the save button
    if (event.reason && typeof event.reason === 'object' && 'message' in event.reason) {
      const errorMessage = event.reason.message || '';
      if (errorMessage.includes('save') || errorMessage.includes('database') || errorMessage.includes('insert')) {
        console.log('ðŸ”„ Detected save-related error, resetting save button...');
        const saveButton = document.getElementById('save-and-pay');
        if (saveButton) {
          saveButton.disabled = false;
          saveButton.textContent = 'Save and Make Payment';
          console.log(' Save button reset via global error handler');
        }
      }
    }
    
    // Prevent default browser error handling (we're handling it)
    event.preventDefault();
  });
  
  // Global error handler for general errors
  window.addEventListener('error', (event) => {
    console.error(' GLOBAL ERROR ');
    console.error(' Error:', event.error);
    console.error(' Message:', event.message);
    console.error(' Source:', event.filename, ':', event.lineno);
    
    // Reset save button if it's stuck
    const saveButton = document.getElementById('save-and-pay');
    if (saveButton && saveButton.disabled) {
      console.log('ðŸ”„ Resetting stuck save button due to global error...');
      saveButton.disabled = false;
      saveButton.textContent = 'Save and Make Payment';
    }
  });

  // Import the FIXED database helper
  import { saveCustomizationForm } from '../lib/customization-db.js';

  // Menu Photos Array
  let menuPhotos = [];
  
  // Global variables to store files BEFORE form submission (to prevent them from being cleared)
  let cachedMenuPhotos = [];
  let cachedLogoFile = null;
  
  // Function to clear logo and menu photos fields after form submission
  function clearFormFileFields() {
    try {
      // Clear logo field
      const logoUpload = document.getElementById('order-menu-logo-upload') as HTMLInputElement;
      if (logoUpload) {
        logoUpload.value = '';
      }
      
      // Reset logo upload area
      const logoUploadArea = document.getElementById('order-menu-logo-upload-area');
      if (logoUploadArea) {
        logoUploadArea.innerHTML = `
          <div class="flex flex-col items-center">
            <svg class="w-12 h-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <p class="text-gray-600 mb-2">Click to upload logo</p>
            <p class="text-sm text-gray-500">PNG, JPG, SVG up to 10MB</p>
          </div>
        `;
      }
      
      // Hide logo preview
      const logoPreview = document.getElementById('order-menu-logo-preview');
      if (logoPreview) {
        logoPreview.classList.add('hidden');
      }
      
      // Clear menu photos field
      const menuPhotosUpload = document.getElementById('menu-photos-upload') as HTMLInputElement;
      if (menuPhotosUpload) {
        menuPhotosUpload.value = '';
      }
      
      // Reset menu photos upload area
      const menuPhotosUploadArea = document.getElementById('menu-photos-upload-area');
      if (menuPhotosUploadArea) {
        menuPhotosUploadArea.innerHTML = `
          <div class="flex flex-col items-center">
            <svg class="w-12 h-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <p class="text-gray-600 mb-2">Click to upload menu photos</p>
            <p class="text-sm text-gray-500">PNG, JPG up to 5MB each</p>
          </div>
        `;
        // Re-add click handler
        if (menuPhotosUpload) {
          menuPhotosUploadArea.addEventListener('click', () => {
            menuPhotosUpload.click();
          });
        }
      }
      
      // Clear menu photos preview
      const menuPhotosPreview = document.getElementById('menu-photos-preview');
      if (menuPhotosPreview) {
        menuPhotosPreview.classList.add('hidden');
      }
      
      // Clear menu photos grid
      const menuPhotosGrid = document.getElementById('menu-photos-grid');
      if (menuPhotosGrid) {
        menuPhotosGrid.innerHTML = '';
      }
      
      // Clear cached files
      cachedMenuPhotos = [];
      cachedLogoFile = null;
      
      // Clear global menuPhotos array if it exists
      if (typeof menuPhotos !== 'undefined') {
        menuPhotos = [];
      }
      
      console.log(' Form file fields cleared successfully');
    } catch (error) {
      console.error(' Error clearing form file fields:', error);
    }
  }
  
  console.log('Dashboard loaded - using global auth manager');

  // Function to fetch user profile from Supabase
  async function fetchUserProfile(userId) {
    try {
      console.log(' Fetching user profile from Supabase for user:', userId);
      const { supabase } = await import('../lib/supabase');
      
      const { data, error } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', userId)
        .single();

      if (error) {
        console.error('Error fetching user profile:', error);
        return null;
      }

      console.log(' User profile fetched from Supabase:', data);
      return data;
    } catch (error) {
      console.error('Error in fetchUserProfile:', error);
      return null;
    }
  }

  // Function to update user info - ENHANCED FOR SUPABASE
  async function updateUserInfo() {
    console.log('ðŸ”„ Updating user info...');
    
    // CRITICAL: Check if user is actually logged in first
    const authManager = window.globalAuthManager || window.simpleAuthManager;
    if (!authManager || !authManager.isUserLoggedIn()) {
      console.log(' User not logged in - showing generic welcome message');
      
      // Update welcome message to generic text
      const userWelcome = document.getElementById('user-welcome');
      if (userWelcome) {
        userWelcome.textContent = 'Guest';
        console.log('ðŸ‘‹ Welcome message updated to: Guest');
      }
      
      console.log(' Dashboard updated for guest user');
      return;
    }
    
    // Get authenticated user data
    let userData = null;
    let source = '';
    
    // Get current user from auth manager
    const currentUser = authManager.getCurrentUser();
    if (currentUser && currentUser.email) {
      userData = currentUser;
      source = 'auth-manager';
      console.log(` Found authenticated user data:`, userData.email);
    }
    
    // If still no data, try to get from storage (but only if user is logged in)
    if (!userData) {
      console.log('No auth manager data, checking storage...');
      const sources = [
        { key: 'simple-auth-session', storage: sessionStorage, path: 'user' },
        { key: 'simple-auth-user', storage: localStorage, path: null },
        { key: 'simple-auth-session', storage: localStorage, path: 'user' }
      ];
      
      for (const sourceInfo of sources) {
        try {
          const data = sourceInfo.storage.getItem(sourceInfo.key);
          if (data) {
            const parsed = JSON.parse(data);
            userData = sourceInfo.path ? parsed[sourceInfo.path] : parsed;
            if (userData && userData.email) {
              source = sourceInfo.key;
              console.log(` Found user data in ${sourceInfo.key}:`, userData.email);
              break;
            }
          }
        } catch (error) {
          console.log(`Error reading ${sourceInfo.key}:`, error);
        }
      }
    }
    
    // If still no data, show generic message (don't create mock data)
    if (!userData) {
      console.log(' No authenticated user data found');
      
      // Update welcome message to generic text
      const userWelcome = document.getElementById('user-welcome');
      if (userWelcome) {
        userWelcome.textContent = 'Guest';
        console.log('ðŸ‘‹ Welcome message updated to: Guest');
      }
      
      console.log(' Dashboard updated for guest user');
      return;
    }
    
    // Normalize user data structure for Supabase
    if (userData) {
      // Handle Supabase user metadata
      if (userData.user_metadata) {
        userData.full_name = userData.user_metadata.full_name || userData.full_name;
        userData.phone = userData.user_metadata.phone || userData.phone;
        userData.company_name = userData.user_metadata.company_name || userData.company_name;
      }
      
      // If we have incomplete data, try to fetch from Supabase
      if (userData.id && (!userData.full_name || userData.full_name === 'User' || !userData.phone || userData.phone === 'Not set')) {
        console.log('ðŸ”„ Incomplete user data, fetching from Supabase...');
        try {
          const profileData = await fetchUserProfile(userData.id);
          if (profileData) {
            // Merge profile data with existing user data
            userData = {
              ...userData,
              ...profileData,
              email: userData.email || profileData.email
            };
            console.log(' Enhanced user data with profile:', userData);
          }
        } catch (error) {
          console.log('Error fetching profile data:', error);
        }
      }
      
      // Ensure we have the required fields (but don't create fake data)
      userData.full_name = userData.full_name || userData.fullName || 'User';
      userData.phone = userData.phone || 'Not set';
      userData.company_name = userData.company_name || userData.companyName || 'Not set';
      // Don't create fake email - only use real authenticated email
      if (!userData.email) {
        console.log(' No email found in authenticated user data');
        return;
      }
      
      console.log('ðŸ“‹ Final normalized user data:', userData);
    }
    
    // Update the dashboard elements (only welcome message remains)
    
    // Update welcome message
    const userWelcome = document.getElementById('user-welcome');
    if (userWelcome) {
      const displayName = userData.full_name || userData.fullName || userData.email?.split('@')[0] || 'User';
      userWelcome.textContent = displayName;
      console.log('ðŸ‘‹ Welcome message updated to:', displayName);
    }
    
    console.log(` Dashboard updated successfully from ${source}`);
    
    // Force update welcome message
    setTimeout(() => {
      console.log('ðŸ”„ Force update welcome message...');
      const userWelcome = document.getElementById('user-welcome');
      if (userWelcome) {
        const displayName = userData.full_name || userData.fullName || userData.email?.split('@')[0] || 'User';
        userWelcome.textContent = displayName;
        console.log('Force updated welcome to:', userWelcome.textContent);
      }
    }, 100);
  }

  // Handle product selection and customization form
  function handleProductSelection() {
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('product');
    const price = urlParams.get('price');
    
    console.log(' Checking for product selection:', { productId, price });
    
    if (productId && price) {
      console.log(' Product selected, showing customization form');
      
      // Get product details from actual products data (matching products-data.ts)
      const products = [
        { id: '1', name: 'Restaurant Menu System', description: 'Digital menu system with QR code integration, online ordering, and real-time updates. Perfect for restaurants looking to modernize their customer experience.', price: 25000, type: 'restaurant' },
        { id: '2', name: 'Android TV App', description: 'Custom Android TV applications with beautiful UI, content management, and remote control support. Perfect for streaming services and media companies.', price: 55000, type: 'non-restaurant' },
        { id: '3', name: 'Streaming Mobile App', description: 'Mobile streaming applications for iOS and Android with custom features, user authentication, and content management.', price: 35000, type: 'non-restaurant' },
        { id: '4', name: 'Restaurant Website', description: 'Professional restaurant website with online ordering, menu display, and customer management features.', price: 20000, type: 'restaurant' },
        { id: '5', name: 'Order Menu System', description: 'Complete order management system with digital menu integration, real-time order tracking, and payment processing. Perfect for restaurants looking to streamline their ordering process.', price: 999, type: 'order-menu' }
      ];
      
      const selectedProduct = products.find(p => p.id === productId);
      
      if (selectedProduct) {
        // Hide all forms first with smooth transition
        const productForm = document.getElementById('product-customization-form');
        const orderMenuForm = document.getElementById('order-menu-customization-form');
        const orderMenuPricePage = document.getElementById('order-menu-price-page');
        const recentActivity = document.getElementById('recent-activity');
        
        // Smooth hide transitions
        if (productForm && !productForm.classList.contains('hidden')) {
          productForm.style.transition = 'opacity 0.3s ease-in-out, transform 0.3s ease-in-out';
          productForm.style.opacity = '0';
          productForm.style.transform = 'translateY(-10px)';
          setTimeout(() => productForm.classList.add('hidden'), 300);
        }
        
        if (orderMenuForm && !orderMenuForm.classList.contains('hidden')) {
          orderMenuForm.style.transition = 'opacity 0.3s ease-in-out, transform 0.3s ease-in-out';
          orderMenuForm.style.opacity = '0';
          orderMenuForm.style.transform = 'translateY(-10px)';
          setTimeout(() => orderMenuForm.classList.add('hidden'), 300);
        }
        
        // Always hide price page - we go directly to customization form for OMS
        if (orderMenuPricePage && !orderMenuPricePage.classList.contains('hidden')) {
          orderMenuPricePage.style.transition = 'opacity 0.3s ease-in-out, transform 0.3s ease-in-out';
          orderMenuPricePage.style.opacity = '0';
          orderMenuPricePage.style.transform = 'translateY(-10px)';
          setTimeout(() => orderMenuPricePage.classList.add('hidden'), 300);
        }
        
        if (recentActivity && !recentActivity.classList.contains('hidden')) {
          recentActivity.style.transition = 'opacity 0.3s ease-in-out, transform 0.3s ease-in-out';
          recentActivity.style.opacity = '0';
          recentActivity.style.transform = 'translateY(-10px)';
          setTimeout(() => recentActivity.classList.add('hidden'), 300);
        }
        
        // Show appropriate form with smooth transition after hiding
        setTimeout(() => {
          // Force common price for Order Menu System
          const forcedPrice = selectedProduct.type === 'order-menu' ? 999 : parseInt(price);
          if (selectedProduct.type === 'order-menu') {
            // Show Order Menu System customization form directly (skip price page)
            document.getElementById('order-menu-product-name').textContent = selectedProduct.name;
            
            const orderMenuForm = document.getElementById('order-menu-customization-form');
            orderMenuForm.classList.remove('hidden');
            orderMenuForm.style.transition = 'opacity 0.3s ease-in-out, transform 0.3s ease-in-out';
            orderMenuForm.style.opacity = '0';
            orderMenuForm.style.transform = 'translateY(10px)';
            
            setTimeout(() => {
              orderMenuForm.style.opacity = '1';
              orderMenuForm.style.transform = 'translateY(0)';
              // Reinitialize pincode autocomplete when form becomes visible
              if (window.reinitializePincodeAutocomplete) {
                window.reinitializePincodeAutocomplete();
              }
              // Auto-fill user details when form becomes visible
              setTimeout(() => autofillUserDetails(), 200);
            }, 50);
    } else {
            // Show regular customization form
            document.getElementById('selected-product-name').textContent = selectedProduct.name;
            document.getElementById('selected-product-price').textContent = `â‚¹${forcedPrice.toLocaleString()}`;
            
            // Show/hide cuisine type and restaurant name based on product type
            const cuisineField = document.getElementById('cuisine-type-field');
            const restaurantNameField = document.getElementById('restaurant-name-field');
            
            if (selectedProduct.type === 'restaurant') {
              cuisineField.classList.remove('hidden');
              cuisineField.querySelector('select').required = true;
              restaurantNameField.classList.remove('hidden');
              restaurantNameField.querySelector('input').required = true;
            } else {
              cuisineField.classList.add('hidden');
              cuisineField.querySelector('select').required = false;
              restaurantNameField.classList.add('hidden');
              restaurantNameField.querySelector('input').required = false;
            }
            
            const productForm = document.getElementById('product-customization-form');
            productForm.classList.remove('hidden');
            productForm.style.transition = 'opacity 0.3s ease-in-out, transform 0.3s ease-in-out';
            productForm.style.opacity = '0';
            productForm.style.transform = 'translateY(10px)';
            
            setTimeout(() => {
              productForm.style.opacity = '1';
              productForm.style.transform = 'translateY(0)';
            }, 50);
          }
        }, 350);
        
        // Auto-fill user details when form is shown (with longer delay)
        setTimeout(() => autofillUserDetails(), 500);
        
        // Don't clear URL parameters immediately - let them persist for refresh
        // window.history.replaceState({}, document.title, window.location.pathname);
      }
    }
  }

  // City and State data arrays
  const indianCities = [
    'Mumbai', 'Delhi', 'Bangalore', 'Hyderabad', 'Chennai', 'Kolkata', 'Pune', 'Ahmedabad', 'Jaipur', 'Surat',
    'Lucknow', 'Kanpur', 'Nagpur', 'Indore', 'Thane', 'Bhopal', 'Visakhapatnam', 'Pimpri-Chinchwad', 'Patna', 'Vadodara',
    'Ghaziabad', 'Ludhiana', 'Agra', 'Nashik', 'Faridabad', 'Meerut', 'Rajkot', 'Kalyan-Dombivali', 'Vasai-Virar', 'Varanasi',
    'Srinagar', 'Aurangabad', 'Navi Mumbai', 'Solapur', 'Vijayawada', 'Kolhapur', 'Amritsar', 'Noida', 'Ranchi', 'Howrah',
    'Coimbatore', 'Raipur', 'Jabalpur', 'Gwalior', 'Chandigarh', 'Tiruchirappalli', 'Mysore', 'Bhubaneswar', 'Kochi', 'Bhavnagar',
    'Salem', 'Warangal', 'Guntur', 'Bhiwandi', 'Amravati', 'Nanded', 'Sangli', 'Malegaon', 'Ulhasnagar', 'Jalgaon',
    'Latur', 'Ahmadnagar', 'Dhule', 'Ichalkaranji', 'Parbhani', 'Jalna', 'Bhusawal', 'Panvel', 'Satara', 'Beed',
    'Yavatmal', 'Kamptee', 'Gondia', 'Barshi', 'Achalpur', 'Osmanabad', 'Nandurbar', 'Wardha', 'Udgir', 'Amalner',
    'Akot', 'Pandharpur', 'Shirpur', 'Parli', 'Pathri', 'Sinnar', 'Shirur', 'Mangrulpir', 'Phaltan', 'Pulgaon',
    'Pimpri', 'Pachora', 'Paratwada', 'Pusad', 'Purna', 'Rahuri', 'Rajura', 'Ramtek', 'Ratnagiri', 'Raver',
    'Risod', 'Sailu', 'Sangamner', 'Sasvad', 'Satana', 'Shahpur', 'Shegaon', 'Shendurjana', 'Shirdi', 'Shrigonda',
    'Shrirampur', 'Sillod', 'Soyagaon', 'Talegaon Dabhade', 'Talode', 'Tasgaon', 'Telhara', 'Tirora', 'Tuljapur', 'Tumsar',
    'Uchgaon', 'Umarga', 'Umarkhed', 'Umred', 'Uran', 'Uran Islampur', 'Vadgaon Kasba', 'Vaijapur', 'Vasai', 'Virar',
    'Vita', 'Wadgaon Road', 'Wai', 'Wani', 'Warora', 'Warud', 'Washim', 'Yawal', 'Yevla'
  ];

  const indianStates = [
    'Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar', 'Chhattisgarh', 'Goa', 'Gujarat', 'Haryana', 'Himachal Pradesh', 'Jharkhand',
    'Karnataka', 'Kerala', 'Madhya Pradesh', 'Maharashtra', 'Manipur', 'Meghalaya', 'Mizoram', 'Nagaland', 'Odisha', 'Punjab',
    'Rajasthan', 'Sikkim', 'Tamil Nadu', 'Telangana', 'Tripura', 'Uttar Pradesh', 'Uttarakhand', 'West Bengal',
    'Andaman and Nicobar Islands', 'Chandigarh', 'Dadra and Nagar Haveli and Daman and Diu', 'Delhi', 'Jammu and Kashmir', 'Ladakh', 'Lakshadweep', 'Puducherry'
  ];

  // Form validation functions
  function setupFormValidation() {
    const pincodeInput = document.getElementById('pincode-input');
    const cityInput = document.getElementById('city-input');
    const stateInput = document.getElementById('state-input');
    const phoneInput = document.getElementById('phone-input');
    
    // Pincode validation - only allow numbers and exactly 6 digits
    if (pincodeInput) {
      pincodeInput.addEventListener('input', function(e) {
        // Remove any non-numeric characters
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
        
        // Limit to 6 digits
        if (e.target.value.length > 6) {
          e.target.value = e.target.value.slice(0, 6);
        }
        
        // Show/hide error message
        const errorDiv = document.getElementById('pincode-error');
        if (e.target.value.length > 0 && e.target.value.length !== 6) {
          errorDiv.classList.remove('hidden');
        } else {
          errorDiv.classList.add('hidden');
        }
      });
    }
    
    // City validation - searchable dropdown
    if (cityInput) {
      const citySuggestions = document.getElementById('city-suggestions');
      
      cityInput.addEventListener('input', function(e) {
        const query = e.target.value.toLowerCase();
        const filteredCities = indianCities.filter(city => 
          city.toLowerCase().includes(query)
        );
        
        // Show/hide suggestions
        if (query.length > 0 && filteredCities.length > 0) {
          citySuggestions.innerHTML = filteredCities.map(city => 
            `<div class="px-4 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0" data-value="${city}">${city}</div>`
          ).join('');
          citySuggestions.classList.remove('hidden');
        } else {
          citySuggestions.classList.add('hidden');
        }
        
        // Show/hide error message: only require non-empty
        const errorDiv = document.getElementById('city-error');
        if (e.target.value === '') {
          errorDiv.classList.remove('hidden');
        } else {
          errorDiv.classList.add('hidden');
        }
      });
      
      // Handle suggestion clicks
      citySuggestions.addEventListener('click', function(e) {
        if (e.target.dataset.value) {
          cityInput.value = e.target.dataset.value;
          citySuggestions.classList.add('hidden');
          // Hide error message
          document.getElementById('city-error').classList.add('hidden');
        }
      });
      
      // Hide suggestions when clicking outside
      document.addEventListener('click', function(e) {
        if (!cityInput.contains(e.target) && !citySuggestions.contains(e.target)) {
          citySuggestions.classList.add('hidden');
        }
      });
    }
    
    // State validation - searchable dropdown
    if (stateInput) {
      const stateSuggestions = document.getElementById('state-suggestions');
      
      stateInput.addEventListener('input', function(e) {
        const query = e.target.value.toLowerCase();
        const filteredStates = indianStates.filter(state => 
          state.toLowerCase().includes(query)
        );
        
        // Show/hide suggestions
        if (query.length > 0 && filteredStates.length > 0) {
          stateSuggestions.innerHTML = filteredStates.map(state => 
            `<div class="px-4 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0" data-value="${state}">${state}</div>`
          ).join('');
          stateSuggestions.classList.remove('hidden');
        } else {
          stateSuggestions.classList.add('hidden');
        }
        
        // Show/hide error message
        const errorDiv = document.getElementById('state-error');
        if (e.target.value === '' || !indianStates.includes(e.target.value)) {
          errorDiv.classList.remove('hidden');
        } else {
          errorDiv.classList.add('hidden');
        }
      });
      
      // Handle suggestion clicks
      stateSuggestions.addEventListener('click', function(e) {
        if (e.target.dataset.value) {
          stateInput.value = e.target.dataset.value;
          stateSuggestions.classList.add('hidden');
          // Hide error message
          document.getElementById('state-error').classList.add('hidden');
        }
      });
      
      // Hide suggestions when clicking outside
      document.addEventListener('click', function(e) {
        if (!stateInput.contains(e.target) && !stateSuggestions.contains(e.target)) {
          stateSuggestions.classList.add('hidden');
        }
      });
    }
    
    // Phone number validation with country code
    const phoneCountryCodeSelect = document.getElementById('phone_country_code') as HTMLSelectElement;
    if (phoneInput && phoneCountryCodeSelect) {
      // Function to get the country code from select
      function getCountryCode(): string {
        return phoneCountryCodeSelect.value;
      }

      const countryCodeLimits: { [key: string]: number } = {
        '+91': 10, '+1': 10, '+44': 10, '+61': 9, '+86': 11,
        '+81': 10, '+49': 11, '+33': 9, '+971': 9, '+966': 9
      };

      function validatePhone() {
        const countryCode = getCountryCode();
        const phone = phoneInput.value.replace(/\D/g, '');
        const maxDigits = countryCodeLimits[countryCode] || 10;

        // Update maxlength and pattern
        phoneInput.maxLength = maxDigits;
        phoneInput.pattern = `[0-9]{1,${maxDigits}}`;

        // For India (+91), validate 10 digits
        if (countryCode === '+91') {
          const errorDiv = document.getElementById('phone-error');
          if (phone.length > 0 && phone.length !== 10) {
            errorDiv?.classList.remove('hidden');
            errorDiv.textContent = 'Please enter a valid 10-digit phone number';
            phoneInput.classList.add('border-red-500');
          } else {
            errorDiv?.classList.add('hidden');
            phoneInput.classList.remove('border-red-500');
          }
        } else {
          // For other countries
          const errorDiv = document.getElementById('phone-error');
          if (phone.length > 0 && phone.length !== maxDigits) {
            errorDiv?.classList.remove('hidden');
            errorDiv.textContent = `Please enter a valid ${maxDigits}-digit phone number`;
            phoneInput.classList.add('border-red-500');
          } else {
            errorDiv?.classList.add('hidden');
            phoneInput.classList.remove('border-red-500');
          }
        }
      }

      phoneInput.addEventListener('input', function(e) {
        // Strip all non-digits to ensure only numbers are entered
        const value = (e.target as HTMLInputElement).value.replace(/[^0-9]/g, '');
        const countryCode = getCountryCode();
        const maxDigits = countryCodeLimits[countryCode] || 10;
        
        (e.target as HTMLInputElement).value = value.slice(0, maxDigits);
        validatePhone();
      });

      phoneCountryCodeSelect.addEventListener('change', function() {
        // Clear phone input when country code changes
        phoneInput.value = '';
        const countryCode = getCountryCode();
        phoneInput.placeholder = countryCode === '+91' ? '9876543210' : 'Enter phone number';
        validatePhone();
      });

      // Validate on blur
      phoneInput.addEventListener('blur', validatePhone);
    }
  }
  
  // Setup real-time validation error clearing
  function setupRealTimeValidation() {
    // Get all form inputs
    const inputs = document.querySelectorAll('#order-menu-form input, #order-menu-form select, #order-menu-form textarea');
    
    inputs.forEach(input => {
      // Clear validation errors when user starts typing/selecting
      input.addEventListener('input', clearValidationErrors);
      input.addEventListener('change', clearValidationErrors);
      input.addEventListener('focus', clearValidationErrors);
    });
    
    // Clear menu photos error when files are uploaded
    const menuPhotosUpload = document.getElementById('menu-photos-upload');
    if (menuPhotosUpload) {
      menuPhotosUpload.addEventListener('change', () => {
        const menuPhotosError = document.getElementById('menu-photos-error');
        if (menuPhotosError) {
          menuPhotosError.classList.add('hidden');
        }
      });
    }
  }
  
  // Clear validation errors
  function clearValidationErrors() {
    const validationErrors = document.getElementById('validation-errors');
    if (validationErrors) {
      validationErrors.classList.add('hidden');
    }
    
    // Clear individual field errors
    const fieldErrors = document.querySelectorAll('#pincode-error, #city-error, #state-error, #phone-error');
    fieldErrors.forEach(error => {
      if (error) {
        error.classList.add('hidden');
      }
    });
    
    // Clear validation popup if it exists
    const validationPopup = document.getElementById('validation-popup');
    if (validationPopup) {
      validationPopup.remove();
    }
    
    // Clear field error highlighting
    const fields = document.querySelectorAll('#order-menu-form input, #order-menu-form select, #order-menu-form textarea');
    fields.forEach(field => {
      field.classList.remove('border-red-500', 'ring-2', 'ring-red-200');
      field.classList.add('border-gray-300');
    });
  }
  
  function validateFormFields() {
    console.log(' validateFormFields() called');
    
    const pincodeInput = document.getElementById('pincode-input');
    const cityInput = document.getElementById('city-input');
    const stateInput = document.getElementById('state-input');
    const phoneInput = document.getElementById('phone-input');
    
    // Get all required form fields from the ORDER MENU FORM specifically
    const orderMenuForm = document.getElementById('order-menu-form');
    if (!orderMenuForm) {
      console.error('Order menu form not found for validation');
      return false;
    }
    
    const projectName = orderMenuForm.querySelector('input[name="projectName"]');
    const restaurantName = orderMenuForm.querySelector('input[name="restaurantName"]');
    const ownerName = orderMenuForm.querySelector('input[name="ownerName"]');
    const contactPerson = orderMenuForm.querySelector('input[name="contactPerson"]');
    const email = orderMenuForm.querySelector('input[name="email"]');
    const houseNumber = orderMenuForm.querySelector('input[name="houseNumber"]');
    const addressLine1 = orderMenuForm.querySelector('input[name="addressLine1"]');
    const country = orderMenuForm.querySelector('select[name="country"]');
    
    console.log(' Form fields found:');
    console.log('  - projectName:', projectName ? projectName.value : 'not found');
    console.log('  - restaurantName:', restaurantName ? restaurantName.value : 'not found');
    console.log('  - ownerName:', ownerName ? ownerName.value : 'not found');
    console.log('  - contactPerson:', contactPerson ? contactPerson.value : 'not found');
    console.log('  - email:', email ? email.value : 'not found');
    console.log('  - houseNumber:', houseNumber ? houseNumber.value : 'not found');
    console.log('  - addressLine1:', addressLine1 ? addressLine1.value : 'not found');
    console.log('  - country:', country ? country.value : 'not found');
    console.log('  - phone:', phoneInput ? phoneInput.value : 'not found');
    console.log('  - city:', cityInput ? cityInput.value : 'not found');
    console.log('  - state:', stateInput ? stateInput.value : 'not found');
    console.log('  - pincode:', pincodeInput ? pincodeInput.value : 'not found');
    
    let isValid = true;
    let errorMessages = [];
    let emptyFields = [];
    
    // Clear previous error states
    clearAllFieldErrors();
    
    // Validate required text fields
    if (!projectName || !projectName.value.trim()) {
      console.log(' Project Name validation failed:');
      console.log('  - projectName element:', projectName);
      console.log('  - projectName.value:', projectName ? projectName.value : 'element not found');
      emptyFields.push('Project Name');
      errorMessages.push('Project Name is required');
      isValid = false;
      highlightFieldError(projectName);
    }
    
    if (!restaurantName || !restaurantName.value.trim()) {
      console.log(' Restaurant Name validation failed:');
      console.log('  - restaurantName element:', restaurantName);
      console.log('  - restaurantName.value:', restaurantName ? restaurantName.value : 'element not found');
      emptyFields.push('Restaurant Name');
      errorMessages.push('Restaurant Name is required');
      isValid = false;
      highlightFieldError(restaurantName);
    }
    
    if (!ownerName || !ownerName.value.trim()) {
      emptyFields.push('Owner Name');
      errorMessages.push('Owner Name is required');
      isValid = false;
      highlightFieldError(ownerName);
    }
    
    if (!contactPerson || !contactPerson.value.trim()) {
      emptyFields.push('Contact Person');
      errorMessages.push('Contact Person is required');
      isValid = false;
      highlightFieldError(contactPerson);
    }
    
    if (!email || !email.value.trim()) {
      emptyFields.push('Email');
      errorMessages.push('Email is required');
      isValid = false;
      highlightFieldError(email);
    } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value)) {
      errorMessages.push('Please enter a valid email address');
      isValid = false;
      highlightFieldError(email);
    }
    
    // Validate address fields
    if (!houseNumber || !houseNumber.value.trim()) {
      emptyFields.push('House/Flat Number');
      errorMessages.push('House/Flat Number is required');
      isValid = false;
      highlightFieldError(houseNumber);
    }
    
    if (!addressLine1 || !addressLine1.value.trim()) {
      emptyFields.push('Address Line 1');
      errorMessages.push('Address Line 1 is required');
      isValid = false;
      highlightFieldError(addressLine1);
    }
    
    // Validate pincode
    if (pincodeInput && (!pincodeInput.value || pincodeInput.value.length !== 6 || !/^[0-9]{6}$/.test(pincodeInput.value))) {
      const errorDiv = document.getElementById('pincode-error');
      if (errorDiv) {
        errorDiv.classList.remove('hidden');
        errorDiv.textContent = 'Pincode must be exactly 6 digits';
      }
      emptyFields.push('Pincode');
      errorMessages.push('Pincode must be exactly 6 digits');
      isValid = false;
      highlightFieldError(pincodeInput);
    }
    
    // Validate city - allow any non-empty text
    if (cityInput && (!cityInput.value || !cityInput.value.trim())) {
      console.log(' City validation failed:');
      console.log('  - cityInput.value:', cityInput.value);
      
      const errorDiv = document.getElementById('city-error');
      if (errorDiv) {
        errorDiv.classList.remove('hidden');
        errorDiv.textContent = 'City is required';
      }
      emptyFields.push('City');
      errorMessages.push('City is required');
      isValid = false;
      highlightFieldError(cityInput);
    }
    
    // Validate state - must be from valid states list
    if (stateInput && (!stateInput.value || !indianStates.includes(stateInput.value))) {
      const errorDiv = document.getElementById('state-error');
      if (errorDiv) {
        errorDiv.classList.remove('hidden');
        errorDiv.textContent = 'Please select a valid state';
      }
      emptyFields.push('State');
      errorMessages.push('Please select a valid state');
      isValid = false;
      highlightFieldError(stateInput);
    }
    
    if (!country || !country.value) {
      emptyFields.push('Country');
      errorMessages.push('Country is required');
      isValid = false;
      highlightFieldError(country);
    }
    
    // Validate phone number based on country code
    const phoneCountryCodeSelect = document.getElementById('phone_country_code') as HTMLSelectElement;
    if (phoneInput && phoneCountryCodeSelect) {
      const countryCode = phoneCountryCodeSelect.value;
      const phoneDigits = phoneInput.value.replace(/\D/g, '');
      
      if (countryCode === '+91') {
        // For India, validate 10 digits
        if (!phoneDigits || phoneDigits.length !== 10 || !/^[0-9]{10}$/.test(phoneDigits)) {
          const errorDiv = document.getElementById('phone-error');
          if (errorDiv) {
            errorDiv.classList.remove('hidden');
            errorDiv.textContent = 'Please enter a valid 10-digit phone number for India';
          }
          emptyFields.push('Phone Number');
          errorMessages.push('Please enter a valid 10-digit phone number for India');
          isValid = false;
          highlightFieldError(phoneInput);
        }
      } else {
        // For other countries, validate based on their max digits
        const countryCodeLimits: { [key: string]: number } = {
          '+1': 10, '+44': 10, '+61': 9, '+86': 11, '+81': 10,
          '+49': 11, '+33': 9, '+971': 9, '+966': 9
        };
        const maxDigits = countryCodeLimits[countryCode] || 10;
        if (!phoneDigits || phoneDigits.length !== maxDigits || !/^[0-9]+$/.test(phoneDigits)) {
          const errorDiv = document.getElementById('phone-error');
          if (errorDiv) {
            errorDiv.classList.remove('hidden');
            errorDiv.textContent = `Please enter a valid ${maxDigits}-digit phone number`;
          }
          emptyFields.push('Phone Number');
          errorMessages.push(`Please enter a valid ${maxDigits}-digit phone number`);
          isValid = false;
          highlightFieldError(phoneInput);
        }
      }
    }
    
    // Show validation errors with popup
    if (!isValid) {
      console.log(' Form validation failed with errors:', errorMessages);
      showValidationPopup(emptyFields, errorMessages);
      
      // Scroll to top of form to show errors
      const form = document.getElementById('order-menu-form');
      if (form) {
        form.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    } else {
      console.log(' Form validation passed - all required fields are filled');
    }
    
    console.log(' validateFormFields() returning:', isValid);
    return isValid;
  }

  // Helper function to highlight field errors
  function highlightFieldError(field) {
    if (field) {
      field.classList.add('border-red-500', 'ring-2', 'ring-red-200');
      field.classList.remove('border-gray-300', 'ring-primary-500');
    }
  }

  // Helper function to clear all field errors
  function clearAllFieldErrors() {
    const fields = document.querySelectorAll('#order-menu-form input, #order-menu-form select, #order-menu-form textarea');
    fields.forEach(field => {
      field.classList.remove('border-red-500', 'ring-2', 'ring-red-200');
      field.classList.add('border-gray-300');
    });
    
    // Clear individual field error messages
    const fieldErrors = document.querySelectorAll('#pincode-error, #city-error, #state-error, #phone-error');
    fieldErrors.forEach(error => {
      if (error) {
        error.classList.add('hidden');
      }
    });
  }

  // Function to show validation popup
  function showValidationPopup(emptyFields, errorMessages) {
    // Create popup if it doesn't exist
    let popup = document.getElementById('validation-popup');
    if (!popup) {
      popup = document.createElement('div');
      popup.id = 'validation-popup';
      popup.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      popup.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-red-600">Required Fields Missing</h3>
            <button id="close-validation-popup" class="text-gray-400 hover:text-gray-600">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          <div class="mb-4">
            <p class="text-gray-700 mb-3">Please fill in all required fields marked with <span class="text-red-500 font-bold">*</span>:</p>
            <ul class="list-disc list-inside text-red-600 space-y-1">
              ${emptyFields.map(field => `<li>${field}</li>`).join('')}
            </ul>
          </div>
          <div class="flex justify-end">
            <button id="ok-validation-popup" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
              OK
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(popup);
      
      // Add event listeners
      document.getElementById('close-validation-popup').addEventListener('click', () => {
        popup.remove();
      });
      
      document.getElementById('ok-validation-popup').addEventListener('click', () => {
        popup.remove();
      });
      
      // Close popup when clicking outside
      popup.addEventListener('click', (e) => {
        if (e.target === popup) {
          popup.remove();
        }
      });
    } else {
      // Update existing popup content
      const emptyFieldsList = popup.querySelector('ul');
      emptyFieldsList.innerHTML = emptyFields.map(field => `<li>${field}</li>`).join('');
    }
  }

  // Handle Order Menu System form
  function handleOrderMenuForm() {
    const form = document.getElementById('order-menu-form');
    console.log('handleOrderMenuForm called - form found:', form);
    const closeBtn = document.getElementById('close-order-menu-form');
    const cancelBtn = document.getElementById('cancel-order-menu');
    
    console.log(' Close button found:', closeBtn);
    console.log(' Cancel button found:', cancelBtn);
    const logoUpload = document.getElementById('order-menu-logo-upload');
    const logoUploadArea = document.getElementById('order-menu-logo-upload-area');
    const logoPreview = document.getElementById('order-menu-logo-preview');
    const logoPreviewImg = document.getElementById('order-menu-logo-preview-img');
    const logoFilename = document.getElementById('order-menu-logo-filename');
    const logoRemoveBtn = document.getElementById('order-menu-logo-remove');
    const menuPhotosUpload = document.getElementById('menu-photos-upload');
    const menuPhotosUploadArea = document.getElementById('menu-photos-upload-area');
    const menuPhotosPreview = document.getElementById('menu-photos-preview');
    const menuPhotosGrid = document.getElementById('menu-photos-grid');
    
    console.log('menuPhotosPreview element found:', menuPhotosPreview);
    console.log('menuPhotosGrid element found:', menuPhotosGrid);
    console.log('menuPhotosUpload element found:', menuPhotosUpload);
    
    // Test if file input exists
    if (!menuPhotosUpload) {
      console.error('CRITICAL: File input element not found! Creating fallback...');
      
      // Create a fallback file input
      const fallbackInput = document.createElement('input');
      fallbackInput.type = 'file';
      fallbackInput.name = 'menuPhotos';
      fallbackInput.accept = 'image/*';
      fallbackInput.multiple = true;
      fallbackInput.className = 'hidden';
      fallbackInput.id = 'menu-photos-upload';
      
      // Add it to the form
      const form = document.getElementById('order-menu-form');
      if (form) {
        form.appendChild(fallbackInput);
        console.log('Fallback file input created and added to form');
      }
    } else {
      console.log('File input element found successfully');
    }
    const removeAllMenuPhotosBtn = document.getElementById('remove-all-menu-photos');
    
    // Menu Photos Upload Functionality
    if (menuPhotosUploadArea && menuPhotosUpload) {
      menuPhotosUploadArea.addEventListener('click', () => {
        menuPhotosUpload.click();
      });

      // File input change handler
      menuPhotosUpload.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        
        if (files.length > 0) {
          // Validate file sizes (5MB max per file)
          const validFiles = files.filter(file => {
            const fileSizeMB = file.size / (1024 * 1024);
            return fileSizeMB <= 5;
          });
          
          if (validFiles.length !== files.length) {
            // Show file size error inline instead of alert
            const errorDiv = document.getElementById('file-size-error');
            if (errorDiv) {
              errorDiv.classList.remove('hidden');
              errorDiv.textContent = `Some files were too large. Only files under 5MB are allowed. ${validFiles.length}/${files.length} files uploaded.`;
            }
          }
          
          // Add all valid files to the array
          menuPhotos = [...menuPhotos, ...validFiles];
          
          // CRITICAL: Cache files in global variable BEFORE input is cleared
          cachedMenuPhotos = [...menuPhotos];
          console.log('ðŸ“¸ Cached menu photos:', cachedMenuPhotos.length, 'files');
          
          // Update preview
          updateMenuPhotosPreview();
          
          // Reset visual warning styles
          menuPhotosUploadArea.classList.remove('border-red-300', 'bg-red-50');
          menuPhotosUploadArea.classList.add('border-gray-300', 'bg-gray-50');
          
          // Show success message and add more button
          menuPhotosUploadArea.innerHTML = `
            <div class="flex flex-col items-center">
              <svg class="w-16 h-16 text-green-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 13l4 4L19 7"></path>
              </svg>
              <p class="text-green-600 mb-2 font-medium">${validFiles.length} photo(s) uploaded successfully</p>
              <p class="text-sm text-gray-500">Total: ${menuPhotos.length} photos uploaded</p>
              <button type="button" onclick="document.getElementById('menu-photos-upload').click()" class="mt-4 px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg transition-all transform hover:scale-105 shadow-lg">
                <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Add More Photos
              </button>
            </div>
          `;
          
          // Reset file input
          menuPhotosUpload.value = '';
        }
      });
    }

    // Update menu photos preview
    function updateMenuPhotosPreview() {
      if (menuPhotos.length > 0) {
        menuPhotosPreview.classList.remove('hidden');
        menuPhotosGrid.innerHTML = '';
        
        // Add photo counter header
        const counterDiv = document.createElement('div');
        counterDiv.className = 'col-span-full mb-4 p-4 bg-green-50 border border-green-200 rounded-lg';
        counterDiv.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <svg class="w-6 h-6 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              <div>
                <span class="text-green-800 font-semibold text-lg">${menuPhotos.length} Photo(s) Uploaded</span>
                <p class="text-sm text-green-600">Menu photos ready for your order system</p>
              </div>
            </div>
            <button type="button" onclick="removeAllMenuPhotos()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white text-sm font-medium rounded-lg transition-colors">
              <svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
              Remove All
            </button>
          </div>
        `;
        menuPhotosGrid.appendChild(counterDiv);
        
        // Add individual photo previews
        menuPhotos.forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const photoDiv = document.createElement('div');
            photoDiv.className = 'relative group bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow';
            photoDiv.innerHTML = `
              <div class="relative">
                <img src="${e.target.result}" alt="Menu photo ${index + 1}" class="w-full h-32 object-cover">
                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all duration-200 flex items-center justify-center">
                  <button type="button" class="opacity-0 group-hover:opacity-100 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm hover:bg-red-600 transition-all duration-200 shadow-lg" onclick="removeMenuPhoto(${index})">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                  </button>
                </div>
              </div>
              <div class="p-3">
                <p class="text-sm text-gray-700 font-medium truncate">${file.name}</p>
                <p class="text-xs text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
              </div>
            `;
            menuPhotosGrid.appendChild(photoDiv);
          };
          reader.readAsDataURL(file);
        });
      } else {
        menuPhotosPreview.classList.add('hidden');
      }
    }

    // Remove individual menu photo
    window.removeMenuPhoto = (index) => {
      console.log('removeMenuPhoto called, index:', index);
      console.log('Before removal - menuPhotos length:', menuPhotos.length);
      menuPhotos.splice(index, 1);
      console.log('After removal - menuPhotos length:', menuPhotos.length);
      updateMenuPhotosPreview();
      
      // Reset upload area if no photos
      if (menuPhotos.length === 0) {
        menuPhotosUploadArea.innerHTML = `
          <div class="flex flex-col items-center">
            <svg class="w-16 h-16 text-red-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
            <p class="text-red-600 mb-2 font-medium">Menu photos required!</p>
            <p class="text-sm text-gray-500 mb-2">Please upload at least one menu photo to continue</p>
            <div class="mt-3 flex items-center text-xs text-red-500 font-medium">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              This field is mandatory
            </div>
          </div>
        `;
        // Add red border to indicate required field
        menuPhotosUploadArea.classList.add('border-red-300', 'bg-red-50');
        menuPhotosUploadArea.classList.remove('border-gray-300', 'bg-gray-50');
      }
    };

    // Remove all menu photos
    window.removeAllMenuPhotos = () => {
      console.log('removeAllMenuPhotos called');
      console.log('Before removal - menuPhotos length:', menuPhotos.length);
      menuPhotos = [];
      console.log('After removal - menuPhotos length:', menuPhotos.length);
      updateMenuPhotosPreview();
      menuPhotosUpload.value = '';
      
      // Reset upload area with warning
      menuPhotosUploadArea.innerHTML = `
        <div class="flex flex-col items-center">
          <svg class="w-16 h-16 text-red-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
          <p class="text-red-600 mb-2 font-medium">Menu photos required!</p>
          <p class="text-sm text-gray-500 mb-2">Please upload at least one menu photo to continue</p>
          <div class="mt-3 flex items-center text-xs text-red-500 font-medium">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            This field is mandatory
          </div>
        </div>
      `;
      // Add red border to indicate required field
      menuPhotosUploadArea.classList.add('border-red-300', 'bg-red-50');
      menuPhotosUploadArea.classList.remove('border-gray-300', 'bg-gray-50');
    };

    const addMenuItemBtn = document.getElementById('add-menu-item');
    const menuItemsContainer = document.getElementById('menu-items-container');
    const categoryInput = document.getElementById('oms-category-input');
    const addCategoryBtn = document.getElementById('oms-add-category-btn');
    const clearAllCategoriesBtn = document.getElementById('oms-clear-all-categories-btn');
    const categoryPills = document.getElementById('oms-category-pills');
    const currentCategoryEl = document.getElementById('oms-current-category');
    const prevBtn = document.getElementById('oms-prev-page');
    const nextBtn = document.getElementById('oms-next-page');
    const pageIndicator = document.getElementById('oms-page-indicator');

    // Category state
    const categories = [];
    let currentCategoryIndex = -1;
    const ITEMS_PER_PAGE = 6;
    let currentPage = 1;

    function renderCategoryPills() {
      categoryPills.innerHTML = '';
      categories.forEach((cat, idx) => {
        const pill = document.createElement('button');
        pill.type = 'button';
        pill.className = `px-3 py-1 rounded-full text-sm ${idx === currentCategoryIndex ? 'bg-amber-600 text-white' : 'bg-gray-100'} flex items-center`;
        // Build button-like content with spacing between text and x
        const label = document.createElement('span');
        label.textContent = cat;
        label.className = 'mr-2';
        pill.appendChild(label);
        const x = document.createElement('span');
        x.textContent = 'âœ•';
        x.className = 'text-xs opacity-70 hover:opacity-100 ml-1';
        x.addEventListener('click', (e) => {
          e.stopPropagation();
          // Remove this category and any items with it
          const removed = categories.splice(idx, 1)[0];
          if (currentCategoryIndex >= categories.length) currentCategoryIndex = categories.length - 1;
          // Remove category from visible item rows' category inputs if matched
          if (menuItemsContainer) {
            menuItemsContainer.querySelectorAll('.menu-item-row').forEach(row => {
              const input = row.querySelector('.oms-category-field');
              if (input && input.value === removed) {
                input.value = '';
              }
            });
          }
          currentCategoryEl.textContent = categories[currentCategoryIndex] || 'Uncategorized';
          renderCategoryPills();
          filterItemsByCategory();
        });
        pill.appendChild(x);
        pill.addEventListener('click', () => {
          currentCategoryIndex = idx;
          currentCategoryEl.textContent = cat;
          renderCategoryPills();
          filterItemsByCategory();
        });
        categoryPills.appendChild(pill);
      });
    }
    // Remove selected button intentionally removed per request

    // Clear all categories
    clearAllCategoriesBtn?.addEventListener('click', () => {
      categories.splice(0, categories.length);
      currentCategoryIndex = -1;
      currentCategoryEl.textContent = 'Uncategorized';
      renderCategoryPills();
      filterItemsByCategory();
      // Do not delete items, just clear their category values
      if (menuItemsContainer) menuItemsContainer.querySelectorAll('.oms-category-field').forEach((el) => el.value = '');
    });

    addCategoryBtn?.addEventListener('click', () => {
      const value = categoryInput.value.trim();
      if (!value) return;
      if (!categories.includes(value)) {
        categories.push(value);
        currentCategoryIndex = categories.length - 1;
        currentCategoryEl.textContent = value;
        renderCategoryPills();
        // Apply to visible category inputs
        if (menuItemsContainer) {
          menuItemsContainer.querySelectorAll('.oms-category-field').forEach((el) => {
            if (!el.value) el.value = value;
          });
        }
        categoryInput.value = '';
      }
    });

    function filterItemsByCategory() {
      if (!menuItemsContainer) return;
      const allItems = Array.from(menuItemsContainer.querySelectorAll('.menu-item-row'));
      // Show all first
      allItems.forEach(row => row.style.display = '');
      // Filter by category if selected
      if (currentCategoryIndex >= 0) {
        const cat = categories[currentCategoryIndex];
        allItems.forEach(row => {
          const input = row.querySelector('.oms-category-field');
          if (input && input.value && input.value !== cat) {
            row.style.display = 'none';
          }
        });
      }
      // Then paginate
      const visible = allItems.filter(r => r.style.display !== 'none');
      const totalPages = Math.max(1, Math.ceil(visible.length / ITEMS_PER_PAGE));
      currentPage = Math.min(currentPage, totalPages);
      if (pageIndicator) {
        pageIndicator.textContent = `Page ${currentPage} / ${totalPages}`;
      }
      visible.forEach((row, idx) => {
        const pageOfItem = Math.floor(idx / ITEMS_PER_PAGE) + 1;
        row.style.display = (pageOfItem === currentPage) ? '' : 'none';
      });
    }

    prevBtn?.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage -= 1;
        filterItemsByCategory();
      }
    });

    nextBtn?.addEventListener('click', () => {
      currentPage += 1;
      filterItemsByCategory();
    });
    
    logoUpload?.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const fileName = file.name;
        const fileSize = (file.size / 1024 / 1024).toFixed(2);
        logoUploadArea.innerHTML = `
          <div class="flex flex-col items-center">
            <svg class="w-12 h-12 text-green-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <p class="text-green-600 mb-1 font-medium">Logo uploaded successfully</p>
            <p class="text-sm text-gray-500">${fileName} (${fileSize} MB)</p>
          </div>
        `;
      }
    });


    // Menu style selection functionality
    const menuStyleOptions = document.querySelectorAll('.menu-style-option');
    menuStyleOptions.forEach(option => {
      option.addEventListener('click', () => {
        // Remove selected class from all options
        menuStyleOptions.forEach(opt => {
          opt.classList.remove('border-primary-500', 'bg-primary-50');
          opt.classList.add('border-gray-200');
        });
        
        // Add selected class to clicked option
        option.classList.remove('border-gray-200');
        option.classList.add('border-primary-500', 'bg-primary-50');
        
        // Check the radio button
        const radio = option.querySelector('input[type="radio"]');
        if (radio) {
          radio.checked = true;
        }
      });
    });
    
    // Color picker synchronization for Order Menu form
    function syncOrderMenuColorInputs() {
      const colorInputs = form?.querySelectorAll('input[type="color"]');
      const textInputs = form?.querySelectorAll('input[name$="ColorText"]');
      
      colorInputs?.forEach((colorInput, index) => {
        const textInput = textInputs?.[index];
        if (textInput) {
          // Sync color picker to text input
          colorInput.addEventListener('input', () => {
            textInput.value = colorInput.value;
          });
          
          // Sync text input to color picker
          textInput.addEventListener('input', () => {
            if (/^#[0-9A-F]{6}$/i.test(textInput.value)) {
              colorInput.value = textInput.value;
            }
          });
        }
      });
    }
    
    syncOrderMenuColorInputs();
    
    // Add menu item functionality
    let menuItemCount = 1;
    addMenuItemBtn?.addEventListener('click', () => {
      const menuItemRow = document.createElement('div');
      menuItemRow.className = 'menu-item-row grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 p-4 border border-gray-200 rounded-lg';
      menuItemRow.innerHTML = `
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Item Name</label>
          <input type="text" name="menuItems[${menuItemCount}][item_name]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="e.g., Margherita Pizza" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Price (â‚¹)</label>
          <input type="number" name="menuItems[${menuItemCount}][price]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="299" step="0.01" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
          <input type="text" name="menuItems[${menuItemCount}][item_category]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 oms-category-field" placeholder="Type or pick from pills" required>
        </div>
        <div class="flex items-end">
          <button type="button" class="remove-menu-item px-3 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm">
            Remove
          </button>
        </div>
      `;
      menuItemsContainer?.appendChild(menuItemRow);
      menuItemCount++;
      // Apply current category automatically
      if (currentCategoryIndex >= 0) {
        const currentCat = categories[currentCategoryIndex];
        const catInput = menuItemRow.querySelector('.oms-category-field');
        if (catInput && !catInput.value) catInput.value = currentCat;
      }
      filterItemsByCategory();
    });
    
    // Remove menu item functionality
    menuItemsContainer?.addEventListener('click', (e) => {
      if (e.target.classList.contains('remove-menu-item')) {
        e.target.closest('.menu-item-row').remove();
        filterItemsByCategory();
      }
    });

    // Initial filter
    filterItemsByCategory();
    
    // Close form handlers
    closeBtn?.addEventListener('click', () => {
      userClosedForm = true;
      showBrowseProductsSection();
      showNoActivityMessage();
      // Clear URL parameters when form is closed
      window.history.replaceState({}, document.title, window.location.pathname);
    });
    
    cancelBtn?.addEventListener('click', () => {
      userClosedForm = true;
      showBrowseProductsSection();
      showNoActivityMessage();
      // Clear URL parameters when form is closed
      window.history.replaceState({}, document.title, window.location.pathname);
    });
    
    // Form submission - simplified validation
    console.log('Adding form submission event listener to form:', form);
    // Disabled legacy submit handler; unified handler below handles validation + upload + insert
    if (false && form) {
      form.addEventListener('submit', async (e) => {
        console.log('Form submit event triggered!');
        e.preventDefault();
        
        // CRITICAL: Check if user is logged in before allowing form submission
        const authManager = window.globalAuthManager || window.simpleAuthManager;
        if (!authManager || !authManager.isUserLoggedIn()) {
          alert(' Please log in to submit this form. You must be authenticated to place an order.');
          return;
        }
      
      const formData = new FormData(form);
      const formDataObj = Object.fromEntries(formData);
      
      // Validate menu photos are uploaded (Required for Order Menu System)
      console.log('Form submission - menuPhotos length:', menuPhotos.length);
      if (menuPhotos.length === 0) {
        // Show menu photos error inline instead of alert
        const errorDiv = document.getElementById('menu-photos-error');
        if (errorDiv) {
          errorDiv.classList.remove('hidden');
          errorDiv.textContent = 'Please upload at least one menu photo. This field is required for Order Menu System.';
        }
        console.log('Form submission blocked - no menu photos');
        return;
      }
      console.log('Form submission allowed - menu photos present');
      return;

      // Validate phone number
      if (!formDataObj.phone || formDataObj.phone.trim() === '') {
        // Show phone error inline instead of alert
        const errorDiv = document.getElementById('phone-validation-error');
        if (errorDiv) {
          errorDiv.classList.remove('hidden');
          errorDiv.textContent = 'Please enter your phone number. This field is required.';
        }
        return;
      }

      // Validate restaurant address fields
      if (!formDataObj.houseNumber || formDataObj.houseNumber.trim() === '') {
        // Show address error inline instead of alert
        const errorDiv = document.getElementById('address-validation-error');
        if (errorDiv) {
          errorDiv.classList.remove('hidden');
          errorDiv.textContent = 'Please enter house/flat number. This field is required.';
        }
        return;
      }
      if (!formDataObj.addressLine1 || formDataObj.addressLine1.trim() === '') {
        const errorDiv = document.getElementById('address-validation-error');
        if (errorDiv) {
          errorDiv.classList.remove('hidden');
          errorDiv.textContent = 'Please enter address line 1. This field is required.';
        }
        return;
      }
      if (!formDataObj.city || formDataObj.city.trim() === '') {
        const errorDiv = document.getElementById('address-validation-error');
        if (errorDiv) {
          errorDiv.classList.remove('hidden');
          errorDiv.textContent = 'Please enter city. This field is required.';
        }
        return;
      }
      if (!formDataObj.state || formDataObj.state.trim() === '') {
        const errorDiv = document.getElementById('address-validation-error');
        if (errorDiv) {
          errorDiv.classList.remove('hidden');
          errorDiv.textContent = 'Please enter state. This field is required.';
        }
        return;
      }
      if (!formDataObj.pincode || formDataObj.pincode.trim() === '') {
        const errorDiv = document.getElementById('address-validation-error');
        if (errorDiv) {
          errorDiv.classList.remove('hidden');
          errorDiv.textContent = 'Please enter pincode. This field is required.';
        }
        return;
      }

      // Validate email
      if (!formDataObj.email || formDataObj.email.trim() === '') {
        // Show email error inline instead of alert
        const errorDiv = document.getElementById('email-validation-error');
        if (errorDiv) {
          errorDiv.classList.remove('hidden');
          errorDiv.textContent = 'Please enter your email address. This field is required.';
        }
        return;
      }
      
      console.log(' Order Menu requirements saved:', formDataObj);
      
      // Clear all error messages
      const errorDivs = ['validation-errors', 'menu-photos-error', 'phone-validation-error', 'address-validation-error', 'email-validation-error', 'file-size-error', 'warning-message', 'popup-message', 'error-message'];
      errorDivs.forEach(id => {
        const div = document.getElementById(id);
        if (div) div.classList.add('hidden');
      });
      
      // Create order menu requirements object
      const orderMenuRequirements = {
        productId: '5',
        productName: 'Order Menu System',
        productDescription: 'Complete order management system with digital menu integration, real-time order tracking, and payment processing. Perfect for restaurants looking to streamline their ordering process.',
        productPrice: 'â‚¹1,179',
        projectName: formDataObj.projectName,
        restaurantName: formDataObj.restaurantName,
        ownerName: formDataObj.ownerName,
        houseNumber: formDataObj.houseNumber,
        addressLine1: formDataObj.addressLine1,
        city: formDataObj.city,
        state: formDataObj.state,
        pincode: formDataObj.pincode,
        country: formDataObj.country,
        contactPerson: formDataObj.contactPerson,
        email: formDataObj.email,
        phone: (() => {
          const countryCode = phoneCountryCodeSelect?.value || '+91';
          return phoneCountryCodeSelect ? `${countryCode}${formDataObj.phone.replace(/\D/g, '')}` : formDataObj.phone;
        })(),
        additionalRequirements: formDataObj.additionalRequirements,
        restaurantLogo: formDataObj.restaurantLogo,
        menuPhotos: menuPhotos || [],
        timestamp: new Date().toISOString()
      };
      
      try {
        // Save Order Menu System to Supabase OMS table
        console.log(' Saving OMS data to Supabase...');
        
        // Get Supabase client
        const { supabase } = await import('../lib/supabase');
        
        // Check if Supabase is available
        if (!supabase) {
          console.error(' Supabase not available, saving locally only');
          const existingRequirements = JSON.parse(localStorage.getItem('order-menu-requirements') || '[]');
          existingRequirements.push(orderMenuRequirements);
          localStorage.setItem('order-menu-requirements', JSON.stringify(existingRequirements));
          // Show success message inline instead of alert
          const successDiv = document.getElementById('success-message');
          if (successDiv) {
            successDiv.classList.remove('hidden');
            successDiv.textContent = 'Order Menu requirements saved locally! Our team will contact you soon.';
          }
        } else {
          // Save to Supabase using OMS function
          // Upload optional logo to Supabase Storage 'logos' bucket (RPC flow)
          let rpcLogoUrl = null;
          let rpcLogoFilename = null;
          let rpcLogoSize = null;
          try {
            const logoInputEl = document.getElementById('order-menu-logo-upload');
            const rpcLogoFile = (typeof cachedLogoFile !== 'undefined' && cachedLogoFile) ? cachedLogoFile : (logoInputEl && logoInputEl.files && logoInputEl.files[0]) ? logoInputEl.files[0] : null;
            if (rpcLogoFile) {
              const timestamp = Date.now();
              const randomId = Math.random().toString(36).substring(2, 8);
              const safeName = rpcLogoFile.name.replace(/[^a-zA-Z0-9.-]/g, '_');
              const path = `logos/${timestamp}_${randomId}_${safeName}`;
              const { error: uploadError } = await supabase.storage
                .from('logos')
                .upload(path, rpcLogoFile, { upsert: true, contentType: rpcLogoFile.type, cacheControl: '3600' });
              if (!uploadError) {
                const { data: urlData } = supabase.storage.from('logos').getPublicUrl(path);
                rpcLogoUrl = urlData?.publicUrl || null;
                if (!rpcLogoUrl) {
                  const { data: signed } = await supabase.storage.from('logos').createSignedUrl(path, 60 * 60 * 24 * 365);
                  rpcLogoUrl = signed?.signedUrl || null;
                }
                rpcLogoFilename = rpcLogoFile.name;
                rpcLogoSize = rpcLogoFile.size;
              } else {
                console.error(' Logo upload error (RPC flow):', uploadError);
              }
            }
          } catch (e) {
            console.warn(' Logo upload skipped (RPC flow):', e);
          }
          const phoneCountryCodeSelect = document.getElementById('phone_country_code') as HTMLSelectElement;
          const countryCode = phoneCountryCodeSelect?.value || '+91';
          const formattedPhone = phoneCountryCodeSelect ? `${countryCode}${formDataObj.phone.replace(/\D/g, '')}` : formDataObj.phone;
          
          const { data: customizationData, error: customizationError } = await supabase.rpc('upsert_oms_customization', {
            p_user_email: formDataObj.email,
            p_project_name: formDataObj.projectName,
            p_restaurant_name: formDataObj.restaurantName,
            p_owner_name: formDataObj.ownerName,
            p_restaurant_address: `${formDataObj.houseNumber}, ${formDataObj.addressLine1}, ${formDataObj.city}, ${formDataObj.state} ${formDataObj.pincode}, ${formDataObj.country}`,
            p_contact_person: formDataObj.contactPerson,
            p_phone_number: formattedPhone,
            p_house_number: formDataObj.houseNumber,
            p_address_line1: formDataObj.addressLine1,
            p_city: formDataObj.city,
            p_state: formDataObj.state,
            p_pincode: formDataObj.pincode,
            p_country: formDataObj.country,
            p_contact_person: formDataObj.contactPerson,
            p_phone_number: formattedPhone,
            p_user_id: null,
            p_logo_url: rpcLogoUrl,
            p_logo_filename: rpcLogoFilename,
            p_logo_size: rpcLogoSize,
            p_additional_requirements: formDataObj.additionalRequirements || ''
          });
          
          if (customizationError) {
            console.error(' Error saving to Supabase:', customizationError);
            // Fallback to localStorage
            const existingRequirements = JSON.parse(localStorage.getItem('order-menu-requirements') || '[]');
            existingRequirements.push(orderMenuRequirements);
            localStorage.setItem('order-menu-requirements', JSON.stringify(existingRequirements));
            // Show success message inline instead of alert
          const successDiv = document.getElementById('success-message');
          if (successDiv) {
            successDiv.classList.remove('hidden');
            successDiv.textContent = 'Order Menu requirements saved locally! Our team will contact you soon.';
          }
          } else if (customizationData && customizationData.length > 0) {
            const result = customizationData[0];
            if (result.is_duplicate) {
              // Show duplicate data warning based on duplicate type
              let duplicateMessage = '';
              if (result.duplicate_type === 'exact') {
                duplicateMessage = 'This exact data has already been submitted. Please check your existing orders or contact support if you need to make changes.';
              } else if (result.duplicate_type === 'contact') {
                duplicateMessage = 'Data with the same contact person and phone number already exists. The existing record has been updated with your new project information.';
              } else if (result.duplicate_type === 'restaurant') {
                duplicateMessage = 'A restaurant with this name already exists, but your project name is different. A new record has been created.';
              } else {
                duplicateMessage = 'This data has already been submitted. Please check your existing orders or contact support if you need to make changes.';
              }
              
              const warningDiv = document.getElementById('warning-message');
              if (warningDiv) {
                warningDiv.classList.remove('hidden');
                warningDiv.textContent = ` ${duplicateMessage}`;
              }
            } else {
              console.log(' OMS data saved to Supabase with ID:', result.data_id);
              // Show success message inline instead of alert
              const successDiv = document.getElementById('success-message');
              if (successDiv) {
                successDiv.classList.remove('hidden');
                successDiv.textContent = 'Order Menu requirements saved successfully!';
              }

              // Refresh recent activity to show the new submission
              setTimeout(() => {
                loadRecentActivity();
              }, 500);
            }
          } else {
            console.error(' No data returned from OMS function');
            // Fallback to localStorage
            const existingRequirements = JSON.parse(localStorage.getItem('order-menu-requirements') || '[]');
            existingRequirements.push(orderMenuRequirements);
            localStorage.setItem('order-menu-requirements', JSON.stringify(existingRequirements));
            // Show success message inline instead of alert
          const successDiv = document.getElementById('success-message');
          if (successDiv) {
            successDiv.classList.remove('hidden');
            successDiv.textContent = 'Order Menu requirements saved locally! Our team will contact you soon.';
          }
          }
        }
        
        // Clear URL parameters to show browse products section
        window.history.replaceState({}, document.title, window.location.pathname);
        // Show Browse Products section with smooth transition
        showBrowseProductsSection();
        // Clear form
        form.reset();
      } catch (error) {
        console.error('Error saving order menu requirements:', error);
        // Show error message inline instead of alert
        const errorDiv = document.getElementById('error-message');
        if (errorDiv) {
          errorDiv.classList.remove('hidden');
          errorDiv.textContent = 'Error saving order menu requirements. Please try again.';
        }
      }
    });


    // Logo upload functionality for Order Menu System
    console.log('OMS Logo upload elements:', {
      logoUpload: !!logoUpload,
      logoUploadArea: !!logoUploadArea,
      logoPreview: !!logoPreview,
      logoPreviewImg: !!logoPreviewImg,
      logoFilename: !!logoFilename,
      logoRemoveBtn: !!logoRemoveBtn
    });
    
    // Setup logo upload functionality
    function setupLogoUpload() {
      const logoUpload = document.getElementById('order-menu-logo-upload');
      const logoUploadArea = document.getElementById('order-menu-logo-upload-area');
      
      console.log('Setting up logo upload - elements found:', {
        logoUpload: !!logoUpload,
        logoUploadArea: !!logoUploadArea
      });
      
      if (logoUpload && logoUploadArea) {
        // Remove any existing event listeners
        logoUploadArea.replaceWith(logoUploadArea.cloneNode(true));
        const newLogoUploadArea = document.getElementById('order-menu-logo-upload-area');
        
        // Add click handler
        newLogoUploadArea.addEventListener('click', (e) => {
          console.log('Logo upload area clicked!');
          e.preventDefault();
          e.stopPropagation();
          console.log('Triggering file input click...');
          logoUpload.click();
          console.log('File input click triggered');
        });
        
        console.log('Logo upload click handler attached successfully');
      } else {
        console.error('Logo upload elements not found!');
      }
    }
    
    // Setup logo upload immediately
    setupLogoUpload();
    
    // Also setup when form becomes visible
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          const form = document.getElementById('order-menu-customization-form');
          if (form && !form.classList.contains('hidden')) {
            console.log('Order menu form is now visible, setting up logo upload...');
            setupLogoUpload();
          }
        }
      });
    });
    
    const orderMenuForm = document.getElementById('order-menu-customization-form');
    if (orderMenuForm) {
      observer.observe(orderMenuForm, { attributes: true, attributeFilter: ['class'] });
    }
    
    // Logo upload change handler
    if (logoUpload) {
      logoUpload.addEventListener('change', (e) => {
        console.log('OMS Logo upload change event triggered');
        const file = e.target.files[0];
        if (file) {
          console.log('File selected:', file.name);
          
          // CRITICAL: Cache logo file in global variable
          cachedLogoFile = file;
          console.log('ðŸ·ï¸ Cached logo file:', file.name);
          
          const reader = new FileReader();
          reader.onload = (e) => {
            console.log('File reader onload triggered');
            logoPreviewImg.src = e.target.result;
            logoFilename.textContent = file.name;
            logoPreview.classList.remove('hidden');
            // Update upload area to show success state instead of hiding it
            console.log('Updating logoUploadArea innerHTML');
            logoUploadArea.innerHTML = `
              <div class="flex flex-col items-center">
                <svg class="w-12 h-12 text-green-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <p class="text-green-600 mb-1 font-medium">Logo uploaded successfully</p>
                <p class="text-sm text-gray-500">${file.name}</p>
                <button type="button" id="change-logo-btn-oms" class="mt-2 text-sm text-blue-600 hover:text-blue-800 underline" style="display: block !important; visibility: visible !important;">Change Logo</button>
              </div>
            `;
            
            // Add event listener to the new button
            const changeLogoBtn = document.getElementById('change-logo-btn-oms');
            if (changeLogoBtn) {
              changeLogoBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const fileInput = document.getElementById('order-menu-logo-upload');
                if (fileInput) {
                  fileInput.click();
                } else {
                  console.error('order-menu-logo-upload element not found when clicking change logo button');
                }
              });
            }
            
            console.log('LogoUploadArea innerHTML updated');
          };
          reader.readAsDataURL(file);
        }
      });

      // Remove logo functionality
      logoRemoveBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        logoUpload.value = '';
        logoPreview.classList.add('hidden');
        // Reset upload area to original state
        logoUploadArea.innerHTML = `
          <div class="flex flex-col items-center">
            <svg class="w-12 h-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            <p class="text-gray-600 mb-2">Click to upload restaurant logo</p>
            <p class="text-sm text-gray-500">PNG, JPG, SVG up to 10MB</p>
          </div>
        `;
      });
    }


    // Close form handlers using event delegation
    console.log('Setting up Order Menu form event listeners...');
    console.log('Close button found:', closeBtn);
    console.log('Cancel button found:', cancelBtn);
    
    // Use event delegation to ensure buttons work even if they're not immediately available
    document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'close-order-menu-form') {
        console.log('Close button clicked via delegation!');
        e.preventDefault();
        document.getElementById('order-menu-customization-form').classList.add('hidden');
        window.history.replaceState({}, document.title, window.location.pathname);
        // Set flag to prevent loadRecentActivity from overriding
        userClosedForm = true;
        // Immediately show browse products content without delay
        showBrowseProductsSection();
        showNoActivityMessage();
      }
      
      if (e.target && e.target.id === 'cancel-order-menu') {
        console.log('Cancel button clicked via delegation!');
        e.preventDefault();
        document.getElementById('order-menu-customization-form').classList.add('hidden');
        window.history.replaceState({}, document.title, window.location.pathname);
        // Set flag to prevent loadRecentActivity from overriding
        userClosedForm = true;
        // Immediately show browse products content without delay
        showBrowseProductsSection();
        showNoActivityMessage();
      }
    });
    
    // Add direct event listeners as backup
    if (closeBtn) {
      console.log(' Adding direct event listener to close button');
      closeBtn.addEventListener('click', (e) => {
        console.log('Close button clicked via direct listener!');
        e.preventDefault();
        document.getElementById('order-menu-customization-form').classList.add('hidden');
        window.history.replaceState({}, document.title, window.location.pathname);
        userClosedForm = true;
        showBrowseProductsSection();
        showNoActivityMessage();
      });
    } else {
      console.log(' Close button not found for direct event listener');
    }
    
    if (cancelBtn) {
      console.log(' Adding direct event listener to cancel button');
      cancelBtn.addEventListener('click', (e) => {
        console.log('Cancel button clicked via direct listener!');
        e.preventDefault();
        document.getElementById('order-menu-customization-form').classList.add('hidden');
        window.history.replaceState({}, document.title, window.location.pathname);
        userClosedForm = true;
        showBrowseProductsSection();
        showNoActivityMessage();
      });
    } else {
      console.log(' Cancel button not found for direct event listener');
    }
    } else {
      console.error('Form not found - cannot add event listener');
    }
    
    // Add real-time validation for form fields
    setupFormValidation();
    
    // Add real-time validation error clearing
    setupRealTimeValidation();
    
    // Add form submit event listener to prevent submission if validation fails
    if (form) {
      form.addEventListener('submit', (e) => {
        console.log('Form submit event triggered!');
        
        // Always prevent default submission first
        e.preventDefault();
        e.stopPropagation();
        
        // Run validation before submission
        console.log(' Running validation before form submit event...');
        const formValidationResult = validateFormFields();
        if (!formValidationResult) {
          console.log(' Validation failed, preventing form submission');
          return;
        }
        
        // Submit via unified handler after validation passes
        handleOrderMenuFormSubmission();
      });
    } else {
      console.error('Form not found for submit event listener');
    }
  }

  // Handle Order Menu Form submission after validation passes
  async function handleOrderMenuFormSubmission() {
    console.log('ðŸš€ðŸš€ðŸš€ STARTING handleOrderMenuFormSubmission() ðŸš€ðŸš€ðŸš€');
    console.log('ðŸ“ Timestamp:', new Date().toISOString());
    
    const form = document.getElementById('order-menu-form');
    if (!form) {
      console.error(' Order menu form not found ');
      throw new Error('Form not found. Please refresh the page and try again.');
    }
    console.log(' Form found:', form);

    // CRITICAL: Check if user is logged in before allowing form submission
    const authManager = window.globalAuthManager || window.simpleAuthManager;
    console.log(' Auth manager check:', {
      globalAuthManager: !!window.globalAuthManager,
      simpleAuthManager: !!window.simpleAuthManager,
      authManager: !!authManager
    });
    
    if (!authManager) {
      console.error(' No auth manager found ');
      throw new Error('Please log in to submit this form. You must be authenticated to place an order.');
    }
    
    const isLoggedIn = authManager.isUserLoggedIn();
    console.log(' User logged in:', isLoggedIn);
    
    if (!isLoggedIn) {
      console.error(' User not logged in ');
      throw new Error('Please log in to submit this form. You must be authenticated to place an order.');
    }
    
    const currentUser = authManager.getCurrentUser();
    console.log('ðŸ‘¤ Current user:', currentUser);

    // VALIDATION: Check all required fields before proceeding
    console.log(' Running comprehensive validation before submission...');
    const formValidationResult = validateFormFields();
    console.log(' Form validation result:', formValidationResult);
    
    if (!formValidationResult) {
      console.log(' Form validation failed - required fields missing');
      throw new Error('Form validation failed. Please fill in all required fields.');
    }
    
    // VALIDATION: Check menu photos are uploaded (Required for Order Menu System)
    const menuPhotosInputAtSubmit = document.getElementById('menu-photos-upload') as HTMLInputElement | null;
    const hasMenuPhotosAtSubmit = (cachedMenuPhotos && cachedMenuPhotos.length > 0) || (menuPhotosInputAtSubmit && menuPhotosInputAtSubmit.files && menuPhotosInputAtSubmit.files.length > 0);
    
    if (!hasMenuPhotosAtSubmit) {
      console.log(' Menu photos validation failed - no photos uploaded');
      const errorDiv = document.getElementById('menu-photos-error');
      if (errorDiv) {
        errorDiv.classList.remove('hidden');
        errorDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-3"><p class="text-red-700 font-medium">Please upload at least one menu photo. This field is required for Order Menu System.</p></div>';
      }
      
      const validationErrorDiv = document.getElementById('validation-errors');
      if (validationErrorDiv) {
        validationErrorDiv.classList.remove('hidden');
        validationErrorDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-4"><h4 class="text-red-800 font-semibold mb-2">Please fix the following errors:</h4><ul class="list-disc list-inside text-red-700 space-y-1"><li>Please upload at least one menu photo. This field is required for Order Menu System.</li></ul></div>';
      }
      
      const menuPhotosSection = document.getElementById('menu-photos-upload-area');
      if (menuPhotosSection) {
        menuPhotosSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      
      throw new Error('Please upload at least one menu photo. This field is required for Order Menu System.');
    }
    
    console.log(' All validations passed, proceeding with form submission');
    
    // IMMEDIATE CHECK: Are files cached?
    console.log(' IMMEDIATE FILE CHECK:');
    console.log('ðŸ“¸ Cached menu photos count:', cachedMenuPhotos.length);
    console.log('ðŸ·ï¸ Cached logo file:', cachedLogoFile ? 'Yes' : 'No');
    
    if (cachedMenuPhotos.length > 0) {
      console.log('ðŸ“¸ Cached menu photos details:', cachedMenuPhotos.map(f => ({ name: f.name, size: f.size, type: f.type })));
    }
    
    if (cachedLogoFile) {
      console.log('ðŸ·ï¸ Cached logo file details:', { name: cachedLogoFile.name, size: cachedLogoFile.size, type: cachedLogoFile.type });
    }
    
    // Log cached file counts (avoid blocking alerts)
    const menuCount = cachedMenuPhotos.length;
    const logoCount = cachedLogoFile ? 1 : 0;
    console.log('Cached files => menuPhotos:', menuCount, 'logo:', logoCount);

    const formData = new FormData(form);
    const formDataObj = Object.fromEntries(formData);
    
    console.log(' Form data collected:', formDataObj);
    
    // Get phone country code select element
    const phoneCountryCodeSelect = document.getElementById('phone_country_code') as HTMLSelectElement;
    console.log('ðŸ“ž Phone country code select:', phoneCountryCodeSelect ? phoneCountryCodeSelect.value : 'not found');
    
    try {
      let supabase;
      try {
        // Get Supabase client with fast timeout (5 seconds)
        const importPromise = import('../lib/supabase');
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('Supabase import timed out')), 5000);
        });
        
        const supabaseModule = await Promise.race([importPromise, timeoutPromise]) as any;
        supabase = supabaseModule.supabase;
      } catch (importError: any) {
        console.error(' Supabase import error:', importError.message);
        throw new Error('Failed to load database connection. Please refresh the page and try again.');
      }
      
      if (!supabase || typeof supabase.from !== 'function') {
        throw new Error('Database connection failed. Please refresh the page and try again.');
      }
      
      // Skip client-side bucket listing; assume buckets exist and handle upload errors gracefully.
      
      // CRITICAL: Save data FIRST, then upload files in background
      // This ensures data is saved immediately and doesn't timeout
      
      // Get current user ID if available
      let userId = null;
      try {
        if (currentUser && currentUser.id) {
          userId = currentUser.id;
        } else if (authManager && typeof authManager.getCurrentUser === 'function') {
          const user = authManager.getCurrentUser();
          userId = user?.id || null;
        }
      } catch (userError) {
        console.warn(' Could not get user ID:', userError);
      }
      
      // Upload logo FIRST (before database insert) to get URL immediately
      let restaurantLogoUrl = null;
      const logoInputElForRest = document.getElementById('order-menu-logo-upload') as HTMLInputElement | null;
      const fallbackInputFile = logoInputElForRest?.files?.[0] || null;
      const resolvedLogoFile = cachedLogoFile || fallbackInputFile;
      
      if (resolvedLogoFile) {
        try {
          console.log('ðŸ“¤ Uploading logo before database insert...');
          const timestamp = Date.now();
          const randomId = Math.random().toString(36).substring(2, 8);
          const safeName = resolvedLogoFile.name.replace(/[^a-zA-Z0-9.-]/g, '_');
          const path = `logos/${timestamp}_${randomId}_${safeName}`;
          
          const { error: uploadError } = await supabase.storage
            .from('logos')
            .upload(path, resolvedLogoFile, { 
              upsert: true, 
              contentType: resolvedLogoFile.type,
              cacheControl: '3600'
            });
          
          if (!uploadError) {
            const { data: urlData } = supabase.storage
              .from('logos')
              .getPublicUrl(path);
            
            if (urlData?.publicUrl) {
              restaurantLogoUrl = urlData.publicUrl;
              console.log(' Logo uploaded successfully:', restaurantLogoUrl);
            }
          } else {
            console.error(' Logo upload error:', uploadError);
          }
        } catch (logoErr) {
          console.error(' Logo upload exception:', logoErr);
          // Continue without logo - don't block save
        }
      }

      // Prepare data for database insertion (with logo URL if available)
      const now = new Date().toISOString();
      const insertData: any = {
        project_name: formDataObj.projectName || '',
        owner_name: formDataObj.ownerName || '',
        contact_person: formDataObj.contactPerson || '',
        email: formDataObj.email || '',
        phone_number: (() => {
          const countryCode = phoneCountryCodeSelect?.value || '+91';
          return phoneCountryCodeSelect ? `${countryCode}${(formDataObj.phone || '').replace(/\D/g, '')}` : (formDataObj.phone || '');
        })(),
        house_flat_number: formDataObj.houseNumber || '',
        address_line_1: formDataObj.addressLine1 || '',
        city: formDataObj.city || '',
        state: formDataObj.state || '',
        pincode: formDataObj.pincode || '',
        country: formDataObj.country || 'India',
        restaurant_name: formDataObj.restaurantName || '',
        restaurant_logo_url: restaurantLogoUrl, // Include logo URL if uploaded
        menu_photos_urls: null, // Will be updated after upload (menu photos can be large)
        additional_requirements: formDataObj.additionalRequirements || '',
        base_package_cost: 999.00,
        gst_amount: 180.00,
        total_amount: 1179.00, // Fixed price for Order Menu System
        status: 'completed', // Set status to completed when order is placed
        created_at: now,
        updated_at: now
      };
      
      // Add user_id if available (some tables require it)
      if (userId) {
        insertData.user_id = userId;
      }
      
      console.log('ðŸ• Timestamp added - Created at:', now);

      // Minimal logging for speed
      console.log(' Saving order customization data...');

      // Save to database IMMEDIATELY (skip connection test to save time)
      const dbInsertStartTime = Date.now();
      console.log('ðŸ“¤ Saving to database...');
      
      let savedData, saveError;
      
      // Retry function with exponential backoff
      const insertWithRetry = async (maxRetries = 2, retryDelay = 1000): Promise<any> => {
        let currentTimeoutId: ReturnType<typeof setTimeout> | null = null;
        
        for (let attempt = 0; attempt <= maxRetries; attempt++) {
          try {
            if (attempt > 0) {
              console.log(` Retrying database insert (attempt ${attempt + 1}/${maxRetries + 1})...`);
              await new Promise(resolve => setTimeout(resolve, retryDelay * attempt));
            }
            
            // Create timeout promise that properly rejects
            const timeoutPromise = new Promise<never>((_, reject) => {
              currentTimeoutId = setTimeout(() => {
                reject(new Error('Database insert timed out after 30 seconds'));
              }, 30000); // Increased to 30 seconds for better reliability
            });
            
            // Create the insert promise
            const insertPromise = supabase
              .from('order_customizations')
              .insert(insertData)
              .select();
            
            // Race the insert against the timeout
            const result = await Promise.race([insertPromise, timeoutPromise]);
            
            // Clear timeout if operation completed
            if (currentTimeoutId) {
              clearTimeout(currentTimeoutId);
              currentTimeoutId = null;
            }
            
            // Properly handle Supabase response format { data, error }
            if (result && typeof result === 'object' && 'data' in result) {
              const supabaseResult = result as { data: any; error: any };
              if (supabaseResult.error) {
                // If it's a retryable error, throw to retry
                if (attempt < maxRetries && (
                  supabaseResult.error.code === 'PGRST301' || // Connection error
                  supabaseResult.error.message?.includes('timeout') ||
                  supabaseResult.error.message?.includes('network')
                )) {
                  throw supabaseResult.error;
                }
                return { data: null, error: supabaseResult.error };
              }
              return { data: supabaseResult.data, error: null };
            }
            
            // Fallback for unexpected response format
            return { data: result, error: null };
          } catch (dbError: any) {
            // Clear timeout on error
            if (currentTimeoutId) {
              clearTimeout(currentTimeoutId);
              currentTimeoutId = null;
            }
            
            // If it's the last attempt or not a retryable error, return the error
            if (attempt === maxRetries || (
              dbError?.message && 
              !dbError.message.includes('timeout') && 
              !dbError.message.includes('network')
            )) {
              return { data: null, error: dbError };
            }
            
            // Otherwise, continue to next retry
            console.warn(` Database insert attempt ${attempt + 1} failed, will retry...`, dbError?.message);
          }
        }
        
        return { data: null, error: new Error('All retry attempts failed') };
      };
      
      try {
        const result = await insertWithRetry();
        savedData = result.data;
        saveError = result.error;
        
        const dbInsertElapsed = Math.round((Date.now() - dbInsertStartTime) / 1000);
        console.log(` Database insert completed in ${dbInsertElapsed} seconds`);
        console.log(' Insert result:', { savedData, saveError });
      } catch (dbError: any) {
        console.error(' Database insert exception:', dbError);
        console.error(' Error message:', dbError?.message);
        console.error(' Error stack:', dbError?.stack);
        
        // Check if it's a timeout error
        if (dbError?.message && dbError.message.includes('timed out')) {
          saveError = {
            message: 'Database operation timed out. Please check your internet connection and try again.',
            code: 'TIMEOUT',
            details: 'The database insert took longer than 30 seconds to complete.',
            hint: 'This may be due to network issues or database overload. Please try again.'
          };
        } else if (dbError?.error) {
          // If error is wrapped in an error object
          saveError = dbError.error;
        } else {
          saveError = {
            message: dbError?.message || 'Unknown database error occurred',
            code: dbError?.code || 'UNKNOWN',
            details: dbError?.details || '',
            hint: dbError?.hint || 'Please try again or contact support.'
          };
        }
        savedData = null;
        
        // Don't throw here - let the error handling below deal with it
      }
      if (saveError) {
        console.error(' Error saving:', saveError.message || saveError.code || 'Unknown error');
        console.error(' Full error object:', saveError);
        
        // Create detailed error message
        let errorMessage = saveError.message || saveError.hint || 'Failed to save your order.';
        let errorDetails = '';
        
        // Add specific error details based on error code
        if (saveError.code === '23505') {
          errorMessage = 'This order already exists. A duplicate order with the same details was detected.';
          errorDetails = 'Please check if you have already submitted this order.';
        } else if (saveError.code === '23503') {
          errorMessage = 'Database constraint violation. Some required reference data is missing.';
          errorDetails = 'Please refresh the page and try again.';
        } else if (saveError.code === '42501') {
          errorMessage = 'Permission denied. You may not have permission to save orders.';
          errorDetails = 'Please ensure you are logged in and have the correct permissions.';
        } else if (saveError.code === 'PGRST116') {
          errorMessage = 'Table not found. The database table may not exist.';
          errorDetails = 'Please contact support. Error code: PGRST116';
        } else if (saveError.code === 'TIMEOUT') {
          errorMessage = 'Database operation timed out.';
          errorDetails = 'Please check your internet connection and try again.';
        } else if (saveError.message) {
          errorDetails = saveError.hint || saveError.details || '';
        }
        
        // Show user-friendly error message
        const errorDiv = document.getElementById('validation-errors');
        if (errorDiv) {
          errorDiv.classList.remove('hidden');
          const safeErrorMessage = errorMessage.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
          const safeErrorDetails = errorDetails.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
          const safeErrorCode = (saveError.code || 'Unknown').replace(/"/g, '&quot;');
          errorDiv.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
              <h4 class="text-red-800 font-semibold mb-2"> Error Saving Order</h4>
              <p class="text-red-700 font-medium">${safeErrorMessage}</p>
              ${safeErrorDetails ? `<p class="text-red-600 text-sm mt-2">${safeErrorDetails}</p>` : ''}
              <p class="text-red-600 text-sm mt-2">Error Code: ${safeErrorCode}</p>
              <p class="text-red-600 text-sm mt-2">If this problem persists, please contact support with the error code above.</p>
            </div>
          `;
        }
        
        // Throw error to be caught by button handler - this ensures button resets
        throw new Error(errorMessage);
      }

      if (!savedData || (Array.isArray(savedData) && savedData.length === 0)) {
        console.error(' No data returned from insert operation ');
        console.error(' savedData:', savedData);
        console.error(' savedData type:', typeof savedData);
        console.error(' savedData is array:', Array.isArray(savedData));
        console.error(' savedData length:', savedData ? (Array.isArray(savedData) ? savedData.length : 'not an array') : 'null/undefined');
        throw new Error('Error saving your order. No data was returned from database. Please try again.');
      }

      // Handle both array and single object responses
      const savedRecord = Array.isArray(savedData) ? savedData[0] : savedData;
      console.log(' Order saved successfully! ID:', savedRecord?.id);

      const savedRecordId = savedRecord?.id;
      
      // Show success message immediately (files will upload in background)
      const successDiv = document.getElementById('validation-errors');
      if (successDiv) {
        successDiv.classList.remove('hidden');
        successDiv.innerHTML = `
          <div class="bg-green-50 border border-green-200 rounded-lg p-4">
            <h4 class="text-green-800 font-semibold mb-2"> Order Submitted Successfully!</h4>
            <p class="text-green-700">Your order has been saved. Files are uploading in the background...</p>
          </div>
        `;
      }

      // Upload files in background and update record (non-blocking)
      // This runs asynchronously and doesn't block the main save operation
      // Start background uploads but don't wait for them
      Promise.resolve().then(async () => {
        try {
          console.log('ðŸ“¸ Starting background file uploads...');
          let menuPhotosUrls = [];
          let restaurantLogoUrl = null;
          
          // Upload menu photos in parallel (faster than sequential)
          if (cachedMenuPhotos && cachedMenuPhotos.length > 0) {
            console.log(`ðŸ“¸ Uploading ${cachedMenuPhotos.length} menu photos in background...`);
            
            const uploadPromises = cachedMenuPhotos.map(async (photo, i) => {
              try {
                const timestamp = Date.now();
                const randomId = Math.random().toString(36).substring(2, 8);
                const safeName = photo.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                const path = `menu_photos/${timestamp}_${randomId}_${i}_${safeName}`;
                
                const { error: uploadError } = await supabase.storage
                  .from('menu-photos')
                  .upload(path, photo, {
                    upsert: true,
                    contentType: photo.type,
                    cacheControl: '3600'
                  });
                
                if (uploadError) {
                  console.error(` Upload error for photo ${i + 1}:`, uploadError);
                  return null;
                }
                
                const { data: urlData } = supabase.storage
                  .from('menu-photos')
                  .getPublicUrl(path);
                
                if (urlData?.publicUrl) {
                  return {
                    url: urlData.publicUrl,
                    filename: photo.name,
                    mimeType: photo.type,
                    size: photo.size,
                    path: path
                  };
                }
                return null;
              } catch (fileErr) {
                console.error(` Exception uploading photo ${i + 1}:`, fileErr);
                return null;
              }
            });
            
            const uploadResults = await Promise.all(uploadPromises);
            menuPhotosUrls = uploadResults.filter(result => result !== null);
            console.log(` ${menuPhotosUrls.length} menu photos uploaded successfully`);
          }
          
          // Logo is already uploaded and saved with initial insert, so we only need to update menu photos
          // Update database record with menu photos URLs (logo URL was already saved in initial insert)
          if (savedRecordId && menuPhotosUrls.length > 0) {
            const menuPhotosUrlsFormatted = menuPhotosUrls.length > 0 ? menuPhotosUrls.map(photo => ({
              url: photo.url,
              filename: photo.filename || 'menu-photo',
              size: photo.size || null,
              path: photo.path || null,
              mimeType: photo.mimeType || null
            })) : null;
            
            const { error: updateError } = await supabase
              .from('order_customizations')
              .update({
                menu_photos_urls: menuPhotosUrlsFormatted,
                updated_at: new Date().toISOString()
              })
              .eq('id', savedRecordId);
            
            if (updateError) {
              console.error(' Error updating record with file URLs:', updateError);
            } else {
              console.log(' Record updated with file URLs successfully');
            }
          }
        } catch (bgError) {
          console.error(' Background file upload error:', bgError);
          // Don't throw - this is background operation
        }
      }).catch(err => {
        console.error(' Background upload promise error:', err);
      });
      
      // IMPORTANT: Return immediately after saving data
      // Button will reset in finally block, files upload in background
      return;

      // Note: Form clearing is handled by button handler after successful save

    } catch (error: any) {
      console.error(' Error in form submission:', error);
      // Re-throw error so button handler can catch it and reset button state
      throw new Error(error.message || 'An error occurred while submitting your order. Please try again.');
    }
  }

  // Handle form submission
  function handleFormSubmission() {
    const form = document.getElementById('customization-form');
    const closeBtn = document.getElementById('close-customization-form');
    const cancelBtn = document.getElementById('cancel-customization');
    const logoUpload = document.getElementById('restaurant-logo-upload');
    const logoUploadArea = document.getElementById('restaurant-logo-upload-area');
    const logoPreview = document.getElementById('restaurant-logo-preview');
    const logoPreviewImg = document.getElementById('restaurant-logo-preview-img');
    const logoFilename = document.getElementById('restaurant-logo-filename');
    const logoRemoveBtn = document.getElementById('restaurant-logo-remove');
    
    // Initialize logo upload area click handler
    if (logoUploadArea) {
      logoUploadArea.onclick = () => {
        const el = document.getElementById('restaurant-logo-upload');
        if (el) el.click();
        else console.error('restaurant-logo-upload element not found in initial handler');
      };
    }

    logoUpload?.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          logoPreviewImg.src = e.target.result;
          logoFilename.textContent = file.name;
          logoPreview.classList.remove('hidden');
          // Update upload area to show success state instead of hiding it
          logoUploadArea.innerHTML = `
            <div class="flex flex-col items-center">
              <svg class="w-12 h-12 text-green-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              <p class="text-green-600 mb-1 font-medium">Logo uploaded successfully</p>
              <p class="text-sm text-gray-500">${file.name}</p>
              <button type="button" onclick="const el = document.getElementById('restaurant-logo-upload'); if(el) el.click(); else console.error('restaurant-logo-upload element not found in button onclick');" class="mt-2 text-sm text-blue-600 hover:text-blue-800">Change Logo</button>
            </div>
          `;
        };
        reader.readAsDataURL(file);
      }
    });

    // Remove logo functionality
    logoRemoveBtn?.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      logoUpload.value = '';
      logoPreview.classList.add('hidden');
      // Reset upload area to original state
      logoUploadArea.innerHTML = `
        <div class="flex flex-col items-center">
          <svg class="w-12 h-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          <p class="text-gray-600 mb-2">Click to upload logo</p>
          <p class="text-sm text-gray-500">PNG, JPG, SVG up to 10MB</p>
        </div>
      `;
      // Re-add click handler
      logoUploadArea.onclick = () => {
        const el = document.getElementById('restaurant-logo-upload');
        if (el) el.click();
        else console.error('restaurant-logo-upload element not found in reset handler');
      };
    });
    
    // Color picker synchronization
    function syncColorInputs() {
      const colorInputs = form?.querySelectorAll('input[type="color"]');
      const textInputs = form?.querySelectorAll('input[name$="ColorText"]');
      
      colorInputs?.forEach((colorInput, index) => {
        const textInput = textInputs?.[index];
        if (textInput) {
          // Sync color picker to text input
          colorInput.addEventListener('input', () => {
            textInput.value = colorInput.value;
          });
          
          // Sync text input to color picker
          textInput.addEventListener('input', () => {
            if (/^#[0-9A-F]{6}$/i.test(textInput.value)) {
              colorInput.value = textInput.value;
            }
          });
        }
      });
    }
    
    syncColorInputs();
    
    // Close form handlers
    closeBtn?.addEventListener('click', () => {
      userClosedForm = true;
      showBrowseProductsSection();
      showNoActivityMessage();
      // Clear URL parameters when form is closed
      window.history.replaceState({}, document.title, window.location.pathname);
    });
    
    cancelBtn?.addEventListener('click', () => {
      userClosedForm = true;
      showBrowseProductsSection();
      showNoActivityMessage();
      // Clear URL parameters when form is closed
      window.history.replaceState({}, document.title, window.location.pathname);
    });
    
    // Form submission - Save requirements only
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      console.log('ðŸš€ FORM SUBMIT EVENT TRIGGERED!');
      console.log('ðŸš€ Form element:', form);
      console.log('ðŸš€ Event target:', e.target);
      
      // CRITICAL: Check if user is logged in before allowing form submission
      const authManager = window.globalAuthManager || window.simpleAuthManager;
      if (!authManager || !authManager.isUserLoggedIn()) {
        alert(' Please log in to submit this form. You must be authenticated to place an order.');
        return;
      }

      // Enforce required field validation here too (generic message only)
      if (!validateFormFields()) {
        console.log(' Customization form validation failed, blocking save');
        return;
      }
      
      const formData = new FormData(form);
      const data = Object.fromEntries(formData);
      
      console.log(' Project requirements saved:', data);
      console.log(' Form data keys:', Object.keys(data));
      console.log(' Form data values:', Object.values(data));
      
      // Get product details first
      const productName = document.getElementById('selected-product-name').textContent;
      const productPrice = document.getElementById('selected-product-price').textContent;
      
      // Check if it's Order Menu System and save to database
      if (false && productName && productName.toLowerCase().includes('order menu')) {
        console.log('ðŸ§ª Order Menu System detected, saving to database...');
        
        // Prepare data for database
        const insertData = {
          project_name: data.projectName || 'Form Submit Project',
          restaurant_name: data.restaurantName || 'Form Submit Restaurant',
          owner_name: data.ownerName || 'Form Submit Owner',
          contact_person: data.contactPerson || 'Form Submit Contact',
          email: data.email || 'form@submit.com',
          phone_number: data.phone || '1234567890',
          house_flat_number: data.houseNumber || '123',
          address_line_1: data.addressLine1 || 'Form Submit Address',
          city: data.city || 'Form Submit City',
          state: data.state || 'Form Submit State',
          pincode: data.pincode || '123456',
          country: data.country || 'India',
          restaurant_logo_url: null,
          menu_photos_urls: [],
          additional_requirements: data.additionalRequirements || 'Form submit requirements',
          base_package_cost: 999.00,
          gst_amount: 180.00,
          total_amount: 1179.00,
          status: 'pending',
          payment_status: 'pending'
        };
        
        console.log('ðŸ§ª Insert data prepared:', insertData);
        
        try {
          console.log('ðŸ§ª Saving to Supabase...');
          const { data: result, error } = await window.supabase
            .from('order_customizations')
            .insert(insertData)
            .select();
            
          if (error) {
            console.error(' Form submit save failed:', error);
            alert(' Form submit save failed: ' + error.message);
          } else {
            console.log(' Form submit save successful!', result);
            alert(' Data saved successfully to Supabase!');
          }
        } catch (err) {
          console.error(' Form submit save error:', err);
          alert(' Form submit save error: ' + err.message);
        }
      } else {
        console.log('ðŸ§ª Not Order Menu System, skipping database save');
        console.log('ðŸ§ª Product name was:', productName);
      }
      
      // Create project requirements object
      const projectRequirements = {
        productId: new URLSearchParams(window.location.search).get('product') || '1',
        // product context
        productName,
        productPrice,
        projectName: data.projectName,
        appName: data.appName,
        contactPerson: data.contactPerson,
        productDescriptionCustom: data.productDescription,
        email: data.email,
        phone: data.phone,
        additionalRequirements: data.additionalRequirements,
        restaurantLogo: data.restaurantLogo,
        timestamp: new Date().toISOString()
      };
      
      // Always capture restaurant-specific fields if present (avoid ID mismatches)
      projectRequirements.restaurantName = data.restaurantName || projectRequirements.restaurantName || '';
      projectRequirements.cuisineType = data.cuisineType || projectRequirements.cuisineType || '';
      
      try {
        // Save to database using the helper function
        console.log(' Saving project form to database...');
        
        // Determine product type from the visible product name to avoid ID mismatches
        const normalize = (s) => (s || '').toLowerCase();
        const name = normalize(productName);
        let productType = 'restaurant-website';
        if (name.includes('order menu')) productType = 'restaurant-menu-system';
        else if (name.includes('restaurant website')) productType = 'restaurant-website';
        else if (name.includes('android tv')) productType = 'android-tv-app';
        else if (name.includes('streaming')) productType = 'streaming-mobile-app';

        // Upload logo to Supabase Storage (if provided)
        let logoUrl = projectRequirements.logoUrl || null;
        let logoFilename = projectRequirements.logoFilename || null;
        let logoMimeType = projectRequirements.logoMimeType || null;
        let logoSize = projectRequirements.logoSize || null;
        try {
          const fileInput = form.querySelector('input[name="restaurantLogo"]');
          const file = fileInput?.files?.[0];
          if (file) {
            const { supabase } = await import('../lib/supabase');
            // Normalize filename (no spaces), enforce max size 10MB, and use ArrayBuffer for reliability
            const safeName = file.name.replace(/\s+/g, '_');
            if (file.size > 10 * 1024 * 1024) {
              throw new Error('Logo file exceeds 10MB limit');
            }
            const path = `${Date.now()}_${safeName}`;
            const fileBuffer = await file.arrayBuffer();
            const { error: upErr } = await supabase.storage
              .from('logos')
              .upload(path, fileBuffer, { upsert: true, contentType: file.type, cacheControl: '3600' });
            if (!upErr) {
              const { data: pub } = supabase.storage.from('logos').getPublicUrl(path);
              logoUrl = pub?.publicUrl || null;
              // Fallback: create a long-lived signed URL if bucket isn't public
              if (!logoUrl) {
                const { data: signed, error: signErr } = await supabase.storage
                  .from('logos')
                  .createSignedUrl(path, 60 * 60 * 24 * 365); // 1 year
                if (!signErr) {
                  logoUrl = signed?.signedUrl || null;
                }
              }
              logoFilename = file.name;
              logoMimeType = file.type;
              logoSize = file.size;
            }
          }
        } catch (e) {
          console.warn('Logo upload skipped:', e);
        }
        
        // Upload menu photos to Supabase Storage (Required for Order Menu System)
        let menuPhotosUrls = [];
        if (name.includes('order menu') && menuPhotos.length > 0) {
          try {
            console.log('ðŸ“¸ Starting menu photos upload to Supabase Storage...');
            const { supabase } = await import('../lib/supabase');
            
            for (let i = 0; i < menuPhotos.length; i++) {
              const photo = menuPhotos[i];
              const safeName = photo.name.replace(/[^a-zA-Z0-9.-]/g, '_');
              const timestamp = Date.now();
              const path = `menu_photos/${timestamp}_${i}_${safeName}`;
              
              console.log(`ðŸ“¸ Uploading photo ${i + 1}/${menuPhotos.length}: ${photo.name}`);
              console.log(`ðŸ“¸ Upload path: ${path}`);
              
              const fileBuffer = await photo.arrayBuffer();
              const { error: upErr } = await supabase.storage
                .from('menu-photos')
                .upload(path, fileBuffer, { 
                  upsert: true, 
                  contentType: photo.type, 
                  cacheControl: '3600' 
                });
              
              if (!upErr) {
                const { data: pub } = supabase.storage.from('menu-photos').getPublicUrl(path);
                menuPhotosUrls.push({
                  url: pub?.publicUrl || null,
                  filename: photo.name,
                  mimeType: photo.type,
                  size: photo.size,
                  path: path
                });
                console.log(` Photo ${i + 1} uploaded successfully:`, pub?.publicUrl);
              } else {
                console.error(` Error uploading photo ${i + 1}:`, upErr);
              }
            }
            
            console.log('ðŸ“¸ Menu photos upload completed. URLs:', menuPhotosUrls);
          } catch (e) {
            console.error(' Menu photos upload failed:', e);
          }
        }
        
        const formData = {
          productName,
          productPrice,
          projectName: projectRequirements.projectName,
          contactPerson: projectRequirements.contactPerson,
          appName: projectRequirements.appName,
          productDescription: projectRequirements.productDescriptionCustom,
          restaurantName: projectRequirements.restaurantName,
          cuisineType: projectRequirements.cuisineType,
          email: projectRequirements.email,
          phone: projectRequirements.phone,
          primaryColor: projectRequirements.primaryColor,
          secondaryColor: projectRequirements.secondaryColor,
          accentColor: projectRequirements.accentColor,
          textColor: projectRequirements.textColor,
          additionalRequirements: projectRequirements.additionalRequirements,
          // logo info
          logoUrl,
          logoFilename,
          logoMimeType,
          logoSize,
          // menu photos info
          menuPhotosUrls: JSON.stringify(menuPhotosUrls)
        };

        const result = await saveCustomizationForm(formData, productType);
        
        if (result.success) {
          console.log(' Project form saved to Supabase database:', result.data);
          
          // Show success message with database confirmation
          alert(` Project requirements saved to database successfully!\n\nRecord ID: ${result.data.id}\nProject: ${result.data.project_name}\nRestaurant: ${result.data.restaurant_name || 'N/A'}\nCuisine: ${result.data.cuisine_type || 'N/A'}\n\nOur team will contact you soon!`);
        } else {
          console.error(' Error saving to database:', result.error);
          
          // Fallback to localStorage
        const existingRequirements = JSON.parse(localStorage.getItem('project-requirements') || '[]');
        existingRequirements.push(projectRequirements);
        localStorage.setItem('project-requirements', JSON.stringify(existingRequirements));
        
          alert(` Database save failed: ${result.error}\n\nData saved locally as backup. Our team will contact you soon.`);
        }
        
        // Clear URL parameters to show browse products section
        window.history.replaceState({}, document.title, window.location.pathname);
        
        // Show Browse Products section with smooth transition
        showBrowseProductsSection();
        
        // Clear form
        form.reset();
        
        // Reset logo upload area
        if (logoUploadArea) {
          logoUploadArea.innerHTML = `
            <div class="flex flex-col items-center">
              <svg class="w-12 h-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
              </svg>
              <p class="text-gray-600 mb-2">Click to upload restaurant logo</p>
              <p class="text-sm text-gray-500">PNG, JPG, SVG up to 10MB</p>
            </div>
          `;
        }
        
      } catch (error) {
        console.error('Error saving requirements:', error);
        alert('Error saving project requirements. Please try again.');
      }
    });
  }

  // Show Browse Products section with smooth transition
  function showBrowseProductsSection() {
    console.log('ðŸ”„ Showing browse products section...');
    const productForm = document.getElementById('product-customization-form');
    const orderMenuForm = document.getElementById('order-menu-customization-form');
    const recentActivity = document.getElementById('recent-activity');
    
    console.log('Recent activity element found:', recentActivity);
    
    // Hide forms with smooth transition
    if (productForm && !productForm.classList.contains('hidden')) {
      console.log('Hiding product form...');
      productForm.style.transition = 'opacity 0.3s ease-in-out, transform 0.3s ease-in-out';
      productForm.style.opacity = '0';
      productForm.style.transform = 'translateY(-10px)';
      setTimeout(() => productForm.classList.add('hidden'), 300);
    }
    
    if (orderMenuForm && !orderMenuForm.classList.contains('hidden')) {
      console.log('Hiding order menu form...');
      orderMenuForm.style.transition = 'opacity 0.3s ease-in-out, transform 0.3s ease-in-out';
      orderMenuForm.style.opacity = '0';
      orderMenuForm.style.transform = 'translateY(-10px)';
      setTimeout(() => orderMenuForm.classList.add('hidden'), 300);
    }
    
    // Show Browse Products section with smooth transition
    setTimeout(() => {
      if (recentActivity) {
        console.log('Showing recent activity section...');
        recentActivity.style.display = 'block'; // Ensure it's visible
        recentActivity.classList.remove('hidden');
        recentActivity.style.transition = 'opacity 0.3s ease-in-out, transform 0.3s ease-in-out';
        recentActivity.style.opacity = '0';
        recentActivity.style.transform = 'translateY(10px)';
        
        setTimeout(() => {
          recentActivity.style.opacity = '1';
          recentActivity.style.transform = 'translateY(0)';
          console.log(' Browse products section is now visible');
          console.log('Recent activity display style:', recentActivity.style.display);
          console.log('Recent activity class list:', recentActivity.classList.toString());
        }, 50);
      } else {
        console.error(' Recent activity element not found!');
      }
    }, 350);
  }

  // Make function globally accessible
  window.showBrowseProductsSection = showBrowseProductsSection;

  // Global form submission prevention - scope strictly to order-menu-form
  document.addEventListener('submit', (e) => {
    console.log('ðŸš« FORM SUBMISSION EVENT DETECTED!');
    console.log('ðŸš« Event target:', e.target);
    console.log('ðŸš« Event target ID:', e.target.id);
    console.log('ðŸš« Event target tagName:', e.target.tagName);
    console.log('ðŸš« Global form submission intercepted:', e.target.id);
    console.log('ðŸš« Current menuPhotos length:', typeof menuPhotos !== 'undefined' ? menuPhotos.length : 'undefined');
    
    // If it's not our target form, do nothing and allow default behavior
    if (!e.target || e.target.id !== 'order-menu-form') {
      return; // allow sign-in/sign-out and other forms
    }

    // Only allow order-menu-form to submit if it passes validation
    if (e.target.id === 'order-menu-form') {
      e.preventDefault();
      e.stopPropagation();
      
      console.log(' Validating order-menu-form submission...');
      console.log(' menuPhotos variable:', menuPhotos);
      console.log(' menuPhotos type:', typeof menuPhotos);
      console.log(' menuPhotos length:', menuPhotos ? menuPhotos.length : 'undefined');
      
      // Check menu photos validation - check both the array and the file input
      const menuPhotosInput = document.getElementById('menu-photos-upload');
      const hasMenuPhotos = (menuPhotos && menuPhotos.length > 0) || (menuPhotosInput && menuPhotosInput.files && menuPhotosInput.files.length > 0);
      
      console.log(' menuPhotos array length:', menuPhotos ? menuPhotos.length : 'undefined');
      console.log(' menuPhotosInput files length:', menuPhotosInput ? menuPhotosInput.files.length : 'undefined');
      console.log(' hasMenuPhotos:', hasMenuPhotos);
      
      if (!hasMenuPhotos) {
        console.log(' Menu photos validation failed - no photos uploaded');
        const errorDiv = document.getElementById('menu-photos-error');
        if (errorDiv) {
          errorDiv.classList.remove('hidden');
          errorDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-3"><p class="text-red-700 font-medium">Please upload at least one menu photo. This field is required for Order Menu System.</p></div>';
        }
        
        const validationErrorDiv = document.getElementById('validation-errors');
        if (validationErrorDiv) {
          validationErrorDiv.classList.remove('hidden');
          validationErrorDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-4"><h4 class="text-red-800 font-semibold mb-2">Please fix the following errors:</h4><ul class="list-disc list-inside text-red-700 space-y-1"><li>Please upload at least one menu photo. This field is required for Order Menu System.</li></ul></div>';
        }
        
        const menuPhotosSection = document.getElementById('menu-photos-upload-area');
        if (menuPhotosSection) {
          menuPhotosSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        return false;
      }
      
      // Validate form fields before submission
      console.log(' Running form field validation...');
      const formValidationResult = validateFormFields();
      console.log(' Form validation result:', formValidationResult);
      
      if (!formValidationResult) {
        console.log(' Form validation failed - required fields missing');
        return false;
      }
      
      console.log(' All validations passed, proceeding with form submission');
      
      // If all validations pass, manually trigger the form submission
      handleOrderMenuFormSubmission();
    }
  });

  // Additional guard: only observe submit clicks for our specific form
  document.addEventListener('click', (e) => {
    if (!e.target) return;
    const isSubmit = e.target.type === 'submit' || e.target.getAttribute('type') === 'submit';
    if (!isSubmit) return;
    // If it's the order menu form, let the submit event handler deal with it; otherwise allow default
    if (e.target.form && e.target.form.id === 'order-menu-form') {
      console.log('ðŸš« Order menu form submit button clicked - letting submit event handle it');
    }
  });

  // Global event listeners for order menu form buttons (backup)
  document.addEventListener('DOMContentLoaded', () => {
    console.log('ðŸ”§ Setting up global event listeners for order menu form buttons');
    
    // Add event listener for proceed to form button
    const proceedBtn = document.getElementById('proceed-to-oms-form');
    if (proceedBtn) {
      console.log(' Proceed to OMS form button found, adding event listener');
      proceedBtn.addEventListener('click', (e) => {
        e.preventDefault();
        console.log('ðŸš€ Proceed to OMS form button clicked!');
        
        // Hide price page
        const pricePage = document.getElementById('order-menu-price-page');
        if (pricePage) {
          pricePage.style.transition = 'opacity 0.3s ease-in-out, transform 0.3s ease-in-out';
          pricePage.style.opacity = '0';
          pricePage.style.transform = 'translateY(-10px)';
          setTimeout(() => {
            pricePage.classList.add('hidden');
          }, 300);
        }
        
        // Show customization form
        setTimeout(() => {
          const orderMenuForm = document.getElementById('order-menu-customization-form');
          if (orderMenuForm) {
            orderMenuForm.classList.remove('hidden');
            orderMenuForm.style.transition = 'opacity 0.3s ease-in-out, transform 0.3s ease-in-out';
            orderMenuForm.style.opacity = '0';
            orderMenuForm.style.transform = 'translateY(10px)';
            
            setTimeout(() => {
              orderMenuForm.style.opacity = '1';
              orderMenuForm.style.transform = 'translateY(0)';
              // Reinitialize pincode autocomplete when form becomes visible
              if (window.reinitializePincodeAutocomplete) {
                window.reinitializePincodeAutocomplete();
              }
            }, 50);
          }
        }, 300);
      });
    } else {
      console.log(' Proceed to OMS form button not found');
    }
    
    // Add event listener for close button
    const closeBtn = document.getElementById('close-order-menu-form');
    if (closeBtn) {
      console.log(' Global close button found, adding event listener');
      closeBtn.addEventListener('click', (e) => {
        console.log('ðŸš€ Global close button clicked!');
        e.preventDefault();
        e.stopPropagation();
        const form = document.getElementById('order-menu-customization-form');
        if (form) {
          form.classList.add('hidden');
        }
        window.history.replaceState({}, document.title, window.location.pathname);
        userClosedForm = true;
        showBrowseProductsSection();
        showNoActivityMessage();
      });
    } else {
      console.log(' Global close button not found');
    }
    
    // Add event listener for cancel button
    const cancelBtn = document.getElementById('cancel-order-menu');
    if (cancelBtn) {
      console.log(' Global cancel button found, adding event listener');
      cancelBtn.addEventListener('click', (e) => {
        console.log('ðŸš€ Global cancel button clicked!');
        e.preventDefault();
        e.stopPropagation();
        const form = document.getElementById('order-menu-customization-form');
        if (form) {
          form.classList.add('hidden');
        }
        window.history.replaceState({}, document.title, window.location.pathname);
        userClosedForm = true;
        showBrowseProductsSection();
        showNoActivityMessage();
      });
    } else {
      console.log(' Global cancel button not found');
    }
  });

  // Auto-fill user details in forms - ONLY when user is properly authenticated
  async function autofillUserDetails() {
    console.log('ðŸ”„ Attempting to auto-fill user details...');
    
    // Wait for auth manager to be available
    const waitForAuthManager = async () => {
      const authManager = window.globalAuthManager || window.simpleAuthManager;
      
      // CRITICAL: Check if user is actually logged in before proceeding
      if (!authManager || !authManager.isUserLoggedIn()) {
        console.log(' User not logged in - skipping auto-fill');
        return false;
      }
      
      // Get user from auth manager, but also check sessionStorage for latest updates
      let currentUser = authManager.getCurrentUser();
      console.log('ðŸ‘¤ Current user from auth manager:', currentUser);
      
      // Check sessionStorage for updated profile data (in case profile was just updated)
      try {
        const sessionData = sessionStorage.getItem('simple-auth-session');
        if (sessionData) {
          const session = JSON.parse(sessionData);
          if (session.user && session.user.email) {
            // Merge sessionStorage data with auth manager data (sessionStorage has latest)
            currentUser = {
              ...currentUser,
              ...session.user,
              // Prefer sessionStorage data for fields that might have been updated
              full_name: session.user.full_name || currentUser?.full_name,
              phone: session.user.phone || currentUser?.phone,
              company_name: session.user.company_name || currentUser?.company_name
            };
            console.log(' Using updated user data from sessionStorage:', currentUser);
          }
        }
      } catch (e) {
        console.warn(' Could not read sessionStorage:', e);
      }
      
      // Additional check: ensure we have valid user data
      if (!currentUser || !currentUser.email) {
        console.log(' No valid user data found - skipping auto-fill');
        return false;
      }
      
      // Verify user is properly authenticated (not just cached data)
      if (!currentUser.id && !currentUser.user_id) {
        console.log(' User lacks proper authentication ID - skipping auto-fill');
        return false;
      }
      
      console.log(' User is properly authenticated - proceeding with auto-fill');
      
      if (currentUser && currentUser.email) {
        console.log('ðŸ“§ Auto-filling email:', currentUser.email);
        const emailFields = document.querySelectorAll('input[name="email"], input[type="email"]');
        emailFields.forEach(field => {
          field.value = currentUser.email;
          field.dispatchEvent(new Event('input', { bubbles: true }));
          field.dispatchEvent(new Event('change', { bubbles: true }));
          console.log(' Filled email field:', field);
        });
      }
      
      const authPhone = currentUser ? (currentUser.phone || currentUser.phone_number || currentUser?.user_metadata?.phone || currentUser?.user_metadata?.phone_number) : null;
      if (authPhone) {
        console.log('ðŸ“± Auto-filling phone from auth manager:', authPhone);
        // Try multiple possible IDs for phone input
        const phoneInput = document.getElementById('phone-input') as HTMLInputElement || 
                          document.getElementById('phone') as HTMLInputElement ||
                          document.querySelector('input[name="phone"]') as HTMLInputElement;
        const phoneCountryCodeSelect = document.getElementById('phone_country_code') as HTMLSelectElement;
        
        if (phoneInput && phoneCountryCodeSelect) {
          const phoneValue = authPhone.toString().trim();
          console.log('ðŸ“± Processing phone value from auth:', phoneValue);
          
          // Parse phone number to extract country code and number
          if (phoneValue.startsWith('+')) {
            // Try to match country codes from longest to shortest
            const knownCountryCodes = ['+971', '+966', '+91', '+86', '+81', '+61', '+49', '+44', '+33', '+1'];
            let extractedCountryCode = '';
            let phoneNumber = '';
            
            // First, try known country codes from longest to shortest
            for (const code of knownCountryCodes) {
              if (phoneValue.startsWith(code)) {
                extractedCountryCode = code;
                phoneNumber = phoneValue.substring(code.length).replace(/\D/g, '');
                break;
              }
            }
            
            // If no match found, try regex pattern
            if (!extractedCountryCode) {
              const match = phoneValue.match(/^(\+\d{1,4})(\d+)$/);
              if (match) {
                extractedCountryCode = match[1];
                phoneNumber = match[2];
              }
            }
            
            if (extractedCountryCode && phoneNumber) {
              // Check if the country code exists in the dropdown options
              const optionExists = Array.from(phoneCountryCodeSelect.options).some(
                option => option.value === extractedCountryCode
              );
              
              if (optionExists) {
                // Country code exists in dropdown, select it
                phoneCountryCodeSelect.value = extractedCountryCode;
                phoneInput.value = phoneNumber;
                console.log(' Filled phone from auth: country code =', extractedCountryCode, ', number =', phoneNumber);
              } else {
                // Country code doesn't exist in dropdown, default to +91 but keep the number
                phoneCountryCodeSelect.value = '+91';
                phoneInput.value = phoneNumber;
                console.log(' Filled phone from auth with default country code +91, number =', phoneNumber);
              }
            } else {
              // Couldn't parse, try to extract just digits
              phoneInput.value = phoneValue.replace(/\D/g, '');
              phoneCountryCodeSelect.value = '+91';
              console.log(' Could not parse phone from auth, using all digits');
            }
          } else {
            // No country code prefix, assume it's just the number
            phoneInput.value = phoneValue.replace(/\D/g, '');
            phoneCountryCodeSelect.value = '+91';
            console.log(' Filled phone number from auth without country code');
          }
          
          phoneInput.dispatchEvent(new Event('input', { bubbles: true }));
          phoneInput.dispatchEvent(new Event('change', { bubbles: true }));
          console.log(' Successfully filled phone from auth manager');
        } else {
          console.warn(' Phone input or country code select not found, using fallback');
          // Fallback: if elements not found, use old method
          const phoneFields = document.querySelectorAll('input[name="phone"], input[type="tel"]');
          phoneFields.forEach(field => {
            (field as HTMLInputElement).value = authPhone.toString().replace(/\D/g, '');
            field.dispatchEvent(new Event('input', { bubbles: true }));
            field.dispatchEvent(new Event('change', { bubbles: true }));
            console.log(' Filled phone field (fallback):', field);
          });
        }
      }
      
      if (currentUser && currentUser.full_name) {
        console.log('ðŸ‘¤ Auto-filling contact person:', currentUser.full_name);
        const contactPersonFields = document.querySelectorAll('input[name="contactPerson"]');
        contactPersonFields.forEach(field => {
          field.value = currentUser.full_name;
          field.dispatchEvent(new Event('input', { bubbles: true }));
          field.dispatchEvent(new Event('change', { bubbles: true }));
          console.log(' Filled contact person field:', field);
        });
      }

      // Fallback: Also fetch from Supabase profiles and fill (in case authManager lacks data)
      try {
        const { supabase } = await import('../lib/supabase');
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
          console.log(' Attempting to fetch user profile from Supabase...');
          
          // Check if profiles table exists first - fetch all phone-related fields
          const { data: profile, error: profileError } = await supabase
            .from('profiles')
            .select('email, phone, phone_number, full_name, company_name')
            .eq('id', user.id)
            .single();
            
          if (profileError) {
            console.log(' Profile fetch failed (this is normal if profiles table doesn\'t exist):', profileError.message);
            // Don't show this error to user - it's expected if profiles table doesn't exist
            return true;
          }
          
          if (profile) {
            console.log(' Profile data found:', profile);
            
            // Fill email
            if (profile.email) {
              document.querySelectorAll('input[name="email"], input[type="email"]').forEach((field) => {
                (field as HTMLInputElement).value = profile.email;
                field.dispatchEvent(new Event('input', { bubbles: true }));
                field.dispatchEvent(new Event('change', { bubbles: true }));
              });
            }
            
            // Fill phone - try multiple field names and ensure we get the actual value
            const profilePhone = profile.phone || profile.phone_number;
            console.log('ðŸ“± Profile phone value:', profilePhone);
            
            if (profilePhone) {
              // Wait a bit to ensure form elements are ready
              setTimeout(() => {
                const phoneInput = document.getElementById('phone-input') as HTMLInputElement || 
                                 document.getElementById('phone') as HTMLInputElement ||
                                 document.querySelector('input[name="phone"]') as HTMLInputElement;
                const phoneCountryCodeSelect = document.getElementById('phone_country_code') as HTMLSelectElement;
                
                if (phoneInput && phoneCountryCodeSelect) {
                  const phoneValue = profilePhone.toString().trim();
                  console.log('ðŸ“± Processing phone value:', phoneValue);
                  
                  // Parse phone number to extract country code and number
                  if (phoneValue.startsWith('+')) {
                    // Try to match country codes from longest to shortest
                    const knownCountryCodes = ['+971', '+966', '+91', '+86', '+81', '+61', '+49', '+44', '+33', '+1'];
                    let extractedCountryCode = '';
                    let phoneNumber = '';
                    
                    // First, try known country codes from longest to shortest
                    for (const code of knownCountryCodes) {
                      if (phoneValue.startsWith(code)) {
                        extractedCountryCode = code;
                        phoneNumber = phoneValue.substring(code.length).replace(/\D/g, '');
                        break;
                      }
                    }
                    
                    // If no match found, try regex pattern
                    if (!extractedCountryCode) {
                      const match = phoneValue.match(/^(\+\d{1,4})(\d+)$/);
                      if (match) {
                        extractedCountryCode = match[1];
                        phoneNumber = match[2];
                      }
                    }
                    
                    if (extractedCountryCode && phoneNumber) {
                      // Check if the country code exists in the dropdown options
                      const optionExists = Array.from(phoneCountryCodeSelect.options).some(
                        option => option.value === extractedCountryCode
                      );
                      
                      if (optionExists) {
                        // Country code exists in dropdown, select it
                        phoneCountryCodeSelect.value = extractedCountryCode;
                        phoneInput.value = phoneNumber;
                        console.log(' Filled phone: country code =', extractedCountryCode, ', number =', phoneNumber);
                      } else {
                        // Country code doesn't exist in dropdown, default to +91 but keep the number
                        phoneCountryCodeSelect.value = '+91';
                        phoneInput.value = phoneNumber;
                        console.log(' Filled phone with default country code +91, number =', phoneNumber);
                      }
                    } else {
                      // Couldn't parse, try to extract just digits
                      phoneInput.value = phoneValue.replace(/\D/g, '');
                      phoneCountryCodeSelect.value = '+91';
                      console.log(' Could not parse phone, using all digits');
                    }
                  } else {
                    // No country code prefix, assume it's just the number
                    phoneInput.value = phoneValue.replace(/\D/g, '');
                    phoneCountryCodeSelect.value = '+91';
                    console.log(' Filled phone number without country code');
                  }
                  
                  phoneInput.dispatchEvent(new Event('input', { bubbles: true }));
                  phoneInput.dispatchEvent(new Event('change', { bubbles: true }));
                  console.log(' Successfully filled phone from profile');
                } else {
                  console.warn(' Phone input or country code select not found');
                  // Fallback: if elements not found, use old method
                  document.querySelectorAll('input[name="phone"], input[type="tel"]').forEach((field) => {
                    (field as HTMLInputElement).value = profilePhone.toString().replace(/\D/g, '');
                    field.dispatchEvent(new Event('input', { bubbles: true }));
                    field.dispatchEvent(new Event('change', { bubbles: true }));
                  });
                }
              }, 100);
            } else {
              console.log(' No phone number found in profile');
            }
            
            // Fill full name / contact person
            if (profile.full_name) {
              document.querySelectorAll('input[name="contactPerson"]').forEach((field) => {
                (field as HTMLInputElement).value = profile.full_name;
                field.dispatchEvent(new Event('input', { bubbles: true }));
                field.dispatchEvent(new Event('change', { bubbles: true }));
              });
            }
          }
        }
      } catch (error) {
        console.log(' Profile fetch error (this is normal):', error.message);
        // Don't show this error to user - it's expected if profiles table doesn't exist
      }
      
      // Note: Removed auto-filling of company name, restaurant name, and owner name
      // Only contact details (email, phone) and contact person name are auto-filled
      // Other fields should be filled manually by the user
      
      console.log(' Auto-fill completed with auth manager data');
      return true;
    };
    
    // Try immediate fill
    if (!(await waitForAuthManager())) {
      // If auth manager not ready, wait for it
      let attempts = 0;
      const maxAttempts = 50; // 5 seconds
      const interval = setInterval(() => {
        attempts++;
        waitForAuthManager().then((ok) => {
          if (ok || attempts >= maxAttempts) {
          clearInterval(interval);
        if (attempts >= maxAttempts) {
          console.log('â° Auth manager timeout - user appears to be not logged in');
          console.log(' No authenticated user found - forms will remain empty');
          return;
        }
          }
        });
      }, 100);
    }
  }

  // Flag to track if user manually closed a form
  let userClosedForm = false;

  // Load recent activity: Show get-started guidance
  async function loadRecentActivity() {
    const activityContent = document.getElementById('activity-content');
    if (!activityContent) return;
    activityContent.innerHTML = `
      <div class="text-center py-6">
        <p class="text-gray-800 text-base font-medium">Get started with your first order</p>
        <p class="text-gray-500 text-sm mt-1">Choose a product, submit your requirements, and track it in My Orders.</p>
        <div class="mt-4 flex items-center justify-center gap-3">
          <a href="/products" class="inline-flex items-center px-5 py-2.5 rounded-md bg-primary-600 text-white hover:bg-primary-700 transition-colors">Browse Products</a>
        </div>
      </div>
    `;
  }
  
  // Show no activity message
  function showNoActivityMessage() {
    const activityContent = document.getElementById('activity-content');
    const recentActivity = document.getElementById('recent-activity');
    if (recentActivity) {
      recentActivity.classList.remove('hidden');
      recentActivity.style.display = 'block';
    }
    if (!activityContent) return;
    activityContent.innerHTML = `
      <div class="text-center py-6">
        <p class="text-gray-800 text-base font-medium">Get started with your first order</p>
        <p class="text-gray-500 text-sm mt-1">Choose a product, submit your requirements, and track it in My Orders.</p>
        <div class="mt-4 flex items-center justify-center gap-3">
          <a href="/products" class="inline-flex items-center px-5 py-2.5 rounded-md bg-primary-600 text-white hover:bg-primary-700 transition-colors">Browse Products</a>
        </div>
      </div>
    `;
  }
  
  // View order details
  window.viewOrderDetails = async function(customizationId) {
    console.log('ðŸ”„ Loading order details for:', customizationId);
    
    try {
      const { supabase } = await import('../lib/supabase');
      
      const { data: customization, error } = await supabase
        .from('order_customizations')
        .select('*')
        .eq('id', customizationId)
        .single();
      
      if (error) {
        console.error('Error loading customization details:', error);
        alert('Error loading order details: ' + error.message);
        return;
      }
      
      const details = `
Order Menu System Details:
=========================

Project Information:
-------------------
Project Name: ${customization.project_name || 'Not provided'}
Restaurant Name: ${customization.restaurant_name || 'Not provided'}
Owner Name: ${customization.owner_name || 'Not provided'}
Contact Person: ${customization.contact_person || 'Not provided'}

Contact Information:
-------------------
Email: ${customization.email || 'Not provided'}
Phone: ${customization.phone_number || 'Not provided'}

Address Information:
------------------
House/Flat Number: ${customization.house_flat_number || 'Not provided'}
Address: ${customization.address_line_1 || 'Not provided'}
City: ${customization.city || 'Not provided'}
State: ${customization.state || 'Not provided'}
Pincode: ${customization.pincode || 'Not provided'}
Country: ${customization.country || 'Not provided'}

Additional Requirements:
-----------------------
${customization.additional_requirements || 'No additional requirements provided'}

Order Details:
-------------
Price: â‚¹${(customization.total_amount || 0).toLocaleString('en-IN')}
Submitted: ${new Date(customization.created_at).toLocaleString()}
Status: Submitted
      `;
      
      alert(details);
    } catch (error) {
      console.error('Error viewing order details:', error);
      alert('Error viewing order details: ' + error.message);
    }
  };
  
  // Open image modal for full-size viewing
  window.openImageModal = function(imageUrl, filename) {
    console.log('Opening image modal for:', filename);
    
    // Lock body scroll
    document.body.style.overflow = 'hidden';
    
    // Create modal overlay
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
    modal.innerHTML = `
      <div class="relative max-w-4xl max-h-full p-4">
        <button onclick="closeImageModal()" class="absolute top-2 right-2 z-10 bg-white bg-opacity-80 hover:bg-opacity-100 rounded-full p-2 transition-all">
          <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
        <img 
          src="${imageUrl}" 
          alt="${filename}"
          class="max-w-full max-h-full object-contain rounded-lg shadow-2xl"
          onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDQwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yMDAgMTIwTDI0MCAxNjBIMTYwTDIwMCAxMjBaIiBmaWxsPSIjOUNBM0FGIi8+CjxjaXJjbGUgY3g9IjIwMCIgY3k9IjIwMCIgcj0iMjAiIGZpbGw9IiM5Q0EzQUYiLz4KPHRleHQgeD0iMjAwIiB5PSIyNDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZm9udC13ZWlnaHQ9ImJvbGQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM2QjcyODAiPkltYWdlIFVuYXZhaWxhYmxlPC90ZXh0Pgo8L3N2Zz4K'"
        />
        <div class="absolute bottom-4 left-4 right-4 bg-black bg-opacity-50 text-white p-3 rounded-lg">
          <p class="text-sm font-medium">${filename}</p>
        </div>
      </div>
    `;
    
    // Add click outside to close
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeImageModal();
      }
    });
    
    // Add escape key to close
    const escapeHandler = function(e) {
      if (e.key === 'Escape') {
        closeImageModal();
        document.removeEventListener('keydown', escapeHandler);
      }
    };
    document.addEventListener('keydown', escapeHandler);
    
    document.body.appendChild(modal);
    
    // Store modal reference for closing
    window.currentImageModal = modal;
  };
  
  // Close image modal
  window.closeImageModal = function() {
    if (window.currentImageModal) {
      document.body.removeChild(window.currentImageModal);
      window.currentImageModal = null;
      // Unlock body scroll
      document.body.style.overflow = '';
    }
  };
  
  // Test function to debug file upload
  window.testFileUpload = async function() {
    console.log('ðŸ§ª Testing file upload...');
    
    const menuPhotosInput = document.getElementById('menu-photos-upload');
    console.log('ðŸ“¸ File input element:', menuPhotosInput);
    console.log('ðŸ“¸ Files in input:', menuPhotosInput ? menuPhotosInput.files : 'no input');
    
    if (menuPhotosInput && menuPhotosInput.files && menuPhotosInput.files.length > 0) {
      const file = menuPhotosInput.files[0];
      console.log('ðŸ“¸ Testing with file:', file.name, file.size, file.type);
      
      try {
        const { supabase } = await import('../lib/supabase');
        console.log('ðŸ“¸ Supabase client loaded');
        
        // Convert to binary
        const fileBuffer = await file.arrayBuffer();
        console.log('ðŸ“¸ File converted to buffer:', fileBuffer.byteLength, 'bytes');
        
        // Test upload
        const timestamp = Date.now();
        const path = `menu_photos/test_${timestamp}_${file.name}`;
        console.log('ðŸ“¸ Upload path:', path);
        
        const { error } = await supabase.storage
          .from('menu-photos')
          .upload(path, fileBuffer, { 
            upsert: true, 
            contentType: file.type
          });
        
        if (error) {
          console.error(' Upload failed:', error);
        } else {
          const { data } = supabase.storage.from('menu-photos').getPublicUrl(path);
          console.log(' Upload successful:', data.publicUrl);
          console.log('ðŸŽ¯ Check your Supabase Storage menu-photos bucket!');
        }
      } catch (e) {
        console.error(' Test failed:', e);
      }
    } else {
      console.log(' No files selected');
    }
  };

  // Update user info when page loads
  document.addEventListener('DOMContentLoaded', () => {
    console.log('Dashboard DOM loaded - initializing with global auth manager');
    
    // Force clean dashboard view only when NOT arriving with a product selection
    // Keep ?product=&price= so the customization form can show
    const initialParams = new URLSearchParams(window.location.search);
    const hasProductSelection = initialParams.has('product') && initialParams.has('price');
    if (window.location.search && !hasProductSelection) {
      window.history.replaceState({}, document.title, window.location.pathname);
    }
    // Check URL parameters after optional cleaning
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('product');
    const price = urlParams.get('price');
    
    const recentActivity = document.getElementById('recent-activity');
    
    // Show recent activity for normal dashboard load (menu operator or any user) when no product selected
    if (!productId || !price) {
      if (recentActivity) {
        recentActivity.style.display = 'block';
        recentActivity.classList.remove('hidden');
        console.log(' Showing browse products section - no product selected');
        // Always load recent activity on dashboard
        loadRecentActivity();
      }
      // Ensure forms are hidden when no product is selected
      const productForm = document.getElementById('product-customization-form');
      const orderMenuForm = document.getElementById('order-menu-customization-form');
      if (productForm) productForm.classList.add('hidden');
      if (orderMenuForm) orderMenuForm.classList.add('hidden');
    } else {
      // Hide recent activity if there are URL parameters (product selected)
      if (recentActivity) {
        recentActivity.style.display = 'none';
        recentActivity.classList.add('hidden');
        console.log(' Hiding browse products section - product selected');
      }
    }
    
    
    // Remove page load transition to prevent bluish screen
      document.body.style.opacity = '1';
    
    // Check if we should show a form based on URL parameters (fix refresh issue)
    if (productId && price) {
      console.log('URL parameters detected - showing form for product:', productId);
      // Show the appropriate form based on product ID
      const products = [
        { id: '1', name: 'Restaurant Menu System', description: 'Digital menu system with QR code integration, online ordering, and real-time updates. Perfect for restaurants looking to modernize their customer experience.', price: 25000, type: 'restaurant' },
        { id: '2', name: 'Android TV App', description: 'Custom Android TV applications with beautiful UI, content management, and remote control support. Perfect for streaming services and media companies.', price: 55000, type: 'non-restaurant' },
        { id: '3', name: 'Streaming Mobile App', description: 'Mobile streaming applications for iOS and Android with custom features, user authentication, and content management.', price: 35000, type: 'non-restaurant' },
        { id: '4', name: 'Restaurant Website', description: 'Professional restaurant website with online ordering, menu display, and customer management features.', price: 20000, type: 'restaurant' },
        { id: '5', name: 'Order Menu System', description: 'Complete order management system with digital menu integration, real-time order tracking, and payment processing. Perfect for restaurants looking to streamline their ordering process.', price: 999, type: 'order-menu' }
      ];
      
      const selectedProduct = products.find(p => p.id === productId);
      if (selectedProduct) {
        // Update product details
        document.getElementById('selected-product-name').textContent = selectedProduct.name;
        document.getElementById('selected-product-price').textContent = `â‚¹${selectedProduct.price.toLocaleString()}`;
        
        // Update Order Menu System product details
        document.getElementById('order-menu-product-name').textContent = selectedProduct.name;
        // Price is now displayed in the right column pricing section
        
        // Show appropriate form with smooth transition
        const recentActivity = document.getElementById('recent-activity');
        const productForm = document.getElementById('product-customization-form');
        const orderMenuForm = document.getElementById('order-menu-customization-form');
        
        // Hide recent activity with smooth transition
        if (recentActivity) {
          recentActivity.style.transition = 'opacity 0.3s ease-in-out, transform 0.3s ease-in-out';
          recentActivity.style.opacity = '0';
          recentActivity.style.transform = 'translateY(-10px)';
          
          setTimeout(() => {
            recentActivity.classList.add('hidden');
          }, 300);
        }
        
        // Show appropriate form with smooth transition
        setTimeout(() => {
          if (selectedProduct.type === 'order-menu') {
            if (orderMenuForm) {
              orderMenuForm.classList.remove('hidden');
              orderMenuForm.style.transition = 'opacity 0.3s ease-in-out, transform 0.3s ease-in-out';
              orderMenuForm.style.opacity = '0';
              orderMenuForm.style.transform = 'translateY(10px)';
              
              setTimeout(() => {
                orderMenuForm.style.opacity = '1';
                orderMenuForm.style.transform = 'translateY(0)';
              }, 50);
            }
          } else {
            if (productForm) {
              productForm.classList.remove('hidden');
              productForm.style.transition = 'opacity 0.3s ease-in-out, transform 0.3s ease-in-out';
              productForm.style.opacity = '0';
              productForm.style.transform = 'translateY(10px)';
              
              setTimeout(() => {
                productForm.style.opacity = '1';
                productForm.style.transform = 'translateY(0)';
              }, 50);
            }
            
            // Show/hide cuisine type and restaurant name field
            const cuisineField = document.getElementById('cuisine-type-field');
            const restaurantNameField = document.getElementById('restaurant-name-field');
            
            if (selectedProduct.type === 'restaurant') {
              cuisineField.classList.remove('hidden');
              cuisineField.querySelector('select').setAttribute('required', 'required');
              restaurantNameField.classList.remove('hidden');
              restaurantNameField.querySelector('input').setAttribute('required', 'required');
            } else {
              cuisineField.classList.add('hidden');
              cuisineField.querySelector('select').removeAttribute('required');
              restaurantNameField.classList.add('hidden');
              restaurantNameField.querySelector('input').removeAttribute('required');
            }
          }
        }, 300);
        
        // Auto-fill user details when form is shown (with longer delay)
        setTimeout(() => autofillUserDetails(), 500);
      }
    }
    
    // Handle product selection (will no-op since we cleared params for dashboard entry)
    handleProductSelection();
    
    // Handle form functionality
    handleFormSubmission();
    
    // Handle Order Menu form functionality
    handleOrderMenuForm();
    
    // Auto-fill user details (try multiple times)
    autofillUserDetails();
    setTimeout(() => autofillUserDetails(), 1000);
    setTimeout(() => autofillUserDetails(), 2000);
    
    // Watch for form visibility changes and auto-fill when forms become visible
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          const target = mutation.target;
          if (target.id === 'product-customization-form' || target.id === 'order-menu-customization-form') {
            if (!target.classList.contains('hidden')) {
              console.log('ðŸ‘ï¸ Form became visible, auto-filling...');
              setTimeout(() => autofillUserDetails(), 100);
            }
          }
        }
      });
    });
    
    // Observe both forms for class changes
    const productForm = document.getElementById('product-customization-form');
    const orderMenuForm = document.getElementById('order-menu-customization-form');
    
    if (productForm) observer.observe(productForm, { attributes: true, attributeFilter: ['class'] });
    if (orderMenuForm) observer.observe(orderMenuForm, { attributes: true, attributeFilter: ['class'] });
    
    // Try multiple times with different delays to ensure data loads
    updateUserInfo(); // Immediate
    setTimeout(() => updateUserInfo(), 100);
    setTimeout(() => updateUserInfo(), 500);
    setTimeout(() => updateUserInfo(), 1000);
    setTimeout(() => updateUserInfo(), 2000);
    
    // Double-check browse products section visibility after page load
    setTimeout(() => {
      const urlParams = new URLSearchParams(window.location.search);
      const productId = urlParams.get('product');
      const price = urlParams.get('price');
      
      const recentActivity = document.getElementById('recent-activity');
      
      // Only show browse products section if no product is selected
      if (!productId || !price) {
        if (recentActivity) {
          recentActivity.style.display = 'block';
          recentActivity.classList.remove('hidden');
          console.log(' Browse products section confirmed visible - no product selected');
        }
      } else {
        if (recentActivity) {
          recentActivity.style.display = 'none';
          console.log(' Browse products section confirmed hidden - product selected');
        }
      }
    }, 1000);
  });
  
  // Also try when window loads
  window.addEventListener('load', () => {
    console.log('Window loaded - trying again');
    updateUserInfo();
  });
  
  // Try every 2 seconds for the first 10 seconds
  let attempts = 0;
  const maxAttempts = 5;
  const interval = setInterval(() => {
    attempts++;
    console.log(`Attempt ${attempts} to load user data...`);
    updateUserInfo();
    
    if (attempts >= maxAttempts) {
      clearInterval(interval);
      console.log('Max attempts reached');
    }
  }, 2000);
  
  // Listen for auth state changes
  window.addEventListener('user-logged-in', () => {
    console.log('User logged in event received in dashboard');
    updateUserInfo();
    // Refresh recent activity when auth changes (menu operator dashboards)
    setTimeout(() => loadRecentActivity(), 100);
  });
  
  window.addEventListener('user-logged-out', () => {
    console.log('User logged out event received in dashboard');
    updateUserInfo();
    setTimeout(() => loadRecentActivity(), 100);
  });
  
  // Logout functionality removed (was in Quick Actions section)
  
  
  console.log(' Dashboard script initialized with global auth manager');

  // Pincode-based autocomplete functionality
  const pincodeData = {
    '400001': { city: 'Mumbai', state: 'Maharashtra' },
    '400002': { city: 'Mumbai', state: 'Maharashtra' },
    '400003': { city: 'Mumbai', state: 'Maharashtra' },
    '400004': { city: 'Mumbai', state: 'Maharashtra' },
    '400005': { city: 'Mumbai', state: 'Maharashtra' },
    '400006': { city: 'Mumbai', state: 'Maharashtra' },
    '400007': { city: 'Mumbai', state: 'Maharashtra' },
    '400008': { city: 'Mumbai', state: 'Maharashtra' },
    '400009': { city: 'Mumbai', state: 'Maharashtra' },
    '400010': { city: 'Mumbai', state: 'Maharashtra' },
    '110001': { city: 'New Delhi', state: 'Delhi' },
    '110002': { city: 'New Delhi', state: 'Delhi' },
    '110003': { city: 'New Delhi', state: 'Delhi' },
    '110004': { city: 'New Delhi', state: 'Delhi' },
    '110005': { city: 'New Delhi', state: 'Delhi' },
    '110006': { city: 'New Delhi', state: 'Delhi' },
    '110007': { city: 'New Delhi', state: 'Delhi' },
    '110008': { city: 'New Delhi', state: 'Delhi' },
    '110009': { city: 'New Delhi', state: 'Delhi' },
    '110010': { city: 'New Delhi', state: 'Delhi' },
    '560001': { city: 'Bangalore', state: 'Karnataka' },
    '560002': { city: 'Bangalore', state: 'Karnataka' },
    '560003': { city: 'Bangalore', state: 'Karnataka' },
    '560004': { city: 'Bangalore', state: 'Karnataka' },
    '560005': { city: 'Bangalore', state: 'Karnataka' },
    '560006': { city: 'Bangalore', state: 'Karnataka' },
    '560007': { city: 'Bangalore', state: 'Karnataka' },
    '560008': { city: 'Bangalore', state: 'Karnataka' },
    '560009': { city: 'Bangalore', state: 'Karnataka' },
    '560010': { city: 'Bangalore', state: 'Karnataka' },
    '600001': { city: 'Chennai', state: 'Tamil Nadu' },
    '600002': { city: 'Chennai', state: 'Tamil Nadu' },
    '600003': { city: 'Chennai', state: 'Tamil Nadu' },
    '600004': { city: 'Chennai', state: 'Tamil Nadu' },
    '600005': { city: 'Chennai', state: 'Tamil Nadu' },
    '600006': { city: 'Chennai', state: 'Tamil Nadu' },
    '600007': { city: 'Chennai', state: 'Tamil Nadu' },
    '600008': { city: 'Chennai', state: 'Tamil Nadu' },
    '600009': { city: 'Chennai', state: 'Tamil Nadu' },
    '600010': { city: 'Chennai', state: 'Tamil Nadu' },
    '700001': { city: 'Kolkata', state: 'West Bengal' },
    '700002': { city: 'Kolkata', state: 'West Bengal' },
    '700003': { city: 'Kolkata', state: 'West Bengal' },
    '700004': { city: 'Kolkata', state: 'West Bengal' },
    '700005': { city: 'Kolkata', state: 'West Bengal' },
    '700006': { city: 'Kolkata', state: 'West Bengal' },
    '700007': { city: 'Kolkata', state: 'West Bengal' },
    '700008': { city: 'Kolkata', state: 'West Bengal' },
    '700009': { city: 'Kolkata', state: 'West Bengal' },
    '700010': { city: 'Kolkata', state: 'West Bengal' },
    '380001': { city: 'Ahmedabad', state: 'Gujarat' },
    '380002': { city: 'Ahmedabad', state: 'Gujarat' },
    '380003': { city: 'Ahmedabad', state: 'Gujarat' },
    '380004': { city: 'Ahmedabad', state: 'Gujarat' },
    '380005': { city: 'Ahmedabad', state: 'Gujarat' },
    '380006': { city: 'Ahmedabad', state: 'Gujarat' },
    '380007': { city: 'Ahmedabad', state: 'Gujarat' },
    '380008': { city: 'Ahmedabad', state: 'Gujarat' },
    '380009': { city: 'Ahmedabad', state: 'Gujarat' },
    '380010': { city: 'Ahmedabad', state: 'Gujarat' },
    '411001': { city: 'Pune', state: 'Maharashtra' },
    '411002': { city: 'Pune', state: 'Maharashtra' },
    '411003': { city: 'Pune', state: 'Maharashtra' },
    '411004': { city: 'Pune', state: 'Maharashtra' },
    '411005': { city: 'Pune', state: 'Maharashtra' },
    '411006': { city: 'Pune', state: 'Maharashtra' },
    '411007': { city: 'Pune', state: 'Maharashtra' },
    '411008': { city: 'Pune', state: 'Maharashtra' },
    '411009': { city: 'Pune', state: 'Maharashtra' },
    '411010': { city: 'Pune', state: 'Maharashtra' },
    // More rural pincodes
    '302001': { city: 'Jaipur', state: 'Rajasthan' },
    '302002': { city: 'Jaipur', state: 'Rajasthan' },
    '302003': { city: 'Jaipur', state: 'Rajasthan' },
    '302004': { city: 'Jaipur', state: 'Rajasthan' },
    '302005': { city: 'Jaipur', state: 'Rajasthan' },
    '302006': { city: 'Jaipur', state: 'Rajasthan' },
    '302007': { city: 'Jaipur', state: 'Rajasthan' },
    '302008': { city: 'Jaipur', state: 'Rajasthan' },
    '302009': { city: 'Jaipur', state: 'Rajasthan' },
    '302010': { city: 'Jaipur', state: 'Rajasthan' },
    '641001': { city: 'Coimbatore', state: 'Tamil Nadu' },
    '641002': { city: 'Coimbatore', state: 'Tamil Nadu' },
    '641003': { city: 'Coimbatore', state: 'Tamil Nadu' },
    '641004': { city: 'Coimbatore', state: 'Tamil Nadu' },
    '641005': { city: 'Coimbatore', state: 'Tamil Nadu' },
    '625001': { city: 'Madurai', state: 'Tamil Nadu' },
    '625002': { city: 'Madurai', state: 'Tamil Nadu' },
    '625003': { city: 'Madurai', state: 'Tamil Nadu' },
    '625004': { city: 'Madurai', state: 'Tamil Nadu' },
    '625005': { city: 'Madurai', state: 'Tamil Nadu' },
    '570001': { city: 'Mysore', state: 'Karnataka' },
    '570002': { city: 'Mysore', state: 'Karnataka' },
    '570003': { city: 'Mysore', state: 'Karnataka' },
    '570004': { city: 'Mysore', state: 'Karnataka' },
    '570005': { city: 'Mysore', state: 'Karnataka' },
    '580001': { city: 'Hubli', state: 'Karnataka' },
    '580002': { city: 'Hubli', state: 'Karnataka' },
    '580003': { city: 'Hubli', state: 'Karnataka' },
    '580004': { city: 'Hubli', state: 'Karnataka' },
    '580005': { city: 'Hubli', state: 'Karnataka' },
    '500001': { city: 'Hyderabad', state: 'Telangana' },
    '500002': { city: 'Hyderabad', state: 'Telangana' },
    '500003': { city: 'Hyderabad', state: 'Telangana' },
    '500004': { city: 'Hyderabad', state: 'Telangana' },
    '500005': { city: 'Hyderabad', state: 'Telangana' },
    '500006': { city: 'Hyderabad', state: 'Telangana' },
    '500007': { city: 'Hyderabad', state: 'Telangana' },
    '500008': { city: 'Hyderabad', state: 'Telangana' },
    '500009': { city: 'Hyderabad', state: 'Telangana' },
    '500010': { city: 'Hyderabad', state: 'Telangana' },
    // More common Indian pincodes
    '110001': { city: 'Delhi', state: 'Delhi' },
    '110002': { city: 'Delhi', state: 'Delhi' },
    '110003': { city: 'Delhi', state: 'Delhi' },
    '110004': { city: 'Delhi', state: 'Delhi' },
    '110005': { city: 'Delhi', state: 'Delhi' },
    '110006': { city: 'Delhi', state: 'Delhi' },
    '110007': { city: 'Delhi', state: 'Delhi' },
    '110008': { city: 'Delhi', state: 'Delhi' },
    '110009': { city: 'Delhi', state: 'Delhi' },
    '110010': { city: 'Delhi', state: 'Delhi' },
    '560001': { city: 'Bangalore', state: 'Karnataka' },
    '560002': { city: 'Bangalore', state: 'Karnataka' },
    '560003': { city: 'Bangalore', state: 'Karnataka' },
    '560004': { city: 'Bangalore', state: 'Karnataka' },
    '560005': { city: 'Bangalore', state: 'Karnataka' },
    '560006': { city: 'Bangalore', state: 'Karnataka' },
    '560007': { city: 'Bangalore', state: 'Karnataka' },
    '560008': { city: 'Bangalore', state: 'Karnataka' },
    '560009': { city: 'Bangalore', state: 'Karnataka' },
    '560010': { city: 'Bangalore', state: 'Karnataka' },
    '600001': { city: 'Chennai', state: 'Tamil Nadu' },
    '600002': { city: 'Chennai', state: 'Tamil Nadu' },
    '600003': { city: 'Chennai', state: 'Tamil Nadu' },
    '600004': { city: 'Chennai', state: 'Tamil Nadu' },
    '600005': { city: 'Chennai', state: 'Tamil Nadu' },
    '600006': { city: 'Chennai', state: 'Tamil Nadu' },
    '600007': { city: 'Chennai', state: 'Tamil Nadu' },
    '600008': { city: 'Chennai', state: 'Tamil Nadu' },
    '600009': { city: 'Chennai', state: 'Tamil Nadu' },
    '600010': { city: 'Chennai', state: 'Tamil Nadu' },
    '700001': { city: 'Kolkata', state: 'West Bengal' },
    '700002': { city: 'Kolkata', state: 'West Bengal' },
    '700003': { city: 'Kolkata', state: 'West Bengal' },
    '700004': { city: 'Kolkata', state: 'West Bengal' },
    '700005': { city: 'Kolkata', state: 'West Bengal' },
    '700006': { city: 'Kolkata', state: 'West Bengal' },
    '700007': { city: 'Kolkata', state: 'West Bengal' },
    '700008': { city: 'Kolkata', state: 'West Bengal' },
    '700009': { city: 'Kolkata', state: 'West Bengal' },
    '700010': { city: 'Kolkata', state: 'West Bengal' }
  };


  // Pincode autocomplete functionality
  function initializePincodeAutocomplete() {
    const pincodeInput = document.getElementById('pincode-input');
    const cityInput = document.getElementById('city-input');
    const stateInput = document.getElementById('state-input');
    const citySuggestions = document.getElementById('city-suggestions');
    const stateSuggestions = document.getElementById('state-suggestions');

    if (pincodeInput && cityInput && stateInput) {
      console.log('Initializing pincode autocomplete...');
      
      // Pincode-based autofill
      pincodeInput.addEventListener('input', function() {
        const pincode = this.value.trim();
        console.log('Pincode entered:', pincode);
        if (pincode.length === 6 && pincodeData[pincode]) {
          console.log('Found pincode data:', pincodeData[pincode]);
          cityInput.value = pincodeData[pincode].city;
          stateInput.value = pincodeData[pincode].state;
          // Set country to India when pincode is found
          const countrySelect = document.getElementById('country-select');
          if (countrySelect) {
            countrySelect.value = 'India';
          }
        }
      });

      // City autocomplete
      cityInput.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        if (query.length > 0) {
          const filtered = indianCities.filter(city => 
            city.toLowerCase().includes(query)
          );
          showSuggestions(citySuggestions, filtered, cityInput);
        } else {
          hideSuggestions(citySuggestions);
        }
      });

      // State autocomplete
      stateInput.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        if (query.length > 0) {
          const filtered = indianStates.filter(state => 
            state.toLowerCase().includes(query)
          );
          showSuggestions(stateSuggestions, filtered, stateInput);
        } else {
          hideSuggestions(stateSuggestions);
        }
      });

      // Hide suggestions when clicking outside
      document.addEventListener('click', function(e) {
        if (!cityInput.contains(e.target) && !citySuggestions.contains(e.target)) {
          hideSuggestions(citySuggestions);
        }
        if (!stateInput.contains(e.target) && !stateSuggestions.contains(e.target)) {
          hideSuggestions(stateSuggestions);
        }
      });
    }
  }

  // Initialize when DOM is loaded
  document.addEventListener('DOMContentLoaded', function() {
    initializePincodeAutocomplete();
    // Try again after a short delay
    setTimeout(initializePincodeAutocomplete, 500);
    setTimeout(initializePincodeAutocomplete, 1000);
    setTimeout(initializePincodeAutocomplete, 2000);
  });
  
  // Also try to initialize when the form becomes visible (for dynamic forms)
  setTimeout(initializePincodeAutocomplete, 3000);
  setTimeout(initializePincodeAutocomplete, 5000);
  
  // Reinitialize when Order Menu System form is shown
  function reinitializePincodeAutocomplete() {
    console.log('Reinitializing pincode autocomplete...');
    initializePincodeAutocomplete();
  }
  
  // Make it globally available for form visibility changes
  window.reinitializePincodeAutocomplete = reinitializePincodeAutocomplete;

  // Add test save button functionality
  document.addEventListener('DOMContentLoaded', function() {
    const testSaveBtn = document.getElementById('test-save');
    if (testSaveBtn) {
      testSaveBtn.addEventListener('click', async function() {
        console.log('ðŸ§ª Test save button clicked!');
        
        const form = document.getElementById('requirements-form');
        if (form) {
          const formData = new FormData(form);
          const data = Object.fromEntries(formData);
          console.log('ðŸ§ª Test save - Form data:', data);
          
          await testDirectOrderCustomizationSave(data);
        } else {
          console.error(' Form not found for test save');
        }
      });
    }
    
    // Simple test button
    const simpleTestBtn = document.getElementById('simple-test');
    if (simpleTestBtn) {
      simpleTestBtn.addEventListener('click', async function() {
        console.log('ðŸ”µ Simple test button clicked!');
        alert('ðŸ”µ Simple test button works!');
        
        // Test basic data insertion
        const testData = {
          project_name: 'Simple Test Project',
          restaurant_name: 'Simple Test Restaurant',
          owner_name: 'Simple Test Owner',
          contact_person: 'Simple Test Contact',
          email: 'test@example.com',
          phone_number: '1234567890',
          house_flat_number: '123',
          address_line_1: 'Test Address',
          city: 'Test City',
          state: 'Test State',
          pincode: '123456',
          country: 'India',
          restaurant_logo_url: null,
          menu_photos_urls: [],
          additional_requirements: 'Simple test requirements',
          base_package_cost: 999.00,
          gst_amount: 180.00,
          total_amount: 1179.00,
          status: 'pending',
          payment_status: 'pending'
        };
        
        console.log('ðŸ”µ Simple test data:', testData);
        
        try {
          const { data: result, error } = await window.supabase
            .from('order_customizations')
            .insert(testData)
            .select();
            
          if (error) {
            console.error(' Simple test failed:', error);
            alert(' Simple test failed: ' + error.message);
          } else {
            console.log(' Simple test successful!', result);
            alert(' Simple test successful! Data saved to database.');
          }
        } catch (err) {
          console.error(' Simple test error:', err);
          alert(' Simple test error: ' + err.message);
        }
      });
    }
    
    // Function to find and setup form
    function setupForm() {
      const form = document.getElementById('requirements-form');
      console.log(' Form found:', !!form);
      console.log(' Form element:', form);
      
      if (form) {
        console.log(' Form found, adding event listener...');
        
        // Override the form submission completely
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          console.log('ðŸš€ FORCE FORM SUBMISSION TRIGGERED!');
          alert('ðŸš€ Form submission detected!');
          
          // Get form data
          const formData = new FormData(form);
          const data = Object.fromEntries(formData);
          console.log('ðŸš€ Form data collected:', data);
          
          // Always try to save to order_customizations
          try {
            const insertData = {
              project_name: data.projectName || 'Manual Test Project',
              restaurant_name: data.restaurantName || 'Manual Test Restaurant',
              owner_name: data.ownerName || 'Manual Test Owner',
              contact_person: data.contactPerson || 'Manual Test Contact',
              email: data.email || 'manual@test.com',
              phone_number: data.phone || '1234567890',
              house_flat_number: data.houseNumber || '123',
              address_line_1: data.addressLine1 || 'Manual Test Address',
              city: data.city || 'Manual Test City',
              state: data.state || 'Manual Test State',
              pincode: data.pincode || '123456',
              country: data.country || 'India',
              restaurant_logo_url: null,
              menu_photos_urls: [],
              additional_requirements: data.additionalRequirements || 'Manual test requirements',
              base_package_cost: 999.00,
              gst_amount: 180.00,
              total_amount: 1179.00,
              status: 'pending',
              payment_status: 'pending'
            };
            
            console.log('ðŸš€ Insert data prepared:', insertData);
            
            const { data: result, error } = await window.supabase
              .from('order_customizations')
              .insert(insertData)
              .select();
              
            if (error) {
              console.error(' Force save failed:', error);
              alert(' Save failed: ' + error.message);
            } else {
              console.log(' Force save successful!', result);
              alert(' Data saved successfully to order_customizations table!');
            }
          } catch (err) {
            console.error(' Force save error:', err);
            alert(' Save error: ' + err.message);
          }
        });
        
        return true;
      } else {
        console.log('â³ Form not found yet, will retry...');
        return false;
      }
    }
    
    // Try to setup form immediately
    if (!setupForm()) {
      // If form not found, try again after delays
      setTimeout(() => {
        console.log('ðŸ”„ Retrying form setup after 1 second...');
        if (!setupForm()) {
          setTimeout(() => {
            console.log('ðŸ”„ Retrying form setup after 3 seconds...');
            if (!setupForm()) {
              setTimeout(() => {
                console.log('ðŸ”„ Retrying form setup after 5 seconds...');
                setupForm();
              }, 5000);
            }
          }, 3000);
        }
      }, 1000);
    }
    
    // Also add a global form submission handler
    document.addEventListener('submit', function(e) {
      console.log('ðŸŒ Global form submission detected!');
      console.log('ðŸŒ Form element:', e.target);
      console.log('ðŸŒ Form ID:', e.target.id);
      
      if (e.target.id === 'requirements-form') {
        console.log('ðŸŒ Requirements form submitted globally!');
        alert('ðŸŒ Global form submission detected!');
      }
    });
    
    // Add direct click listener to Save and Make Payment button
    console.log(' Looking for save button...');
    
    // First try to find the button inside the order-menu-form
    const orderMenuForm = document.getElementById('order-menu-form');
    let targetButton = null;
    
    if (orderMenuForm) {
      console.log(' Order menu form found:', orderMenuForm);
      targetButton = orderMenuForm.querySelector('button[type="submit"]');
      console.log(' Save button in order menu form:', targetButton);
    }
    
    // If not found, try to find by text content
    if (!targetButton) {
      const allButtons = document.querySelectorAll('button');
      console.log(' All buttons found:', allButtons.length);
      
      for (let button of allButtons) {
        if (button.textContent.includes('Save and Make Payment')) {
          // Check if this button is inside the order-menu-form
          if (orderMenuForm && orderMenuForm.contains(button)) {
            targetButton = button;
            console.log(' Found save button by text in order menu form:', targetButton);
            break;
          }
        }
      }
    }
    
    console.log(' SEARCHING FOR SAVE BUTTON ');
    console.log(' Order menu form:', orderMenuForm);
    console.log(' Target button (initial):', targetButton);
    
    if (targetButton) {
      console.log(' SAVE BUTTON FOUND! ');
      console.log('ðŸ”´ Save button element:', targetButton);
      console.log('ðŸ”´ Save button ID:', targetButton.id);
      console.log('ðŸ”´ Save button classes:', targetButton.className);
      console.log('ðŸ”´ Save button text:', targetButton.textContent);
      console.log('ðŸ”´ Save button type:', targetButton.type);
      
      let isSaving = false; // Flag to prevent duplicate saves
      console.log('ðŸ“Œ Attaching click event listener to save button...');
      targetButton.addEventListener('click', async function(e) {
        console.log('ðŸ”´ðŸ”´ðŸ”´ SAVE BUTTON CLICKED! ðŸ”´ðŸ”´ðŸ”´');
        console.log('ðŸ“ Button element:', targetButton);
        console.log('ðŸ“ Button ID:', targetButton.id);
        console.log('ðŸ“ Button type:', targetButton.type);
        console.log('ðŸ“ Event:', e);
        console.log('ðŸ“ Timestamp:', new Date().toISOString());
        
        e.preventDefault();
        e.stopPropagation();
        
        if (isSaving) {
          console.log(' Save already in progress, ignoring click ');
          alert(' Save is already in progress. Please wait...');
          return;
        }
        
        // Run validation BEFORE setting isSaving flag
        console.log(' RUNNING VALIDATION FIRST ');
        const formValidationResult = validateFormFields();
        console.log(' Validation result:', formValidationResult);
        
        if (!formValidationResult) {
          console.log(' Validation failed, preventing save ');
          alert(' Please fill in all required fields before saving.');
          return; // Don't set isSaving flag if validation fails
        }
        
        // Only set isSaving flag after validation passes
        console.log(' Setting isSaving flag to true');
        isSaving = true;
        
        // Disable button to prevent multiple clicks
        targetButton.disabled = true;
        const originalButtonText = targetButton.innerHTML;
        targetButton.innerHTML = `
          <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12a8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>Saving...</span>
        `;
        
        try {
          console.log(' VALIDATION PASSED, CALLING handleOrderMenuFormSubmission() ');
          console.log('ðŸ• Save operation started at:', new Date().toISOString());
          
          const saveStartTime = Date.now();
          let timeoutWarning: NodeJS.Timeout | null = null;
          let timeoutForced: NodeJS.Timeout | null = null;
          
          // Timeout warning after 30 seconds
          timeoutWarning = setTimeout(() => {
            console.warn(' Save operation is taking longer than expected. Please wait...');
            const elapsed = Math.round((Date.now() - saveStartTime) / 1000);
            console.warn(` Elapsed time: ${elapsed} seconds`);
          }, 30000);
          
          try {
            // Call the save operation directly without aggressive timeout
            // The function has its own timeout protection for database operations
            await handleOrderMenuFormSubmission();
            
          // Clear timeout warning if operation completed
          if (timeoutWarning) clearTimeout(timeoutWarning);
            
            const elapsed = Math.round((Date.now() - saveStartTime) / 1000);
            console.log(' handleOrderMenuFormSubmission() COMPLETED ');
            console.log(' DATA SUCCESSFULLY SAVED TO SUPABASE ');
            console.log(`ðŸ• Save operation completed in ${elapsed} seconds`);
            console.log('ðŸ• Save operation completed at:', new Date().toISOString());
            
            // After successful save, clear both forms if present
            try { document.getElementById('order-menu-form')?.reset(); } catch {}
            try { document.getElementById('customization-form')?.reset(); } catch {}
            
            // Clear logo and menu photos fields
            clearFormFileFields();
            
            // Show success confirmation
            console.log(' Button will be reset in finally block');
          } catch (saveError: any) {
            // Clear timeout warning on error
            if (timeoutWarning) clearTimeout(timeoutWarning);
            
            const elapsed = Math.round((Date.now() - saveStartTime) / 1000);
            console.error(' Save operation error:', saveError);
            console.error(`ðŸ• Save operation failed after ${elapsed} seconds`);
            throw saveError;
          }
        } catch (err: any) {
          console.error(' SAVE BUTTON ERROR ');
          console.error('ðŸ• Error occurred at:', new Date().toISOString());
          console.error(' Error object:', err);
          console.error(' Error message:', err?.message || 'Unknown error');
          console.error(' Error stack:', err?.stack);
          
          // Show error message to user
          const errorMessage = err?.message || 'An error occurred while saving. Please try again.';
          const errorDiv = document.getElementById('validation-errors');
          if (errorDiv) {
            errorDiv.classList.remove('hidden');
            const safeErrorMessage = errorMessage.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            errorDiv.innerHTML = `
              <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <h4 class="text-red-800 font-semibold mb-2"> Error Saving Order</h4>
                <p class="text-red-700">${safeErrorMessage}</p>
                <p class="text-red-600 text-sm mt-2">Please check the console for more details and try again.</p>
              </div>
            `;
          }
        } finally {
          console.log('ðŸ”„ Resetting isSaving flag to false');
          isSaving = false;
          // Ensure button is always reset, even if there was an error
          try {
            if (targetButton) {
              targetButton.disabled = false;
              targetButton.innerHTML = originalButtonText;
              console.log(' Button state reset successfully');
            } else {
              console.error(' Target button not found during reset');
            }
          } catch (resetError) {
            console.error(' Error resetting button state:', resetError);
            // Force reset as fallback - try multiple methods
            try {
              const fallbackBtn = document.getElementById('save-and-pay');
              if (fallbackBtn) {
                fallbackBtn.disabled = false;
                fallbackBtn.textContent = 'Save and Make Payment';
                console.log(' Button reset via fallback method');
              }
            } catch (fallbackError) {
              console.error(' Fallback reset also failed:', fallbackError);
            }
          }
        }
      });
      console.log(' CLICK EVENT LISTENER ATTACHED SUCCESSFULLY ');
      
      // Test: Try to manually trigger click to verify button is accessible
      console.log('ðŸ§ª Testing button accessibility...');
      console.log('ðŸ§ª Button is in DOM:', document.body.contains(targetButton));
      console.log('ðŸ§ª Button is visible:', targetButton.offsetParent !== null);
      console.log('ðŸ§ª Button is enabled:', !targetButton.disabled);
      
      // Add a test function to window for manual testing
      window.testSaveButton = function() {
        console.log('ðŸ§ªðŸ§ªðŸ§ª MANUAL TEST: Triggering save button click ðŸ§ªðŸ§ªðŸ§ª');
        targetButton.click();
      };
      console.log('ðŸ§ª Test function available: window.testSaveButton()');
      
    } else {
      console.error(' SAVE BUTTON NOT FOUND! ');
      console.error(' Attempting fallback search...');
      
      // Fallback: attach by explicit ID if present
      const fallbackBtn = document.getElementById('save-and-pay');
      console.log(' Fallback button search result:', fallbackBtn);
      
      if (fallbackBtn) {
        console.log(' FALLBACK BUTTON FOUND! ');
        console.log('ðŸ”´ Fallback button element:', fallbackBtn);
        console.log('ðŸ”´ Fallback button ID:', fallbackBtn.id);
        
        let isSaving = false;
        console.log('ðŸ“Œ Attaching click event listener to fallback button...');
        fallbackBtn.addEventListener('click', async (e) => {
          console.log('ðŸ”´ðŸ”´ðŸ”´ FALLBACK SAVE BUTTON CLICKED! ðŸ”´ðŸ”´ðŸ”´');
          e.preventDefault();
          e.stopPropagation();
          if (isSaving) {
            console.log(' Save already in progress, ignoring click ');
            return;
          }
          
          // Run validation BEFORE setting isSaving flag
          console.log(' Running validation before fallback save button submission...');
          const formValidationResult = validateFormFields();
          if (!formValidationResult) {
            console.log(' Validation failed, preventing save');
            alert(' Please fill in all required fields before saving.');
            return; // Don't set isSaving flag if validation fails
          }
          
          // Only set isSaving flag after validation passes
          isSaving = true;
          
          // Disable button to prevent multiple clicks
          fallbackBtn.disabled = true;
          const originalButtonText = fallbackBtn.innerHTML;
          fallbackBtn.innerHTML = `
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12a8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Saving...</span>
          `;
          
          try {
            const fallbackStartTime = Date.now();
            console.log(' FALLBACK VALIDATION PASSED, CALLING handleOrderMenuFormSubmission() ');
            console.log('ðŸ• Fallback save operation started at:', new Date().toISOString());
            
            let fallbackTimeoutWarning: NodeJS.Timeout | null = null;
            let fallbackTimeoutForced: NodeJS.Timeout | null = null;
            
            // Timeout warning after 30 seconds
            fallbackTimeoutWarning = setTimeout(() => {
              console.warn(' Fallback save operation is taking longer than expected. Please wait...');
              const elapsed = Math.round((Date.now() - fallbackStartTime) / 1000);
              console.warn(` Elapsed time: ${elapsed} seconds`);
            }, 30000);
            
            // Call the save operation directly without aggressive timeout
            // The function has its own timeout protection for database operations
            await handleOrderMenuFormSubmission();
            
            // Clear timeout warning if operation completed
            if (fallbackTimeoutWarning) clearTimeout(fallbackTimeoutWarning);
            
            const fallbackElapsed = Math.round((Date.now() - fallbackStartTime) / 1000);
            console.log(' FALLBACK handleOrderMenuFormSubmission() COMPLETED ');
            console.log(`ðŸ• Fallback save operation completed in ${fallbackElapsed} seconds`);
            console.log('ðŸ• Fallback save operation completed at:', new Date().toISOString());
            
            try { document.getElementById('order-menu-form')?.reset(); } catch {}
            try { document.getElementById('customization-form')?.reset(); } catch {}
            
            // Clear logo and menu photos fields
            clearFormFileFields();
          } catch (err: any) {
            // Clear timeout warning on error
            if (fallbackTimeoutWarning) clearTimeout(fallbackTimeoutWarning);
            
            console.error(' FALLBACK SAVE BUTTON ERROR ');
            console.error('ðŸ• Fallback error occurred at:', new Date().toISOString());
            console.error(' Error object:', err);
            console.error(' Error message:', err?.message || 'Unknown error');
            console.error(' Error stack:', err?.stack);
            
            // Show error in UI
            const errorDiv = document.getElementById('validation-errors');
            if (errorDiv) {
              errorDiv.classList.remove('hidden');
              const safeErrorMessage = (err?.message || 'Unknown error').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
              errorDiv.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                  <h4 class="text-red-800 font-semibold mb-2"> Error Saving Order</h4>
                  <p class="text-red-700">${safeErrorMessage}</p>
                  <p class="text-red-600 text-sm mt-2">Please check the console for more details and try again.</p>
                </div>
              `;
            }
          } finally {
            console.log('ðŸ”„ Resetting fallback isSaving flag to false');
            isSaving = false;
            // Ensure button is always reset, even if there was an error
            try {
              if (fallbackBtn) {
                fallbackBtn.disabled = false;
                fallbackBtn.innerHTML = originalButtonText;
                console.log(' Fallback button state reset successfully');
              } else {
                console.error(' Fallback button not found during reset');
              }
            } catch (resetError) {
              console.error(' Error resetting fallback button state:', resetError);
              // Force reset as fallback
              try {
                const fallbackBtn2 = document.getElementById('save-and-pay');
                if (fallbackBtn2) {
                  fallbackBtn2.disabled = false;
                  fallbackBtn2.textContent = 'Save and Make Payment';
                  console.log(' Fallback button reset via alternative method');
                }
              } catch (fallbackError2) {
                console.error(' Alternative fallback reset also failed:', fallbackError2);
              }
            }
          }
        });
        console.log(' FALLBACK CLICK EVENT LISTENER ATTACHED SUCCESSFULLY ');
      } else {
        console.error(' FALLBACK BUTTON ALSO NOT FOUND! ');
        console.error(' All save button search methods failed!');
        alert(' Save button not found. Please refresh the page.');
      }
    }
    
    // Global click handler removed to prevent duplicate saves
    
    // Direct save button - this will definitely work
    const directSaveBtn = document.getElementById('direct-save');
    if (directSaveBtn) {
      directSaveBtn.addEventListener('click', async function() {
        console.log('ðŸ”´ Direct save button clicked!');
        
        // Run validation before submission
        console.log(' Running validation before direct save submission...');
        const formValidationResult = validateFormFields();
        if (!formValidationResult) {
          console.log(' Validation failed, preventing direct save');
          return;
        }
        
        // Route through the same validated submission path (uploads + DB insert)
        try {
          await handleOrderMenuFormSubmission();
        } catch (err) {
          console.error(' Direct save flow failed:', err);
          alert(' Direct save failed. See console.');
        }
      });
    }
    
    // Order Menu System test buttons removed
  });

  function showSuggestions(container, suggestions, input) {
    if (suggestions.length === 0) {
      hideSuggestions(container);
      return;
    }

    container.innerHTML = '';
    suggestions.slice(0, 5).forEach(suggestion => {
      const div = document.createElement('div');
      div.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-200';
      div.textContent = suggestion;
      div.addEventListener('click', function() {
        input.value = suggestion;
        hideSuggestions(container);
      });
      container.appendChild(div);
    });

    container.classList.remove('hidden');
    container.style.position = 'absolute';
    container.style.zIndex = '10';
    container.style.width = input.offsetWidth + 'px';
    container.style.top = (input.offsetTop + input.offsetHeight) + 'px';
    container.style.left = input.offsetLeft + 'px';
  }

  function hideSuggestions(container) {
    container.classList.add('hidden');
  }

  // Test function to directly save to order_customizations table
  async function testDirectOrderCustomizationSave(formData) {
    try {
      console.log('ðŸ§ª Starting direct save test...');
      console.log('ðŸ§ª Form data received:', formData);
      console.log('ðŸ§ª Form data keys:', Object.keys(formData));
      console.log('ðŸ§ª Form data values:', Object.values(formData));
      
      // Get current user
      const authManager = window.globalAuthManager || window.simpleAuthManager;
      const currentUser = authManager?.getCurrentUser();
      console.log('ðŸ§ª Current user:', currentUser);
      
      if (!currentUser) {
        console.error(' No user found for direct save test');
        return;
      }
      
      // Check if Supabase is available
      if (!window.supabase) {
        console.error(' Supabase not available for direct save test');
        alert(' Supabase not available! Check console for details.');
        return;
      }
      
      // Test Supabase connection
      console.log('ðŸ§ª Testing Supabase connection...');
      try {
        const { data: testData, error: testError } = await window.supabase
          .from('order_customizations')
          .select('count')
          .limit(1);
        
        if (testError) {
          console.error(' Supabase connection test failed:', testError);
          alert(' Supabase connection failed: ' + testError.message);
          return;
        } else {
          console.log(' Supabase connection test successful');
        }
      } catch (connError) {
        console.error(' Supabase connection error:', connError);
        alert(' Supabase connection error: ' + connError.message);
        return;
      }
      
      // Prepare data for order_customizations table using correct field names
      const insertData = {
        project_name: formData.projectName || 'Test Project',
        restaurant_name: formData.restaurantName || 'Test Restaurant',
        owner_name: formData.ownerName || 'Test Owner',
        contact_person: formData.contactPerson || 'Test Contact',
        email: formData.email || currentUser.email,
        phone_number: formData.phone || '1234567890',
        house_flat_number: formData.houseNumber || '123',
        address_line_1: formData.addressLine1 || 'Test Address',
        city: formData.city || 'Test City',
        state: formData.state || 'Test State',
        pincode: formData.pincode || '123456',
        country: formData.country || 'India',
        restaurant_logo_url: null, // Will be handled separately
        menu_photos_urls: [], // Will be handled separately
        additional_requirements: formData.additionalRequirements || 'Test requirements',
        base_package_cost: 999.00,
        gst_amount: 180.00,
        total_amount: 1179.00,
        status: 'pending',
        payment_status: 'pending'
      };
      
      console.log('ðŸ§ª Insert data prepared:', insertData);
      
      // Insert into order_customizations table
      const { data: result, error } = await window.supabase
        .from('order_customizations')
        .insert(insertData)
        .select();
        
      if (error) {
        console.error(' Direct save test failed:', error);
        console.error(' Error details:', JSON.stringify(error, null, 2));
      } else {
        console.log(' Direct save test successful!', result);
        alert(' Data saved successfully to order_customizations table!');
      }
      
    } catch (err) {
      console.error(' Direct save test error:', err);
    }
  }
</script>

<style>
  /* Mobile responsive fixes for phone field in customization form */
  @media (max-width: 640px) {
    /* Ensure form container doesn't overflow */
    #order-menu-customization-form {
      overflow-x: hidden;
      max-width: 100%;
    }
    
    /* Phone field container - prevent overflow */
    #order-menu-customization-form .flex.min-w-0 {
      width: 100%;
      min-width: 0;
      overflow: hidden;
    }
    
    /* Country code select - fixed width on mobile */
    #phone_country_code {
      flex: 0 0 auto;
      min-width: 100px;
      max-width: 140px;
      width: auto;
    }
    
    /* Custom country code input - fixed width on mobile */
    #phone_country_code_custom:not(.hidden) {
      flex: 0 0 auto;
      min-width: 80px;
      max-width: 100px;
      width: auto;
    }
    
    /* Phone input - takes remaining space */
    #phone-input {
      flex: 1 1 auto;
      min-width: 0;
      width: 0; /* Force flex to calculate width */
    }
    
    /* Prevent text overflow in inputs */
    #phone_country_code,
    #phone_country_code_custom,
    #phone-input {
      overflow: hidden;
      text-overflow: ellipsis;
    }
  }
</style>