---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Authentication Fix Test - DevExpress">
  <div class="min-h-screen bg-gray-50 py-12">
    <div class="max-w-4xl mx-auto px-4">
      <h1 class="text-3xl font-bold text-gray-900 mb-8">🔧 Authentication Fix Test</h1>
      
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4">Current Authentication Status</h2>
        <div id="auth-status" class="space-y-2">
          <p><strong>Status:</strong> <span id="status-text">Loading...</span></p>
          <p><strong>User:</strong> <span id="user-info">Loading...</span></p>
          <p><strong>Session Storage:</strong> <span id="session-storage">Loading...</span></p>
          <p><strong>Local Storage:</strong> <span id="local-storage">Loading...</span></p>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4">Test Actions</h2>
        <div class="space-y-4">
          <button id="check-auth-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
            Check Authentication
          </button>
          <button id="test-login-btn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
            Test Login Event
          </button>
          <button id="test-profile-update-btn" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
            Test Profile Update
          </button>
          <button id="clear-session-btn" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">
            Clear Session
          </button>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-semibold mb-4">Console Logs</h2>
        <div id="console-logs" class="bg-gray-100 p-4 rounded text-sm font-mono max-h-64 overflow-y-auto">
          <p>Console logs will appear here...</p>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  console.log('Test fix page loaded');

  // Function to add logs to the page
  function addLog(message) {
    const logsDiv = document.getElementById('console-logs');
    if (logsDiv) {
      const logEntry = document.createElement('p');
      logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logsDiv.appendChild(logEntry);
      logsDiv.scrollTop = logsDiv.scrollHeight;
    }
  }

  // Function to update authentication status
  function updateAuthStatus() {
    const statusText = document.getElementById('status-text');
    const userInfo = document.getElementById('user-info');
    const sessionStorage = document.getElementById('session-storage');
    const localStorage = document.getElementById('local-storage');

    const authManager = window.globalAuthManager || window.simpleAuthManager;
    
    if (authManager) {
      if (authManager.isUserLoggedIn()) {
        const user = authManager.getCurrentUser();
        statusText.textContent = '✅ Authenticated';
        userInfo.textContent = user ? `${user.email} (${user.full_name || 'No name'})` : 'User data missing';
        
        // Check session storage
        try {
          const sessionData = window.sessionStorage.getItem('simple-auth-session');
          if (sessionData) {
            const session = JSON.parse(sessionData);
            sessionStorage.textContent = `Active (${new Date(session.timestamp).toLocaleString()})`;
          } else {
            sessionStorage.textContent = 'No session data';
          }
        } catch (error) {
          sessionStorage.textContent = 'Session error: ' + error.message;
        }

        // Check local storage
        try {
          const localData = window.localStorage.getItem('simple-auth-user');
          if (localData) {
            const user = JSON.parse(localData);
            localStorage.textContent = `Active (${user.email})`;
          } else {
            localStorage.textContent = 'No local data';
          }
        } catch (error) {
          localStorage.textContent = 'Local error: ' + error.message;
        }
      } else {
        statusText.textContent = '❌ Not authenticated';
        userInfo.textContent = 'No user logged in';
        sessionStorage.textContent = 'No active session';
        localStorage.textContent = 'No local data';
      }
    } else {
      statusText.textContent = '⚠️ Auth manager not available';
      userInfo.textContent = 'Manager not loaded';
      sessionStorage.textContent = 'Manager not loaded';
      localStorage.textContent = 'Manager not loaded';
    }
  }

  // Check authentication button
  document.getElementById('check-auth-btn')?.addEventListener('click', () => {
    addLog('Checking authentication...');
    updateAuthStatus();
    addLog('Authentication check complete');
  });

  // Test login button
  document.getElementById('test-login-btn')?.addEventListener('click', () => {
    addLog('Testing login event...');
    
    const testUser = {
      id: 'test-user-123',
      email: 'test@example.com',
      full_name: 'Test User',
      phone: '123-456-7890',
      company_name: 'Test Company',
      role: 'customer'
    };

    // Trigger login event
    window.dispatchEvent(new CustomEvent('user-logged-in', {
      detail: testUser
    }));

    addLog('Login event triggered for: ' + testUser.email);
    
    // Update status after a short delay
    setTimeout(() => {
      updateAuthStatus();
      addLog('Status updated after login event');
    }, 100);
  });

  // Test profile update button
  document.getElementById('test-profile-update-btn')?.addEventListener('click', () => {
    addLog('Testing profile update...');
    
    const authManager = window.globalAuthManager || window.simpleAuthManager;
    if (authManager && authManager.isUserLoggedIn()) {
      authManager.updateProfile({
        full_name: 'Updated Test User',
        phone: '987-654-3210',
        company_name: 'Updated Company'
      });
      addLog('Profile update triggered');
      
      setTimeout(() => {
        updateAuthStatus();
        addLog('Status updated after profile update');
      }, 100);
    } else {
      addLog('Cannot test profile update - user not logged in');
    }
  });

  // Clear session button
  document.getElementById('clear-session-btn')?.addEventListener('click', () => {
    addLog('Clearing session...');
    
    window.sessionStorage.removeItem('simple-auth-session');
    window.localStorage.removeItem('simple-auth-user');
    
    addLog('Session cleared from storage');
    
    // Update status
    updateAuthStatus();
  });

  // Update status when page loads
  document.addEventListener('DOMContentLoaded', () => {
    addLog('Page loaded, checking authentication...');
    
    // Wait for auth manager to be ready
    setTimeout(() => {
      updateAuthStatus();
      addLog('Initial authentication check complete');
    }, 500);
  });

  // Listen for auth state changes
  window.addEventListener('user-logged-in', (e) => {
    addLog('User logged in event received: ' + e.detail.email);
    updateAuthStatus();
  });

  window.addEventListener('user-logged-out', () => {
    addLog('User logged out event received');
    updateAuthStatus();
  });

  addLog('Test fix page script initialized');
</script>
