---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Database Test - DevExpress">
  <section class="py-12 bg-gray-50 min-h-screen">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="bg-white rounded-lg shadow-sm p-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">Database Integration Test</h1>
        
        <div class="space-y-6">
          <div>
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Test Form Submission</h2>
            <form id="test-form" class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Project Name</label>
                  <input type="text" name="projectName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="Test Project" required>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Contact Person</label>
                  <input type="text" name="contactPerson" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="Test User" required>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">App Name</label>
                  <input type="text" name="appName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="Test App" required>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                  <input type="email" name="email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="test@example.com" required>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                  <input type="tel" name="phone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="+1234567890" required>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Product Type</label>
                  <select name="productType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500" required>
                    <option value="">Select Product Type</option>
                    <option value="restaurant-website">Restaurant Website</option>
                    <option value="streaming-mobile-app">Streaming Mobile App</option>
                    <option value="android-tv-app">Android TV App</option>
                    <option value="restaurant-menu-system">Restaurant Menu System</option>
                  </select>
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Product Description</label>
                <textarea name="productDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="Test description"></textarea>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Additional Requirements</label>
                <textarea name="additionalRequirements" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="Test requirements"></textarea>
              </div>
              
              <button type="submit" class="w-full bg-primary-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                Test Database Save
              </button>
            </form>
          </div>
          
          <div id="test-results" class="hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Test Results</h2>
            <div id="result-content" class="bg-gray-100 rounded-lg p-4">
              <!-- Results will be displayed here -->
            </div>
          </div>
          
          <div>
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Instructions</h2>
            <ol class="list-decimal list-inside space-y-2 text-gray-600">
              <li>Fill out the form above with test data</li>
              <li>Click "Test Database Save" to submit the form</li>
              <li>Check the browser console for detailed logs</li>
              <li>Check the Supabase dashboard to see if data was saved</li>
              <li>Try submitting the same data again to test duplicate prevention</li>
            </ol>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  // Import the database helper
  import { saveCustomizationForm } from '../lib/customization-db.js';
  
  console.log('üß™ Database test page loaded');
  
  const form = document.getElementById('test-form');
  const resultsDiv = document.getElementById('test-results');
  const resultContent = document.getElementById('result-content');
  
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    console.log('üß™ Test form submitted');
    
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    console.log('üìù Form data:', data);
    
    // Show loading state
    resultContent.innerHTML = '<div class="text-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto"></div><p class="mt-2">Saving to database...</p></div>';
    resultsDiv.classList.remove('hidden');
    
    try {
      // Prepare data for database
      const dbData = {
        projectName: data.projectName,
        contactPerson: data.contactPerson,
        appName: data.appName,
        productDescription: data.productDescription,
        email: data.email,
        phone: data.phone,
        additionalRequirements: data.additionalRequirements,
        primaryColor: '#3B82F6',
        secondaryColor: '#10B981',
        accentColor: '#F59E0B',
        textColor: '#1F2937'
      };
      
      console.log('üíæ Attempting to save to database...');
      const result = await saveCustomizationForm(dbData, data.productType);
      
      if (result.success) {
        console.log('‚úÖ Database save successful:', result.data);
        
        resultContent.innerHTML = `
          <div class="text-green-600">
            <h3 class="font-semibold text-lg mb-2">‚úÖ Success!</h3>
            <p class="mb-2">Data saved to database successfully.</p>
            <p class="text-sm">Record ID: ${result.data.id}</p>
            <p class="text-sm">Created: ${new Date(result.data.created_at).toLocaleString()}</p>
            <p class="text-sm">Is Update: ${result.isUpdate ? 'Yes (duplicate prevented)' : 'No (new record)'}</p>
          </div>
        `;
      } else {
        console.error('‚ùå Database save failed:', result.error);
        
        resultContent.innerHTML = `
          <div class="text-red-600">
            <h3 class="font-semibold text-lg mb-2">‚ùå Error!</h3>
            <p class="mb-2">Failed to save to database.</p>
            <p class="text-sm">Error: ${result.error}</p>
            <p class="text-sm mt-2">Check the browser console for more details.</p>
          </div>
        `;
      }
    } catch (error) {
      console.error('‚ùå Unexpected error:', error);
      
      resultContent.innerHTML = `
        <div class="text-red-600">
          <h3 class="font-semibold text-lg mb-2">‚ùå Unexpected Error!</h3>
          <p class="mb-2">An unexpected error occurred.</p>
          <p class="text-sm">Error: ${error.message}</p>
          <p class="text-sm mt-2">Check the browser console for more details.</p>
        </div>
      `;
    }
  });
</script>
